<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
    <title>Progress Summary (N2)</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.28/esri/themes/dark/main.css"
    />

    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css"
    />

    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://js.arcgis.com/4.28/"></script>
  </head>
  <body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <div id="applicationDiv">
        <div id="headerTitleDiv">Pre-Construction Work Progress (N2)</div>
        <div class="contentBox">
          <div class="container">
            <div class="landStrucIsfBox">
              <div id="landChartDiv"></div>
              <div id="landChartCountDiv"></div>
              <div id="structureChartDiv"></div>
            </div>
            <div class="treeBox">
              <div id="isfChartDiv"></div>
              <div id="treeCuttingChartDiv"></div>
              <div id="treeCompenChartDiv"></div>
              <!-- <div id="treeEmptyChartDiv"></div> -->
            </div>
            <div class="utilityBox">
              <div id="utilityPointChartDiv"></div>
              <div id="utilityLineChartDiv"></div>
              <div id="utilityEmptyChartDiv"></div>
            </div>
          </div>
        </div>
        <div id="legendChartDiv"></div>
        <div class="dateDiv">January 31, 2024</div>
        <div id="informationDiv"></div>
      </div>
    </calcite-shell>
  </body>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }

    #applicationDiv {
      display: flex;
      flex-wrap: wrap;
      height: 97%;
      margin: 0 auto;
      box-sizing: border-box;
      background-color: #113149;
    }

    #informationDiv {
      position: absolute;
      z-index: 99;
      width: 30vw;
      height: 10vh;
      color: white;
      bottom: 190;
      right: 5;
      font-size: 1rem;
    }

    #informationDiv b {
      font-size: 1rem;
      color: orange;
      margin: 0;
      padding: 0;
    }

    calcite-shell {
      background-color: #113149;
    }

    calcite-action-bar {
      position: absolute;
      z-index: 99;
      top: 0;
      right: 0;
      margin: 1rem;
    }

    calcite-panel {
      position: absolute;
      z-index: 1;
      bottom: 10px;
      right: 300px;
      width: 30vw;
      height: 50%;
    }
    calcite-loader {
      align-self: center;
      justify-self: center;
    }

    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    #info-content {
      padding: 0.75rem;
    }

    .contentBox {
      display: grid;
      grid-template-columns: 80vw 17.8vw;
      width: 100%;
      height: 88vh;
    }

    .container {
      display: grid;
      flex-wrap: wrap;
      height: 88vh;
      box-sizing: border-box;
      border-right: 0;
    }

    .containerB {
      font-size: 1.5vw;
      color: white;
      padding-top: 40%;
    }

    #headerTitleDiv {
      color: white;
      font-weight: bold;
      font-size: 1.8vw;
      margin: 0.5rem;
    }

    .dateDiv {
      z-index: 99;
      position: absolute;
      padding-bottom: 10;
      font-size: 1vw;
      color: rgb(0, 197, 255);
      right: 10;
      bottom: 10;
    }

    .landStrucIsfBox,
    .treeBox {
      display: inline-flex;
      height: 29.5vh;
      width: 100%;
      box-sizing: border-box;
      border-top: 0;
      border-bottom: 0;
      margin: 0;
      padding: 0;
    }

    .utilityBox {
      display: inline-flex;
      height: 29.5vh;
      width: 100%;
      box-sizing: border-box;
      border-top: 0;
      border-bottom: 0;
      margin: 0;
      padding: 0;
    }

    #legendChartDiv {
      position: absolute;
      z-index: 99;
      right: 80;
      margin: 0;
      padding: 0;
      top: 0;
      background-color: rgba(0, 0, 0, 0);
      height: 50vh;
      width: 10vw;
    }

    #landChartDiv,
    #landChartCountDiv,
    #structureChartDiv,
    #isfChartDiv,
    #treeCuttingChartDiv,
    #treeCompenChartDiv,
    #utilityPointChartDiv,
    #utilityLineChartDiv,
    #treeEmptyChartDiv,
    #utilityEmptyChartDiv {
      width: 35%;
      height: 32vh;
      align-items: center;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      margin: 0;
      padding: 0;
    }

    a {
      font-size: 1.2rem;
      color: white;
      font-weight: bold;
    }

    a:hover,
    a:focus {
      color: rgb(185, 171, 171);
      font-size: 1.2vw;
    }

    ul {
      list-style: none;
      padding-left: 10;
      line-height: 3rem;
    }
    â€‹ p {
      font-size: 1rem;
      width: auto;
      vertical-align: text-bottom;
      padding: 0;
      margin-top: 0;
    }

    h2 {
      font-weight: 400;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      font-style: normal;
      font-size: 23px;
      color: white;
      padding: 3px;
      margin: 0px;
      width: 470px;
      vertical-align: text-top;
    }

    h3 {
      color: white;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 10;
      width: 100%;
    }

    h4 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: left;
      font-weight: normal;
      font-size: 16px;
      padding-top: 20px;
      margin: 0;
      width: 160px;
      vertical-align: text-bottom;
    }

    h5 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 3;
      margin: 10;
    }

    h6 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: normal;
      font-size: 30px;
      padding: 0px 0px 0px 0px;
    }

    .sassy-theme .esri-menu,
    .sassy-theme .esri-popup__main-container,
    .sassy-theme .esri-popup .esri-popup__pointer-direction,
    .sassy-theme .esri-popup .esri-popup__button,
    .sassy-theme .esri-button,
    .sassy-theme .esri-input,
    .sassy-theme .esri-legend,
    .sassy-theme .esri-layer-list,
    .sassy-theme .esri-widget a {
      background-color: rgb(0, 0, 0, 0.7);
      color: #fff;
    }

    .sassy-theme .esri-legend__layer-caption {
      display: none;
    }
  </style>

  <script>
    require([
      "esri/Basemap",
      "esri/Map",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/layers/support/FeatureFilter",
      "esri/layers/SceneLayer",
      "esri/layers/Layer",
      "esri/layers/TileLayer",
      "esri/layers/VectorTileLayer",
      "esri/layers/support/LabelClass",
      "esri/symbols/LabelSymbol3D",
      "esri/WebMap",
      "esri/WebScene",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/widgets/TimeSlider",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/Fullscreen",
      "esri/rest/geometryService",
      "esri/rest/support/Query",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/TimeExtent",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/support/DatePicker",
      "esri/widgets/FeatureTable",
      "esri/widgets/Compass",
      "esri/layers/ElevationLayer",
      "esri/Ground",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
    ], function (
      Basemap,
      Map,
      MapView,
      SceneView,
      FeatureLayer,
      FeatureFilter,
      SceneLayer,
      Layer,
      TileLayer,
      VectorTileLayer,
      LabelClass,
      LabelSymbol3D,
      WebMap,
      WebScene,
      PortalItem,
      Portal,
      TimeSlider,
      Legend,
      LayerList,
      Fullscreen,
      geometryService,
      Query,
      StatisticDefinition,
      WebStyleSymbol,
      TimeExtent,
      Expand,
      Editor,
      UniqueValueRenderer,
      DatePicker,
      FeatureTable,
      Compass,
      ElevationLayer,
      Ground,
      GraphicsLayer,
      Search
    ) {
      ////////////////////////////////////////////////////
      var basemap = new Basemap({
        baseLayers: [
          new VectorTileLayer({
            portalItem: {
              id: "8a9ef2a144e8423786f6139408ac3424", // 3a62040541b84f528da3ac7b80cf4a63
            },
          }),
        ],
      });

      var map = new Map({
        basemap: basemap, //"gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
      });
      //map.ground.surfaceColor = "#FFFF";
      //map.ground.opacity = 0.5;

      var view = new MapView({
        map: map,
        center: [120.5793, 15.18],
        zoom: 10,
        container: "viewDiv",
        environment: {
          background: {
            type: "color", // autocasts as new ColorBackground()
            color: [0, 0, 0, 1],
          },
          // disable stars
          starsEnabled: false,
          //disable atmosphere
          atmosphereEnabled: false,
        },
      });

      //
      function shiftCamera(deg) {
        var camera = view.camera.clone();
        camera.position.longitude += deg;
        return camera;
      }

      function catchAbortError(error) {
        if (error.name != "AbortError") {
          console.error(error);
        }
      }

      // Setup UI

      //*******************************//
      // Import Layers                 //
      //*******************************//
      var lotLayer = new FeatureLayer({
        portalItem: {
          id: "22926e24ad0c41219b60a1522240900d",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 14,
        outFields: ["*"],
        title: "Status of Land Acquisition",
        labelsVisible: false,
      });

      // Structure
      var structureLayer = new FeatureLayer({
        portalItem: {
          id: "22926e24ad0c41219b60a1522240900d",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 13,
        title: "Status of Structure",
        outFields: ["*"],
      });

      // Relocation Status point layer
      var reloISFLayer = new FeatureLayer({
        portalItem: {
          id: "22926e24ad0c41219b60a1522240900d",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 11,
        outFields: ["*"],
        title: "Status for Relocation (ISF)",
      });
      //reloISFLayer.listMode = "hide";

      // Tree Cutting
      var treeLayer = new FeatureLayer({
        portalItem: {
          id: "fb800f69e4354821b97892ef65696323",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 1,
        elevationInfo: {
          mode: "on-the-ground",
        },
        outFields: ["*"],
        title: "Status of Tree Cutting",
      });

      // Utility Relocation (Point)
      var utilPointLayer = new FeatureLayer({
        portalItem: {
          id: "fb800f69e4354821b97892ef65696323",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 2,
        title: "Utility Point",
        outFields: ["*"],
        elevationInfo: {
          mode: "on-the-ground",
        },
      });

      // Utility Relocation (Line)
      var utilLineLayer = new FeatureLayer({
        portalItem: {
          id: "fb800f69e4354821b97892ef65696323",
          // portal: {
          //   url: "https://gis.railway-sector.com/portal",
          // },
        },
        layerId: 3,
        title: "Utility Line",
        elevationInfo: {
          mode: "relative-to-scene",
          featureExpressionInfo: {
            expression: "$feature.height",
          },
          unit: "meters",
          //offset: 0
        },
        outFields: ["*"],
      });

      /////////////////////////////////////////////////////////////////////
      var applicationDiv = document.getElementById("applicationDiv");

      var headerDiv = document.getElementById("headerDiv");
      var headerTitleDiv = document.getElementById("headerTitleDiv");

      // Land, structure, and ISF
      var landChartDiv = document.getElementById("landChartDiv");
      var landChartCountDiv = document.getElementById("landChartCountDiv");
      var structureChartDiv = document.getElementById("structureChartDiv");
      var isfChartDiv = document.getElementById("isfChartDiv");

      // Tree cutting and tree compensation
      var treeCuttingChartDiv = document.getElementById("treeCuttingChartDiv");
      var treeCompenChartDiv = document.getElementById("treeCompenChartDiv");

      // Utitlity Relocation
      var utilityPointChartDiv = document.getElementById(
        "utilityPointChartDiv"
      );
      var utilityLineChartDiv = document.getElementById("utilityLineChartDiv");

      var informationDiv = document.getElementById("informationDiv");

      //informationDiv.innerHTML =  "<br>" + "<b>" + "Note:" + "</b>" + "<br>" + "<br>" + "* Each gauge shows percent progress of each CP in the sliced chart.";
      // informationDiv.innerHTML = `<b>Note:</b><br>
      //                             <p>1. The progress of individual CPs is indicated in the sliced areas of gauges.</p>
      //                             <p>2. Values in the parentheses represent the total number of observations or total area (m2).
      //                            `;

      // Thousand separators function
      function thousands_separators(num) {
        var num_parts = num.toString().split(".");
        num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return num_parts.join(".");
      }

      ////////// Chart Begins //////////////////
      am4core.ready(function () {
        am4core.useTheme(am4themes_animated);

        // Color Definition
        const color_101 = "#ffa500";
        const color_102 = "#00ff00";
        const color_103 = "#70ad47";
        const color_104 = "#ffff00";
        const color_105 = "#bf40bf";
        const color_handedOver = "#00c5ff";

        // Bottom Title Color
        const BOTTOM_LABEL_COL = am4core.color("#C5C5C5");
        const TOP_TITLE_COL = am4core.color("#FFFFFF");

        // Gauge Needle (hand) length
        const NEEDLE_LENGTH = am4core.percent(70);

        const bottomLabelFontSize = "1.3em";
        const titleFontSize = "1.7em";
        const labelMarginTop = -5;

        // Total percent and total number label properties
        const totalPercentLabel_y = -15;
        const totalPercentLabel_fontSize = "3.5em";

        const totalNumberLabel_y = 5;
        const totalNumberLabel_fontSize = "1.5em";

        // Themes begin

        // Legend
        //
        function legendCP() {
          var total_n01_lot = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_lot",
            statisticType: "sum",
          };

          var total_n02_lot = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_lot",
            statisticType: "sum",
          };

          var total_n03_lot = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_lot",
            statisticType: "sum",
          };

          var total_n04_lot = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_lot",
            statisticType: "sum",
          };

          var total_n05_lot = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_lot",
            statisticType: "sum",
          };

          var query = lotLayer.createQuery();
          query.outStatistics = [
            total_n01_lot,
            total_n02_lot,
            total_n03_lot,
            total_n04_lot,
            total_n05_lot,
          ];
          query.returnGeometry = true;

          return lotLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const n01 = stats.total_n01_lot;
            const n02 = stats.total_n02_lot;
            const n03 = stats.total_n03_lot;
            const n04 = stats.total_n04_lot;
            const n05 = stats.total_n05_lot;

            var chart = am4core.create("legendChartDiv", am4charts.PieChart);

            // Add data
            chart.data = [
              {
                CP: "All CPs",
                status: 0,
                color: am4core.color(color_handedOver),
              },
              {
                CP: "CP N-01 (%)",
                status: n01,
                color: am4core.color(color_101),
              },
              {
                CP: "CP N-02 (%)",
                status: n02,
                color: am4core.color(color_102),
              },
              {
                CP: "CP N-03 (%)",
                status: n03,
                color: am4core.color(color_103),
              },
              {
                CP: "CP N-04 (%)",
                status: n04,
                color: am4core.color(color_104),
              },
              {
                CP: "CP N-05 (%)",
                status: n05,
                color: am4core.color(color_105),
              },
            ];

            // Set inner radius
            chart.innerRadius = am4core.percent(0);
            chart.radius = am4core.percent(0);
            // Add and configure Series

            function createSlices(field, status) {
              var pieSeries = chart.series.push(new am4charts.PieSeries());
              pieSeries.dataFields.value = field;
              pieSeries.dataFields.category = status;
              pieSeries.disabled = true;
              pieSeries.slices.template.propertyFields.fill = "color";
              pieSeries.slices.template.stroke = am4core.color("#fff");
              pieSeries.slices.template.strokeWidth = 0;
              pieSeries.slices.template.strokeOpacity = 1;

              // change the cursor on hover to make it apparent the object can be interacted with
              pieSeries.slices.template.cursorOverStyle = [
                {
                  property: "cursor",
                  value: "pointer",
                },
              ];

              // Add a legend
              const LegendFontSizze = "1em";
              chart.legend = new am4charts.Legend();

              chart.legend.valueLabels.template.align = "right";
              chart.legend.valueLabels.template.textAlign = "end";

              //chart.legend.position = "bottom";
              chart.legend.labels.template.fontSize = LegendFontSizze;
              chart.legend.labels.template.fill = "#ffffff";
              chart.legend.valueLabels.template.fill = am4core.color("#ffffff");

              //pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
              //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";

              // Responsive code for chart
              chart.responsive.enabled = true;
              chart.responsive.useDefault = false;
              chart.logo.disabled = true;

              chart.responsive.rules.push({
                relevant: function (target) {
                  if (target.pixelWidth <= 400) {
                    return true;
                  }
                  return false;
                },
                state: function (target, stateId) {
                  if (target instanceof am4charts.PieSeries) {
                    var state = target.states.create(stateId);

                    var labelState =
                      target.labels.template.states.create(stateId);
                    labelState.properties.disabled = true;

                    var tickState =
                      target.ticks.template.states.create(stateId);
                    tickState.properties.disabled = true;
                    return state;
                  }
                  if (target instanceof am4charts.Legend) {
                    var state = target.states.create(stateId);
                    state.properties.paddingTop = 0;
                    state.properties.paddingRight = 0;
                    state.properties.paddingBottom = 0;
                    state.properties.paddingLeft = 0;
                    state.properties.marginLeft = 0;
                    return state;
                  }
                  return null;
                },
              });
              // Responsive code for chart

              // Chart Title
              //var title = chart.titles.create();
              //title.text = "Land"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
              //title.fontSize = 20;
              //title.fontWeight = "bold";
              //title.fill = "#ffffff";
              //title.marginTop = 5;

              var marker = chart.legend.markers.template.children.getIndex(0);
              var markerTemplate = chart.legend.markers.template;
              //marker.cornerRadius(12, 12, 12, 12); round legend marker
              marker.strokeWidth = 1;
              marker.strokeOpacity = 1;
              marker.stroke = am4core.color("#ccc");

              // Change size of legend marker
              markerTemplate.width = 18;
              markerTemplate.height = 18;
              // This creates initial animation
              //pieSeries.hiddenState.properties.opacity = 1;
              //pieSeries.hiddenState.properties.endAngle = -90;
              //pieSeries.hiddenState.properties.startAngle = -90;
            } // End of createSlices function

            createSlices("status", "CP");
          }); // End of queryFeatures
        } // End of updateChartLot()
        legendCP();

        // Calculate Statistcis
        // Land, Structure, and ISF

        //////////////////////////////////////////

        /// 1. Land (handed-over area)
        function lotTotalArea() {
          var total_affected_area = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_affected_area",
            statisticType: "sum",
          };

          var total_handover_area = {
            onStatisticField: "HandedOverArea",
            outStatisticFieldName: "total_handover_area",
            statisticType: "sum",
          };

          var query = lotLayer.createQuery();
          query.outStatistics = [total_affected_area, total_handover_area];

          return lotLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const totalAffected = stats.total_affected_area;
            const totalHandedOver = stats.total_handover_area;
            //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
            return totalAffected;
          });
        }

        function lotSummary(totalAffected) {
          var total_affected_area = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_affected_area",
            statisticType: "sum",
          };

          var total_handover_area = {
            onStatisticField: "HandedOverArea",
            outStatisticFieldName: "total_handover_area",
            statisticType: "sum",
          };

          var query = lotLayer.createQuery();
          query.outStatistics = [total_affected_area, total_handover_area];
          query.returnGeometry = true;
          query.groupByFieldsForStatistics = ["CP"];

          var cpN01 = [];
          var cpN01_a = [];

          var cpN02 = [];
          var cpN02_a = [];

          var cpN03 = [];
          var cpN03_a = [];

          var cpN04 = [];
          var cpN04_a = [];

          var cpN05 = [];
          var cpN05_a = [];

          return lotLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const affected = attributes.total_affected_area;
              const handedOver = attributes.total_handover_area;
              const LOT_HANDOVER_PERC = (handedOver / totalAffected) * 100;
              const lot_handedover = (handedOver / affected) * 100;

              if (cpPackage === "N-01") {
                cpN01.push(LOT_HANDOVER_PERC);
                cpN01_a.push(lot_handedover);
              } else if (cpPackage === "N-02") {
                cpN02.push(LOT_HANDOVER_PERC);
                cpN02_a.push(lot_handedover);
              } else if (cpPackage === "N-03") {
                cpN03.push(LOT_HANDOVER_PERC);
                cpN03_a.push(lot_handedover);
              } else if (cpPackage === "N-04") {
                cpN04.push(LOT_HANDOVER_PERC);
                cpN04_a.push(lot_handedover);
              } else if (cpPackage === "N-05") {
                cpN05.push(LOT_HANDOVER_PERC);
                cpN05_a.push(lot_handedover);
              }
            });
            return [
              cpN01,
              cpN02,
              cpN03,
              cpN04,
              cpN05,
              cpN01_a,
              cpN02_a,
              cpN03_a,
              cpN04_a,
              cpN05_a,
              totalAffected,
            ];
          });
        } // End of lotSummary function

        var axis1TickColor = "#C5C5C5";

        function laFigureLot([
          cpN01,
          cpN02,
          cpN03,
          cpN04,
          cpN05,
          cpN01_a,
          cpN02_a,
          cpN03_a,
          cpN04_a,
          cpN05_a,
          totalAffected,
        ]) {
          var totalScore =
            Number(cpN01) +
            Number(cpN02) +
            Number(cpN03) +
            Number(cpN04) +
            Number(cpN05);

          var N01 = Number(cpN01);
          var N02 = Number(cpN01) + Number(cpN02);
          var N03 = Number(cpN01) + Number(cpN02) + Number(cpN03);
          var N04 =
            Number(cpN01) + Number(cpN02) + Number(cpN03) + Number(cpN04);
          var N05 =
            Number(cpN01) +
            Number(cpN02) +
            Number(cpN03) +
            Number(cpN04) +
            Number(cpN05);

          var n01 = Number(cpN01_a);
          var n02 = Number(cpN02_a);
          var n03 = Number(cpN03_a);
          var n04 = Number(cpN04_a);
          var n05 = Number(cpN05_a);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("landChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          //'<a href="https://google.com"}">More info</a>'

          title.text = "LAND";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">LAND</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          //var sourceLabel = chart.createChild(am4core.Label);
          //sourceLabel.html = '<a href="https://google.com">Test</a>';

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]HANDED-OVER AREA";
          //label.html = '<a href="https://google.com">HANDED-OVER AREA</a>';
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1; // default 0.8 fill-color of
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text =
            "(" + thousands_separators(totalAffected.toFixed(0)) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }
        lotTotalArea().then(lotSummary).then(laFigureLot);

        /// 1. Land (handed-over counts)
        function totalLotCount() {
          var total_lot = {
            onStatisticField: "LotID",
            outStatisticFieldName: "total_lot",
            statisticType: "count",
          };

          var total_handedover = {
            onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_handedover",
            statisticType: "sum",
          };

          var total_n01 = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01",
            statisticType: "sum",
          };

          var total_n01_handedover = {
            onStatisticField:
              "CASE WHEN (HandedOver = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_handedover",
            statisticType: "sum",
          };

          var total_n02 = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02",
            statisticType: "sum",
          };

          var total_n02_handedover = {
            onStatisticField:
              "CASE WHEN (HandedOver = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_handedover",
            statisticType: "sum",
          };

          var total_n03 = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03",
            statisticType: "sum",
          };

          var total_n03_handedover = {
            onStatisticField:
              "CASE WHEN (HandedOver = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_handedover",
            statisticType: "sum",
          };

          var total_n04 = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04",
            statisticType: "sum",
          };

          var total_n04_handedover = {
            onStatisticField:
              "CASE WHEN (HandedOver = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_handedover",
            statisticType: "sum",
          };

          var total_n05 = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05",
            statisticType: "sum",
          };

          var total_n05_handedover = {
            onStatisticField:
              "CASE WHEN (HandedOver = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_handedover",
            statisticType: "sum",
          };

          var query = lotLayer.createQuery();
          query.outStatistics = [
            total_lot,
            total_handedover,
            total_n01,
            total_n01_handedover,
            total_n02,
            total_n02_handedover,
            total_n03,
            total_n03_handedover,
            total_n04,
            total_n04_handedover,
            total_n05,
            total_n05_handedover,
          ];

          return lotLayer.queryFeatures(query).then((response) => {
            var stats = response.features[0].attributes;
            const total = stats.total_lot;
            const handedOver = stats.total_handedover;
            const percent = (handedOver / total) * 100;

            const n01_total = stats.total_n01;
            const n02_total = stats.total_n02;
            const n03_total = stats.total_n03;
            const n04_total = stats.total_n04;
            const n05_total = stats.total_n05;

            const n01_total_handedover = stats.total_n01_handedover;
            const n02_total_handedover = stats.total_n02_handedover;
            const n03_total_handedover = stats.total_n03_handedover;
            const n04_total_handedover = stats.total_n04_handedover;
            const n05_total_handedover = stats.total_n05_handedover;

            const n01_percent =
              n01_total === 0 ? 0 : (n01_total_handedover / n01_total) * 100;
            const n02_percent =
              n02_total === 0 ? 0 : (n02_total_handedover / n02_total) * 100;
            const n03_percent =
              n03_total === 0 ? 0 : (n03_total_handedover / n03_total) * 100;
            const n04_percent =
              n04_total === 0 ? 0 : (n04_total_handedover / n04_total) * 100;
            const n05_percent =
              n05_total === 0 ? 0 : (n05_total_handedover / n05_total) * 100;

            const n01_percent_total = (n01_total_handedover / total) * 100;
            const n02_percent_total = (n02_total_handedover / total) * 100;
            const n03_percent_total = (n03_total_handedover / total) * 100;
            const n04_percent_total = (n04_total_handedover / total) * 100;
            const n05_percent_total = (n05_total_handedover / total) * 100;

            return [
              total,
              percent,
              n01_percent,
              n02_percent,
              n03_percent,
              n04_percent,
              n05_percent,
              n01_percent_total,
              n02_percent_total,
              n03_percent_total,
              n04_percent_total,
              n05_percent_total,
            ];
          });
        }

        function chartTotalLotHandedOverCount([
          total,
          percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("landChartCountDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          //'<a href="https://google.com"}">More info</a>'

          title.text = "LAND";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">LAND</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          //var sourceLabel = chart.createChild(am4core.Label);
          //sourceLabel.html = '<a href="https://google.com">Test</a>';

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]HANDED-OVER";
          //label.html = '<a href="https://google.com">HANDED-OVER AREA</a>';
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1; // default 0.8 fill-color of
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total.toFixed(0)) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        totalLotCount().then(chartTotalLotHandedOverCount);

        /// 2. Structure
        function totalStrucCount() {
          var total_struc = {
            onStatisticField: "StrucID",
            outStatisticFieldName: "total_struc",
            statisticType: "count",
          };

          var total_dismantle = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_dismantle",
            statisticType: "sum",
          };

          var total_n01 = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01",
            statisticType: "sum",
          };

          var total_n01_dismantle = {
            onStatisticField:
              "CASE WHEN (StatusStruc = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_dismantle",
            statisticType: "sum",
          };

          var total_n02 = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02",
            statisticType: "sum",
          };

          var total_n02_dismantle = {
            onStatisticField:
              "CASE WHEN (StatusStruc = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_dismantle",
            statisticType: "sum",
          };

          var total_n03 = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03",
            statisticType: "sum",
          };

          var total_n03_dismantle = {
            onStatisticField:
              "CASE WHEN (StatusStruc = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_dismantle",
            statisticType: "sum",
          };

          var total_n04 = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04",
            statisticType: "sum",
          };

          var total_n04_dismantle = {
            onStatisticField:
              "CASE WHEN (StatusStruc = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_dismantle",
            statisticType: "sum",
          };

          var total_n05 = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05",
            statisticType: "sum",
          };

          var total_n05_dismantle = {
            onStatisticField:
              "CASE WHEN (StatusStruc = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_dismantle",
            statisticType: "sum",
          };

          var query = structureLayer.createQuery();
          query.outStatistics = [
            total_struc,
            total_dismantle,
            total_n01,
            total_n01_dismantle,
            total_n02,
            total_n02_dismantle,
            total_n03,
            total_n03_dismantle,
            total_n04,
            total_n04_dismantle,
            total_n05,
            total_n05_dismantle,
          ];

          return structureLayer.queryFeatures(query).then((response) => {
            var stats = response.features[0].attributes;
            const total = stats.total_struc;
            const dismantled = stats.total_dismantle;
            const percent = (dismantled / total) * 100;

            const n01_total = stats.total_n01;
            const n02_total = stats.total_n02;
            const n03_total = stats.total_n03;
            const n04_total = stats.total_n04;
            const n05_total = stats.total_n05;

            const n01_total_dismantle = stats.total_n01_dismantle;
            const n02_total_dismantle = stats.total_n02_dismantle;
            const n03_total_dismantle = stats.total_n03_dismantle;
            const n04_total_dismantle = stats.total_n04_dismantle;
            const n05_total_dismantle = stats.total_n05_dismantle;

            const n01_percent =
              n01_total === 0 ? 0 : (n01_total_dismantle / n01_total) * 100;
            const n02_percent =
              n02_total === 0 ? 0 : (n02_total_dismantle / n02_total) * 100;
            const n03_percent =
              n03_total === 0 ? 0 : (n03_total_dismantle / n03_total) * 100;
            const n04_percent =
              n04_total === 0 ? 0 : (n04_total_dismantle / n04_total) * 100;
            const n05_percent =
              n05_total === 0 ? 0 : (n05_total_dismantle / n05_total) * 100;

            const n01_percent_total = (n01_total_dismantle / total) * 100;
            const n02_percent_total = (n02_total_dismantle / total) * 100;
            const n03_percent_total = (n03_total_dismantle / total) * 100;
            const n04_percent_total = (n04_total_dismantle / total) * 100;
            const n05_percent_total = (n05_total_dismantle / total) * 100;

            return [
              total,
              percent,
              n01_percent,
              n02_percent,
              n03_percent,
              n04_percent,
              n05_percent,
              n01_percent_total,
              n02_percent_total,
              n03_percent_total,
              n04_percent_total,
              n05_percent_total,
            ];
          });
        }

        function chartTotalStrucDismantleCount([
          total,
          percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("structureChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "EXISTING STRUCTURE";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">EXISTING STRUCTURE</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]DISMANTLED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        totalStrucCount().then(chartTotalStrucDismantleCount);

        /// 3. ISF
        function totalIsfCount() {
          var total_isf = {
            onStatisticField: "StrucID",
            outStatisticFieldName: "total_isf",
            statisticType: "count",
          };

          var total_isf_relocated = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_isf_relocated",
            statisticType: "sum",
          };

          var total_n01 = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01",
            statisticType: "sum",
          };

          var total_n01_isf = {
            onStatisticField:
              "CASE WHEN (StatusRC = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_isf",
            statisticType: "sum",
          };

          var total_n02 = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02",
            statisticType: "sum",
          };

          var total_n02_isf = {
            onStatisticField:
              "CASE WHEN (StatusRC = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_isf",
            statisticType: "sum",
          };

          var total_n03 = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03",
            statisticType: "sum",
          };

          var total_n03_isf = {
            onStatisticField:
              "CASE WHEN (StatusRC = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_isf",
            statisticType: "sum",
          };

          var total_n04 = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04",
            statisticType: "sum",
          };

          var total_n04_isf = {
            onStatisticField:
              "CASE WHEN (StatusRC = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_isf",
            statisticType: "sum",
          };

          var total_n05 = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05",
            statisticType: "sum",
          };

          var total_n05_isf = {
            onStatisticField:
              "CASE WHEN (StatusRC = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_isf",
            statisticType: "sum",
          };

          var query = reloISFLayer.createQuery();
          query.outStatistics = [
            total_isf,
            total_isf_relocated,
            total_n01,
            total_n01_isf,
            total_n02,
            total_n02_isf,
            total_n03,
            total_n03_isf,
            total_n04,
            total_n04_isf,
            total_n05,
            total_n05_isf,
          ];

          return reloISFLayer.queryFeatures(query).then((response) => {
            var stats = response.features[0].attributes;
            const total = stats.total_isf;
            const isfd = stats.total_isf_relocated;
            const percent = (isfd / total) * 100;

            const n01_total = stats.total_n01;
            const n02_total = stats.total_n02;
            const n03_total = stats.total_n03;
            const n04_total = stats.total_n04;
            const n05_total = stats.total_n05;

            const n01_total_isf = stats.total_n01_isf;
            const n02_total_isf = stats.total_n02_isf;
            const n03_total_isf = stats.total_n03_isf;
            const n04_total_isf = stats.total_n04_isf;
            const n05_total_isf = stats.total_n05_isf;

            const n01_percent =
              n01_total === 0 ? 0 : (n01_total_isf / n01_total) * 100;
            const n02_percent =
              n02_total === 0 ? 0 : (n02_total_isf / n02_total) * 100;
            const n03_percent =
              n03_total === 0 ? 0 : (n03_total_isf / n03_total) * 100;
            const n04_percent =
              n04_total === 0 ? 0 : (n04_total_isf / n04_total) * 100;
            const n05_percent =
              n05_total === 0 ? 0 : (n05_total_isf / n05_total) * 100;

            const n01_percent_total = (n01_total_isf / total) * 100;
            const n02_percent_total = (n02_total_isf / total) * 100;
            const n03_percent_total = (n03_total_isf / total) * 100;
            const n04_percent_total = (n04_total_isf / total) * 100;
            const n05_percent_total = (n05_total_isf / total) * 100;

            return [
              total,
              percent,
              n01_percent,
              n02_percent,
              n03_percent,
              n04_percent,
              n05_percent,
              n01_percent_total,
              n02_percent_total,
              n03_percent_total,
              n04_percent_total,
              n05_percent_total,
            ];
          });
        }

        function chartTotalIsfRelocateCount([
          total,
          percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("isfChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "INFORMAL SETTLERS";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">INFORMAL SETTLERS</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]RELOCATED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";

          //label.dataItem = data;
          label.wrap = true;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        totalIsfCount().then(chartTotalIsfRelocateCount);

        /// 1. Tree Cutting
        function totalTreeCuttingCount() {
          var total_tree = {
            onStatisticField: "CommonName",
            outStatisticFieldName: "total_tree",
            statisticType: "count",
          };

          var total_cut = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_cut",
            statisticType: "sum",
          };

          var total_n01 = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01",
            statisticType: "sum",
          };

          var total_n01_cut = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_cut",
            statisticType: "sum",
          };

          var total_n02 = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02",
            statisticType: "sum",
          };

          var total_n02_cut = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_cut",
            statisticType: "sum",
          };

          var total_n03 = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03",
            statisticType: "sum",
          };

          var total_n03_cut = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_cut",
            statisticType: "sum",
          };

          var total_n04 = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04",
            statisticType: "sum",
          };

          var total_n04_cut = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_cut",
            statisticType: "sum",
          };

          var total_n05 = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05",
            statisticType: "sum",
          };

          var total_n05_cut = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_cut",
            statisticType: "sum",
          };

          var query = reloISFLayer.createQuery();
          query.outStatistics = [
            total_tree,
            total_cut,
            total_n01,
            total_n01_cut,
            total_n02,
            total_n02_cut,
            total_n03,
            total_n03_cut,
            total_n04,
            total_n04_cut,
            total_n05,
            total_n05_cut,
          ];

          return treeLayer.queryFeatures(query).then((response) => {
            var stats = response.features[0].attributes;
            const total = stats.total_tree;
            const cutd = stats.total_cut;
            const percent = (cutd / total) * 100;

            const n01_total = stats.total_n01;
            const n02_total = stats.total_n02;
            const n03_total = stats.total_n03;
            const n04_total = stats.total_n04;
            const n05_total = stats.total_n05;

            const n01_total_cut = stats.total_n01_cut;
            const n02_total_cut = stats.total_n02_cut;
            const n03_total_cut = stats.total_n03_cut;
            const n04_total_cut = stats.total_n04_cut;
            const n05_total_cut = stats.total_n05_cut;

            const n01_percent =
              n01_total === 0 ? 0 : (n01_total_cut / n01_total) * 100;
            const n02_percent =
              n02_total === 0 ? 0 : (n02_total_cut / n02_total) * 100;
            const n03_percent =
              n03_total === 0 ? 0 : (n03_total_cut / n03_total) * 100;
            const n04_percent =
              n04_total === 0 ? 0 : (n04_total_cut / n04_total) * 100;
            const n05_percent =
              n05_total === 0 ? 0 : (n05_total_cut / n05_total) * 100;

            const n01_percent_total = (n01_total_cut / total) * 100;
            const n02_percent_total = (n02_total_cut / total) * 100;
            const n03_percent_total = (n03_total_cut / total) * 100;
            const n04_percent_total = (n04_total_cut / total) * 100;
            const n05_percent_total = (n05_total_cut / total) * 100;

            return [
              total,
              percent,
              n01_percent,
              n02_percent,
              n03_percent,
              n04_percent,
              n05_percent,
              n01_percent_total,
              n02_percent_total,
              n03_percent_total,
              n04_percent_total,
              n05_percent_total,
            ];
          });
        }

        function chartTotalTreeCutCount([
          total,
          percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "treeCuttingChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "TREE CUTTING";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">INFORMAL SETTLERS</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]CUT/EARTHBALLED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";

          //label.dataItem = data;
          label.wrap = true;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        totalTreeCuttingCount().then(chartTotalTreeCutCount);

        // Tree Compensation
        function totalTreeCompensationCount() {
          var total_tree = {
            onStatisticField: "CASE WHEN Compensation >= 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_tree",
            statisticType: "sum",
          };

          var total_compensation = {
            onStatisticField: "CASE WHEN Compensation = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_compensation",
            statisticType: "sum",
          };

          var total_n01 = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01",
            statisticType: "sum",
          };

          var total_n01_compensation = {
            onStatisticField:
              "CASE WHEN (Compensation = 3 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_compensation",
            statisticType: "sum",
          };

          var total_n02 = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02",
            statisticType: "sum",
          };

          var total_n02_compensation = {
            onStatisticField:
              "CASE WHEN (Compensation = 3 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_compensation",
            statisticType: "sum",
          };

          var total_n03 = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03",
            statisticType: "sum",
          };

          var total_n03_compensation = {
            onStatisticField:
              "CASE WHEN (Compensation = 3 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_compensation",
            statisticType: "sum",
          };

          var total_n04 = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04",
            statisticType: "sum",
          };

          var total_n04_compensation = {
            onStatisticField:
              "CASE WHEN (Compensation = 3 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_compensation",
            statisticType: "sum",
          };

          var total_n05 = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05",
            statisticType: "sum",
          };

          var total_n05_compensation = {
            onStatisticField:
              "CASE WHEN (Compensation = 3 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_compensation",
            statisticType: "sum",
          };

          var query = reloISFLayer.createQuery();
          query.outStatistics = [
            total_tree,
            total_compensation,
            total_n01,
            total_n01_compensation,
            total_n02,
            total_n02_compensation,
            total_n03,
            total_n03_compensation,
            total_n04,
            total_n04_compensation,
            total_n05,
            total_n05_compensation,
          ];

          return treeLayer.queryFeatures(query).then((response) => {
            var stats = response.features[0].attributes;
            const total = stats.total_tree;
            const cutd = stats.total_compensation;
            const percent = (cutd / total) * 100;

            const n01_total = stats.total_n01;
            const n02_total = stats.total_n02;
            const n03_total = stats.total_n03;
            const n04_total = stats.total_n04;
            const n05_total = stats.total_n05;

            const n01_total_compensation = stats.total_n01_compensation;
            const n02_total_compensation = stats.total_n02_compensation;
            const n03_total_compensation = stats.total_n03_compensation;
            const n04_total_compensation = stats.total_n04_compensation;
            const n05_total_compensation = stats.total_n05_compensation;

            const n01_percent =
              n01_total === 0 ? 0 : (n01_total_compensation / n01_total) * 100;
            const n02_percent =
              n02_total === 0 ? 0 : (n02_total_compensation / n02_total) * 100;
            const n03_percent =
              n03_total === 0 ? 0 : (n03_total_compensation / n03_total) * 100;
            const n04_percent =
              n04_total === 0 ? 0 : (n04_total_compensation / n04_total) * 100;
            const n05_percent =
              n05_total === 0 ? 0 : (n05_total_compensation / n05_total) * 100;

            const n01_percent_total = (n01_total_compensation / total) * 100;
            const n02_percent_total = (n02_total_compensation / total) * 100;
            const n03_percent_total = (n03_total_compensation / total) * 100;
            const n04_percent_total = (n04_total_compensation / total) * 100;
            const n05_percent_total = (n05_total_compensation / total) * 100;

            return [
              total,
              percent,
              n01_percent,
              n02_percent,
              n03_percent,
              n04_percent,
              n05_percent,
              n01_percent_total,
              n02_percent_total,
              n03_percent_total,
              n04_percent_total,
              n05_percent_total,
            ];
          });
        }

        function chartTotalTreeCompensationCount([
          total,
          percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "treeCompenChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "TREE COMPENSATION";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">INFORMAL SETTLERS</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]COMPENSATED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";

          //label.dataItem = data;
          label.wrap = true;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        totalTreeCompensationCount().then(chartTotalTreeCompensationCount);

        // Total Number: Utility Point + Utility Line
        async function utilityTotalCount() {
          /// point
          var total_number_point = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_point",
            statisticType: "count",
          };

          var total_completed_point = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_completed_point",
            statisticType: "sum",
          };

          var total_n01_point = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_point",
            statisticType: "sum",
          };

          var total_n01_completed_point = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_completed_point",
            statisticType: "sum",
          };

          var total_n02_point = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_point",
            statisticType: "sum",
          };

          var total_n02_completed_point = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_completed_point",
            statisticType: "sum",
          };

          var total_n03_point = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_point",
            statisticType: "sum",
          };

          var total_n03_completed_point = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_completed_point",
            statisticType: "sum",
          };

          var total_n04_point = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_point",
            statisticType: "sum",
          };

          var total_n04_completed_point = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_completed_point",
            statisticType: "sum",
          };

          var total_n05_point = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_point",
            statisticType: "sum",
          };

          var total_n05_completed_point = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_completed_point",
            statisticType: "sum",
          };

          // Line
          var total_number_line = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_line",
            statisticType: "count",
          };

          var total_completed_line = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_completed_line",
            statisticType: "sum",
          };

          var total_n01_line = {
            onStatisticField: "CASE WHEN CP = 'N-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_line",
            statisticType: "sum",
          };

          var total_n01_completed_line = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-01') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n01_completed_line",
            statisticType: "sum",
          };

          var total_n02_line = {
            onStatisticField: "CASE WHEN CP = 'N-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_line",
            statisticType: "sum",
          };

          var total_n02_completed_line = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-02') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n02_completed_line",
            statisticType: "sum",
          };

          var total_n03_line = {
            onStatisticField: "CASE WHEN CP = 'N-03' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_line",
            statisticType: "sum",
          };

          var total_n03_completed_line = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-03') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n03_completed_line",
            statisticType: "sum",
          };

          var total_n04_line = {
            onStatisticField: "CASE WHEN CP = 'N-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_line",
            statisticType: "sum",
          };

          var total_n04_completed_line = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-04') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n04_completed_line",
            statisticType: "sum",
          };

          var total_n05_line = {
            onStatisticField: "CASE WHEN CP = 'N-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_line",
            statisticType: "sum",
          };

          var total_n05_completed_line = {
            onStatisticField:
              "CASE WHEN (Status = 1 and CP = 'N-05') THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_n05_completed_line",
            statisticType: "sum",
          };

          // Query point
          var query_p = utilPointLayer.createQuery();
          query_p.outStatistics = [
            total_number_point,
            total_completed_point,
            total_n01_point,
            total_n01_completed_point,
            total_n02_point,
            total_n02_completed_point,
            total_n03_point,
            total_n03_completed_point,
            total_n04_point,
            total_n04_completed_point,
            total_n05_point,
            total_n05_completed_point,
          ];

          const pointCompile = utilPointLayer
            .queryFeatures(query_p)
            .then((response) => {
              stats = response.features;
              var stats = response.features[0].attributes;
              const total_point = stats.total_number_point;
              const total_comp_point = stats.total_completed_point;
              const total_n01_point = stats.total_n01_point;
              const total_n01_comp_point = stats.total_n01_completed_point;
              const total_n02_point = stats.total_n02_point;
              const total_n02_comp_point = stats.total_n02_completed_point;
              const total_n03_point = stats.total_n03_point;
              const total_n03_comp_point = stats.total_n03_completed_point;
              const total_n04_point = stats.total_n04_point;
              const total_n04_comp_point = stats.total_n04_completed_point;
              const total_n05_point = stats.total_n05_point;
              const total_n05_comp_point = stats.total_n05_completed_point;

              return [
                total_point,
                total_comp_point,
                total_n01_point,
                total_n01_comp_point,
                total_n02_point,
                total_n02_comp_point,
                total_n03_point,
                total_n03_comp_point,
                total_n04_point,
                total_n04_comp_point,
                total_n05_point,
                total_n05_comp_point,
              ];
            });

          // Query Line
          var query_l = utilLineLayer.createQuery();
          query_l.outStatistics = [
            total_number_line,
            total_completed_line,
            total_n01_line,
            total_n01_completed_line,
            total_n02_line,
            total_n02_completed_line,
            total_n03_line,
            total_n03_completed_line,
            total_n04_line,
            total_n04_completed_line,
            total_n05_line,
            total_n05_completed_line,
          ];

          const lineCompile = utilLineLayer
            .queryFeatures(query_l)
            .then((response) => {
              stats = response.features;
              var stats = response.features[0].attributes;
              const total_line = stats.total_number_line;
              const total_comp_line = stats.total_completed_line;
              const total_n01_line = stats.total_n01_line;
              const total_n01_comp_line = stats.total_n01_completed_line;
              const total_n02_line = stats.total_n02_line;
              const total_n02_comp_line = stats.total_n02_completed_line;
              const total_n03_line = stats.total_n03_line;
              const total_n03_comp_line = stats.total_n03_completed_line;
              const total_n04_line = stats.total_n04_line;
              const total_n04_comp_line = stats.total_n04_completed_line;
              const total_n05_line = stats.total_n05_line;
              const total_n05_comp_line = stats.total_n05_completed_line;

              return [
                total_line,
                total_comp_line,
                total_n01_line,
                total_n01_comp_line,
                total_n02_line,
                total_n02_comp_line,
                total_n03_line,
                total_n03_comp_line,
                total_n04_line,
                total_n04_comp_line,
                total_n05_line,
                total_n05_comp_line,
              ];
            });

          const point = await pointCompile;
          const line = await lineCompile;

          const total = point[0] + line[0];
          const total_comp = point[1] + line[1];
          const total_n01 = point[2] + line[2];
          const total_n01_comp = point[3] + line[3];
          const total_n02 = point[4] + line[4];
          const total_n02_comp = point[5] + line[5];
          const total_n03 = point[6] + line[6];
          const total_n03_comp = point[7] + line[7];
          const total_n04 = point[8] + line[8];
          const total_n04_comp = point[9] + line[9];
          const total_n05 = point[10] + line[10];
          const total_n05_comp = point[11] + line[11];

          const total_percent = (total_comp / total) * 100;
          const n01_percent = (total_n01_comp / total_n01) * 100;
          const n02_percent = (total_n02_comp / total_n02) * 100;
          const n03_percent = (total_n03_comp / total_n03) * 100;
          const n04_percent = (total_n04_comp / total_n04) * 100;
          const n05_percent = (total_n05_comp / total_n05) * 100;

          const n01_percent_total = (total_n01_comp / total) * 100;
          const n02_percent_total = (total_n02_comp / total) * 100;
          const n03_percent_total = (total_n03_comp / total) * 100;
          const n04_percent_total = (total_n04_comp / total) * 100;
          const n05_percent_total = (total_n05_comp / total) * 100;

          return [
            total,
            total_percent,
            n01_percent,
            n02_percent,
            n03_percent,
            n04_percent,
            n05_percent,
            n01_percent_total,
            n02_percent_total,
            n03_percent_total,
            n04_percent_total,
            n05_percent_total,
          ];
        }

        function utilityChart([
          total,
          total_percent,
          n01_percent,
          n02_percent,
          n03_percent,
          n04_percent,
          n05_percent,
          n01_percent_total,
          n02_percent_total,
          n03_percent_total,
          n04_percent_total,
          n05_percent_total,
        ]) {
          var totalScore = total_percent;

          var N01 = n01_percent_total;
          var N02 = n01_percent_total + n02_percent_total;
          var N03 = n01_percent_total + n02_percent_total + n03_percent_total;
          var N04 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total;
          var N05 =
            n01_percent_total +
            n02_percent_total +
            n03_percent_total +
            n04_percent_total +
            n05_percent_total;

          var chartMin = 0;
          var chartMax = 100;

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: n01_percent.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: N01,
              },
              {
                title: n02_percent.toFixed(0),
                color: color_102,
                lowScore: N01,
                highScore: N02,
              },
              {
                title: n03_percent.toFixed(0),
                color: color_103,
                lowScore: N02,
                highScore: N03,
              },
              {
                title: n04_percent.toFixed(0),
                color: color_104,
                lowScore: N03,
                highScore: N04,
              },
              {
                title: n05_percent.toFixed(0),
                color: color_105,
                lowScore: N04,
                highScore: N05,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: N05,
                highScore: 100,
              },
            ],
          };

          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "utilityPointChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "UTILITY";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">INFORMAL SETTLERS</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]COMPLETED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = totalPercentLabel_fontSize;
          label.x = am4core.percent(50);
          label.y = totalPercentLabel_y;
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";

          //label.dataItem = data;
          label.wrap = true;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          var label2 = chart.radarContainer.createChild(am4core.Label);
          label2.isMeasured = false;
          label2.fontSize = totalNumberLabel_fontSize;
          label2.horizontalCenter = "middle";
          label2.verticalCenter = "bottom";
          label2.y = totalNumberLabel_y;
          label2.text = "(" + thousands_separators(total) + ")";
          label2.fill = am4core.color("#00C3FF");

          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;
        }

        utilityTotalCount().then(utilityChart);
      }); // end am4core.ready()
    });
  </script>
</html>