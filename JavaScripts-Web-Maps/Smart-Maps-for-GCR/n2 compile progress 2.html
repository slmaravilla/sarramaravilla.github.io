<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>N2 Work Progress</title>

    <!-- https://www.esri.com/arcgis-blog/products/arcgis-living-atlas/public-safety/wildfire-aware-app-design-and-implementation/-->

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <!-- Resources -->
    <script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.144.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <script src="https://js.arcgis.com/4.28/"></script>
    <script src="js/animepoint.js"></script>

</head>
<style>
    html,
    body,
    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    body {
        display: flex;
    }

    #container {
        display: grid;
        flex-wrap: wrap;
        box-sizing: border-box;
        grid-template-columns: 1fr 0.25fr;
        width: 100%;
        height: 100%;
    }



    calcite-list {
        overflow-y: auto;
    }


    calcite-tab {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    calcite-loader {
        align-self: center;
        justify-self: center;
    }

    /* Header */
    #header {
        display: flex;
        padding: 0 1rem;
        width: 100%;
    }

    #header-title {
        color: white;
        margin-left: 1rem;
        font-size: 2.6vh;
        margin-top: auto;
        margin-bottom: auto;
    }

    #dateDiv {
        color: gray;
        font-size: 0.8rem;
        width: 150px;
        height: 20px;
        margin-top: auto;
        margin-left: 2rem;
    }

    #contractPackageDiv {
        margin-top: 10px;
        margin-bottom: auto;
        margin-left: auto;
        margin-right: 2rem;

    }

    calcite-segmented-control {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: 10px;
    }

    calcite-button {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: auto;
    }

    #info-content {
        padding: 0.75rem;
        overflow-y: auto;
    }

    calcite-rating {
        margin-top: 0.25rem;
    }

    

    #header-controls {
        display: flex;
        margin-inline-start: auto;
        align-self: center;
    }

    .label-wrapper {
        display: flex;
        margin-inline: 1rem;
        padding: 0.5rem;
        border: 1px solid var(--calcite-ui-border-1);
        cursor: pointer;
    }

    /* CHART AND CONTENT PANEL */
    #chartPanel {
        background-color: rgb(0, 0, 0, 0);
        padding: 8;
        width: 100%;
        height: 100%;
    }

    #landPieChartDiv,
    #structurePieChartDiv,
    #nloPieChartDiv,
    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
        height: 45%;
        margin-bottom: 5;
    }

    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
        height: 40%;
        margin-bottom: 5;
    }


    .lotNumber-container,
    .structureNumber-container,
    .nloNumber-container,
    .pteLot-container,
    .pteStructure-container,
    .treeNumber-container,
    .utilityNumber-container,
    .viaductNumber-container {
        display: flex;
    }

    #lotNumberDiv,
    #structureNumberDiv,
    #nloNumberDiv,
    #pteLotNumberDiv,
    #pteStructureNumberDiv,
    #treeNumberDiv,
    #utilityNumberDiv,
    #viaductNumberDiv {
        width: 50%;
        height: 10%;
        padding-top: 2%;
        padding-left: 15px;
        font-size: 1vw;
        color: #f7f5f7;
    }

    #pteLotNumberDiv b,
    #pteStructureNumberDiv b {
        font-size: 2vw;
        font-family: 'Calibri';
        font-weight: bold;
        color: #6ede00;
        /*#d4ff33;*/
        margin: auto;
    }

    #landImage,
    #landNumberImage,
    #nloNumberImage,
    #structureImage,
    #structureNumberImage,
    #treeNumberImage,
    #utilityNumberImage {
        width: 17.5%;
        height: auto;
        margin-left: auto;
        margin-right: auto;
        margin-top: 0;
        margin-bottom: -10;
    }

    #viaductNumberImage {
        width: 17%;
        height: 17%;
        margin-left: auto;
        margin-right: auto;
        margin-top: 5;
        margin-bottom: -30;
    }

    #lotNumberDiv b,
    #nloNumberDiv b,
    #structureNumberDiv b,
    #treeNumberDiv b,
    #utilityNumberDiv b,
    #viaductNumberDiv b {
        font-size: 2.5vw;
        font-family: 'Calibri';
        font-weight: bold;
        color: #6ede00;
        /*#d4ff33;*/
        margin: auto;
    }

    #chartMoaLotDiv,
    #chartMoaStructureDiv {
        width: 100%;
        height: 30%;
        align-items: center;
        padding: 1%;
        margin-top: 5%;
    }

    #utilityPointChartDiv,
    #utilityLineChartDiv {
        padding-left: 12px;
        align-items: center;
        width: 91%;
        height: 38%;
        font-size: 1vw;
        color: #f7f5f7;
    }

    #viaductChartDiv {
        padding-left: 12px;
        align-items: center;
        width: 91%;
        height: 50%;
        font-size: 1vw;
        color: #f7f5f7;
    }

    #timeSeriesChartViaduct,
    #timeSeriesChartLand {
        position: absolute;
        z-index: 1;
        height: 40vh;
        width: 60vw;
        bottom: 20%;
        left: 8vw;
        background-color: rgb(37, 37, 37);
    }

    /* See Through Label */
    #see-through-label,
    #viaduct-checkbox,
    #land-checkbox {
        padding: 10;
    }

    b {
        color: orange;
    }

    /* TRAIN ANIMATION BUTTON */
    .overlay {
        position: fixed;
        z-index: 1;
        width: 2%;
        bottom: 0;
        right: 7;
        background-color: rgba(80, 80, 80, 0);
        padding: 0;
        /*text-align: center;*/
    }

    .button {
        cursor: pointer;
        font-size: 1vw !important;
        font-weight: bold !important;
        color: rgb(230, 230, 230);
        padding: 0;
    }

    .button:hover,
    #label {
        color: white;
    }

    .button,
    #label {
        margin: 15px;
    }

    /* SCROLL BAR */
    /* ESRI POPUP */

    ::-webkit-scrollbar {
        width: 5px;

    }

    /* Track */
    ::-webkit-scrollbar-track {
        background: #00032235;
        /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
        background: #FFBA1F;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
        background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
    }

    /*
    .esri-legend__layer-cell--info {
      background-color: black;
      color: white;
      font-size: 0.85vw;
    }
    */

    .esri-legend {
        overflow: hidden;
        overflow-y: auto;
        margin-left: -10;
    }



    #image {
        width: 50px;
        height: 50px;
    }

    /*
    .esri-legend__layer-cell {
      min-width: 100px;
      word-break: break-word;
      padding: 0;
      vertical-align: middle;
      margin: 0;
    }
    */

    #measurementToolMenu {
        padding: 0.8em;
        max-width: 180px;
        width: 250px;
    }

    #measurementToolLabel {
        color: white;
    }

    #sliceContainer {
        width: inherit;
    }

    #sliceOptions {
        margin: 0 15px;
    }

    #sliceOptions>button {
        margin-bottom: 15px;
    }

    #sliceContainer {
        max-width: 228px;
    }

    .esri-icon-non-visible::before {
        content: "\e610" !important;
        color: #969696 !important;
    }

    .esri-icon-visible::before {
        content: "\e611" !important;
        background-color: #11a7fd;
        color: white !important;
    }

    #urgentLots-segmented-control {
        margin-bottom: 20px;   
    }

    #logo {
        margin-bottom: "auto";
        margin-top: "auto";
    }
</style>

<body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
        <!--  Header slot  -->
        <header slot="header" id="header">
            <img id="logo" src="https://EijiGorilla.github.io/Symbols/Projec_Logo/DOTr_Logo_v2.png" alt="DOTr Logo" style="height:2.9%;width:2.9%"/>

            <!-- Title -->
            <b id="header-title">N2 WORK PROGRESS</b>
            <div id="dateDiv">As of December 4, 2023</div>

            <!-- Dropdown Lists -->
            <div id="contractPackageDiv">
                <calcite-segmented-control>
                    <calcite-segmented-control-item id="All" value="all" checked>All</calcite-segmented-control-item>
                    <calcite-segmented-control-item id="N-01" value="n-01">N-01</calcite-segmented-control-item>
                    <calcite-segmented-control-item id="N-02" value="n-02">N-02</calcite-segmented-control-item>
                    <calcite-segmented-control-item id="N-03" value="n-03">N-03</calcite-segmented-control-item>
                    <calcite-segmented-control-item id="N-04" value="n-04">N-04</calcite-segmented-control-item>
                    <calcite-segmented-control-item id="N-05" value="n-05">N-05</calcite-segmented-control-item>
                </calcite-segmented-control>
            </div>
            <img id="logo" src="https://EijiGorilla.github.io/Symbols/Projec_Logo/GCR LOGO.png" alt="GCR Logo" style="height:4.4%;width:4.4%"/>
        </header>

        <!-- Icon -->
        <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
        <calcite-shell-panel slot="panel-start" display-mode="float" detached>
            <calcite-action-bar slot="action-bar">
                <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
                <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
                <calcite-action data-action-id="seethrough" icon="transparency" text="Underground"></calcite-action>
                <calcite-action data-action-id="urgent" icon="selection" text="Super Urgent Lots"></calcite-action>
                <calcite-action data-action-id="charts" icon="graph-time-series" text="Progress Chart"></calcite-action>
                <calcite-action data-action-id="smartmaps" icon="collection" text="Smart Map Link"></calcite-action>
                <calcite-action data-action-id="animation" icon="play" text="Animation"></calcite-action>
                <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>

            <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
            <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
                <div id="layers-container"></div>
            </calcite-panel>
            <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
                <div id="basemaps-container"></div>
            </calcite-panel>
            <calcite-panel heading="View Underground" height-scale="l" data-panel-id="seethrough" hidden>
                <calcite-label layout="inline" id="see-through-label">
                    <calcite-checkbox id="myLink"></calcite-checkbox> Ground color becomes transparent
                </calcite-label>
            </calcite-panel>

            <!--Panel for super urgent lots button-->
            <calcite-panel heading="View Super Urgent Lots" height-scale="1" data-panel-id="urgent" hidden>
                <div id="viewUrgentLots">
                    <calcite-segmented-control id="urgentLots-segmented-control">
                        <calcite-segmented-control-item id="urgentLots-on"
                            value="urgentLotson">ON</calcite-segmented-control-item>
                        <calcite-segmented-control-item id="urgentLots-off" value="urgentLotsoff"
                            checked>OFF</calcite-segmented-control-item>
                    </calcite-segmented-control>
                </div>
            </calcite-panel>

            <calcite-panel class="timeSeries-panel" heading="Progress Chart" height-scale="l" data-panel-id="charts"
                hidden>
                <calcite-label layout="inline" id="viaduct-timeSeries-label">
                    <calcite-checkbox id="viaduct-checkbox"></calcite-checkbox>Viaduct
                </calcite-label>
                <calcite-label layout="inline" id="land-timeSeries-label">
                    <calcite-checkbox id="land-checkbox"></calcite-checkbox>Handed-Over Lot
                </calcite-label>
            </calcite-panel>

            <calcite-panel heading="Links to Individual Smart Maps" height-scale="l" data-panel-id="smartmaps" hidden>
                <calcite-list>
                    <calcite-list-item label="Land Acqusition" description="Structure/NLO included">
                        <calcite-link slot="actions-start"
                            href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html"
                            icon-start="launch" target="_blank">
                        </calcite-link>
                    </calcite-list-item>
                    <calcite-list-item label="Tree Cutting/Compensation"
                        description="Tree conservation status included">
                        <calcite-link slot="actions-start"
                            href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Tree_Cutting/index2.html"
                            icon-start="launch" target="_blank">
                        </calcite-link>
                    </calcite-list-item>
                    <calcite-list-item label="Utility Relocation" description="Major utility companies included">
                        <calcite-link slot="actions-start"
                            href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Utility_Relocation/index.html"
                            icon-start="launch" target="_blank">
                        </calcite-link>
                    </calcite-list-item>
                    <calcite-list-item label="Viaduct" description="Construction progress on main viaduct">
                        <calcite-link slot="actions-start"
                            href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Viaduct/index2.html"
                            icon-start="launch" target="_blank">
                        </calcite-link>
                    </calcite-list-item>
                </calcite-list>
            </calcite-panel>

            <calcite-panel class="animation-panel" height-scale="l" data-panel-id="animation" hidden></calcite-panel>

            <!-- Info panel (populates with info from the web map) -->
            <calcite-panel heading="Description" data-panel-id="information" hidden>
                <div id="info-content">
                    <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                    <div id="item-description">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </calcite-panel>
        </calcite-shell-panel>

        <div id="container">
            <div id="timeSeriesChartViaduct" hidden></div>
            <div id="timeSeriesChartLand" hidden></div>
            <div id="viewDiv">
                <div id="measurementToolMenu" class="esri-widget">
                    <calcite-label>
                        <div id="measurementToolLabel">
                            Click one of the buttons below to open the corresponding analysis widget and interact with
                            the analysis.
                        </div>
                    </calcite-label>
                    <calcite-button id="directLineMeasurementAnalysisButton" icon-start="measure-line"
                        title="Interact with direct line measurement">
                    </calcite-button>
                    <calcite-button id="areaMeasurementAnalysisButton" icon-start="measure-area"
                        title="Interact with area measurement">
                    </calcite-button>
                    <calcite-button id="sliceAnalysisButton" icon-start="slice" title="Interact with slice plane">
                    </calcite-button>
                    <calcite-button id="lineOfSightAnalysisButton" icon-start="line-of-sight"
                        title="Interact with line of sight analysis">
                    </calcite-button>
                    <calcite-label></calcite-label>
                    <calcite-button id="removeWidgetButton" title="Remove Widget"
                        style="display: none; width: 140px">Remove Widget
                    </calcite-button>
                </div>
            </div>
            <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
            <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
            <calcite-tabs>
                <div id="chartPanel">
                    <calcite-tab-nav slot="tab-nav" id="thetabs">
                        <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                        <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                        <calcite-tab-title class="ISF">NLO</calcite-tab-title>
                        <calcite-tab-title class="Trees">Tree</calcite-tab-title>
                        <calcite-tab-title class="Utility">Utility</calcite-tab-title>
                        <calcite-tab-title class="Viaduct">Viaduct</calcite-tab-title>
                    </calcite-tab-nav>
                    <calcite-tab>
                        <div class="lotNumber-container">
                            <div id="lotNumberDiv"></div>
                            <img id="landNumberImage" src="https://EijiGorilla.github.io/Symbols/Land_logo.png">
                        </div>
                        <div class="box" id="landPieChartDiv"></div>
                        <div class="pteLot-container">
                            <div id="pteLotNumberDiv"></div>
                            <img id="landImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
                        </div>
                        <div id="chartMoaLotDiv"></div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="structureNumber-container">
                            <div id="structureNumberDiv"></div>
                            <img id="structureNumberImage" src="https://EijiGorilla.github.io/Symbols/House_Logo.svg">
                        </div>
                        <div class="box2" id="structurePieChartDiv"></div>
                        <div class="pteStructure-container">
                            <div id="pteStructureNumberDiv"></div>
                            <img id="structureImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
                        </div>
                        <div id="chartMoaStructureDiv"></div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="nloNumber-container">
                            <div id="nloNumberDiv"></div>
                            <img id="nloNumberImage" src="https://EijiGorilla.github.io/Symbols/NLO_Logo.svg">
                        </div>
                        <div class="box3" id="nloPieChartDiv"></div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="treeNumber-container">
                            <div id="treeNumberDiv"></div>
                            <img id="treeNumberImage" src="https://EijiGorilla.github.io/Symbols/Tree_Logo.svg">
                        </div>
                        <div class="box4" id="treeCuttingPieChartDiv"></div>
                        <div class="box5" id="treeCompensationPieChartDiv"></div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="utilityNumber-container">
                            <div id="utilityNumberDiv"></div>
                            <img id="utilityNumberImage" src="https://EijiGorilla.github.io/Symbols/Utility_Logo.png">
                        </div>
                        <div class="box6" id="utilityPointChartDiv">UTILITY POINT</div>
                        <div class="box7" id="utilityLineChartDiv">UTILITY LINE</div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="viaductNumber-container">
                            <div id="viaductNumberDiv"></div>
                            <img id="viaductNumberImage"
                                src="https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_All_Logo.svg">
                        </div>
                        <div class="box8" id="viaductChartDiv"></div>
                    </calcite-tab>
                    <calcite-tab>
                        <div class="panel-side esri-widget">
                            <ul id="expropriationListDiv">
                                <li>Loading&hellip;</li>
                            </ul>
                        </div>
                    </calcite-tab>
            </calcite-tabs>
        </div>
    </calcite-shell>
</body>
<script>
    require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/views/SceneView",
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/layers/SceneLayer",
        "esri/widgets/Bookmarks",
        "esri/widgets/BasemapGallery",
        "esri/widgets/LayerList",
        "esri/widgets/Legend",
        "esri/rest/support/Query",
        "esri/widgets/Fullscreen",
        "esri/layers/support/FeatureFilter",
        "esri/widgets/TableList",
        "esri/portal/PortalItem",
        "esri/portal/Portal",
        "esri/rest/geometryService",
        "esri/rest/support/StatisticDefinition",
        "esri/symbols/WebStyleSymbol",
        "esri/widgets/Expand",
        "esri/renderers/UniqueValueRenderer",
        "esri/Ground",
        "esri/rest/support/RelationshipQuery",
        "esri/layers/GraphicsLayer",
        "esri/widgets/Search",
        "esri/widgets/Locate",
        "esri/widgets/BasemapToggle",
        "esri/PopupTemplate",
        "esri/layers/support/LabelClass",
        "esri/popup/content/CustomContent",
        "esri/layers/TileLayer",
        "esri/core/reactiveUtils",
        "esri/popup/support/FieldInfoFormat",
        "esri/geometry/geometryEngine",
        "esri/rest/route",
        "esri/rest/support/RouteParameters",
        "esri/core/Accessor",
        "esri/Graphic",
        "esri/geometry/Point",
        "esri/geometry/Polyline",
        "esri/views/3d/externalRenderers",
        "esri/rest/support/FeatureSet",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/SimpleLineSymbol",
        "esri/geometry/SpatialReference",
        "esri/layers/BuildingSceneLayer",
        "esri/analysis/DirectLineMeasurementAnalysis",
        "esri/widgets/DirectLineMeasurement3D",
        "esri/analysis/AreaMeasurementAnalysis",
        "esri/widgets/AreaMeasurement3D",
        "esri/analysis/SliceAnalysis",
        "esri/widgets/Slice",
        "esri/analysis/LineOfSightAnalysis",
        "esri/widgets/LineOfSight",
        "esri/geometry/Polygon",
        "esri/layers/GroupLayer",
    ], function (WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend,
        Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
        StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
        RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
        LabelClass, CustomContent, TileLayer, reactiveUtils,
        FieldInfoFormat, geometryEngine, route, RouteParameters, Accessor, Graphic,
        Point, Polyline, externalRenderers, FeatureSet, SimpleMarkerSymbol, SimpleLineSymbol,
        SpatialReference, BuildingSceneLayer,
        DirectLineMeasurementAnalysis, DirectLineMeasurement3D,
        AreaMeasurementAnalysis, AreaMeasurement3D, SliceAnalysis, Slice,
        LineOfSightAnalysis, LineOfSight, Polygon, GroupLayer
    ) {



        // Reference link
        // 2D to 3D
        //https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/

        // 3D Extrusion using point, line, and polygon
        // https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/3d-visualization-working-with-objects-paths-and-extrusion/?rmedium=redirect&rsource=blogs.esri.com/esri/arcgis/2016/01/25/3d-visualization-working-with-objects-paths-and-extrusion


        var map = new Map({
            basemap: "satellite",//"dark-gray-vector", // "streets-night-vector", basemap
            ground: "world-elevation",
        });

        var view = new SceneView({
            map: map,
            center: [120.57930, 15.18],
            zoom: 12,
            viewingMode: "local",
            container: "viewDiv",
            camera: {
                position: {
                    x: 120.75200,
                    y: 14.90,
                    z: 2500
                },
                tilt: 65
            },
            environment: {
                background: {
                    type: "color", // autocasts as new ColorBackground()
                    color: [0, 0, 0, 1]
                },
                starsEnabled: false,

            }
        });

        view.ui.components = [];

        const basemaps = new BasemapGallery({
            view,
            container: "basemaps-container"
        });


        // TRAIN ANIMATION //
        ////// Train Animation using externalRenderers
        // Route Layer for animatioin
        // The stops and route result will be stored in this layer
        var routeLyr = new GraphicsLayer();

        // Setup the route parameters
        var routeParams = new RouteParameters({
            stops: new FeatureSet(),
            outSpatialReference: { // autocasts as new SpatialReference()
                wkid: 3857
            }
        });

        // Define the symbology used to display the stops
        var stopSymbol = new SimpleMarkerSymbol({
            style: "cross",
            size: 0, // 15
            outline: { // autocasts as new SimpleLineSymbol()
                width: 0 // 4
            }
        });

        // Define the symbology used to display the route
        var routeSymbol = new SimpleLineSymbol({
            color: [0, 0, 255, 0], // [0, 0, 255, 0.5]
            width: 5
        });

        // Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
        //on(view, "click", addStop);
        /*
        view.on("click", function() {
          addStop();
  
      });
      */

        function addStop(event) {

            // Add a point at the location of the map click
            //var stop = new Graphic({
            //    geometry: event.mapPoint,
            //    symbol: stopSymbol
            //});

            var stop1 = new Graphic({
                geometry: new Point({ x: 13422812.716400001, y: 1710317.0639999993, z: 115.65110000000277, spatialReference: SpatialReference.WebMercator }),
                symbol: stopSymbol
            });
            routeLyr.add(stop1);

            var stop2 = new Graphic({
                geometry: new Point({ x: 13422004.020599999, y: 1713789.0846000016, z: 105.54970000000321, spatialReference: SpatialReference.WebMercator }),
                symbol: stopSymbol
            });
            routeLyr.add(stop2);

            routeParams.stops.features.push(stop1);
            routeParams.stops.features.push(stop2);

            // Execute the route task if 2 or more stops are input
            //routeParams.stops.features.push(stop);
            if (routeParams.stops.features.length >= 2) {
                //routeTask.solve(routeParams).then(showRoute);
                showRoute();
            }
        }

        // Adds the solved route to the map as a graphic
        function showRoute(data) {

            //var routeResult = data.routeResults[0].route;

            var polyline = new Polyline(polylinePoints);
            polyline.spatialReference = SpatialReference.WebMercator;

            var routeResult = new Graphic({
                geometry: polyline,
                symbol: routeSymbol
            });
            routeResult.symbol = routeSymbol;

            routeLyr.add(routeResult);

            // the speed of the object becomes low with maximum segment of length
            var pl = geometryEngine.densify(routeResult.geometry, 0.5, "meters");
            // register the external renderer
            const myExternalRenderer = new skeletonRenderer(view, pl);
            externalRenderers.add(view, myExternalRenderer);

        }
        // Disable lighting based on the current camera position.
        // We want to display the lighting according to the current time of day.
        //view.environment.lighting.cameraTrackingEnabled = false;

        // Create our custom external renderer
        //////////////////////////////////////////////////////////////////////////////////////
        //https://github.nicogis.it/externalRendererSkeleton/
        var skeletonRenderer = Accessor.createSubclass({ // if '|| {}' is not added beside null,
            // you will receive the following error 'Cannot destructure property of xx of 'null' as it is null'
            view: null,
            //pl: null,
            renderer: null,     // three.js renderer
            camera: null,       // three.js camera
            scene: null,        // three.js scene
            vertexIdx: 0,
            ambient: null,      // three.js ambient light source
            sun: null,          // three.js sun light source
            mixer: null,
            mixer2: null,
            clock: null,
            clips: null,
            animate: null,
            light: null,
            iss: null,
            iss2: null,                                                   // ISS model
            issScale: 3,                                     // scale for the iss model
            issScale2: 10,
            path: null,
            count: null,
            up: null,
            timeDelta: null,
            markerMaterial: null,    // material for the markers left by the ISS
            markerGeometry: null,    // geometry for the markers left by the ISS
            //issMaterial: new THREE.MeshLambertMaterial({ color: 0x2194ce, transparent: true, opacity: 0.1 }), 

            cameraPositionInitialized: false, // we focus the view on the ISS once we receive our first data point
            positionHistory: [],

            constructor: function (view, pl) {
                this.view = view;
                this.path = pl.paths[0]; //pl.paths[0];
            },
            /**
             * Setup function, called once by the ArcGIS JS API.
             */
            setup: function (context) {

                // initialize the three.js renderer
                /////////////////////////////////////////////////////////////////////////////////////
                this.renderer = new THREE.WebGLRenderer({
                    context: context.gl,
                    premultipliedAlpha: false
                });
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(context.camera.fullWidth, context.camera.fullHeight);
                this.renderer.setViewport(0, 0, view.width, view.height);

                // prevent three.js from clearing the buffers provided by the ArcGIS JS API.
                this.renderer.autoClearDepth = false;
                this.renderer.autoClearStencil = false;
                this.renderer.autoClearColor = false;

                // The ArcGIS JS API renders to custom offscreen buffers, and not to the default framebuffers.
                // We have to inject this bit of code into the three.js runtime in order for it to bind those
                // buffers instead of the default ones.
                var originalSetRenderTarget = this.renderer.setRenderTarget.bind(this.renderer);
                this.renderer.setRenderTarget = function (target) {
                    originalSetRenderTarget(target);
                    if (target == null) {
                        context.bindRenderTarget();
                    }
                }

                // setup the three.js scene
                //////////////////////////////////////////////////////////////////////////////////////         
                this.scene = new THREE.Scene();

                // setup the camera
                this.camera = new THREE.PerspectiveCamera();

                // setup scene lighting
                this.ambient = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(this.ambient);
                this.sun = new THREE.DirectionalLight(0xffffff, 0.5);
                this.scene.add(this.sun);

                // setup markers
                this.markerGeometry = new THREE.SphereBufferGeometry(12 * 1000, 16, 16);
                this.markerMaterial = new THREE.MeshBasicMaterial({ color: 0xe03110, transparent: true, opacity: 0.5 });

                this.clock = new THREE.Clock();

                var issMeshUrl = "https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Locomotive_rev.glb";
                var loaderGLTF = new THREE.GLTFLoader(); // check this: https://qgenhate.hatenablog.com/ [object not an instance of THREE.Object3D]
                let example = new THREE.Object3D();

                loaderGLTF.load(issMeshUrl,
                    function (gltf) {
                        console.log("ISS mesh loaded.");

                        example = gltf.scene;
                        this.iss = example;

                        // set the specified scale for the model
                        this.iss.scale.set(this.issScale, this.issScale, this.issScale);

                        // add the model
                        this.scene.add(this.iss); // original: this.iss
                        console.log("ISS mesh added.");

                        // Mixer for animation
                        this.mixer = new THREE.AnimationMixer(this.iss);
                        this.mixer.clipAction(gltf.animations[0]).play();

                    }.bind(this), undefined, function (error) {
                        console.error("Error loading ISS mesh. ", error);
                    });

                this.light = new THREE.DirectionalLight(0xffffff, 1);
                this.light.position.set(0, 1, 0);
                this.scene.add(this.light);

                // rotation 
                this.up = new THREE.Vector3(0, 0, 1); // used with lookAt: look at the next point at x-axis
                this.axis = new THREE.Vector3();
                this.n = new THREE.Vector3(); // normal,
                this.b = new THREE.Vector3(); // binormal
                this.M3 = new THREE.Matrix3();
                this.M4 = new THREE.Matrix4();
                this.pp = new THREE.Vector3();
                this.quaternion = new THREE.Quaternion();

                // cleanup after ourselfs
                context.resetWebGLState();
            },
            render: function (context) {

                // update camera parameters
                ///////////////////////////////////////////////////////////////////////////////////
                var cam = context.camera;

                this.camera.position.set(cam.eye[0], cam.eye[1], cam.eye[2]);
                this.camera.up.set(cam.up[0], cam.up[1], cam.up[2]);
                this.camera.lookAt(new THREE.Vector3(cam.center[0], cam.center[1], cam.center[2]));

                // Projection matrix can be copied directly
                this.camera.projectionMatrix.fromArray(cam.projectionMatrix);

                if (this.iss) {

                    // Add this.mixer.update first; otherwise, the object will not be animated.s
                    if (this.mixer) {
                        var scale = 0.0001; //this.gui.getTimeScale();
                        var delta = this.clock.getDelta();

                        this.mixer.update(delta);
                    }

                    if (this.path.length == (this.vertexIdx + 1)) {
                        this.vertexIdx = 0;
                    }

                    var p = this.path[this.vertexIdx]; // vertexIdx = 0
                    var p1 = this.path[this.vertexIdx + 1];


                    // Define Z:
                    // It is important that the same Z values are set for both current (pt) and next points (pt1)
                    // Otherwise, the object will be tilted.
                    const changeZ = 0;
                    const offset = 0;
                    const offsetZ = 0;

                    var pt = new Point({
                        x: p[0] + offset, // longitude
                        y: p[1], // latitude
                        z: p[2] + offsetZ
                    });

                    pt.spatialReference = SpatialReference.WebMercator;

                    //z = offsetZ; // view.basemapTerrain.getElevation(p);

                    pos = [pt.x, pt.y, pt.z];

                    this.vertexIdx++;

                    if (this.path.length == (this.vertexIdx)) {
                        this.vertexIdx--;
                    }

                    var transform = new THREE.Matrix4();
                    transform.fromArray(externalRenderers.renderCoordinateTransformAt(view, pos, SpatialReference.WebMercator, new Array(16)));

                    this.iss.position.set(transform.elements[12], transform.elements[13], transform.elements[14]);

                    this.count++;
                    if (this.count === 1) {
                        console.log(transform.elements[12], transform.elements[13], transform.elements[14]);
                    }

                    var p0;
                    var p1;

                    if ((this.path.length - 1) == (this.vertexIdx)) {
                        p0 = this.path[--this.vertexIdx];
                        p1 = this.path[this.vertexIdx];
                    }
                    else {
                        p0 = this.path[this.vertexIdx];
                        p1 = this.path[++this.vertexIdx];
                    }

                    var rotation = new THREE.Matrix4();

                    var pt1 = new Point({
                        x: p1[0] + offset, // longitude
                        y: p1[1], // latitude
                        z: p1[2] + offsetZ
                    });
                    posR = [pt1.x, pt1.y, pt1.z];
                    rotation.fromArray(externalRenderers.renderCoordinateTransformAt(view, posR, SpatialReference.WebMercator, new Array(16)));
                    // https://answers.unity.com/questions/36255/lookat-to-only-rotate-on-y-axis-how.html
                    // how to use '.up' with lookAt?
                    //geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( Math.PI / 2 ) );
                    this.iss.up = this.up;

                    this.iss.lookAt(rotation.elements[12], rotation.elements[13], rotation.elements[14]);
                }


                // update lighting
                /////////////////////////////////////////////////////////////////////////////////////////////////////
                //view.environment.lighting.date = Date.now();

                var l = context.sunLight;
                this.sun.position.set(
                    l.direction[0],
                    l.direction[1],
                    l.direction[2]
                );
                this.sun.intensity = l.diffuse.intensity;
                this.sun.color = new THREE.Color(l.diffuse.color[0], l.diffuse.color[1], l.diffuse.color[2]);

                this.ambient.intensity = l.ambient.intensity;
                this.ambient.color = new THREE.Color(l.ambient.color[0], l.ambient.color[1], l.ambient.color[2]);

                // draw the scene
                /////////////////////////////////////////////////////////////////////////////////////////////////////
                this.renderer.resetState();
                context.bindRenderTarget();
                this.renderer.render(this.scene, this.camera);
                externalRenderers.requestRender(view);

                // cleanup
                context.resetWebGLState();
            },
        })
        externalRenderers.add(view, skeletonRenderer);
        // End of externalRenderers

        /// Camera animation
        const camera = view.camera.clone();

        const pt1 = { x: 120.58066534, y: 15.18190446, z: 193.6964 };
        const pt2 = { x: 120.57976213, y: 15.1870787, z: 128.02725 };
        const pt3 = { x: 120.57975569, y: 15.19070198, z: 138.165 };
        const pt4 = { x: 120.57831507, y: 15.19802226, z: 183.82172 };
        const pt5 = { x: 120.57478353, y: 15.20799639, z: 145.15981 };
        const pt6 = { x: 120.57369966, y: 15.21207364, z: 138.33217 };

        const comp_pts = [pt1, pt2, pt3, pt4, pt5, pt6];
        const heading_pts = [331.62, 334.31, 336.19, 323.47, 311.74, 289.63];
        const tilt_pts = [72.29, 81.91, 78.58, 72.66, 72.48, 73.59];

        let abort = false;
        async function startAnimation(slideNo) {
            if (!view.interacting && !abort) {

                if (slideNo < comp_pts.length) {
                    if (slideNo === 0) {
                        camera.heading = heading_pts[slideNo];
                        camera.tilt = tilt_pts[slideNo];
                    } else {
                        camera.heading = heading_pts[slideNo];
                    }
                    camera.tilt = tilt_pts[slideNo];
                    camera.position = comp_pts[slideNo];

                    await view.goTo(camera, { animate: true, speedFactor: 0.265, easing: "linear" });
                    //requestAnimationFrame(startAnimation);
                    window.setTimeout(function () {
                        startAnimation(slideNo + 1);
                    }, 0);
                }
            } else {
                abort = true;
            }
        }

        // Initialization

        async function initialization() {
            abort = false;

            viaductLayer.visible = true;
            viaductLayer.renderer = viaductForAnimationRenderer;
            viaductLayer.definitionExpression = "CP = 'N-04'";
            map.basemap = "satellite";
            lotLayer.visible = false;
            structureLayer.visible = false;
            nloLayer.visible = false;
            pierAccessLayer.visible = false;
            utilityPointLayer.visible = false;
            utilityPointLayer1.visible = false;
            utilityLineLayer.visible = false;
            utilityLineLayer1.visible = false;
            pnrLayer.visible = false;

            addStop();
            await startAnimation(0);
            /*
              window.setTimeout(function() {
                  startAnimation(0);
              }, 1)
              */
        }
        // TRAIN ANIMATION END //



        // Default Renderer for Polygon------------
        let defaultLotSymbolBoundary = {
            type: "simple-fill",
            color: [0, 0, 0, 0],
            style: "solid",
            outline: {
                style: "short-dash",
                color: [215, 215, 158],
                width: 1.5
            }
        };

        let defaultSymbol = {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0, 0, 0, 0],
            style: "solid",
            outline: {  // autocasts as new SimpleLineSymbol()
                color: [110, 110, 110],
                width: 0.7
            }
        };

        // ROW //
        var prowLayer = new FeatureLayer({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 1,
            title: "PROW",
            popupEnabled: false
        });
        prowLayer.listMode = "hide";

        //------------- Layer ----------------------------- /
        // Lot Layer----------------------------------
        function colorLotReqs() {
            return {
                0: [0, 197, 255],
                1: [112, 173, 71],
                2: [0, 112, 255],
                3: [255, 255, 0],
                4: [255, 170, 0],
                5: [255, 0, 0],
                6: [0, 0, 0, 0]
            }
        }

        let lotLayerRenderer = {
            type: "unique-value",
            defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
            valueExpression: "When($feature.StatusLA == 0, '0',$feature.StatusLA == 1, '1', $feature.StatusLA == 2, '2', \
                               $feature.StatusLA == 3, '3', $feature.StatusLA == 4, '4', \
                               $feature.StatusLA == 5, '5', $feature.StatusLA)",
            uniqueValueInfos: [
                {
                    value: "0",
                    label: "Handed-Over",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[0],
                    }
                },
                {
                    value: "1",
                    label: "Paid",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[1],
                    }
                },
                {
                    value: "2",
                    label: "For Payment Processing",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[2],
                    }
                },
                {
                    value: "3",
                    label: "For Legal Pass",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[3],
                    }
                },
                {
                    value: "4",
                    label: "For Appraisal/Offer to Buy",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[4],
                    }
                },
                {
                    value: "5",
                    label: "For Expro",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[5],
                    }
                }
            ]
        }

        var lotIdLabel = new LabelClass({
            labelExpressionInfo: { expression: "$feature.LotID" },
            symbol: {
                type: "text",
                color: "black",
                haloColor: "white",
                haloSize: 0.5,
                font: {
                    size: 11,
                    weight: "bold"
                }
            }
        });

        var lotLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 7,
            renderer: lotLayerRenderer,
            labelingInfo: [lotIdLabel],
            outFields: ["*"],
            title: "Land Acquisition",
            minScale: 150000,
            maxScale: 0,
            //labelsVisible: false,
            elevationInfo: {
                model: "on-the-ground"
            }
        });

        /// Popup for lot layer
        const lotStatusArray = [
            "Handed-Over",
            "Paid",
            "For Payment Processing",
            "For Legal Pass",
            "For Appraisal/Offer to Buy",
            "For Expro"
        ];

        const landUseArray = [
            "Agricultural",
            "Agricultural & Commercial",
            "Agricultural / Residential",
            "Commercial",
            "Industrial",
            "Irrigation",
            "Residential",
            "Road",
            "Road Lot",
            "Special Exempt"
        ]

        let customContentLot = new CustomContent({
            outFields: ["*"],
            creator: function (event) {

                // Extract AsscessDate of clicked pierAccessLayer
                const lotNo = event.graphic.attributes.LotID;
                const handOverDate = event.graphic.attributes.HandOverDate;
                const handOverArea = event.graphic.attributes.percentHandedOver;
                const statusLot = event.graphic.attributes.StatusLA;
                const landUse = event.graphic.attributes.LandUse;
                const municipal = event.graphic.attributes.Municipality;
                const barangay = event.graphic.attributes.Barangay;
                const landOwner = event.graphic.attributes.LandOwner;
                const cpNo = event.graphic.attributes.CP;

                // Convert numeric to date format

                var date = new Date(handOverDate);
                var DATES = dateFormat(date, 'MM-dd-yyyy');

                if (DATES === '01-01-1970') {
                    var finalDate = "Undefined"
                } else {
                    var finalDate = dateFormat(date, 'MM-dd-yyyy');
                }
                // Convert domain code to domain name
                /// 1. Status
                if (statusLot >= 0) {
                    //headerTitleDiv.innerHTML = lotStatusArray[statusLot];
                    var statusLotTemp = lotStatusArray[statusLot];
                }

                if (landUse >= 1) {
                    var landUseTemp = landUseArray[landUse - 1];
                }

                return `<ul><li>Handed-Over Area: <b>${handOverArea} %</b></li><br>
                    <li>Status:           <b>${statusLotTemp}</b></li><br>
                    <li>Land Use:         <b>${landUseTemp}</b></li><br>
                    <li>Municipality:     <b>${municipal}</b></li><br>
                    <li>Barangay:         <b>${barangay}</b></li><br>
                    <li>Land Owner:       <b>${landOwner}</b>
                    <li>CP:               <b>${cpNo}</b></li></ul>`;

            }
        });

        const templateLot = new PopupTemplate({
            outFields: ["*"],
            title: "Lot No.: <b>{LotID}</b>",
            lastEditInfoEnabled: false,
            content: [customContentLot]
        });
        lotLayer.popupTemplate = templateLot;

        //**** ---- Endorsed Layer from lot layer ---- ***///

        // Renderer for endorsed lot layer
        let endorsedLayerRenderer = {
            type: "unique-value",
            field: "Endorsed",
            defaultSymbol: defaultSymbol,
            uniqueValueInfos: [
                {
                    value: 0,
                    label: "Not Endorsed",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[5],
                    },
                },
                {
                    value: 1,
                    label: "Endorsed",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[2],
                    },
                },
                {
                    value: 2,
                    label: "NA",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: [211, 211, 211, 0.7],
                    },
                },
            ],
        };

        // Adding endorsed lot layer
        var endorsedLotLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 7,
            renderer: endorsedLayerRenderer,
            labelingInfo: [lotIdLabel], //use the same labelClass as lot layer
            outFields: ["*"],
            title: "Land Acquisition (Endorsed Status)",
            minScale: 150000,
            maxScale: 0,
            //labelsVisible: false,
            elevationInfo: {
                model: "on-the-ground",
            },
        });
        endorsedLotLayer.popupTemplate = templateLot; //use the same popup as lot layer


        //**** ---- Super Urgent Lots ---- ***///

        let urgentLotRenderer = {
            type: "unique-value",
            defaultSymbol: defaultSymbol,
            field: "Urgent",
            uniqueValueInfos: [
                {
                    value: 0,
                    label: "Super Urgent Lots",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: "#FF00C5",

                    },
                },
            ],
        };

        var urgentLotLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 7,
            outFields: ["*"],
            title: "Super Urgent Lots",
            renderer: urgentLotRenderer,
            labelingInfo: [lotIdLabel],
            elevationInfo: {
                model: "on-the-ground",
            },
            minScale: 150000,
            maxScale: 0,

        });
        map.add(urgentLotLayer, 0);
        urgentLotLayer.listMode = "hide";
        urgentLotLayer.visible = false;
        urgentLotLayer.popupTemplate = templateLot;



        // Structure Layer 
        // Polygon 3D extrution
        const height = 5;
        const edgeSize = 0.3;
        const dismantled = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [0, 197, 255, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        };

        const paid = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [112, 173, 71, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        };

        const payp = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [0, 112, 255, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        }

        const legalpass = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [255, 255, 0, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        }

        const otc = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [255, 170, 0, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        }

        const lbp = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: height,
                    material: {
                        color: [255, 0, 0, 0.3]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: edgeSize
                    }
                }
            ]
        }

        const structureRenderer = {
            type: "unique-value",
            defaultSymbol: {
                type: "polygon-3d",
                symbolLayers: [
                    {
                        type: "extrude",
                        size: 5, // in meters
                        material: {
                            color: [0, 0, 0, 0.4]
                        },
                        edges: {
                            type: "solid",
                            color: "#4E4E4E",
                            size: edgeSize
                        }
                    }
                ]
            },
            defaultLabel: "Other",
            field: "StatusStruc",
            legendOptions: {
                title: "Status of Structure"
            },
            uniqueValueInfos: [
                {
                    value: 1,
                    symbol: dismantled,
                    label: "Dismantling/Clearing"
                },
                {
                    value: 2,
                    symbol: paid,
                    label: "Paid"
                },
                {
                    value: 3,
                    symbol: payp,
                    label: "For Payment Processing"
                },
                {
                    value: 4,
                    symbol: legalpass,
                    label: "For Legal Pass"
                },
                {
                    value: 5,
                    symbol: otc,
                    label: "For Appraisal/Offer to Compensation"
                },
                {
                    value: 6,
                    symbol: lbp,
                    label: "LBP Account Opening"
                },
            ]
        }

        var structureLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 6,
            title: "Structure",
            renderer: structureRenderer,
            outFields: ["*"],
            elevationInfo: {
                model: "on-the-ground"
            },
            popupTemplate: {
                title: "<p>{StrucID}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "FamilyNumber",
                                label: "<b>Number of Families</b>"
                            },
                            {
                                fieldName: "StrucOwner",
                                label: "Structure Owner"
                            },
                            {
                                fieldName: "StatusStruc",
                                label: "<p>Status of Structure</p>"
                            },
                            {
                                fieldName: "LotID",
                                label: "Lot ID"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "Barangay"
                            }
                        ]
                    }
                ]
            }
        });

        // Structure (NLO/LO)
        let NLOLORenderer = {
            type: "unique-value",
            field: "Status",
            uniqueValueInfos: [
                {
                    value: 1,
                    label: "LO (Land Owner)",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        style: "forward-diagonal",
                        color: [128, 128, 128, 1],
                        outline: {
                            color: "#6E6E6E",
                            width: 0.3
                        }
                    }
                },
                {
                    value: 2,
                    label: "NLO (Non-Land Owner)",
                    symbol: {
                        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                        style: "vertical",
                        color: [128, 128, 128, 1],
                        outline: {
                            color: "#6E6E6E",
                            width: 0.3
                        }
                    }
                }
            ]
        };

        var strucOwnershipLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            renderer: NLOLORenderer,
            layerId: 3,
            title: "NLO/LO Ownership (Structure)",
            outFields: ["*"],
            popupEnabled: false,
            elevationInfo: {
                model: "on-the-ground"
            }
        });

        // Status of Relocation (Occupancy)
        const outlineColorOccupancy = "gray";

        var verticalOffsetExistingOccupancy = {
            screenLength: 10,
            maxWorldLength: 10,
            minWorldLength: 10
        };

        function getUniqueValueSymbolOccupancy(name, size) {
            return {
                type: "point-3d", // autocasts as new PointSymbol3D()
                symbolLayers: [
                    {
                        type: "icon", // autocasts as new IconSymbol3DLayer()
                        resource: {
                            href: name
                        },
                        size: size,
                        outline: {
                            color: "white",
                            size: 2
                        }
                    }
                ],

                verticalOffset: verticalOffsetExistingOccupancy,

                callout: {
                    type: "line", // autocasts as new LineCallout3D()
                    color: [128, 128, 128, 0.6],
                    size: 0.4,
                    border: {
                        color: "grey"
                    }
                }
            };
        }
        const occupancyPointSize = 20;
        let occupancyRenderer = {
            type: "unique-value",
            valueExpression: "When($feature.Occupancy == 0, 'Occupied', \
                      $feature.Occupancy == 1, 'Relocated', $feature.Occupancy)",
            uniqueValueInfos: [
                {
                    value: "Occupied",
                    label: "Occupied",
                    symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/Demolished.png", occupancyPointSize),
                },
                {
                    value: "Relocated",
                    label: "Relocated",
                    symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png", occupancyPointSize),
                },
            ]
        };

        var occupancyLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 5,
            outFields: ["*"],
            title: "Occupancy (Structure)",
            renderer: occupancyRenderer,
            elevationInfo: {
                mode: "relative-to-scene"
            },
            popupTemplate: {
                title: "<p>{StrucID}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "StrucOwner",
                                label: "Structure Owner"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "Barangay"
                            },
                            {
                                fieldName: "Occupancy",
                                label: "<p>Status for Relocation(structure)</p>"
                            },
                            {
                                fieldName: "Name",
                            },
                            {
                                fieldName: "Status",
                                label: "NLO/LO Ownership"
                            }
                        ]
                    }
                ]
            }
        });

        // ISF
        const outlineColor = "gray";

        var verticalOffsetExisting = {
            screenLength: 80,
            maxWorldLength: 500,
            minWorldLength: 30
        };

        var verticalOffsetNLO = {
            screenLength: 0,
            maxWorldLength: 0,
            minWorldLength: 0
        };

        function getUniqueValueSymbolNLO(name, size) {
            return {
                type: "point-3d", // autocasts as new PointSymbol3D()
                symbolLayers: [
                    {
                        type: "icon", // autocasts as new IconSymbol3DLayer()
                        resource: {
                            href: name
                        },
                        size: size,
                        outline: {
                            color: "white",
                            size: 2
                        }
                    }
                ],

                verticalOffset: verticalOffsetNLO,

                callout: {
                    type: "line", // autocasts as new LineCallout3D()
                    color: [128, 128, 128, 0.6],
                    size: 0.4,
                    border: {
                        color: "grey"
                    }
                }
            };
        }

        const symbolSize = 30;
        let isfRenderer = {
            type: "unique-value",
            field: "StatusRC",
            uniqueValueInfos: [
                {
                    value: 1,
                    label: "Relocated",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Relocated.svg", symbolSize),
                },
                {
                    value: 2,
                    label: "Paid",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Paid.svg", symbolSize),
                },
                {
                    value: 3,
                    label: "For Payment Processing",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_PaymentProcess.svg", symbolSize),
                },
                {
                    value: 4,
                    label: "For Legal Pass",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LegalPass.svg", symbolSize),
                },
                {
                    value: 5,
                    label: "For Appraisal/OtC/Reqs for Other Entitlements",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_OtC.svg", symbolSize),
                },
                {
                    value: 6,
                    label: "LBP Account Opening",
                    symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LBP.svg", symbolSize),
                }
            ]
        };

        var nloLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 4,
            renderer: isfRenderer,
            outFields: ["*"],
            title: "NLO (Non-Land Owner)",
            elevationInfo: {
                mode: "relative-to-scene"
            },
            minScale: 150000,
            maxScale: 0,
            popupTemplate: {
                title: "<p>{StrucID}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "StrucOwner",
                                label: "Structure Owner"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "Barangay"
                            },
                            {
                                fieldName: "StatusRC",
                                label: "<p>Status for Relocation</p>"
                            },
                            {
                                fieldName: "Name",
                            },
                            {
                                fieldName: "Status",
                                label: "NLO/LO Ownership (structure) "
                            }
                        ]
                    }
                ]
            }
        });

        const nloLoOccupancyGroupLayer = new GroupLayer({
            title: "NLO/LO Occupancy",
            visible: true,
            visibilityMode: "independent",
            layers: [occupancyLayer, strucOwnershipLayer, nloLayer]
        });


        //**** ---- Free and Clear Lot ---- ***///

        // Adding the fnc layer
        var fncLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 2,
            title: "Free-and-Clear Area",
            //popupEnabled: false
        });
        map.add(fncLayer, 0); //layer order in the map.add



        // Tree Cutting
        function colorsCut() {
            return {
                1: [113, 171, 72, 0.8], //#71AB48
                //2: [0, 115, 255, 0.8], //#0073FF
                2: [255, 255, 0, 0.8], //#FFFF00
                3: [255, 170, 0, 0.8], //#FFAA00
                4: [255, 0, 0, 0.8] //#FF0000
            }
        }

        function treeCutting3DSymbol(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriThematicTreesStyle"
            };
        }

        const treeCuttingRenderer = {
            type: "unique-value",
            valueExpression: "When($feature.Status == 1, 'cutearthb', \
                        $feature.Status == 2, 'permit', $feature.Status == 3, 'submit', \
                        $feature.Status == 4, 'ongoing', $feature.Status)",
            uniqueValueInfos: [
                {
                    value: "cutearthb",
                    label: "Cut/Earthballed",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                },
                {
                    value: "permit",
                    label: "Permit Acquired",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                },
                {
                    value: "submit",
                    label: "Submitted to DENR",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                },
                {
                    value: "ongoing",
                    label: "Ongoing Acquisition of Application Documents",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                }
            ],
            visualVariables: [
                {
                    type: "size",
                    axis: "height",
                    valueExpression: "When($feature.Status >= 1, 5, 0)",
                    valueUnit: "meters"
                },
                {
                    type: "color",
                    valueExpression: "$feature.Status",
                    valueExpressionTitle: "Status Color",
                    stops: [
                        { value: 1, color: "#71AB48" },
                        { value: 2, color: "#FFFF00" },
                        { value: 3, color: "#FFAA00" },
                        { value: 4, color: "#FF0000" },
                    ],
                    legendOptions: {
                        showLegend: false
                    }
                },
            ]
        };

        var treeCuttingLayer = new FeatureLayer({
            portalItem: {
                id: "ba9104f5829e489faf42b142e5934784",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            outFields: ["*"],
            title: "Tree Cutting",
            renderer: treeCuttingRenderer,
            popupTemplate: {
                title: "Tree No. {TreeNo}, <b>{Status}</b>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Compensation",
                                label: "Status of Tree Compensation"
                            },
                            {
                                fieldName: "Conservation",
                                label: "Conservation Status"
                            },
                            {
                                fieldName: "ScientificName",
                                label: "Scientific Name"
                            },
                            {
                                fieldName: "CommonName",
                                label: "Common Name"
                            },
                            {
                                fieldName: "Province"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "CP",
                                label: "<h5>CP</h5>"
                            },
                            {
                                fieldName: "Compensation",
                                label: "Status of Tree Compensation"
                            },
                            {
                                fieldName: "Conservation",
                                label: "Conservation Status"
                            },
                        ]
                    }
                ]
            }
        });

        // Tree Compensation
        function colorsCompen() {
            return {
                1: [0, 112, 255, 0.8], //#0070FF
                2: [255, 255, 0, 0.8], //#FFFF00
                3: [113, 171, 72, 0.8] //#71AB48
            }
        }

        const treeCompensationRenderer = {
            type: "unique-value",
            valueExpression: "When($feature.Compensation == 1, 'nonCompensable', $feature.Compensation == 2, 'payp', \
                        $feature.Compensation == 3, 'compensated', $feature.Compensation)",
            uniqueValueInfos: [
                {
                    value: "nonCompensable",
                    label: "Non-Compensable",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),

                },
                {
                    value: "payp",
                    label: "For Processing",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                },
                {
                    value: "compensated",
                    label: "Compensated",
                    type: "simple",
                    symbol: treeCutting3DSymbol("Larix"),
                },
            ],
            visualVariables: [
                {
                    type: "size",
                    axis: "height",
                    valueExpression: "When($feature.Compensation >= 1, 5, 0)",
                    valueUnit: "meters"
                },
                {
                    type: "color",
                    valueExpression: "$feature.Compensation",
                    valueExpressionTitle: "Status Color",
                    stops: [
                        { value: 1, color: "#0070FF" },
                        { value: 2, color: "#FFFF00" },
                        { value: 3, color: "#71AB48" },
                    ],
                    legendOptions: {
                        showLegend: false
                    }
                },
            ]
        };

        var treeCompensationLayer = new FeatureLayer({
            portalItem: {
                id: "ba9104f5829e489faf42b142e5934784",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            outFields: ["*"],
            title: "Tree Compensation",
            renderer: treeCompensationRenderer,
            popupTemplate: {
                title: "Tree No. {TreeNo}, <b>{Compensation}</b>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Status",
                                label: "Status of Tree Cutting"
                            },
                            {
                                fieldName: "Conservation",
                                label: "Conservation Status"
                            },
                            {
                                fieldName: "ScientificName",
                                label: "Scientific Name"
                            },
                            {
                                fieldName: "CommonName",
                                label: "Common Name"
                            },
                            {
                                fieldName: "Province"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "TreeNo",
                                label: "Tree No."
                            },
                            {
                                fieldName: "CP",
                                label: "<h5>CP</h5>"
                            },
                        ]
                    }
                ]
            }
        });

        const treeGroupLayer = new GroupLayer({
            title: "Tree Cutting & Compensation",
            visible: true,
            visibilityMode: "independent",
            layers: [treeCuttingLayer, treeCompensationLayer],
            //opacity: 1
        });


        // UTILITY RELOCATION
        // 1. Utility Point
        var labelUtilPtSymbol = {
            type: "label-3d", // autocasts as new LabelSymbol3D()
            labelPlacement: "above-center",
            labelExpressionInfo: {
                //value: "{Company}",
                expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')" //$feature.Comp_Agency
            },
            symbolLayers: [
                {
                    type: "text", // autocasts as new TextSymbol3DLayer()
                    material: {
                        color: "black"
                    },
                    halo: {
                        color: [255, 255, 255, 0.7],
                        size: 2
                    },
                    size: 10
                }
            ],
        };

        // Esri Icon Symbol
        function IconSymbol(name) {
            return {
                type: "web-style", // autocasts as new WebStyleSymbol()
                name: name,
                styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
            };
        }

        // Utility Point Symbol
        /// https://developers.arcgis.com/javascript/latest/guide/esri-web-style-symbols-3d/
        function utilPtSymbolInfra(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriInfrastructureStyle"
            };
        }

        function utilPtSymbolStreet(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriRealisticStreetSceneStyle"
            };
        }

        function utilPtSymbolIcons(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriIconsStyle"
            };
        }

        /* custom 3D Web Style for Utility Pole */
        // Choice: 3D_Electric_Pole, 3D_Drain_Box, 3D_Water_Valve, 3D_Telecom_BTS, 3D_TelecomCATV_Pole
        function customSymbol3D(name) {
            return {
                type: "web-style",
                portal: "https://www.maps.arcgis.com",

                // IMPORTANT: Your browser needs to be able to open the following link. It will say insecure so need to go to advanced.
                styleUrl: "https://www.maps.arcgis.com/sharing/rest/content/items/c04d4d4145f64f8fa38407dd5331dd1f/data",
                name: name
            };
        }

        /* Company and Utilty Relocation Status Symbols with Callout */
        var verticalOffsetExisting = {
            screenLength: 10,
            maxWorldLength: 10,
            minWorldLength: 15
        };

        var verticalOffsetRelocation = {
            screenLength: 10,
            maxWorldLength: 30,
            minWorldLength: 35
        };


        // Function that automatically creates the symbol for the points of interest
        function getUniqueValueSymbol(name, color, sizeS, util) {
            // The point symbol is visualized with an icon symbol. To clearly see the location of the point
            // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
            // of the point feature.
            if (util == "Existing") {
                return {
                    type: "point-3d", // autocasts as new PointSymbol3D()
                    symbolLayers: [
                        {
                            type: "icon", // autocasts as new IconSymbol3DLayer()
                            resource: {
                                href: name
                            },
                            size: sizeS,
                            outline: {
                                color: "white",
                                size: 2
                            }
                        }
                    ],

                    verticalOffset: verticalOffsetExisting,

                    callout: {
                        type: "line", // autocasts as new LineCallout3D()
                        color: [128, 128, 128, 0.1],
                        size: 0.2,
                        border: {
                            color: "grey"
                        }
                    }
                };
            } else {
                return {
                    type: "point-3d", // autocasts as new PointSymbol3D()
                    symbolLayers: [
                        {
                            type: "icon", // autocasts as new IconSymbol3DLayer()
                            resource: {
                                href: name
                            },
                            size: sizeS,
                            outline: {
                                color: "white",
                                size: 2
                            }
                        }
                    ],

                    verticalOffset: verticalOffsetRelocation,

                    callout: {
                        type: "line", // autocasts as new LineCallout3D()
                        color: [128, 128, 128, 0.1],
                        size: 0.2,
                        border: {
                            color: "grey"
                        }
                    }
                };
            }
        }

        var utilTypePtRenderer = {
            type: "unique-value", //"unique-value", "simple"
            //Field: "UtilType2",
            //defaultSymbol: ,
            //valueExpression: "When($feature.UtilType == 1, 'Telecom', $feature.UtilType == 2, 'Water',$feature.UtilType == 3, 'Power', $feature.UtilType)",
            valueExpression: "When($feature.UtilType2 == 1, 'Telecom Pole (BTS)', \
                            $feature.UtilType2 == 2, 'Telecom Pole (CATV)', \
                            $feature.UtilType2 == 3, 'Water Meter', \
                            $feature.UtilType2 == 4, 'Water Valve', \
                            $feature.UtilType2 == 5, 'Manhole', \
                            $feature.UtilType2 == 6, 'Drain Box', \
                            $feature.UtilType2 == 7, 'Electric Pole', \
                            $feature.UtilType2 == 8, 'Street Light', \
                            $feature.UtilType2 == 9, 'Junction Box', \
                            $feature.UtilType2 == 10, 'Coupling', \
                            $feature.UtilType2 == 11, 'Fitting', \
                            $feature.UtilType2 == 12, 'Transformer', \
                            $feature.UtilType2 == 13, 'Truss Guy', \
                            $feature.UtilType2 == 14, 'Concrete Pedestal', \
                            $feature.UtilType2 == 15, 'Ground', \
                            $feature.UtilType2 == 16, 'Down Guy', \
                            $feature.UtilType2 == 17, 'Entry/Exit Pit', \
                            $feature.UtilType2 == 18, 'Handhole', \
                            $feature.UtilType2 == 19, 'Transmission Tower', \
                            $feature.UtilType)",
            uniqueValueInfos: [
                {
                    value: "Telecom Pole (BTS)",
                    symbol: customSymbol3D("3D_Telecom_BTS")
                },
                {
                    value: "Telecom Pole (CATV)",
                    symbol: customSymbol3D("3D_TelecomCATV_Pole")
                },
                {
                    value: "Manhole",
                    symbol: utilPtSymbolStreet("Storm_Drain")
                },
                {
                    value: "Electric Pole",
                    //symbol: utilPtSymbolInfra("Powerline_Pole")
                    symbol: customSymbol3D("3D_Electric_Pole")
                },
                {
                    value: "Street Light",
                    symbol: utilPtSymbolStreet("Overhanging_Street_and_Sidewalk_-_Light_on")
                },
                {
                    value: "Junction Box",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Coupling",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Fitting",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Transformer",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Truss Guy",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Concrete Pedestal",
                    symbol: customSymbol3D("Concrete Pedestal")
                },
                {
                    value: "Ground",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Down Guy",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Entry/Exit Pit",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Handhole",
                    symbol: customSymbol3D("3D_Drain_Box")
                },
                {
                    value: "Transmission Tower",
                    symbol: utilPtSymbolInfra("Powerline_Pole")
                }
            ],
            visualVariables: [
                {
                    type: "size",
                    axis: "height",
                    field: "SIZE",
                    valueUnit: "meters"
                },
                {
                    type: "rotation",
                    field: "ROTATION"
                },
                /*
                {
                  type: "opacity",
                  valueExpression: "($feature.Status * $feature.LAYER) / 2",
                  // when utility is demolished, it becomes transparent
                  //valueExpression: "When($feature.Status == 1 && $feature.LAYER == 1, 0, 1)",
                  //field: "SIZE",
                  stops: [
                    {value: 0, opacity: 0.005}, //  want to delete
                    {value: 1, opacity: 1}, // want to visualize
                  ],
                  legendOptions: {
                    showLegend: false
                  }
                }
          */
            ]
        };

        var utilReloSymbolRenderer = {
            type: "unique-value", // autocasts as new UniqueValueRenderer()
            valueExpression: "When($feature.Remarks == 'pending', 'NoAction', \
                            $feature.Status == 1 && $feature.LAYER == 1, 'DemolishComplete',\
                            $feature.Status == 0 && $feature.LAYER == 1, 'DemolishIncomplete',\
                            $feature.Status == 0 && $feature.LAYER == 2, 'RelocIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 2, 'RelocComplete', \
                            $feature.Status == 0 && $feature.LAYER == 3, 'NewlyAdded', \
                            $feature.Status == 1 && $feature.LAYER == 3, 'NewlyAddedComplete',$feature.Comp_Agency)",
            //field: "Company",
            uniqueValueInfos: [
                {
                    value: "DemolishIncomplete",
                    label: "To be Demolished",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Demolished.png",
                        "#D13470",
                        20,
                        "Relocation"
                    )
                },
                {
                    value: "DemolishComplete",
                    label: "Demolision Completed",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png",
                        "#D13470",
                        25,
                        "Relocation"
                    )
                },
                {
                    value: "RelocIncomplete",
                    label: "Proposed Relocation",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Relocatd.png",
                        "#D13470",
                        30,
                        "Relocation"
                    )
                },
                {
                    value: "RelocComplete",
                    label: "Relocation Completed",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Utility_Relocated_Completed_Symbol.png",
                        "#D13470",
                        30,
                        "Relocation"
                    )
                },
                {
                    value: "NewlyAdded",
                    label: "Add New Utility",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/NewlyAdded.png",
                        "#D13470",
                        35,
                        "Relocation"
                    )
                },
                {
                    value: "NewlyAddedComplete",
                    label: "Newly Utility Added",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/NewlyAdded_Completed.png",
                        "#D13470",
                        35,
                        "Relocation"
                    )
                },
                {
                    value: "NoAction",
                    label: "Require Data Checking",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
                        "#D13470",
                        35,
                        "Relocation"
                    )
                }
            ]
        };

        var utilityPointLayer = new FeatureLayer({
            portalItem: {
                id: "8258f9a91c0e4b9997745fb0741e1c32",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 1,
            title: "Point (symbol)",
            outFields: ["*"],
            renderer: utilTypePtRenderer,
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.Height"
                },
                unit: "meters"
                //offset: 0
            },
            popupTemplate: {
                title: "<h5>{Comp_Agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated",
                        title: "Go to Relocated"
                    }
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id"
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type"
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name"
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>"
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>"
                            },
                            {
                                fieldName: "CP"
                            },
                            {
                                fieldName: "Remarks"
                            }
                        ]
                    }
                ]
            }
        });

        /* Symbols with callout */
        // To locate a symbol with callout on the ground, 
        // If basemap elevation layer is on, use "relative-to-scene"
        // If basemap elevatio layer is off, use "absolute-height"

        var utilityPointLayer1 = new FeatureLayer({
            portalItem: {
                id: "8258f9a91c0e4b9997745fb0741e1c32",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 1,
            title: "Point (status)",
            outFields: ["*"],
            renderer: utilReloSymbolRenderer,
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.Height"
                },
                unit: "meters"
                //offset: 0
            },
            labelingInfo: [labelUtilPtSymbol],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated",
                        title: "Go to Relocated"
                    }
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id"
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type"
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name"
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>"
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>"
                            },
                            {
                                fieldName: "CP"
                            },
                            {
                                fieldName: "Remarks"
                            }
                        ]
                    }
                ]
            }
        });

        // 2. Utilit Line
        var utilityLineLayerLabelClass = {
            type: "label-3d", // autocasts as new LabelSymbol3D()
            labelPlacement: "above-center", // Polyline has not choice
            labelExpressionInfo: {
                expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')"
            },
            symbolLayers: [
                {
                    type: "text", // autocasts as new TextSymbol3DLayer()
                    material: {
                        color: "black"
                    },
                    halo: {
                        color: [255, 255, 255, 0.7],
                        size: 2
                    },
                    size: 10
                }
            ],
        };

        const options = { // Circle
            profile: "circle",
            cap: "none",
            join: "miter",
            width: 0.5,
            height: 0.5,
            //color: [200, 200, 200],
            profileRotation: "all"
        };

        const options1 = { // rectangular
            profile: "quad",
            cap: "none",
            join: "miter",
            width: 0.5,
            height: 0.5,
            color: [200, 200, 200],
            profileRotation: "heading"
        };

        /* The colors used for the each transit line */

        const colorsRelocation = {
            1: [32, 178, 170, 0.5], //Telecom Line
            2: [112, 128, 144, 0.5], // Internet Cable Line
            3: [0, 128, 255, 0.5], // Water Distribution Pipe
            4: [224, 224, 224, 0.5], // Sewage
            5: [105, 105, 105, 0.5], // Drainage
            6: [205, 133, 63, 0.5], // Canal
            7: [139, 69, 19, 0.5], // Creek
            8: [211, 211, 211, 0.5] // Elecric Line
        };

        const colorsExisting = {
            1: [229, 229, 229, 0.1], //Telecom/CA (Utility TYpe)
            2: [229, 229, 229, 0.1], // Water
            3: [229, 229, 229, 0.1], // Power
        };

        var utilityLineLayer = new FeatureLayer({
            portalItem: {
                id: "8258f9a91c0e4b9997745fb0741e1c32",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 2,
            title: "Line (symbol)",
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.height"
                },
                unit: "meters"
                //offset: 0
            },
            outFields: ["*"],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated-line",
                        title: "Go to Relocated"
                    }
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id"
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type"
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name"
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>"
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>"
                            },
                            {
                                fieldName: "CP"
                            },
                            {
                                fieldName: "Remarks"
                            }
                        ]
                    }
                ]
            }
        });

        /* Utility Line rendnerer*/
        function lineSizeShapeSymbolLayers(profile, cap, join, width, height, profileRotation, property) {
            return {
                type: "line-3d",
                symbolLayers: [
                    {
                        type: "path",
                        profile: profile,
                        material: {
                            color: colorsRelocation[property]
                        },
                        width: width,
                        height: height,
                        join: join,
                        cap: cap,
                        anchor: "bottom",
                        profileRotation: profileRotation
                    }
                ]
            }
        }

        function renderutilityLineLayer() {
            const renderer = new UniqueValueRenderer({
                field: "utiltype2"
            });

            for (let property in colorsRelocation) { // For each utility type 2
                if (property == 1) { // If utility type2 === Telecom Line
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 0.5, 0.5, "all", property)
                    });

                } else if (property == 2) { // "Internet Cable Line"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 0.4, 0.4, "all", property)
                    });

                } else if (property == 3) { // "Water Distributin Pipe"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 1, 1, "all", property)
                    });

                } else if (property == 4) { // "Sewerage"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 1, 1, "all", property)
                    });

                } else if (property == 5) { // "Drainage"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 1, 1, "all", property)
                    });

                } else if (property == 6) { // "Canal"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("quad", "none", "miter", 2, 2, "all", property)
                    });

                } else if (property == 7) { // "Creek"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 1, 1, "all", property)
                    });

                } else if (property == 8) { // "Electric Line"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("circle", "none", "miter", 0.3, 0.3, "all", property)
                    });

                } else {// end of 'property == '1'
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers("quad", "none", "miter", 0.3, 0.3, "all", property)

                    });
                }
            }
            utilityLineLayer.renderer = renderer;
        }

        renderutilityLineLayer();

        /*Line for Symbols */
        var utilityLineLayer1 = new FeatureLayer({
            portalItem: {
                id: "8258f9a91c0e4b9997745fb0741e1c32",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 2,
            title: "Line (status)",
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.height"
                },
                unit: "meters"
                //offset: 0
            },
            outFields: ["*"],
            renderer: utilReloSymbolRenderer,
            labelingInfo: [utilityLineLayerLabelClass],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated-line",
                        title: "Go to Relocated"
                    }
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id"
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type"
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name"
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>"
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>"
                            },
                            {
                                fieldName: "CP"
                            },
                            {
                                fieldName: "Remarks"
                            }
                        ]
                    }
                ]
            }
        });

        const utilityGroupLayer = new GroupLayer({
            title: "Utility Relocation",
            visible: true,
            visibilityMode: "independent",
            layers: [utilityLineLayer1, utilityLineLayer, utilityPointLayer1, utilityPointLayer]
        });

        // Chainage
        var labelChainage = new LabelClass({
            labelExpressionInfo: { expression: "$feature.KmSpot" },
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 15,
                    weight: "bold"
                }
            }
        });

        var chainageRenderer = {
            type: "simple",
            symbol: {
                type: "simple-marker",
                size: 5,
                color: [255, 255, 255, 0.9],
                outline: {
                    width: 0.2,
                    color: "black"
                }
            }
        };

        var chainageLayer = new FeatureLayer({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 5,
            title: "Chainage",
            elevationInfo: {
                mode: "relative-to-ground"
            },
            labelingInfo: [labelChainage],
            minScale: 150000,
            maxScale: 0,
            renderer: chainageRenderer,
            outFields: ["*"],
            popupEnabled: false
        });

        // Pier Head and Column

        // Polygon 3D extrution
        /*const pHeight = 0;

        const pierColumn = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: pHeight + 10,
                    material: {
                        color: [78, 78, 78, 0.5]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: 0.3
                    }
                }
            ]
        };

        const pierHead = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: pHeight + 10,
                    material: {
                        color: [169, 169, 169, 0.7]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: 1.0
                    }
                }
            ]
        };

        const pileCap = {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "extrude",
                    size: pHeight + 3,
                    material: {
                        color: [200, 200, 200, 0.7]
                    },
                    edges: {
                        type: "solid",
                        color: "#4E4E4E",
                        size: 1.0
                    }
                }
            ]
        }

        const pierHeadRenderer = {
            type: "unique-value",
            defaultSymbol: {
                type: "polygon-3d",
                symbolLayers: [
                    {
                        type: "extrude",
                        size: 5, // in meters
                        material: {
                            color: "#E1E1E1"
                        },
                        edges: {
                            type: "solid",
                            color: "#4E4E4E",
                            size: 1.0
                        }
                    }
                ]
            },
            defaultLabel: "Other",
            field: "Layer",
            legendOptions: {
                title: "Pier Head/Pier Column/Pile Cap"
            },
            uniqueValueInfos: [
                {
                    value: "Pier_Column",
                    symbol: pierColumn,
                    label: "Column"
                },
                /*
                {
                  value: "Pier_Head",
                  symbol: pierHead,
                  label: "Pier Head"
                },
                
                {
                    value: "Pile_Cap",
                    symbol: pileCap,
                    label: "Pile Cap"
                },
            ]
        }*/

        /*
        var pilecapPierLayer = new FeatureLayer ({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 4,
            title: "Pier Head/Column",
            definitionExpression: "Layer <> 'Pier_Head'",
            outFields: ["*"],
            minScale: 150000,
            maxScale: 0,
            renderer: pierHeadRenderer,
            popupEnabled: false,
            elevationInfo: {
              model: "on-the-ground"
            }
        });
        //pilecapPierLayer.listMode = "hide";
        map.add(pilecapPierLayer, 1);
    */
        // Pier No (point)
        // Renderer
        // 0. Define colors for unique values
        const pierAccessDateColor = {
            0: [0, 255, 0, 0.9],// Accessible (green)
            1: [255, 127, 80],// Orange
            2: [255, 255, 0],// Yellow
            3: [0, 112, 255], // Blue
            4: [143, 0, 255], // violet
            5: [255, 255, 255, 0.9],
            6: [255, 0, 0, 0.9] // Dates are missing
        }

        /*var defaultPointSymbol = {
            type: "simple",
            label: "Accessible",
            symbol: {
                type: "simple-marker",
                size: 5,
                color: pierAccessDateColor[0],
                outline: {
                    width: 0,
                    color: "black"
                }
            }
        }*/

        // labels
        // for multiple label class to a layer:
        // https://developers.arcgis.com/javascript/latest/sample-code/labels-multiple-classes/

        const cutOffDateAccess = 1636070400000;
        // make sure to update numerical date values in 'pierAccessRenderer'

        const pierAccessReadyDateLabel = new LabelClass({
            symbol: {
                type: "label-3d", // autocast as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text",
                        material: {
                            color: pierAccessDateColor[0]
                        },
                        size: 15,
                        color: pierAccessDateColor[0],
                        haloColor: pierAccessDateColor[0],
                        haloSize: 1,
                        font: {
                            family: "Ubuntu Mono",
                            weight: "bold"
                        },
                    }
                ],
                verticalOffset: {
                    screenLength: 80,
                    maxWorldLength: 500,
                    minWorldLength: 30
                },
                callout: {
                    type: "line",
                    size: 0.5,
                    color: [0, 0, 0],
                    border: {
                        color: [255, 255, 255, 0.7]
                    }
                }
            },
            labelExpressionInfo: {
                expression: "$feature.PIER"
                //'DefaultValue($feature.GeoTechName, "no data")'
                //"IIF($feature.Score >= 13, '', '')"
                //value: "{Type}"
            },
            labelPlacement: "above-center",
            where: "AccessDate <= '" + cutOffDateAccess + "'"
        });

        const pierAccessNotYetLabel = new LabelClass({
            symbol: {
                type: "label-3d", // autocast as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text",
                        material: {
                            color: "#cccccc"
                        },
                        size: 10,
                        color: "#cccccc",
                        haloColor: "#cccccc",
                        haloSize: 1,
                        font: {
                            family: "Ubuntu Mono",
                            weight: "normal"
                        },
                    }
                ],
                verticalOffset: {
                    screenLength: 80,
                    maxWorldLength: 500,
                    minWorldLength: 30
                },
                callout: {
                    type: "line",
                    size: 0.5,
                    color: [0, 0, 0],
                    border: {
                        color: [255, 255, 255, 0.7]
                    }
                }
            },
            labelExpressionInfo: {
                expression: "$feature.PIER"
                //'DefaultValue($feature.GeoTechName, "no data")'
                //"IIF($feature.Score >= 13, '', '')"
                //value: "{Type}"
            },
            labelPlacement: "above-center",
            where: "AccessDate > '" + cutOffDateAccess + "'" + " OR " + "AccessDate IS NULL"
        });

        const pierAccessDateMissingLabel = new LabelClass({
            symbol: {
                type: "label-3d", // autocast as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text",
                        material: {
                            color: "#ff0000"
                        },
                        size: 10,
                        color: "#cccccc",
                        haloColor: "#cccccc",
                        haloSize: 1,
                        font: {
                            family: "Ubuntu Mono",
                            weight: "normal"
                        },
                    }
                ],
                verticalOffset: {
                    screenLength: 80,
                    maxWorldLength: 500,
                    minWorldLength: 30
                },
                callout: {
                    type: "line",
                    size: 0.5,
                    color: [0, 0, 0],
                    border: {
                        color: [255, 255, 255, 0.7]
                    }
                }
            },
            labelExpressionInfo: {
                expression: "$feature.PIER"
                //'DefaultValue($feature.GeoTechName, "no data")'
                //"IIF($feature.Score >= 13, '', '')"
                //value: "{Type}"
            },
            labelPlacement: "above-center",
            where: "AccessDate IS NULL"
        });

        // 1. Get unique dates
        const numberDate = new Date(cutOffDateAccess);
        const cutDate = numberDate.toLocaleDateString('en-US');

        var pierAccessLayer = new FeatureLayer({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 6,
            labelingInfo: [pierAccessDateMissingLabel, pierAccessReadyDateLabel, pierAccessNotYetLabel],
            title: "Pier with Access Date",
            minScale: 150000,
            maxScale: 0,
            outFields: ["*"],
            elevationInfo: {
                model: "on-the-ground"
            }
        }, { utcOffset: 300 });

        /*
        // we first need to obtain unique values of date because valueExpression does not allow
        // date'2021-10-01' notation
        const queryDate = "AccessDate IS NOT NULL";
    
        function DateValues() {
            const dates = [];
            var query = pierAccessLayer.createQuery();
    
            query.where = queryDate;
            return pierAccessLayer.queryFeatures(query).then(function(response) {
                var stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const date = attributes.AccessDate;
                    dates.push(date);
                });
                return dates;
            });
        }
    
        function uniqueDateValues(values) {
            var uniqueValues = [];
            values.forEach((item, index) => {
                if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
                    uniqueValues.push(item);
                }
            });
            const sortedDates = uniqueValues.sort();
            return sortedDates;
        }
    
        function uniqueValuesInfos(sortedDates) {
          const dates = sortedDates.map((date, index) => {
                const temp = new Date(date);
                const labelDate = temp.toLocaleDateString('en-US');
                return Object.assign({}, {
                    value: date, // make sure to use 'number'. you cannot add 'date'
                    label: labelDate,
                });
            });
            console.log(dates);
        }
        DateValues().then(uniqueDateValues).then(uniqueValuesInfos);
        */

        const pierAccessRenderer = {
            type: "unique-value", // autocasts as new UniqueValueRenderer()
            field: "AccessDate",
            //defaultSymbol: defaultPointSymbol,

            valueExpression: "When(IsEmpty($feature.AccessDate), 'empty', \
                            $feature.AccessDate <= 1636070400000, 'accessible', \
                            $feature.AccessDate > 1636070400000, 'others',$feature.AccessDate)",
            uniqueValueInfos: [
                {
                    value: "empty",
                    label: "Dates are missing",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: pierAccessDateColor[6],
                        outline: {
                            width: 0.1,
                            color: "white"
                        }
                    }
                },
                {
                    value: "accessible",
                    label: "Accessible",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: pierAccessDateColor[0],
                        outline: {
                            width: 0.1,
                            color: "white"
                        }
                    }
                },
                {
                    value: "others",
                    label: "Others",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: pierAccessDateColor[5],
                        outline: {
                            width: 0.1,
                            color: "white"
                        }
                    }
                },
            ]
        }
        pierAccessLayer.renderer = pierAccessRenderer;

        // Popup Template

        /// Define popup template on dates for pier no
        // Date Format function
        function dateFormat(inputDate, format) {
            //parse the input date
            const date = new Date(inputDate);

            //extract the parts of the date
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            //replace the month
            format = format.replace("MM", month.toString().padStart(2, "0"));

            //replace the year
            if (format.indexOf("yyyy") > -1) {
                format = format.replace("yyyy", year.toString());
            } else if (format.indexOf("yy") > -1) {
                format = format.replace("yy", year.toString().substr(2, 2));
            }

            //replace the day
            format = format.replace("dd", day.toString().padStart(2, "0"));

            return format;
        }

        // Custom Popup Content for pierAccessLayer
        let customContent = new CustomContent({
            outFields: ["*"],
            creator: function (event) {

                // Extract AsscessDate of clicked pierAccessLayer
                const stats = event.graphic.attributes.AccessDate;
                const pierNo = event.graphic.attributes.PIER;

                // Convert numeric to date format
                var date = new Date(stats);
                dateValue = dateFormat(date, 'MM-dd-yyyy');

                const ddd = new Date(cutOffDateAccess);
                dddValue = dateFormat(ddd, 'MM-dd-yyyy')

                //console.log(dateValue + "; " + dddValue);

                // If the date is before current date, popupContent should be "AVAILABLE"
                if (dateValue === '01-01-1970') { // Empty date is entered as this
                    DATES = "NO DATES AVAILABLE"
                } else if (date <= cutOffDateAccess) {
                    DATES = "ACCESSIBLE";
                } else if (date > cutOffDateAccess) {
                    DATES = dateValue;
                }

                //return `Access Date: <b>${DATES}</b>`;
                return `Access Date: <b>${DATES}</b>`;

            }
        });

        const template = new PopupTemplate({
            outFields: ["*"],
            title: "Pier No: <b>{PIER}</b>",
            lastEditInfoEnabled: false,
            content: [customContent]
        });
        pierAccessLayer.popupTemplate = template;

        // Station Box
        let stationBoxRenderer = {
            type: "unique-value",
            field: "Layer",
            defaultSymbol: { type: "simple-fill" },
            uniqueValueInfos: [
                {
                    value: "00_Platform",
                    label: "Platform",
                    symbol: {
                        type: "simple-fill",
                        color: [160, 160, 160],
                        style: "backward-diagonal",
                        outline: {
                            width: 1,
                            color: "black"
                        }
                    }
                },
                {
                    value: "00_Platform 10car",
                    label: "Platform 10car",
                    symbol: {
                        type: "simple-fill",
                        color: [104, 104, 104],
                        style: "cross",
                        outline: {
                            width: 1,
                            color: "black",
                            style: "short-dash"
                        }
                    }
                },
                {
                    value: "00_Station",
                    label: "Station Box",
                    symbol: {
                        type: "simple-fill",
                        color: [0, 0, 0, 0],
                        outline: {
                            width: 2,
                            color: [115, 0, 0]
                        }
                    }
                }
            ]
        };

        var stationBoxLayer = new FeatureLayer({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 3,
            renderer: stationBoxRenderer,
            minScale: 150000,
            maxScale: 0,
            title: "Station Box",
            outFields: ["*"],
            popupEnabled: false,
            elevationInfo: {
                model: "on-the-ground"
            }
        });
        //stationBoxLayer.listMode = "hide";

        const alignmentGroupLayer = new GroupLayer({
            title: "Alignment",
            visible: true,
            visibilityMode: "independent",
            layers: [stationBoxLayer, chainageLayer]
        });
        map.add(alignmentGroupLayer, 1);

        // PNR
        let pnrRenderer = {
            type: "unique-value",
            valueExpression: "When($feature.LandOwner == 'BASES CONVERSION DEVELOPMENT AUTHORITY', 'BCDA', \
                        $feature.LandOwner == 'MANILA RAILROAD COMPANY' || $feature.LandOwner == 'Manila Railroad Company','PNR',$feature.LandOwner)",
            uniqueValueInfos: [
                {
                    value: "BCDA",
                    symbol: {
                        type: "simple-fill",
                        color: [137, 205, 102],
                        style: "diagonal-cross",
                        outline: {
                            width: 0.5,
                            color: "black"
                        }
                    }
                },
                {
                    value: "PNR",
                    symbol: {
                        type: "simple-fill",
                        color: [137, 205, 102],
                        style: "diagonal-cross",
                        outline: {
                            width: 0.5,
                            color: "black"
                        }
                    }
                }
            ]
        };

        var pnrLayer = new FeatureLayer({
            portalItem: {
                id: "13026f2da4804673be557e959ed154c4",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 10,
            title: "Land (PNR)",
            definitionExpression: "LandOwner IN ('BASES CONVERSION DEVELOPMENT AUTHORITY','MANILA RAILROAD COMPANY')",
            outFields: ["*"],
            title: "PNR",
            elevationInfo: {
                model: "on-the-ground"
            },
            labelsVisible: false,
            renderer: pnrRenderer,
            popupTemplate: {
                title: "<p>{LandOwner} ({LotID})</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "HandOverDate",
                                label: "Hand-Over Date"
                            },
                            {
                                fieldName: "Municipality"
                            },
                            {
                                fieldName: "Barangay"
                            },
                            {
                                fieldName: "LandOwner",
                                label: "Land Owner"
                            }
                        ]
                    }
                ]
            }
        });

        const lotGroupLayer = new GroupLayer({
            title: "Land",
            visible: true,
            visibilityMode: "independent",
            layers: [endorsedLotLayer, lotLayer, fncLayer, pnrLayer]
        });

        // Station point feature
        var labelClass = new LabelClass({
            symbol: {
                type: "label-3d",// autocasts as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text", // autocasts as new TextSymbol3DLayer()
                        material: {
                            color: "#d4ff33"
                        },
                        size: 15,
                        color: "black",
                        haloColor: "black",
                        haloSize: 0.5,
                        font: {
                            family: "Ubuntu Mono",
                            //weight: "bold"
                        },
                    }
                ],
                verticalOffset: {
                    screenLength: 100,
                    maxWorldLength: 300,
                    minWorldLength: 80
                },

                callout: {
                    type: "line", // autocasts as new LineCallout3D()
                    color: [128, 128, 128, 0.5],
                    size: 0.2,
                    border: {
                        color: "grey"
                    }
                }
            },
            labelPlacement: "above-center",
            labelExpressionInfo: {
                expression: "IIF($feature.Station == 'NCC', '',$feature.Station)"
                //value: "{TEXTSTRING}"
            }
        });

        function stationsSymbol(name) {
            return {
                type: "web-style", // autocasts as new WebStyleSymbol()
                name: name,
                styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
            };
        }

        var stationsRenderer = {
            type: "unique-value", // autocasts as new UniqueValueRenderer()
            field: "Station",
            defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
        };

        // Station Layer
        var stationLayer = new FeatureLayer({
            portalItem: {
                id: "e47e9f4d475e4e24acad458a1428f3f9",
                portal: {
                    url: "https://gis.railway-sector.com/portal"
                }
            },
            layerId: 2,
            title: "N2 Stations",
            labelingInfo: [labelClass],
            //renderer: stationsRenderer,
            elevationInfo: {
                mode: "relative-to-ground"
            },
        });
        stationLayer.listMode = "hide";
        map.add(stationLayer, 0);

        // Viaduct Layer
        const colors = {
            1: [225, 225, 225, 0.1], // To be Constructed (white)
            2: [130, 130, 130, 0.5], // Under Construction
            3: [255, 0, 0, 0.8], // Delayed
            4: [0, 112, 255, 0.8], // Completed #0070FF
        };

        let viaductForAnimationRenderer = {
            type: "simple",
            symbol: {
                type: "mesh-3d",
                symbolLayers: [
                    {
                        type: "fill",
                        material: {
                            color: "gray",
                            colorMixMode: "replace"
                        },
                        edges: {
                            type: "solid",
                            color: [225, 225, 225, 0.3]
                        }
                    }
                ]
            }
        }


        let viaductRenderer = {
            type: "unique-value",
            defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
            valueExpression: "When($feature.Status1 == 1, 'toBeConstructed',$feature.Status1 == 4, 'Completed', $feature.Status1)",
            uniqueValueInfos: [
                {
                    value: "toBeConstructed",
                    label: "To be Constructed",
                    symbol: {
                        type: "mesh-3d",
                        symbolLayers: [
                            {
                                type: "fill",
                                material: {
                                    color: colors[1],
                                    colorMixMode: "replace"
                                },
                                edges: {
                                    type: "solid", // autocasts as new SolidEdges3D()
                                    color: [225, 225, 225, 0.3]
                                }
                            }
                        ]
                    }
                },
                {
                    value: "Completed",
                    label: "Completed",
                    symbol: {
                        type: "mesh-3d",
                        symbolLayers: [
                            {
                                type: "fill",
                                material: {
                                    color: colors[4],
                                    colorMixMode: "replace"
                                },
                                edges: {
                                    type: "solid", // autocasts as new SolidEdges3D()
                                    color: [225, 225, 225, 0.3]
                                }
                            }
                        ]
                    }
                },
            ]
        }

        var viaductLayer = new SceneLayer({
            portalItem: {
                id: 'c7364b5cd79748e7866ea8eda9681d73',
            },
            // popupTemplate: viadTemplate,
            elevationInfo: {
                mode: "absolute-height" //absolute-height, relative-to-ground
            },
            title: "Viaduct",
            outFields: ["*"],
            renderer: viaductRenderer
        });
        //map.add(viaductLayer);

        // Station structures
        const structureStatusColor = {
            1: [225, 225, 225, 0.1],
            2: [0, 112, 255, 0.8],
        }


        const structureStatusRenderer = {
            type: "unique-value",
            field: "Status",
            uniqueValueInfos: [
                {
                    value: 1,
                    label: "To be Constructed",
                    symbol: {
                        type: "mesh-3d",
                        symbolLayers: [
                            {
                                type: "fill",
                                material: {
                                    color: structureStatusColor[1],
                                    colorMixMode: "replace"
                                },
                                edges: {
                                    type: "solid", // autocasts as new SolidEdges3D()
                                    color: [225, 225, 225, 0.3]
                                }
                            }
                        ]
                    }
                },
                {
                    value: 4,
                    label: "Completed",
                    symbol: {
                        type: "mesh-3d",
                        symbolLayers: [
                            {
                                type: "fill",
                                material: {
                                    color: structureStatusColor[2],
                                    colorMixMode: "replace"
                                },
                                edges: {
                                    type: "solid", // autocasts as new SolidEdges3D()
                                    color: [225, 225, 225, 0.3]
                                }
                            }
                        ]
                    }
                }
            ]
        }

        const buildingLayer = new BuildingSceneLayer({
            portalItem: {
                id: "20e1136eec3149bda9ffa81effa08ebe",
            },
            outFields: ["*"],
            title: "N2 Station Structures"
        });
        //map.add(buildingLayer);

        var columnsLayer = null;
        var floorsLayer = null;
        var wallsLayer = null;

        // Discipline: Structural
        var stFramingLayer = null;
        var stColumnLayer = null;
        var stFoundationLayer = null;

        //
        var fullModelLayer = null;
        var defaultLayer = null;

        buildingLayer.when(() => {
            // Iterate through the flat array of sublayers and extract the ones
            // that should be excluded from the slice widget
            buildingLayer.allSublayers.forEach((layer) => {
                // modelName is standard accross all BuildingSceneLayer,
                // use it to identify a certain layer
                switch (layer.modelName) {
                    // Because of performance reasons, the Full Model view is
                    // by default set to false. In this scene the Full Model should be visible.
                    case "FullModel":
                        layer.visible = true;
                        break;

                    case "Columns":
                        columnsLayer = layer;
                        //excludedLayers.push(layer);
                        break;

                    case "Floors":
                        floorsLayer = layer;
                        //excludedLayers
                        break;

                    case "Walls":
                        wallsLayer = layer;
                        break;

                    case "StructuralFraming":
                        stFramingLayer = layer;
                        break;

                    case "StructuralColumns":
                        stColumnLayer = layer;
                        break;

                    case "StructuralFoundation":
                        stFoundationLayer = layer;
                        break;

                    default:
                        layer.visible = true;
                }
            });
            // setSliceWidget();
        });

        const civilGroupLayer = new GroupLayer({
            title: "Civil Construction",
            visible: true,
            visibilityMode: "independent",
            layers: [buildingLayer, viaductLayer]
        });

        /// Order in the layer list
        map.add(civilGroupLayer);
        map.add(pierAccessLayer);
        map.add(utilityGroupLayer);
        map.add(treeGroupLayer);
        map.add(lotGroupLayer);
        map.add(structureLayer);
        map.add(nloLoOccupancyGroupLayer);
        map.add(alignmentGroupLayer);
        map.add(prowLayer);


        // Filter by Contract Package

        function updateSummary(cpValue) {

            totalNumberOfLots();
            totalNumberOfStructures();
            totalProgressUtility();
            totalProgressViaduct();

            pteNumberLot();
            pteNumberStructure();

            updateChartLot(cpValue);
            updateChartStructure(cpValue);
            updateChartNLO(cpValue);
            updateChartCutting(cpValue);
            updateChartTreeComp(cpValue);
            updateChartUtilityPoint(cpValue);
            updateChartUtilityLine(cpValue);
            updateChartViaduct(cpValue);

            updateMoaChartLot(cpValue);
            updateMoaChartStructure(cpValue);

            timeSeriesChartLand(cpValue);
        }

        const viaductChartDiv = document.getElementById("viaductChartDiv");
        const timeSeriesChartViaductDiv = document.getElementById("timeSeriesChartViaduct");

        document.getElementById("contractPackageDiv").addEventListener("click", changeProject);
        function changeProject(event) {
            const value = event.srcElement.id;

            const cpExpression = "CP = '" + value + "'";

            if (value === "All") {
                lotLayer.definitionExpression = null;
                endorsedLotLayer.definitionExpression = null;
                structureLayer.definitionExpression = null;
                nloLayer.definitionExpression = null;
                occupancyLayer.definitionExpression = null;
                strucOwnershipLayer.definitionExpression = null;
                treeCuttingLayer.definitionExpression = null;
                treeCompensationLayer.definitionExpression = null;
                utilityPointLayer.definitionExpression = null;
                utilityPointLayer1.definitionExpression = null;
                utilityLineLayer.definitionExpression = null;
                utilityLineLayer1.definitionExpression = null;
                pierAccessLayer.definitionExpression = null;
                viaductLayer.definitionExpression = null;
                pnrLayer.definitionExpression = null;

                pierAccessLayer.visible = true;
                viaductChartDiv.style.display = 'block';
                viaductNumberDiv.style.display = 'block';

                pnrLayer.visible = true;
                buildingLayer.visible = false;

                updateSummary(value);
                timeSeriesChartViaduct(value);

                zoomToLayer(pierAccessLayer);

            } else if (value === "N-05") {
                lotLayer.definitionExpression = cpExpression;
                endorsedLotLayer.definitionExpression = cpExpression;
                structureLayer.definitionExpression = cpExpression;
                nloLayer.definitionExpression = cpExpression;
                occupancyLayer.definitionExpression = cpExpression;
                strucOwnershipLayer.definitionExpression = cpExpression;
                treeCuttingLayer.definitionExpression = cpExpression;
                treeCompensationLayer.definitionExpression = cpExpression;
                utilityPointLayer.definitionExpression = cpExpression;
                utilityPointLayer1.definitionExpression = cpExpression;
                utilityLineLayer.definitionExpression = cpExpression;
                utilityLineLayer1.definitionExpression = cpExpression;

                pierAccessLayer.visible = false;
                pnrLayer.definitionExpression = false;

                buildingLayer.visible = false;

                // Viaduct layer has no N-05 so need to hide its chart
                viaductLayer.visible = false;
                viaductChartDiv.style.display = 'none';
                viaductNumberDiv.style.display = 'none';

                updateSummary(value);
                timeSeriesChartViaduct(value);

                zoomToLayer(lotLayer);

            } else {
                lotLayer.definitionExpression = cpExpression;
                endorsedLotLayer.definitionExpression = cpExpression;
                structureLayer.definitionExpression = cpExpression;
                nloLayer.definitionExpression = cpExpression;
                occupancyLayer.definitionExpression = cpExpression;
                strucOwnershipLayer.definitionExpression = cpExpression;
                treeCuttingLayer.definitionExpression = cpExpression;
                treeCompensationLayer.definitionExpression = cpExpression;
                utilityPointLayer.definitionExpression = cpExpression;
                utilityPointLayer1.definitionExpression = cpExpression;
                utilityLineLayer.definitionExpression = cpExpression;
                utilityLineLayer1.definitionExpression = cpExpression;
                pierAccessLayer.definitionExpression = cpExpression;
                viaductLayer.definitionExpression = cpExpression;
                pnrLayer.definitionExpression = cpExpression;

                viaductChartDiv.style.display = 'block';
                viaductNumberDiv.style.display = 'block';

                stationStructuresRendererCP(value);

                updateSummary(value);
                timeSeriesChartViaduct(value);

                zoomToLayer(pierAccessLayer);
            }
        }



        // Contents including chart
        // Total Number
        // Thousand separators function
        function thousands_separators(num) {
            var num_parts = num.toString().split(".");
            num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return num_parts.join(".");
        }

        var highlightSelect;

        const lotNumberDiv = document.getElementById("lotNumberDiv");
        const pteLotNumberDiv = document.getElementById("pteLotNumberDiv");
        const structureNumberDiv = document.getElementById("structureNumberDiv");
        const pteStructureNumberDiv = document.getElementById("pteStructureNumberDiv");
        const nloNumberDiv = document.getElementById("nloNumberDiv");
        const treeNumberDiv = document.getElementById("treeNumberDiv");
        const utilityNumberDiv = document.getElementById("utilityNumberDiv");
        const viaductNumberDiv = document.getElementById("viaductNumberDiv");

        document.getElementById("utilityPointChartDiv").innerHTML = `<br>UTILITY POINT`;
        document.getElementById("utilityLineChartDiv").innerHTML = `<br><br><br>UTILITY LINE`;

        // 1. Total Number of Lots
        function totalNumberOfLots() {
            var totalLot = {
                onStatisticField: "CASE WHEN StatusLA >= 0 THEN 1 ELSE 0 END",
                outStatisticFieldName: "totalLot",
                statisticType: "sum"
            };
            var query = lotLayer.createQuery();
            query.outStatistics = [totalLot];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const LOT_TOTAL = thousands_separators(stats.totalLot);

                lotNumberDiv.innerHTML = `TOTAL LOTS<br><br><b>${LOT_TOTAL}</b>`;
            });
        }

        totalNumberOfLots();

        // Total number of handed-over lots
        function pteNumberLot() {
            var total_pte_lot = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_lot",
                statisticType: "sum"
            };

            var total_lot_N = {
                onStatisticField: "CASE WHEN StatusLA >= 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_lot_N",
                statisticType: "sum"
            };
            var query = lotLayer.createQuery();
            query.outStatistics = [total_pte_lot, total_lot_N];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_lot;
                const totalN = stats.total_lot_N;
                const percPTE = ((pte / totalN) * 100).toFixed(0);

                const value = percPTE == "Infinity" ? "N/A" : percPTE + "% (" + pte + ")";
                pteLotNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
            });
        }
        pteNumberLot();

        // Total number of structures
        function totalNumberOfStructures() {
            var totalStructure = {
                onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "totalStructure",
                statisticType: "count"
            };
            var query = structureLayer.createQuery();
            query.outStatistics = [totalStructure];
            query.returnGeometry = true;

            structureLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
                structureNumberDiv.innerHTML = `TOTAL STRUCTURES<br><br><b>${STRUCTURE_TOTAL}</b>`;
            });
        }
        totalNumberOfStructures();

        // Total number of PTE for structure
        function pteNumberStructure() {
            var total_pte_structure = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_structure",
                statisticType: "sum"
            };

            var total_struc_N = {
                onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_struc_N",
                statisticType: "sum"
            };

            var query = structureLayer.createQuery();
            query.outStatistics = [total_pte_structure, total_struc_N];
            query.returnGeometry = true;

            structureLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_structure;
                const totalN = stats.total_struc_N;
                const percPTE = ((pte / totalN) * 100).toFixed(0);

                const value = percPTE + "% (" + pte + ")";
                pteStructureNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
            });
        }
        pteNumberStructure();

        // Total progress for both points and lines combined
        function totalProgressPt() {
            var total_util_number = {
                onStatisticField: "Status",
                outStatisticFieldName: "total_util_number",
                statisticType: "count"
            };

            var total_prog_util = {
                onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_prog_util",
                statisticType: "sum"
            };

            var query = utilityPointLayer.createQuery();
            query.outStatistics = [total_util_number, total_prog_util];
            query.returnGeometry = true;

            return utilityPointLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const progress = stats.total_prog_util;
                const total = stats.total_util_number;
                const perc = (progress / total) * 100;

                const compileArray = [total, progress];
                return compileArray;
            });
        }

        function totalProgressLine(compileArray) {
            var total_util_number = {
                onStatisticField: "Status",
                outStatisticFieldName: "total_util_number",
                statisticType: "count"
            };

            var total_prog_util = {
                onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_prog_util",
                statisticType: "sum"
            };

            var query = utilityLineLayer.createQuery();
            query.outStatistics = [total_util_number, total_prog_util];
            query.returnGeometry = true;

            utilityLineLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const progress = stats.total_prog_util;
                const total = stats.total_util_number;
                const perc = (progress / total) * 100;

                const totalAll = total + compileArray[0];
                const progressAll = progress + compileArray[1];

                const total_count = thousands_separators(totalAll);
                const totalperc = (progressAll / totalAll) * 100;
                const total_utility = totalperc.toFixed(1);
                utilityNumberDiv.innerHTML = `TOTAL PROGRESS<br><br><b>${total_utility} %</b><br><br>(${total_count})`;
            });
        }

        function totalProgressUtility() {
            totalProgressPt().then(totalProgressLine)
        };
        totalProgressUtility();

        function totalProgressViaduct() {
            var total_viaduct_comp = {
                onStatisticField: "CASE WHEN Status1 = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_viaduct_comp",
                statisticType: "sum"
            };

            var total_viaduct_all = {
                onStatisticField: "Status1",
                outStatisticFieldName: "total_viaduct_all",
                statisticType: "count"
            };

            var query = viaductLayer.createQuery();
            query.outStatistics = [total_viaduct_all, total_viaduct_comp];
            query.returnGeometry = true;

            viaductLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const viaduct_total = stats.total_viaduct_all;
                const viaduct_comp = stats.total_viaduct_comp;

                const PROGRESS = ((viaduct_comp / viaduct_total) * 100).toFixed(1);
                const total = thousands_separators(viaduct_total);

                viaductNumberDiv.innerHTML = `TOTAL PROGRESS<br><br><b>${PROGRESS} %</b><br><br>(${total})`;;
            });
        }
        totalProgressViaduct();

        // Renderer for Building Scene Layer
        function stationStructuresRendererSlide(value) {
            buildingLayer.visible = true;
            const stationExpression = "Station = " + value;
            columnsLayer.definitionExpression = stationExpression;
            floorsLayer.definitionExpression = stationExpression;
            wallsLayer.definitionExpression = stationExpression;
            stFoundationLayer.definitionExpression = stationExpression;
            stFramingLayer.definitionExpression = stationExpression;
            stColumnLayer.definitionExpression = stationExpression;

            columnsLayer.visible = true;
            floorsLayer.visible = true;
            wallsLayer.visible = true;
            stFoundationLayer.visible = true;
            stFramingLayer.visible = true;
            stColumnLayer.visible = true;

            zoomToLayer(stFramingLayer);
        }

        async function stationStructuresRendererCP(value) {
            // without stationStructuresRendererLayerListTrue(), it will not render by clicking layer list button
            await stationStructuresRendererLayerListTrue();
            const stationExpression = "CP = '" + value + "'";
            columnsLayer.definitionExpression = stationExpression;
            floorsLayer.definitionExpression = stationExpression;
            wallsLayer.definitionExpression = stationExpression;
            stFoundationLayer.definitionExpression = stationExpression;
            stFramingLayer.definitionExpression = stationExpression;
            stColumnLayer.definitionExpression = stationExpression;

            /*
            columnsLayer.visible = true;
            floorsLayer.visible = true;
            wallsLayer.visible = true;
            stFoundationLayer.visible = true;
            stFramingLayer.visible = true;
            stColumnLayer.visible = true;
            */

            //zoomToLayer(stFramingLayer);
        }

        function stationStructuresRendererLayerListTrue() {
            columnsLayer.visible = true;
            floorsLayer.visible = true;
            wallsLayer.visible = true;
            stFoundationLayer.visible = true;
            stFramingLayer.visible = true;
            stColumnLayer.visible = true;
        }



        // CHART PANEL FOR LOT
        const LEGEND_FONT_SIZE = "0.9em";
        var root = am5.Root.new("landPieChartDiv");
        root._logo.dispose();

        const statusLot = ["Handed-Over", "Paid", "For Payment Processing",
            "For Legal Pass", "For Appraisal/Offer to Buy",
            "For Expro"];

        function updateChartLot(cpValue) {
            root.container.children.clear();
            // First, define statuses
            var total_handedover_lot = {
                onStatisticField: "CASE WHEN StatusLA = 0 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_handedover_lot",
                statisticType: "sum"
            };

            var total_paid_lot = {
                onStatisticField: "CASE WHEN StatusLA = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_paid_lot",
                statisticType: "sum"
            };

            var total_payp_lot = {
                onStatisticField: "CASE WHEN StatusLA = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_payp_lot",
                statisticType: "sum"
            };

            var total_legalpass_lot = {
                onStatisticField: "CASE WHEN StatusLA = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_legalpass_lot",
                statisticType: "sum"
            };

            var total_otb_lot = {
                onStatisticField: "CASE WHEN StatusLA = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_otb_lot",
                statisticType: "sum"
            };

            var total_expro_lot = {
                onStatisticField: "CASE WHEN StatusLA = 5 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_expro_lot",
                statisticType: "sum"
            };

            var query = lotLayer.createQuery();
            query.outStatistics = [total_handedover_lot, total_paid_lot, total_payp_lot,
                total_legalpass_lot, total_otb_lot, total_expro_lot];
            query.returnGeometry = true;

            return lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const handedover = stats.total_handedover_lot;
                const paid = stats.total_paid_lot;
                const payp = stats.total_payp_lot;
                const legalpass = stats.total_legalpass_lot;
                const otb = stats.total_otb_lot;
                const expro = stats.total_expro_lot;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root.setThemes([
                    am5themes_Animated.new(root),
                    am5themes_Responsive.new(root)
                ]);


                // Create chart
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                var chart = root.container.children.push(
                    am5percent.PieChart.new(root, {

                        //centerY: am5.percent(-2), //-10
                        //y: am5.percent(-30), // -30
                        layout: root.verticalLayout
                    })
                );

                // Create series
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                var pieSeries = chart.series.push(
                    am5percent.PieSeries.new(root, {
                        name: "Series",
                        categoryField: "category",
                        valueField: "value",
                        //legendLabelText: "[{fill}]{category}[/]",
                        legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
                        radius: am5.percent(85), // outer radius
                        innerRadius: am5.percent(40),
                    })
                );

                // Set data
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                // Set slice opacity and stroke color
                pieSeries.slices.template.setAll({
                    fillOpacity: 0.9,
                    stroke: am5.color("#ffffff"),
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    templateField: "sliceSettings"
                });

                // Disabling labels and ticks
                pieSeries.labels.template.set("visible", false);
                pieSeries.ticks.template.set("visible", false);

                //pieSeries.appear(1000, 100)
                pieSeries.slices.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;

                    if (SELECTED == statusLot[0]) {
                        selectedStatus = 0;
                    } else if (SELECTED == statusLot[1]) {
                        selectedStatus = 1;
                    } else if (SELECTED == statusLot[2]) {
                        selectedStatus = 2;
                    } else if (SELECTED == statusLot[3]) {
                        selectedStatus = 3;
                    } else if (SELECTED == statusLot[4]) {
                        selectedStatus = 4;
                    } else if (SELECTED == statusLot[5]) {
                        selectedStatus = 5;
                    } else {
                        selectedStatus = null;
                    }

                    var query = lotLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "StatusLA = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.when(function () {
                        view.whenLayerView(lotLayer).then(function (layerView) {
                            //chartLayerView = layerView;

                            lotLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                lotLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "StatusLA = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                });

                pieSeries.data.setAll(
                    [
                        {
                            category: statusLot[0],
                            value: handedover,
                            sliceSettings: {
                                fill: am5.color("#00c5ff")
                            }
                        },
                        {
                            category: statusLot[1],
                            value: paid,
                            sliceSettings: {
                                fill: am5.color("#70ad47")
                            }
                        },
                        {
                            category: statusLot[2],
                            value: payp,
                            sliceSettings: {
                                fill: am5.color("#0070ff")
                            }
                        },
                        {
                            category: statusLot[3],
                            value: legalpass,
                            sliceSettings: {
                                fill: am5.color("#ffff00")
                            }
                        },
                        {
                            category: statusLot[4],
                            value: otb,
                            sliceSettings: {
                                fill: am5.color("#ffaa00")
                            }
                        },
                        {
                            category: statusLot[5],
                            value: expro,
                            sliceSettings: {
                                fill: am5.color("#ff0000")
                            }
                        },
                    ]
                );

                // Legend
                // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                var legend = chart.children.push(am5.Legend.new(root, {
                    centerX: am5.percent(50),
                    x: am5.percent(50),
                    layout: root.verticalLayout,
                    marginBottom: 10
                }));
                legend.data.setAll(pieSeries.dataItems);

                // Change the size of legend markers
                legend.markers.template.setAll({
                    width: 18,
                    height: 18,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    stroke: am5.color("#ffffff")

                });

                // Change the marker shape
                legend.markerRectangles.template.setAll({
                    cornerRadiusTL: 10,
                    cornerRadiusTR: 10,
                    cornerRadiusBL: 10,
                    cornerRadiusBR: 10,
                });

                // To align legend items: valueLabels right, labels to left
                // 1. fix width of valueLabels
                // 2. dynamically change width of labels by screen size

                const valueLabelsWidth = 50;

                // Responsive legend 
                // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                chart.onPrivate("width", function (width) {
                    let box = document.querySelector('.box');
                    const boxWidth = box.offsetWidth;
                    var availableSpace = Math.max(width - chart.width() - 150, 180);
                    //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                    legend.labels.template.setAll({
                        width: availableSpace,
                        maxWidth: availableSpace
                    });
                });

                // Change legend labelling properties
                // To have responsive font size, do not set font size
                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff")
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                legend.valueLabels.template.setAll({
                    textAlign: "right",
                    width: valueLabelsWidth,
                    fill: am5.color("#ffffff")
                    //fontSize: LEGEND_FONT_SIZE,
                })

                legend.itemContainers.template.setAll({
                    // set space between legend items
                    paddingTop: 1.1,
                    paddingBottom: 2,
                });

                pieSeries.appear(1000, 100);
            }); // End of queryFeatures
        } // End of updateChartLot()
        updateChartLot();

        var root2 = am5.Root.new("chartMoaLotDiv");
        root2._logo.dispose();
        var myTheme = am5.Theme.new(root2);

        myTheme.rule("Grid", ["base"]).setAll({
            strokeOpacity: 0,
        });
        const statusMOA = ["For Negotiation",
            "Expropriation",
            "Donation",
            "CA 141",
            "No Need to Acquire"
        ];

        function updateMoaChartLot(cpValue) {
            root2.container.children.clear();

            var total_nego_lot = {
                onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_nego_lot",
                statisticType: "sum"
            };

            var total_expro_lot = {
                onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_expro_lot",
                statisticType: "sum"
            };

            var total_donate_lot = {
                onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_donate_lot",
                statisticType: "sum"
            };

            var total_ca141_lot = {
                onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_ca141_lot",
                statisticType: "sum"
            };

            var total_noneed_lot = {
                onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_noneed_lot",
                statisticType: "sum"
            };

            var query = lotLayer.createQuery();
            query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const nego = stats.total_nego_lot;
                const expro = stats.total_expro_lot;
                const donate = stats.total_donate_lot;
                const ca141 = stats.total_ca141_lot;
                const noneed = stats.total_noneed_lot;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root2.setThemes([
                    am5themes_Animated.new(root2),
                    myTheme
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root2.container.children.push(
                    am5xy.XYChart.new(root2, {
                        panX: false,
                        panY: false,
                        wheelX: "none",
                        wheelY: "none",
                        paddingLeft: 0,

                    })
                );

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root2, {
                    minGridDistance: 5,
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    inversed: true,
                    stroke: am5.color("#ffffff")
                });
                yRenderer.grid.template.set("location", 1);

                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root2, {
                        maxDeviation: 0,
                        categoryField: "category",
                        renderer: yRenderer,
                    })
                );

                // Remove grid lines
                yAxis.get("renderer").grid.template.set("forceHidden", true);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root2, {
                        maxDeviation: 0,
                        min: 0,
                        renderer: am5xy.AxisRendererX.new(root2, {
                            visible: true,
                            strokeOpacity: 1,
                            strictMinMax: true,
                            calculateTotals: true,
                            strokeWidth: 1,
                            stroke: am5.color("#ffffff"),
                        })
                    })
                );
                // Remove grid lines
                xAxis.get("renderer").grid.template.set("forceHidden", true);

                // Label properties for yAxis (category axis)
                yAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                xAxis.get("renderer").labels.template.setAll({
                    fill: am5.color("#ffffff"),
                    fontSize: 10
                });

                // Create series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                var series = chart.series.push(
                    am5xy.ColumnSeries.new(root2, {
                        name: "Series 1",
                        xAxis: xAxis,
                        yAxis: yAxis,
                        valueXField: "value",
                        sequencedInterpolation: true,
                        categoryYField: "category",
                    })
                );

                var columnTemplate = series.columns.template;

                columnTemplate.setAll({
                    draggable: true,
                    cursorOverStyle: "pointer",
                    tooltipText: "{value}",
                    cornerRadiusBR: 10,
                    cornerRadiusTR: 10,
                    strokeOpacity: 0
                });

                // Add Label bullet
                series.bullets.push(function () {
                    return am5.Bullet.new(root2, {
                        locationY: 1,
                        sprite: am5.Label.new(root2, {
                            text: "{value}",
                            fill: root2.interfaceColors.get("alternativeText"),
                            centerY: 3,
                            centerX: am5.p50,
                            fontSize: 14,
                            populateText: true
                        })
                    });
                });

                // Use different color by column
                columnTemplate.adapters.add("fill", (fill, target) => {
                    return chart.get("colors").getIndex(series.columns.indexOf(target));
                });

                columnTemplate.adapters.add("stroke", (stroke, target) => {
                    return chart.get("colors").getIndex(series.columns.indexOf(target));
                });


                series.columns.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;
                    if (SELECTED == statusMOA[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == statusMOA[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == statusMOA[2]) {
                        selectedStatus = 3;
                    } else if (SELECTED == statusMOA[3]) {
                        selectedStatus = 4;
                    } else if (SELECTED == statusMOA[4]) {
                        selectedStatus = 5;
                    }

                    var query = lotLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "MoA = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.whenLayerView(lotLayer).then(function (layerView) {
                        //CHART_ELEMENT.style.visibility = "visible";

                        lotLayer.queryFeatures(query).then(function (results) {
                            const RESULT_LENGTH = results.features;
                            const ROW_N = RESULT_LENGTH.length;

                            let objID = [];
                            for (var i = 0; i < ROW_N; i++) {
                                var obj = results.features[i].attributes.OBJECTID;
                                objID.push(obj);
                            }

                            var queryExt = new Query({
                                objectIds: objID
                            });

                            lotLayer.queryExtent(queryExt).then(function (result) {
                                if (result.extent) {
                                    view.goTo(result.extent)
                                }
                            });

                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                            highlightSelect = layerView.highlight(objID);

                            view.on("click", function () {
                                layerView.filter = null;
                                highlightSelect.remove();
                            });
                        });
                        layerView.filter = {
                            where: "MoA = " + selectedStatus
                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                        };
                    }); // End of whenLayerView
                });

                // Chart title
                chart.children.unshift(am5.Label.new(root2, {
                    text: "MODE OF ACQUISITION",
                    fontSize: 16,
                    fontWeight: "normal",
                    textAlign: "left",
                    fill: am5.color("#f7f5f7"),
                    paddingTop: -15,
                    paddingBottom: 0,
                }));
                // Set data
                var data = [
                    {
                        category: statusMOA[0],
                        value: nego
                    },
                    {
                        category: statusMOA[1],
                        value: expro
                    },
                    {
                        category: statusMOA[2],
                        value: donate
                    },
                    {
                        category: statusMOA[3],
                        value: ca141
                    },
                    {
                        category: statusMOA[4],
                        value: noneed
                    },
                ]; // End of chart

                yAxis.data.setAll(data);
                series.data.setAll(data);

                // Make stuff animate on load
                // https://www.amcharts.com/docs/v5/concepts/animations/
                series.appear(1000);
                chart.appear(1000, 100);


            }); // End of queryFeatures

        } // End of updateMOAChartLot
        updateMoaChartLot();

        // CHART PANEL FOR STRUCTURE
        var root3 = am5.Root.new("structurePieChartDiv");
        root3._logo.dispose();

        class MyTheme extends am5.Theme {
            setupDefaultRules() {
                var theme = this;

                const gap = 4;
                const rotation = 135;
                const strokeWidth = 1.1;
                const fillOpacity = 0;
                const width = 10;
                const height = 10;


                this.patterns = [
                    am5.LinePattern.new(this._root, {
                        color: am5.color("#00C5FF"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height
                    }),

                    am5.LinePattern.new(this._root, {
                        color: am5.color("#70AD47"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height
                    }),

                    am5.LinePattern.new(this._root, {
                        color: am5.color("#0070FF"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height
                    }),

                    am5.LinePattern.new(this._root, {
                        color: am5.color("#FFFF00"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height

                    }),
                    am5.LinePattern.new(this._root, {
                        color: am5.color("#FFAA00"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height
                    }),

                    am5.LinePattern.new(this._root, {
                        color: am5.color("#FF0000"),
                        gap: gap,
                        rotation: rotation,
                        strokeWidth: strokeWidth,
                        fillOpacity: fillOpacity,
                        width: width,
                        height: height
                    })
                ];

                this.currentPattern = 0;
                this.rule("Slice").setAll({
                    fillOpacity: 0
                });

                this.rule("Slice").setup = function (target) {
                    target.set("fillPattern", theme.patterns[theme.currentPattern]);
                    theme.currentPattern++;
                    if (theme.currentPattern == theme.patterns.length) {
                        theme.currentPattern = 0;
                    }
                };
            }
        }

        const statusStructure = ["Dismantling/Clearing", "Paid", "For Payment Processing",
            "For Legal Pass", "For Appraisal/Offer to Compensate",
            "LBP Account Opening"];

        async function updateChartStructure(cpValue) {
            root3.container.children.clear();

            var total_clear_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_clear_lot",
                statisticType: "sum"
            };

            var total_paid_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_paid_lot",
                statisticType: "sum"
            };

            var total_payp_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_payp_lot",
                statisticType: "sum"
            };

            var total_legalpass_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_legalpass_lot",
                statisticType: "sum"
            };

            var total_otc_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 5 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_otc_lot",
                statisticType: "sum"
            };

            var total_lbp_lot = {
                onStatisticField: "CASE WHEN StatusStruc = 6 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_lbp_lot",
                statisticType: "sum"
            };

            var query = structureLayer.createQuery();
            query.outStatistics = [total_clear_lot, total_paid_lot, total_payp_lot,
                total_legalpass_lot, total_otc_lot, total_lbp_lot];
            query.returnGeometry = true;

            return structureLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const clear = stats.total_clear_lot;
                const paid = stats.total_paid_lot;
                const payp = stats.total_payp_lot;
                const legalpass = stats.total_legalpass_lot;
                const otc = stats.total_otc_lot;
                const lbp = stats.total_lbp_lot;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root3.setThemes([
                    am5themes_Animated.new(root3),
                    am5themes_Responsive.new(root3),
                    MyTheme.new(root3)
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                var chart = root3.container.children.push(
                    am5percent.PieChart.new(root3, {

                        //centerY: am5.percent(-2), //-10
                        //y: am5.percent(-30), // -30
                        layout: root3.verticalLayout
                    })
                );

                // Create series
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                var pieSeries = chart.series.push(
                    am5percent.PieSeries.new(root3, {
                        name: "Series",
                        categoryField: "category",
                        valueField: "value",
                        //legendLabelText: "[{fill}]{category}[/]",
                        legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
                        radius: am5.percent(85), // outer radius
                        innerRadius: am5.percent(40),
                    })
                );

                // Set slice opacity and stroke color
                pieSeries.slices.template.setAll({
                    //fillOpacity: 0.9,
                    stroke: am5.color("#ffffff"),
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    tooltipText: "{category}: {value}",
                    tooltipY: am5.percent(10),
                    //fill: am5.color("#1e8553")//root3.interfaceColors.get("alternativeText"),
                });


                // Disabling labels and ticks
                pieSeries.labels.template.set("visible", false);
                pieSeries.ticks.template.set("visible", false);

                pieSeries.slices.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;

                    if (SELECTED == statusStructure[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == statusStructure[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == statusStructure[2]) {
                        selectedStatus = 3;
                    } else if (SELECTED == statusStructure[3]) {
                        selectedStatus = 4;
                    } else if (SELECTED == statusStructure[4]) {
                        selectedStatus = 5;
                    } else if (SELECTED == statusStructure[5]) {
                        selectedStatus = 6;
                    } else {
                        selectedStatus = null;
                    }

                    var query = structureLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "StatusStruc = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    // Zoom, filter, and highlight selected chart categories 
                    view.when(function () {
                        view.whenLayerView(structureLayer).then(function (layerView) {

                            structureLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                structureLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures

                            layerView.filter = {
                                where: "StatusStruc = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                });

                pieSeries.data.setAll(
                    [
                        {
                            category: statusStructure[0],
                            value: clear,
                        },
                        {
                            category: statusStructure[1],
                            value: paid,
                        },
                        {
                            category: statusStructure[2],
                            value: payp,
                        },
                        {
                            category: statusStructure[3],
                            value: legalpass,
                        },
                        {
                            category: statusStructure[4],
                            value: otc,
                        },
                        {
                            category: statusStructure[5],
                            value: lbp,
                        }
                    ]
                );

                // Legend
                // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                var legend = chart.children.push(am5.Legend.new(root3, {
                    centerX: am5.percent(50),
                    x: am5.percent(50),
                    layout: root3.verticalLayout,
                    marginBottom: 10
                }));
                legend.data.setAll(pieSeries.dataItems);

                // Change the size of legend markers
                legend.markers.template.setAll({
                    width: 18,
                    height: 18,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    stroke: am5.color("#ffffff"),

                });

                // Change the marker shape
                legend.markerRectangles.template.setAll({
                    cornerRadiusTL: 10,
                    cornerRadiusTR: 10,
                    cornerRadiusBL: 10,
                    cornerRadiusBR: 10,
                });

                const valueLabelsWidth = 50;

                // Responsive legend 
                // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                chart.onPrivate("width", function (width) {
                    let box = document.querySelector('.box2');
                    const boxWidth = box.offsetWidth;
                    var availableSpace = Math.max(width - chart.width() - 150, 180);
                    //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                    legend.labels.template.setAll({
                        width: availableSpace,
                        maxWidth: availableSpace
                    });
                });

                // Change legend labelling properties
                // To have responsive font size, do not set font size
                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff")
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                legend.valueLabels.template.setAll({
                    textAlign: "right",
                    width: valueLabelsWidth,
                    fill: am5.color("#ffffff")
                    //fontSize: LEGEND_FONT_SIZE,
                })

                legend.itemContainers.template.setAll({
                    // set space between legend items
                    paddingTop: 1.1,
                    paddingBottom: 1.1,
                });

                pieSeries.appear(1000, 100);

            });  // End of queryFeature       
        } // End of updateChartStructure()
        updateChartStructure();


        var root4 = am5.Root.new("chartMoaStructureDiv");
        root4._logo.dispose();

        var myTheme = am5.Theme.new(root4);
        myTheme.rule("Grid", ["base"]).setAll({
            strokeOpacity: 0,
        });

        const statusMoaStructure = ["For Negotiation",
            "Expropriation",
            "Donation",
            "No Need to Acquire"
        ];

        async function updateMoaChartStructure(cpValue) {
            root4.container.children.clear();

            var total_nego_lot = {
                onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_nego_lot",
                statisticType: "sum"
            };

            var total_expro_lot = {
                onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_expro_lot",
                statisticType: "sum"
            };

            var total_donate_lot = {
                onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_donate_lot",
                statisticType: "sum"
            };

            var total_noneed_lot = {
                onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_noneed_lot",
                statisticType: "sum"
            };

            var query = structureLayer.createQuery();
            query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_noneed_lot];
            query.returnGeometry = true;

            structureLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const nego = stats.total_nego_lot;
                const expro = stats.total_expro_lot;
                const donate = stats.total_donate_lot;
                const noneed = stats.total_noneed_lot;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root4.setThemes([
                    am5themes_Animated.new(root4),
                    myTheme
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root4.container.children.push(
                    am5xy.XYChart.new(root4, {
                        panX: false,
                        panY: false,
                        wheelX: "none",
                        wheelY: "none",
                        paddingLeft: 0,
                    })
                );

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root4, {
                    minGridDistance: 5,
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    inversed: true,
                    stroke: am5.color("#ffffff")
                });
                yRenderer.grid.template.set("location", 1);

                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root4, {
                        maxDeviation: 0,
                        categoryField: "category",
                        renderer: yRenderer,
                    })
                );

                // Remove grid lines
                yAxis.get("renderer").grid.template.set("forceHidden", true);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root4, {
                        maxDeviation: 0,
                        min: 0,
                        renderer: am5xy.AxisRendererX.new(root4, {
                            visible: true,
                            strokeOpacity: 1,
                            strictMinMax: true,
                            calculateTotals: true,
                            strokeWidth: 1,
                            stroke: am5.color("#ffffff"),
                        })
                    })
                );
                // Remove grid lines
                xAxis.get("renderer").grid.template.set("forceHidden", true);


                // Label properties for yAxis (category axis)
                yAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                xAxis.get("renderer").labels.template.setAll({
                    fill: am5.color("#ffffff"),
                });

                // Create series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                var series = chart.series.push(
                    am5xy.ColumnSeries.new(root4, {
                        name: "Series 1",
                        xAxis: xAxis,
                        yAxis: yAxis,
                        valueXField: "value",
                        sequencedInterpolation: true,
                        categoryYField: "category",
                    })
                );

                var columnTemplate = series.columns.template;

                columnTemplate.setAll({
                    draggable: true,
                    cursorOverStyle: "pointer",
                    tooltipText: "{value}",
                    cornerRadiusBR: 10,
                    cornerRadiusTR: 10,
                    strokeOpacity: 0
                });

                // Add Label bullet
                series.bullets.push(function () {
                    return am5.Bullet.new(root4, {
                        locationY: 1,
                        sprite: am5.Label.new(root4, {
                            text: "{value}",
                            fill: root4.interfaceColors.get("alternativeText"),
                            centerY: 1.3,
                            centerX: am5.p50,
                            fontSize: 14,
                            populateText: true
                        })
                    });
                });

                // Use different color by column
                columnTemplate.adapters.add("fill", (fill, target) => {
                    return chart.get("colors").getIndex(series.columns.indexOf(target));
                });

                columnTemplate.adapters.add("stroke", (stroke, target) => {
                    return chart.get("colors").getIndex(series.columns.indexOf(target));
                });


                series.columns.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;

                    if (SELECTED == statusMoaStructure[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == statusMoaStructure[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == statusMoaStructure[2]) {
                        selectedStatus = 3;
                    } else if (SELECTED == statusMoaStructure[3]) {
                        selectedStatus = 4;
                    } else {
                        selectedStatus = null;
                    }

                    var query = structureLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "MoA = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.whenLayerView(structureLayer).then(function (layerView) {
                        //CHART_ELEMENT.style.visibility = "visible";

                        structureLayer.queryFeatures(query).then(function (results) {
                            const RESULT_LENGTH = results.features;
                            const ROW_N = RESULT_LENGTH.length;

                            let objID = [];
                            for (var i = 0; i < ROW_N; i++) {
                                var obj = results.features[i].attributes.OBJECTID;
                                objID.push(obj);
                            }

                            var queryExt = new Query({
                                objectIds: objID
                            });

                            structureLayer.queryExtent(queryExt).then(function (result) {
                                if (result.extent) {
                                    view.goTo(result.extent)
                                }
                            });

                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                            highlightSelect = layerView.highlight(objID);

                            view.on("click", function () {
                                layerView.filter = null;
                                highlightSelect.remove();
                            });
                        });
                        layerView.filter = {
                            where: "MoA = " + selectedStatus
                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                        };
                    }); // End of whenLayerVie
                });

                // Chart title
                chart.children.unshift(am5.Label.new(root4, {
                    text: "MODE OF ACQUISITION",
                    fontSize: 14,
                    fontWeight: "normal",
                    textAlign: "left",
                    fill: am5.color("#f7f5f7"),
                    paddingTop: -15,
                    paddingBottom: 0,
                }));
                // Set data
                var data = [
                    {
                        category: statusMoaStructure[0],
                        value: nego
                    },
                    {
                        category: statusMoaStructure[1],
                        value: expro
                    },
                    {
                        category: statusMoaStructure[2],
                        value: donate
                    },
                    {
                        category: statusMoaStructure[3],
                        value: noneed
                    }
                ];

                yAxis.data.setAll(data);
                series.data.setAll(data);


                // Make stuff animate on load
                // https://www.amcharts.com/docs/v5/concepts/animations/
                series.appear(1000);
                chart.appear(1000, 100);

            }); // End of queryFeatures
        } // End of updateS_MOAChartStructure
        updateMoaChartStructure();

        var root5 = am5.Root.new("nloPieChartDiv");
        root5._logo.dispose();

        const statusISF = ["Relocated", "Paid", "For Payment Processing",
            "For Legal Pass", "For Appraisal/OtC/Requirements for Other Entitlements",
            "LBP Account Opening"]

        async function updateChartNLO(cpValue) {
            root5.container.children.clear();

            var total_relocated_lot = {
                onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_relocated_lot",
                statisticType: "sum"
            };

            var total_paid_lot = {
                onStatisticField: "CASE WHEN StatusRC = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_paid_lot",
                statisticType: "sum"
            };

            var total_payp_lot = {
                onStatisticField: "CASE WHEN StatusRC = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_payp_lot",
                statisticType: "sum"
            };

            var total_legalpass_lot = {
                onStatisticField: "CASE WHEN StatusRC = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_legalpass_lot",
                statisticType: "sum"
            };

            var total_otc_lot = {
                onStatisticField: "CASE WHEN StatusRC = 5 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_otc_lot",
                statisticType: "sum"
            };

            var total_lbp_lot = {
                onStatisticField: "CASE WHEN StatusRC = 6 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_lbp_lot",
                statisticType: "sum"
            };

            var query = nloLayer.createQuery();
            query.outStatistics = [total_relocated_lot, total_paid_lot, total_payp_lot,
                total_legalpass_lot, total_otc_lot, total_lbp_lot];
            query.returnGeometry = true;

            return nloLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const clear = stats.total_relocated_lot;
                const paid = stats.total_paid_lot;
                const payp = stats.total_payp_lot;
                const legalpass = stats.total_legalpass_lot;
                const otc = stats.total_otc_lot;
                const lbp = stats.total_lbp_lot;

                const total_nlo = thousands_separators(clear + paid + payp + legalpass + otc + lbp);
                nloNumberDiv.innerHTML = `TOTAL NLOs<br><br><b>${total_nlo}</b>`;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root5.setThemes([
                    am5themes_Animated.new(root5),
                    am5themes_Responsive.new(root5)
                ]);


                // Create chart
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                var chart = root5.container.children.push(
                    am5percent.PieChart.new(root5, {

                        //centerY: am5.percent(-2), //-10
                        //y: am5.percent(-30), // -30
                        layout: root5.verticalLayout
                    })
                );

                // Create series
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                var pieSeries = chart.series.push(
                    am5percent.PieSeries.new(root5, {
                        name: "Series",
                        categoryField: "category",
                        valueField: "value",
                        //legendLabelText: "[{fill}]{category}[/]",
                        legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
                        radius: am5.percent(85), // outer radius
                        innerRadius: am5.percent(40),
                    })
                );

                // Set data
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                // To set slice color, you need to add this before data.setAll
                /*
                pieSeries.get("colors").set("colors", [
                  am5.color("#70ad47"),
                  am5.color("#0070FF"),
                  am5.color("#FFFF00"),
                  am5.color("#FFAA00"),
                  am5.color("#FF0000"),
                  am5.color("#00734C"),
                ]);
                */

                // Set slice opacity and stroke color
                pieSeries.slices.template.setAll({
                    fillOpacity: 0.9,
                    stroke: am5.color("#ffffff"),
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    templateField: "sliceSettings"
                });


                // Disabling labels and ticks
                pieSeries.labels.template.set("visible", false);
                pieSeries.ticks.template.set("visible", false);


                //pieSeries.appear(1000, 100)
                pieSeries.slices.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;
                    if (SELECTED == statusISF[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == statusISF[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == statusISF[2]) {
                        selectedStatus = 3;
                    } else if (SELECTED == statusISF[3]) {
                        selectedStatus = 4;
                    } else if (SELECTED == statusISF[4]) {
                        selectedStatus = 5;
                    } else if (SELECTED == statusISF[5]) {
                        selectedStatus = 6;
                    } else {
                        selectedStatus = null;
                    }

                    var query = nloLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "StatusRC = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.when(function () {
                        view.whenLayerView(nloLayer).then(function (layerView) {
                            //chartLayerView = layerView;

                            nloLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                nloLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "StatusRC = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                });

                pieSeries.data.setAll(
                    [
                        {
                            category: statusISF[0],
                            value: clear,
                            sliceSettings: {
                                fill: am5.color("#00C5FF")
                            }
                        },
                        {
                            category: statusISF[1],
                            value: paid,
                            sliceSettings: {
                                fill: am5.color("#70AD47")
                            }
                        },
                        {
                            category: statusISF[2],
                            value: payp,
                            sliceSettings: {
                                fill: am5.color("#0070FF")
                            }
                        },
                        {
                            category: statusISF[3],
                            value: legalpass,
                            sliceSettings: {
                                fill: am5.color("#FFFF00")
                            }
                        },
                        {
                            category: statusISF[4],
                            value: otc,
                            sliceSettings: {
                                fill: am5.color("#FFAA00")
                            }
                        },
                        {
                            category: statusISF[5],
                            value: lbp,
                            sliceSettings: {
                                fill: am5.color("#FF0000")
                            }
                        }
                    ]
                );


                // Legend
                // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                var legend = chart.children.push(am5.Legend.new(root5, {
                    centerX: am5.percent(50),
                    x: am5.percent(50),
                    layout: root5.verticalLayout,
                    marginBottom: 10
                }));
                legend.data.setAll(pieSeries.dataItems);

                // Change the size of legend markers
                legend.markers.template.setAll({
                    width: 18,
                    height: 18,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    stroke: am5.color("#ffffff")

                });

                // Change the marker shape
                legend.markerRectangles.template.setAll({
                    cornerRadiusTL: 10,
                    cornerRadiusTR: 10,
                    cornerRadiusBL: 10,
                    cornerRadiusBR: 10,
                });

                // To align legend items: valueLabels right, labels to left
                // 1. fix width of valueLabels
                // 2. dynamically change width of labels by screen size

                const valueLabelsWidth = 50;

                // Responsive legend 
                // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                chart.onPrivate("width", function (width) {
                    let box = document.querySelector('.box3');
                    const boxWidth = box.offsetWidth;
                    var availableSpace = Math.max(width - chart.width() - 150, 180);
                    //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                    legend.labels.template.setAll({
                        width: availableSpace,
                        maxWidth: availableSpace
                    });
                });

                // Change legend labelling properties
                // To have responsive font size, do not set font size
                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff")
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                legend.valueLabels.template.setAll({
                    textAlign: "right",
                    width: valueLabelsWidth,
                    fill: am5.color("#ffffff")
                    //fontSize: LEGEND_FONT_SIZE,
                })

                legend.itemContainers.template.setAll({
                    // set space between legend items
                    paddingTop: 1.1,
                    paddingBottom: 2,
                });

                pieSeries.appear(1000, 100);

            });  // End of queryFeature                 
        } // End of updateChartNLO()
        updateChartNLO();

        var root6 = am5.Root.new("treeCuttingPieChartDiv");
        root6._logo.dispose();

        const treeCutStatus = ["Cut/Earthballed", "Permit Acquired", "Submitted to DENR",
            "Ongoing Acquisition of Application Documents"];

        function updateChartCutting(cpValue) {
            root6.container.children.clear();

            var total_cutearthb = {
                onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_cutearthb",
                statisticType: "sum"
            };

            var total_permit = {
                onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_permit",
                statisticType: "sum"
            };

            var total_denr = {
                onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_denr",
                statisticType: "sum"
            };

            var total_ongoing = {
                onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_ongoing",
                statisticType: "sum"
            };

            var query = treeCuttingLayer.createQuery();
            query.outStatistics = [total_cutearthb, total_permit, total_denr, total_ongoing];
            query.returnGeometry = true;

            treeCuttingLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const cutEarthb = stats.total_cutearthb;
                const permit = stats.total_permit;
                const denr = stats.total_denr;
                const ongoing = stats.total_ongoing;

                const total_trees = thousands_separators(cutEarthb + permit + denr + ongoing);

                treeNumberDiv.innerHTML = `TOTAL TREEs<br><br><b>${total_trees}</b>`;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root6.setThemes([
                    am5themes_Animated.new(root6),
                    am5themes_Responsive.new(root6)
                ]);


                // Create chart
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                var chart = root6.container.children.push(
                    am5percent.PieChart.new(root6, {

                        //centerY: am5.percent(-2), //-10
                        //y: am5.percent(-30), // -30
                        layout: root6.verticalLayout
                    })
                );

                // Add image in the middle
                chart.children.push(am5.Picture.new(root6, {
                    width: 39,
                    height: 39,
                    x: am5.percent(50),
                    y: am5.percent(50),
                    centerX: am5.percent(50),
                    centerY: am5.percent(220),
                    src: "https://EijiGorilla.github.io/Symbols/Tree_Cutting_Logo.svg"
                }));

                // Create series
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                var pieSeries = chart.series.push(
                    am5percent.PieSeries.new(root6, {
                        name: "Series",
                        categoryField: "category",
                        valueField: "value",
                        //legendLabelText: "[{fill}]{category}[/]",
                        legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
                        radius: am5.percent(85), // outer radius
                        innerRadius: am5.percent(40),
                        scale: 0.8
                    })
                );

                // Set data
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                // Set slice opacity and stroke color
                pieSeries.slices.template.setAll({
                    fillOpacity: 0.9,
                    stroke: am5.color("#ffffff"),
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    templateField: "sliceSettings"
                });

                // Disabling labels and ticks
                pieSeries.labels.template.set("visible", false);
                pieSeries.ticks.template.set("visible", false);

                //pieSeries.appear(1000, 100)
                pieSeries.slices.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;

                    if (SELECTED == treeCutStatus[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == treeCutStatus[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == treeCutStatus[2]) {
                        selectedStatus = 3;
                    } else if (SELECTED == treeCutStatus[3]) {
                        selectedStatus = 4;
                    } else {
                        selectedStatus = null;
                    }

                    var query = treeCuttingLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "Status = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.when(function () {
                        view.whenLayerView(treeCuttingLayer).then(function (layerView) {
                            //chartLayerView = layerView;

                            treeCuttingLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                treeCuttingLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "Status = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                });

                pieSeries.data.setAll(
                    [
                        {
                            category: treeCutStatus[0],
                            value: cutEarthb,
                            sliceSettings: {
                                fill: am5.color("#71AB48")
                            }
                        },
                        {
                            category: treeCutStatus[1],
                            value: permit,
                            sliceSettings: {
                                fill: am5.color("#FFFF00")
                            }
                        },
                        {
                            category: treeCutStatus[2],
                            value: denr,
                            sliceSettings: {
                                fill: am5.color("#FFAA00")
                            }
                        },
                        {
                            category: treeCutStatus[3],
                            value: ongoing,
                            sliceSettings: {
                                fill: am5.color("#FF0000")
                            }
                        },
                    ]
                );

                // Legend
                // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                var legend = chart.children.push(am5.Legend.new(root6, {
                    centerX: am5.percent(50),
                    x: am5.percent(50),
                    layout: root6.verticalLayout,
                    marginBottom: 10
                }));
                legend.data.setAll(pieSeries.dataItems);

                // Change the size of legend markers
                legend.markers.template.setAll({
                    width: 18,
                    height: 18,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    stroke: am5.color("#ffffff")

                });

                // Change the marker shape
                legend.markerRectangles.template.setAll({
                    cornerRadiusTL: 10,
                    cornerRadiusTR: 10,
                    cornerRadiusBL: 10,
                    cornerRadiusBR: 10,
                });

                // To align legend items: valueLabels right, labels to left
                // 1. fix width of valueLabels
                // 2. dynamically change width of labels by screen size

                const valueLabelsWidth = 50;

                // Responsive legend 
                // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                chart.onPrivate("width", function (width) {
                    let box = document.querySelector('.box4');
                    const boxWidth = box.offsetWidth;
                    var availableSpace = Math.max(width - chart.width() - 150, 180);
                    //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                    legend.labels.template.setAll({
                        width: availableSpace,
                        maxWidth: availableSpace
                    });
                });

                // Change legend labelling properties
                // To have responsive font size, do not set font size
                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff")
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                legend.valueLabels.template.setAll({
                    textAlign: "right",
                    width: valueLabelsWidth,
                    fill: am5.color("#ffffff")
                    //fontSize: LEGEND_FONT_SIZE,
                })

                legend.itemContainers.template.setAll({
                    // set space between legend items
                    paddingTop: 1.1,
                    paddingBottom: 2,
                });

                pieSeries.appear(1000, 100);
            }); // End of queryFeatures
        } // End of //updateChart
        updateChartCutting();

        var root7 = am5.Root.new("treeCompensationPieChartDiv");
        root7._logo.dispose();

        const treeCompen = ["Non-Compensable", "For Processing", "Compensated"];

        function updateChartTreeComp(cpValue) {
            root7.container.children.clear();

            var total_noncompen = {
                onStatisticField: "CASE WHEN Compensation = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_noncompen",
                statisticType: "sum"
            };

            var total_processing = {
                onStatisticField: "CASE WHEN Compensation = 2 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_processing",
                statisticType: "sum"
            };

            var total_comp = {
                onStatisticField: "CASE WHEN Compensation = 3 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_comp",
                statisticType: "sum"
            };

            var query = treeCompensationLayer.createQuery();
            query.outStatistics = [total_noncompen, total_processing, total_comp];
            query.returnGeometry = true;

            treeCompensationLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;

                const nonComp = stats.total_noncompen;
                const processing = stats.total_processing;
                const compensated = stats.total_comp;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root7.setThemes([
                    am5themes_Animated.new(root7),
                    am5themes_Responsive.new(root7)
                ]);


                // Create chart
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                var chart = root7.container.children.push(
                    am5percent.PieChart.new(root7, {

                        //centerY: am5.percent(-2), //-10
                        //y: am5.percent(-30), // -30
                        layout: root7.verticalLayout
                    })
                );

                // Add image in the middle
                chart.children.push(am5.Picture.new(root7, {
                    width: 37,
                    height: 37,
                    x: am5.percent(50),
                    y: am5.percent(50),
                    centerX: am5.percent(50),
                    centerY: am5.percent(200),
                    src: "https://EijiGorilla.github.io/Symbols/Money_Logo.svg"
                }));

                // Create series
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                var pieSeries = chart.series.push(
                    am5percent.PieSeries.new(root7, {
                        name: "Series",
                        categoryField: "category",
                        valueField: "value",
                        //legendLabelText: "[{fill}]{category}[/]",
                        legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
                        radius: am5.percent(85), // outer radius
                        innerRadius: am5.percent(40),
                        scale: 0.8
                    })
                );

                // Set data
                // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                // Set slice opacity and stroke color
                pieSeries.slices.template.setAll({
                    fillOpacity: 0.9,
                    stroke: am5.color("#ffffff"),
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    templateField: "sliceSettings"
                });

                // Disabling labels and ticks
                pieSeries.labels.template.set("visible", false);
                pieSeries.ticks.template.set("visible", false);

                //pieSeries.appear(1000, 100)
                pieSeries.slices.template.events.on("click", function (ev) {
                    const SELECTED = ev.target.dataItem.dataContext.category;

                    if (SELECTED == treeCompen[0]) {
                        selectedStatus = 1;
                    } else if (SELECTED == treeCompen[1]) {
                        selectedStatus = 2;
                    } else if (SELECTED == treeCompen[2]) {
                        selectedStatus = 3;
                    } else {
                        selectedStatus = null;
                    }

                    var query = treeCompensationLayer.createQuery();
                    const cpExpression = "CP = '" + cpValue + "'";
                    const statusExpression = "Compensation = " + selectedStatus;

                    if (cpValue === undefined || cpValue === "All") {
                        query.where = statusExpression;
                    } else {
                        query.where = cpExpression + " AND " + statusExpression;
                    }

                    view.when(function () {
                        view.whenLayerView(treeCompensationLayer).then(function (layerView) {
                            //chartLayerView = layerView;

                            treeCompensationLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                treeCompensationLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "Compensation = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                });

                pieSeries.data.setAll(
                    [
                        {
                            category: treeCompen[0],
                            value: nonComp,
                            sliceSettings: {
                                fill: am5.color("#0070FF")
                            }
                        },
                        {
                            category: treeCompen[1],
                            value: processing,
                            sliceSettings: {
                                fill: am5.color("#FFFF00")
                            }
                        },
                        {
                            category: treeCompen[2],
                            value: compensated,
                            sliceSettings: {
                                fill: am5.color("#71AB48")
                            }
                        },
                    ]
                );

                // Legend
                // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                var legend = chart.children.push(am5.Legend.new(root7, {
                    centerX: am5.percent(50),
                    x: am5.percent(50),
                    layout: root7.verticalLayout,
                    marginBottom: 10
                }));
                legend.data.setAll(pieSeries.dataItems);

                // Change the size of legend markers
                legend.markers.template.setAll({
                    width: 18,
                    height: 18,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    stroke: am5.color("#ffffff")
                });

                // Change the marker shape
                legend.markerRectangles.template.setAll({
                    cornerRadiusTL: 10,
                    cornerRadiusTR: 10,
                    cornerRadiusBL: 10,
                    cornerRadiusBR: 10,
                });

                // To align legend items: valueLabels right, labels to left
                // 1. fix width of valueLabels
                // 2. dynamically change width of labels by screen size

                const valueLabelsWidth = 50;

                // Responsive legend 
                // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                chart.onPrivate("width", function (width) {
                    let box = document.querySelector('.box5');
                    const boxWidth = box.offsetWidth;
                    var availableSpace = Math.max(width - chart.width() - 150, 180);
                    //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                    legend.labels.template.setAll({
                        width: availableSpace,
                        maxWidth: availableSpace
                    });
                });

                // Change legend labelling properties
                // To have responsive font size, do not set font size
                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff")
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                legend.valueLabels.template.setAll({
                    textAlign: "right",
                    width: valueLabelsWidth,
                    fill: am5.color("#ffffff")
                    //fontSize: LEGEND_FONT_SIZE,
                })

                legend.itemContainers.template.setAll({
                    // set space between legend items
                    paddingTop: 1.1,
                    paddingBottom: 2,
                });

                pieSeries.appear(1000, 100);
            }); // End of queryFeatures
        } // End of //updateChart
        updateChartTreeComp();

        // UTILITY RELOCATION
        const type = [
            {
                "category": "Telecom",
                "value": 1
            },
            {
                "category": "Water",
                "value": 2
            },
            {
                "category": "Sewage",
                "value": 3
            },
            {
                "category": "Power",
                "value": 4
            },
        ]

        const marginTop = 0;
        const marginLeft = 0;
        const marginRight = 0;
        const marginBottom = 0;
        const paddingTop = 10;
        const paddingLeft = 5;
        const paddingRight = 5;
        const paddingBottom = 0;

        const xAxisNumberFormat = "#'%'";
        const seriesBulletLabelFontSize = "1vw";

        // series line fill pattern
        const linePatternColorComplete = "#0070ff";
        const linePatternColorOpacityComplete = 0;
        const linePatternFillOpacityComplete = 0;

        const linePatternColorOpacityIncomplet = 0;
        const linePatternFillOpacityIncomplet = 1;
        const linePatternStrokeOpacityIncomplet = 0;

        // axis label
        const yAxisLabelFontSize = "0.8vw";
        const xAxisLabelFontSize = "0.8vw"
        const legendFontSize = "0.8vw"

        // 1.1. Point
        const chartIconWidth = 35;
        const chartIconHeight = 35;
        const chartIconPositionX = -21;
        const chartPaddingRightIconLabel = 45;

        var root_pt = am5.Root.new("utilityPointChartDiv");
        root_pt._logo.dispose();

        function updateChartUtilityPoint(cpValue) {
            root_pt.container.children.clear();
            var total_telecom_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_telecom_incomp",
                statisticType: "sum"
            };

            var total_telecom_comp = {
                onStatisticField: "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_telecom_comp",
                statisticType: "sum"
            };

            var total_water_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_water_incomp",
                statisticType: "sum"
            };

            var total_water_comp = {
                onStatisticField: "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_water_comp",
                statisticType: "sum"
            };

            var total_sewage_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_sewage_incomp",
                statisticType: "sum"
            };

            var total_sewage_comp = {
                onStatisticField: "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_sewage_comp",
                statisticType: "sum"
            };

            var total_power_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_power_incomp",
                statisticType: "sum"
            };

            var total_power_comp = {
                onStatisticField: "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_power_comp",
                statisticType: "sum"
            };


            // Query
            var query = utilityPointLayer.createQuery();
            query.outStatistics = [
                total_telecom_incomp, total_telecom_comp,
                total_water_incomp, total_water_comp,
                total_sewage_incomp, total_sewage_comp,
                total_power_incomp, total_power_comp
            ];
            query.returnGeometry = true;

            utilityPointLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const telecom_incomp = stats.total_telecom_incomp;
                const telecom_comp = stats.total_telecom_comp;
                const water_incomp = stats.total_water_incomp;
                const water_comp = stats.total_water_comp;
                const sewage_incomp = stats.total_sewage_incomp;
                const sewage_comp = stats.total_sewage_comp;
                const power_incomp = stats.total_power_incomp;
                const power_comp = stats.total_power_comp;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_pt.setThemes([
                    am5themes_Animated.new(root_pt),
                    am5themes_Responsive.new(root_pt),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_pt.container.children.push(am5xy.XYChart.new(root_pt, {
                    panX: false,
                    panY: false,
                    layout: root_pt.verticalLayout,
                    marginTop: marginTop,
                    marginLeft: marginLeft,
                    marginRight: marginRight,
                    marginBottom: marginBottom,
                    paddingTop: paddingTop,
                    paddingLeft: paddingLeft,
                    paddingRight: paddingRight,
                    paddingBottom: paddingBottom,
                    scale: 1,
                    height: am5.percent(100)
                }));

                var data = [
                    {
                        "category": type[Object.keys(type)[0]].category,
                        "comp": telecom_comp,
                        "incomp": telecom_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[1]].category,
                        "comp": water_comp,
                        "incomp": water_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[2]].category,
                        "comp": sewage_comp,
                        "incomp": sewage_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[3]].category,
                        "comp": power_comp,
                        "incomp": power_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_pt, {
                    inversed: true,
                });

                var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_pt, {
                    categoryField: "category",
                    renderer: yRenderer,
                    bullet: function (root_pt, axis, dataItem) {
                        return am5xy.AxisBullet.new(root_pt, {
                            location: 0.5,
                            sprite: am5.Picture.new(root_pt, {
                                width: chartIconWidth,
                                height: chartIconHeight,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                x: chartIconPositionX,
                                src: dataItem.dataContext.icon
                            })
                        });
                    },
                    tooltip: am5.Tooltip.new(root_pt, {})
                }));

                yRenderer.labels.template.setAll({
                    paddingRight: chartPaddingRightIconLabel
                });

                yRenderer.grid.template.setAll({
                    location: 1
                })

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: yAxisLabelFontSize,
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_pt, {
                    min: 0,
                    max: 100,
                    strictMax: true,
                    numberFormat: xAxisNumberFormat,
                    calculateTotals: true,
                    renderer: am5xy.AxisRendererX.new(root_pt, {
                        strokeOpacity: 0,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    })
                }));


                // Label properties for yAxis (category axis)
                xAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: xAxisLabelFontSize
                });

                chart.get("colors").set("colors", [
                    am5.color("#008c1a"), //
                    am5.color("#000000"),
                ]);

                // Add series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(am5xy.ColumnSeries.new(root_pt, {
                        name: name,
                        stacked: true,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        baseAxis: yAxis,
                        valueXField: fieldName,
                        valueXShow: "valueXTotalPercent",
                        categoryYField: "category"
                    }));

                    series.columns.template.setAll({
                        tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
                        tooltipY: am5.percent(90),
                        //fill: am5.color("#ffffff")
                        // 100% transparent for incomplete
                        fillOpacity: fieldName == "incomp" ? 0 : 1,
                        strokeOpacity: 0,
                    });
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_pt, {
                            sprite: am5.Label.new(root_pt, {
                                text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_pt.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true
                            })
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        // Layer
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        const find = type.find((emp) => emp.category === SELECTED);
                        const typeSelect = find.value;

                        const selectedStatus = fieldName == 'incomp' ? 0 : 1;

                        const sqlExpressionWithCP = "CP = '" + cpValue + "'" + " AND " + "UtilType = " + typeSelect + " AND " + "Status = " + selectedStatus;
                        const sqlExpression = "UtilType = " + typeSelect + " AND " + "Status = " + selectedStatus;

                        var query = utilityLineLayer.createQuery();
                        if (cpValue === undefined || cpValue === "All") {
                            query.where = sqlExpression;
                        } else {
                            query.where = sqlExpressionWithCP;
                        }

                        var highlight = null;
                        view.when(() => {
                            let arrLviews = [];
                            view.whenLayerView(utilityPointLayer).then(function (layerView) {
                                utilityPointLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID
                                    });

                                    utilityPointLayer.queryExtent(queryExt).then(function (result) {
                                        if (result.extent) {
                                            view.goTo(result.extent)
                                        }
                                    });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                                };
                            }); // End of whenLayerView

                            view.whenLayerView(utilityPointLayer1).then(function (layerView) {
                                utilityPointLayer1.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                                };
                            }); // End of whenLayerView
                        });

                    });// End of filterByChart

                    //legend.data.push(series);
                }// end of makeSeries
                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");
                // Make stuff animate on load
                // https://www.amcharts.com/docs/v5/concepts/animations/
                chart.appear(1000, 100);
            }); // End of queryFeatures function
        }
        updateChartUtilityPoint();

        // 1.2. Line
        var root_line = am5.Root.new("utilityLineChartDiv");
        root_line._logo.dispose();

        function updateChartUtilityLine(cpValue) {
            root_line.container.children.clear();
            var total_telecom_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_telecom_incomp",
                statisticType: "sum"
            };

            var total_telecom_comp = {
                onStatisticField: "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_telecom_comp",
                statisticType: "sum"
            };

            var total_water_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_water_incomp",
                statisticType: "sum"
            };

            var total_water_comp = {
                onStatisticField: "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_water_comp",
                statisticType: "sum"
            };

            var total_sewage_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_sewage_incomp",
                statisticType: "sum"
            };

            var total_sewage_comp = {
                onStatisticField: "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_sewage_comp",
                statisticType: "sum"
            };

            var total_power_incomp = {
                onStatisticField: "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_power_incomp",
                statisticType: "sum"
            };

            var total_power_comp = {
                onStatisticField: "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_power_comp",
                statisticType: "sum"
            };


            // Query
            var query = utilityLineLayer.createQuery();
            query.outStatistics = [
                total_telecom_incomp, total_telecom_comp,
                total_water_incomp, total_water_comp,
                total_sewage_incomp, total_sewage_comp,
                total_power_incomp, total_power_comp
            ];
            query.returnGeometry = true;

            utilityLineLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const telecom_incomp = stats.total_telecom_incomp;
                const telecom_comp = stats.total_telecom_comp;
                const water_incomp = stats.total_water_incomp;
                const water_comp = stats.total_water_comp;
                const sewage_incomp = stats.total_sewage_incomp;
                const sewage_comp = stats.total_sewage_comp;
                const power_incomp = stats.total_power_incomp;
                const power_comp = stats.total_power_comp;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_line.setThemes([
                    am5themes_Animated.new(root_line),
                    am5themes_Responsive.new(root_line),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_line.container.children.push(am5xy.XYChart.new(root_line, {
                    panX: false,
                    panY: false,
                    layout: root_line.verticalLayout,
                    marginTop: marginTop,
                    marginLeft: marginLeft,
                    marginRight: marginRight,
                    marginBottom: marginBottom,
                    paddingTop: paddingTop,
                    paddingLeft: paddingLeft,
                    paddingRight: paddingRight,
                    paddingBottom: paddingBottom,
                    scale: 1,
                    height: am5.percent(100)
                }));

                var data = [
                    {
                        "category": type[Object.keys(type)[0]].category,
                        "comp": telecom_comp,
                        "incomp": telecom_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[1]].category,
                        "comp": water_comp,
                        "incomp": water_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[2]].category,
                        "comp": sewage_comp,
                        "incomp": sewage_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
                    },
                    {
                        "category": type[Object.keys(type)[3]].category,
                        "comp": power_comp,
                        "incomp": power_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_line, {
                    inversed: true,
                });
                var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_line, {
                    categoryField: "category",
                    renderer: yRenderer,
                    bullet: function (root_line, axis, dataItem) {
                        return am5xy.AxisBullet.new(root_line, {
                            location: 0.5,
                            sprite: am5.Picture.new(root_line, {
                                width: chartIconWidth,
                                height: chartIconHeight,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                x: chartIconPositionX,
                                src: dataItem.dataContext.icon
                            })
                        });
                    },
                    tooltip: am5.Tooltip.new(root_line, {})
                }));

                yRenderer.labels.template.setAll({
                    paddingRight: chartPaddingRightIconLabel
                });

                yRenderer.grid.template.setAll({
                    location: 1
                })

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: yAxisLabelFontSize,
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_line, {
                    min: 0,
                    max: 100,
                    strictMax: true,
                    numberFormat: xAxisNumberFormat,
                    calculateTotals: true,
                    renderer: am5xy.AxisRendererX.new(root_line, {
                        strokeOpacity: 0,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    })
                }));


                // Label properties for yAxis (category axis)
                xAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: xAxisLabelFontSize
                });

                chart.get("colors").set("colors", [
                    am5.color("#008c1a"), //
                    am5.color("#000000"),
                ]);

                // Add series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(am5xy.ColumnSeries.new(root_line, {
                        name: name,
                        stacked: true,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        baseAxis: yAxis,
                        valueXField: fieldName,
                        valueXShow: "valueXTotalPercent",
                        categoryYField: "category"
                    }));

                    series.columns.template.setAll({
                        tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
                        tooltipY: am5.percent(90),
                        //fill: am5.color("#ffffff")
                        // 100% transparent for incomplete
                        fillOpacity: fieldName == "incomp" ? 0 : 1,
                        strokeOpacity: 0,
                    });
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_line, {
                            sprite: am5.Label.new(root_line, {
                                text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_line.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true
                            })
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        const find = type.find((emp) => emp.category === SELECTED);
                        const typeSelect = find.value;

                        const selectedStatus = fieldName == 'incomp' ? 0 : 1;

                        const sqlExpressionWithCP = "CP = '" + cpValue + "'" + " AND " + "UtilType = " + typeSelect + " AND " + "Status = " + selectedStatus;
                        const sqlExpression = "UtilType = " + typeSelect + " AND " + "Status = " + selectedStatus;

                        var query = utilityLineLayer.createQuery();
                        if (cpValue === undefined || cpValue === "All") {
                            query.where = sqlExpression;
                        } else {
                            query.where = sqlExpressionWithCP;
                        }

                        var highlight = null;
                        view.when(() => {
                            let arrLviews = [];
                            view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                utilityLineLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID
                                    });

                                    utilityLineLayer.queryExtent(queryExt).then(function (result) {
                                        if (result.extent) {
                                            view.goTo(result.extent)
                                        }
                                    });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                                };
                            }); // End of whenLayerView

                            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
                                utilityLineLayer1.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                                };
                            }); // End of whenLayerView
                        });


                    });// End of filterByChart

                    //legend.data.push(series);
                }// end of makeSeries
                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");
                // Make stuff animate on load
                // https://www.amcharts.com/docs/v5/concepts/animations/
                chart.appear(1000, 100);
            }); // End of queryFeatures function
        }
        updateChartUtilityLine();

        // VIADUCT
        const viaductType = [
            {
                "category": "Bored Pile",
                "value": 1
            },
            {
                "category": "Pile Cap",
                "value": 2
            },
            {
                "category": "Pier",
                "value": 3
            },
            {
                "category": "Pier Head",
                "value": 4
            },
            {
                "category": "Precast",
                "value": 5
            },
        ]
        var root_via = am5.Root.new("viaductChartDiv");
        root_via._logo.dispose();

        function updateChartViaduct(cpValue) {
            root_via.container.children.clear();
            var total_pile_incomp = {
                onStatisticField: "CASE WHEN (Type = 1 and Status1 = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pile_incomp",
                statisticType: "sum"
            };

            var total_pile_comp = {
                onStatisticField: "CASE WHEN (Type = 1 and Status1 = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pile_comp",
                statisticType: "sum"
            };

            var total_pilecap_incomp = {
                onStatisticField: "CASE WHEN (Type = 2 and Status1 = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pilecap_incomp",
                statisticType: "sum"
            };

            var total_pilecap_comp = {
                onStatisticField: "CASE WHEN (Type = 2 and Status1 = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pilecap_comp",
                statisticType: "sum"
            };

            var total_pier_incomp = {
                onStatisticField: "CASE WHEN (Type = 3 and Status1 = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pier_incomp",
                statisticType: "sum"
            };

            var total_pier_comp = {
                onStatisticField: "CASE WHEN (Type = 3 and Status1 = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pier_comp",
                statisticType: "sum"
            };

            var total_pierhead_incomp = {
                onStatisticField: "CASE WHEN (Type = 4 and Status1 = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pierhead_incomp",
                statisticType: "sum"
            };

            var total_pierhead_comp = {
                onStatisticField: "CASE WHEN (Type = 4 and Status1 = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pierhead_comp",
                statisticType: "sum"
            };

            var total_precast_incomp = {
                onStatisticField: "CASE WHEN (Type = 5 and Status1 = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_precast_incomp",
                statisticType: "sum"
            };

            var total_precast_comp = {
                onStatisticField: "CASE WHEN (Type = 5 and Status1 = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_precast_comp",
                statisticType: "sum"
            };


            // Query
            var query = viaductLayer.createQuery();
            query.outStatistics = [
                total_pile_incomp, total_pile_comp,
                total_pilecap_incomp, total_pilecap_comp,
                total_pier_incomp, total_pier_comp,
                total_pierhead_incomp, total_pierhead_comp,
                total_precast_incomp, total_precast_comp,
            ];
            query.returnGeometry = true;

            viaductLayer.queryFeatures(query).then(function (response) {
                var stats = response.features[0].attributes;
                const pile_incomp = stats.total_pile_incomp;
                const pile_comp = stats.total_pile_comp;
                const pilecap_incomp = stats.total_pilecap_incomp;
                const pilecap_comp = stats.total_pilecap_comp;
                const pier_incomp = stats.total_pier_incomp;
                const pier_comp = stats.total_pier_comp;
                const pierhead_incomp = stats.total_pierhead_incomp;
                const pierhead_comp = stats.total_pierhead_comp;
                const precast_incomp = stats.total_precast_incomp;
                const precast_comp = stats.total_precast_comp;

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_via.setThemes([
                    am5themes_Animated.new(root_via),
                    am5themes_Responsive.new(root_via),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_via.container.children.push(am5xy.XYChart.new(root_via, {
                    panX: false,
                    panY: false,
                    layout: root_via.verticalLayout,
                    marginTop: marginTop,
                    marginLeft: marginLeft,
                    marginRight: marginRight,
                    marginBottom: marginBottom,
                    paddingTop: paddingTop,
                    paddingLeft: paddingLeft,
                    paddingRight: paddingRight,
                    paddingBottom: paddingBottom,
                    scale: 1,
                    height: am5.percent(100)
                }));

                var data = [
                    {
                        "category": viaductType[Object.keys(viaductType)[0]].category,
                        "comp": pile_comp,
                        "incomp": pile_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pile_Logo.svg",
                    },
                    {
                        "category": viaductType[Object.keys(viaductType)[1]].category,
                        "comp": pilecap_comp,
                        "incomp": pilecap_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pilecap_Logo.svg",
                    },
                    {
                        "category": viaductType[Object.keys(viaductType)[2]].category,
                        "comp": pier_comp,
                        "incomp": pier_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pier_Logo.svg",
                    },
                    {
                        "category": viaductType[Object.keys(viaductType)[3]].category,
                        "comp": pierhead_comp,
                        "incomp": pierhead_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pierhead_Logo.svg",
                    },
                    {
                        "category": viaductType[Object.keys(viaductType)[4]].category,
                        "comp": pierhead_comp,
                        "incomp": pierhead_incomp,
                        "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Precast_Logo.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_via, {
                    inversed: true,
                });
                var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_via, {
                    categoryField: "category",
                    renderer: yRenderer,
                    bullet: function (root_via, axis, dataItem) {
                        return am5xy.AxisBullet.new(root_via, {
                            location: 0.5,
                            sprite: am5.Picture.new(root_via, {
                                width: 40,
                                height: 40,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                x: -28,
                                src: dataItem.dataContext.icon
                            })
                        });
                    },
                    tooltip: am5.Tooltip.new(root_via, {})
                }));

                yRenderer.labels.template.setAll({
                    paddingRight: 55
                });

                yRenderer.grid.template.setAll({
                    location: 1
                })

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: yAxisLabelFontSize,
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_via, {
                    min: 0,
                    max: 100,
                    strictMax: true,
                    numberFormat: xAxisNumberFormat,
                    calculateTotals: true,
                    renderer: am5xy.AxisRendererX.new(root_via, {
                        strokeOpacity: 0,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    })
                }));


                // Label properties for yAxis (category axis)
                xAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: xAxisLabelFontSize
                });

                chart.get("colors").set("colors", [
                    am5.color("#0070ff"), //
                    am5.color("#000000"),
                ]);

                // Add series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(am5xy.ColumnSeries.new(root_via, {
                        name: name,
                        stacked: true,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        baseAxis: yAxis,
                        valueXField: fieldName,
                        valueXShow: "valueXTotalPercent",
                        categoryYField: "category"
                    }));

                    series.columns.template.setAll({
                        tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
                        tooltipY: am5.percent(90),
                        //fill: am5.color("#ffffff")
                        // 100% transparent for incomplete
                        fillOpacity: fieldName == "incomp" ? 0 : 1,
                        strokeOpacity: 0,
                    });
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_via, {
                            sprite: am5.Label.new(root_via, {
                                text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_via.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true
                            })
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        const find = viaductType.find((emp) => emp.category === SELECTED);
                        const typeSelect = find.value;

                        const selectedStatus = fieldName == 'incomp' ? 1 : 4;

                        var highlight = null;
                        var query = viaductLayer.createQuery();
                        query.outFields = ["*"]
                        const sqlExpression = "Type = " + typeSelect + " AND " + "Status1 = " + selectedStatus;
                        const cpExpression = "CP = '" + cpValue + "'" + " AND " + "Type = " + typeSelect + " AND " + "Status1 = " + selectedStatus;

                        if (cpValue === undefined || cpValue === "All") {
                            query.where = sqlExpression;
                        } else {
                            query.where = cpExpression;
                        }
                        // Update layerView based on viaduct components being selected
                        view.whenLayerView(viaductLayer).then(function (viaductLayerView) {


                            viaductLayerView.queryFeatures(query).then(function (results) {
                                const ggg = results.features;
                                const rowN = ggg.length;

                                // Extract and obtain OBJECTID
                                let objID = [];
                                for (var i = 0; i < rowN; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                if (highlight) {
                                    highlightSelect.remove();
                                }
                                highlight = viaductLayerView.highlight(objID);

                                view.on("click", function () {
                                    viaductLayerView.filter = null;
                                    highlight.remove();
                                });
                            });
                            viaductLayerView.filter = {
                                where: "Type = " + typeSelect + " AND " + "Status1 = " + selectedStatus
                                //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                            };
                        }); // whenLayerView
                    });// End of filterByChart

                    //legend.data.push(series);
                }// end of makeSeries
                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");
                // Make stuff animate on load
                // https://www.amcharts.com/docs/v5/concepts/animations/
                chart.appear(1000, 100);
            }); // End of queryFeatures function
        }
        updateChartViaduct();

        var root_ts = am5.Root.new("timeSeriesChartViaduct");
        root_ts._logo.dispose();

        function timeSeriesChartViaduct(cpValue) {
            root_ts.container.children.clear();

            var total_complete_pile = {
                onStatisticField: "CASE WHEN (Status1 = 4 and Type = 1) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_complete_pile",
                statisticType: "sum"
            };

            var total_complete_pilecap = {
                onStatisticField: "CASE WHEN (Status1 = 4 and Type = 2) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_complete_pilecap",
                statisticType: "sum"
            };

            var total_complete_pier = {
                onStatisticField: "CASE WHEN (Status1 = 4 and Type = 3) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_complete_pier",
                statisticType: "sum"
            };

            var total_complete_pierhead = {
                onStatisticField: "CASE WHEN (Status1 = 4 and Type = 4) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_complete_pierhead",
                statisticType: "sum"
            };

            var total_complete_precast = {
                onStatisticField: "CASE WHEN (Status1 = 4 and Type = 5) THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_complete_precast",
                statisticType: "sum"
            };

            var query = viaductLayer.createQuery();

            const defaulExpression = "end_date IS NOT NULL";
            if (cpValue === "All") {
                query.where = defaulExpression;

            } else {
                query.where = defaulExpression + " AND " + "CP = '" + cpValue + "'";
            }

            query.outStatistics = [total_complete_pile, total_complete_pilecap,
                total_complete_pier, total_complete_pierhead, total_complete_precast];
            query.outFields = ["end_date"];
            query.orderByFields = ["end_date"];
            query.groupByFieldsForStatistics = ["end_date"];

            const pile = [];
            const pilecap = [];
            const pier = [];
            const pierhead = [];
            const precast = [];

            viaductLayer.queryFeatures(query).then(function (response) {
                var stats = response.features;

                // collect all dates for each viaduct type
                const data = stats.map((result, index) => {
                    const attributes = result.attributes;
                    const date = attributes.end_date;

                    const pileCount = attributes.total_complete_pile;
                    const pilecapCount = attributes.total_complete_pilecap;
                    const pierCount = attributes.total_complete_pier;
                    const pierheadCount = attributes.total_complete_pierhead;
                    const precastCount = attributes.total_complete_precast;

                    // compile in object
                    return Object.assign({}, {
                        date,
                        pile: pileCount,
                        pilecap: pilecapCount,
                        pier: pierCount,
                        piearhead: pierheadCount,
                        precast: precastCount
                    });
                });



                // 6. Add to Chart

                // set themes
                root_ts.setThemes([
                    am5themes_Animated.new(root_ts)
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_ts.container.children.push(am5xy.XYChart.new(root_ts, {
                    panX: false,
                    panY: false,
                    wheelX: "panX",
                    wheelY: "zoomX",
                    layout: root_ts.verticalLayout
                }));

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var xRenderer = am5xy.AxisRendererX.new(root_ts, {
                    //minGridDistance: 60,
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    stroke: am5.color("#ffffff"),
                });
                var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root_ts, {
                    // When you group data for series 
                    // Note you need to baseInterval timeUnit is 'day'
                    // and groupIntervals timeUnit is 'month'
                    maxDeviation: 0,
                    groupData: true,
                    baseInterval: {
                        timeUnit: "day",
                        count: 1
                    },
                    // count: 
                    groupIntervals: [{ timeUnit: "month", count: 1 }],

                    categoryField: "date",
                    renderer: xRenderer,
                    tooltip: am5.Tooltip.new(root_ts, {})
                }));

                xRenderer.grid.template.setAll({
                    location: 1
                })

                // Label properties for yAxis (category axis)
                xAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                xAxis.data.setAll(data);

                var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root_ts, {
                    min: 0,
                    renderer: am5xy.AxisRendererY.new(root_ts, {
                        strokeOpacity: 0.1,
                        minGridDistance: 60,
                        strokeOpacity: 1,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    })
                }));

                // Add yaxix title
                yAxis.children.unshift(
                    am5.Label.new(root_ts, {
                        rotation: -90,
                        text: "Count",
                        y: am5.p50,
                        centerX: am5.p50,
                        fill: am5.color("#ffffff"),
                        fontSize: 11
                    })
                );

                yAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                // Add legend
                // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
                var legend = chart.children.push(am5.Legend.new(root_ts, {
                    centerX: am5.p50,
                    x: am5.p50
                }));

                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff"),
                    fontSize: 17,
                    scale: 0.8,
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });

                // Add series
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(am5xy.ColumnSeries.new(root_ts, {
                        name: name,
                        stacked: true,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        valueYField: fieldName,
                        valueXField: "date",
                        valueYGrouped: "sum"
                    }));

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        tooltipY: am5.percent(10)
                    });
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_ts, {
                            sprite: am5.Label.new(root_ts, {
                                text: "{valueY}",
                                fill: root_ts.interfaceColors.get("alternativeText"),
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true
                            })
                        });
                    });

                    legend.data.push(series);
                }

                makeSeries("Bored Pile", "pile");
                makeSeries("Pile Cap", "pilecap");
                makeSeries("Pier", "pier");
                makeSeries("Pier Head", "pierhead");
                makeSeries("Precast", "precast");

                chart.appear(1000, 100);


            });
        }
        timeSeriesChartViaduct("All");


        //----------------------------------------------------------------------------------//
        /// Time series chart EXPERIMENT
        var root8 = am5.Root.new("timeSeriesChartLand");
        root8._logo.dispose();

        function timeSeriesChartLand(cpValue) {
            root8.container.children.clear();

            var query = lotLayer.createQuery();
            const cpExpression = "CP = '" + cpValue + "'";
            const statusExpression = "HandedOverDate IS NOT NULL";

            if (cpValue === 'All' || cpValue === undefined) {
                query.where = statusExpression;

            } else {
                query.where = cpExpression + " AND " + statusExpression;
            }

            var total_count_handedOver_private = {
                onStatisticField: "CASE WHEN (LandOwner <> 'BASES CONVERSION DEVELOPMENT AUTHORITY' and LandOwner <> 'MANILA RAILROAD COMPANY') THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_count_handedOver_private",
                statisticType: "sum"
            }

            var total_count_handedOver_public = {
                onStatisticField: "CASE WHEN (LandOwner = 'BASES CONVERSION DEVELOPMENT AUTHORITY' or LandOwner = 'MANILA RAILROAD COMPANY') THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_count_handedOver_public",
                statisticType: "sum"
            }

            query.outStatistics = [total_count_handedOver_private, total_count_handedOver_public];
            query.outFields = ["HandedOverDate"];
            query.orderByFields = ["HandedOverDate"];
            query.groupByFieldsForStatistics = ["HandedOverDate"];

            const private = [];
            const public = [];

            lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features;
                ////
                // collect all dates
                const data = stats.map((result, index) => {
                    const attributes = result.attributes;
                    const date = attributes.HandedOverDate;

                    const privateCount = attributes.total_count_handedOver_private;
                    const publicCount = attributes.total_count_handedOver_public;

                    // compile in object array
                    return Object.assign({}, {
                        date,
                        private: privateCount,
                        public: publicCount
                    });
                });

                // set themes
                root8.setThemes([
                    am5themes_Animated.new(root8)
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root8.container.children.push(am5xy.XYChart.new(root8, {
                    panX: false,
                    panY: false,
                    wheelX: "panX",
                    wheelY: "zoomX",
                    paddingBottom: 35,
                }));

                chart.get("colors").set("colors", [
                    am5.color("#6ede00"),
                    am5.color("#4a99ff"),
                ]);

                // Chart title
                chart.children.unshift(am5.Label.new(root8, {
                    text: "Monthly Progress of Handed-Over Lots",
                    fontSize: 14,
                    fontWeight: "bold",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    x: am5.percent(50),
                    centerX: am5.percent(50),
                    paddingTop: 0,
                    paddingBottom: 0,
                }));

                // Add cursor
                // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
                var cursor = chart.set("cursor", am5xy.XYCursor.new(root8, {
                    behavior: "zoomX"
                }));
                cursor.lineY.set("visible", false);

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root8, {
                    maxDeviation: 0,
                    groupData: true,
                    baseInterval: {
                        timeUnit: "day",
                        count: 1
                    },
                    groupIntervals: [{ timeUnit: "month", count: 1 }],
                    renderer: am5xy.AxisRendererX.new(root8, {
                        minGridDistance: 60,
                        strokeOpacity: 1,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    }),
                    //tooltip: am5.Tooltip.new(root8, {})
                }));

                // Label properties for yAxis (category axis)
                xAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root8, {
                    calculateTotals: true,
                    min: 0,
                    renderer: am5xy.AxisRendererY.new(root8, {
                        minGridDistance: 60,
                        strokeOpacity: 1,
                        strokeWidth: 1,
                        stroke: am5.color("#ffffff"),
                    })
                }));

                yAxis.get("renderer").labels.template.setAll({
                    //oversizedBehavior: "wrap",
                    textAlign: "center",
                    fill: am5.color("#ffffff"),
                    //maxWidth: 150,
                    fontSize: 12
                });

                // Add yaxix title
                yAxis.children.unshift(
                    am5.Label.new(root8, {
                        rotation: -90,
                        text: "No. of handed-over lots",
                        y: am5.p50,
                        centerX: am5.p50,
                        fill: am5.color("#ffffff"),
                        fontSize: 11
                    })
                );

                // Add legend
                // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
                var legend = chart.children.push(am5.Legend.new(root8, {
                    centerX: am5.p50,
                    centerY: am5.percent(50),
                    x: am5.p50,
                    y: am5.percent(108),

                }));

                legend.labels.template.setAll({
                    oversizedBehavior: "truncate",
                    fill: am5.color("#ffffff"),
                    fontSize: 17,
                    scale: 0.8,
                    //textDecoration: "underline"
                    //width: am5.percent(200)
                    //fontWeight: "300"
                });


                function makeSeries(name, fieldName) {
                    // Add series
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    var series = chart.series.push(am5xy.ColumnSeries.new(root8, {
                        name: name,
                        stacked: true,
                        xAxis: xAxis,
                        yAxis: yAxis,
                        valueYField: fieldName,
                        valueXField: "date",
                        valueYGrouped: "sum",
                        //fill: fieldName === 'private' ? am5.color(privateLotColor) : am5.color(publicLotColor),
                    }));

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        tooltipY: am5.percent(10),
                        strokeOpacity: 0
                    });
                    series.data.setAll(data);
                    series.appear(1000);

                    // Add Label bullet
                    series.bullets.push(function () {
                        return am5.Bullet.new(root8, {
                            locationY: 1,
                            locationX: 0.5,
                            sprite: am5.Label.new(root8, {
                                text: "{valueY}",
                                fill: root8.interfaceColors.get("alternativeText"),
                                centerY: 0,
                                centerX: am5.p50,
                                populateText: true,
                                fontSize: 10
                            })
                        });
                    });
                    legend.data.push(series);
                }
                makeSeries("Private Land", "private");
                makeSeries("Public Land", "public");

                chart.appear(1000, 100);
            });
        }
        timeSeriesChartLand();
        /////////////////// END Of LAYER IMPORT ////////////////////////////


        // ----------------- Super Urgent Lots Button ----------------- //

        function highlightUrgent() {
            view.whenLayerView(urgentLotLayer).then((urgentlayerView) => {
                var query = urgentLotLayer.createQuery();
                urgentLotLayer.queryFeatures(query).then(function (results) {
                    const RESULT_LENGTH = results.features;
                    const ROW_N = RESULT_LENGTH.length;

                    let objID = [];
                    for (var i = 0; i < ROW_N; i++) {
                        var obj = results.features[i].attributes.OBJECTID;
                        objID.push(obj);
                    }

                    var queryExt = new Query({
                        objectIds: objID,
                    });

                    var queryExt = new Query({
                        objectIds: objID,
                    });

                    lotLayer.queryExtent(queryExt).then(function (result) {
                        if (result.extent) {
                            view.goTo(result.extent);
                        }
                    });

                    if (highlightSelect) {
                        highlightSelect.remove();
                    }
                    highlightSelect = urgentlayerView.highlight(objID);

                    view.on("click", function () {
                        urgentlayerView.filter = null;
                        highlightSelect.remove();
                    });
                });
                urgentlayerView.filter = { where: "Urgent = 0" };
            });
        }


        const viewUrgentLots = document.getElementById("viewUrgentLots");
        const urgentLotsOn = document.getElementById("urgentLots-on");


        
        viewUrgentLots.addEventListener("click", function (event) {
            let urgentLotsOn_switch = urgentLotsOn.checked;

            if (urgentLotsOn_switch === true) {
                urgentLotLayer.visible = true;
                structureLayer.visible = true;
                treeCuttingLayer.visible = true;
                utilityPointLayer.visible = true;
                utilityLineLayer.visible = true;

                lotLayer.visible = false;
                pnrLayer.visible = false;
                highlightUrgent();


            } else {
                urgentLotLayer.visible = false;
                structureLayer.visible = false;
                treeCuttingLayer.visible = false;
                utilityPointLayer.visible = false;
                utilityLineLayer.visible = false;

                lotLayer.visible = true;
                pnrLayer.visible = true;
            }
        });




        // Zoom
        function zoomToLayer(layer) {
            return layer.queryExtent().then(function (response) {
                view.goTo(response.extent, { //response.extent
                    speedFactor: 2,
                }).catch(function (error) {
                    if (error.name != "AbortError") {
                        console.error(error);
                    }
                });
            });
        }

        view.ui.empty("top-left");

        //****---------------- Layer List -----------------------****//

        const layerList = new LayerList({
            view: view,
            selectionEnabled: true,
            container: "layers-container",
            listItemCreatedFunction: function (event) {
                const item = event.item;
                if (
                    item.title === "Chainage" ||
                    item.title === "NLO (Non-Land Owner)" ||
                    item.title === "NLO/LO Ownership (Structure)" ||
                    item.title === "Occupancy (Structure)" ||
                    item.title === "Structure" ||
                    item.title === "Land Acquisition (Endorsed Status)" ||
                    item.title === "Free-and-Clear Area" ||
                    item.title === "Tree Cutting" ||
                    item.title === "Tree Compensation" ||
                    item.title === "Point (symbol)" ||
                    item.title === "Point (status)" ||
                    item.title === "Line (symbol)" ||
                    item.title === "Line (status)" ||
                    item.title === "N2 Station Structures" ||
                    item.title === "Viaduct" 
                )
                {
                    item.visible = false;
                }
                if (item.layer.type != "group") {
                    // don't show legend twice
                    item.panel = {
                        content: "legend",
                        open: true,
                    };
                }
            },
        });

        //Search Widget 
        var searchWidget = new Search({
            view: view,
            locationEnabled: false,
            allPlaceholder: "LotID, Structure, Chainage or Pier No.",
            includeDefaultSources: false,
            sources: [
              {
                layer: lotLayer,
                searchFields: ["LotID"],
                displayField: "LotID",
                exactMatch: false,
                outFields: ["LotID"],
                name: "Lot ID",
                placeholder: "example: 10083",
              },
              {
                layer: structureLayer,
                searchFields: ["StrucID"],
                displayField: "StrucID",
                exactMatch: false,
                outFields: ["StrucID"],
                name: "Structure ID",
                placeholder: "example: MCRP-01-02-ML022",
              },
                {
                    layer: chainageLayer,
                    searchFields: ["KmSpot"],
                    displayField: "KmSpot",
                    exactMatch: false,
                    outFields: ["KmSpot"],
                    name: "Main KM",
                    placeholder: "example: 80+400"
                },
                {
                    layer: pierAccessLayer,
                    searchFields: ["PIER"],
                    displayField: "PIER",
                    exactMatch: false,
                    outFields: ["PIER"],
                    name: "Pier No.",
                    placeholder: "example: PLK-01"
                },
            ]
        });

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search"
        });
        view.ui.add(searchExpand, {
            position: "top-right"
        });

        searchExpand.watch("expanded", function () {
            if (!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });



        // view.when
        view.when(() => {
            //document.querySelector("#header-title").textContent = "N2 WORK PROGRESS";
            document.querySelector("#item-description").innerHTML = `
                                                                 1. This web app shows key progress on:<br>
                                                                 <ul><li>Land acquisition including structures and NLOs (non-land owners),</li><br>
                                                                     <li>Tree cutting and compensation,</li><br>
                                                                     <li>Utility relocation</li></ul><br>
                                                                 2. <b>Click tabs</b> under the contract packages list in the right side of the header to view progress on pre-construction and construction works.<br>
                                                                 <br>3. <b>Click series in pie charts</b> to view progress on the respective items on the map.<br>
                                                                 <br>4. Click/unclick widget icons for viewing:<br>
                                                                  <ul><li>Layer list with legend,</li><br>
                                                                      <li>Basemaps,</li><br>
                                                                      <li>Underground (underground navigation)</li><br>
                                                                      <li>Links to individual web apps,</li><br>
                                                                      <li>Progress charts for land acquisition and viaduct construction,</li></ul>
                                                                 `
                ;

            let activeWidget;
            const handleActionBarClick = ({ target }) => {
                if (target.tagName !== "CALCITE-ACTION") {
                    return;
                }

                if (activeWidget) {
                    document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
                    document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
                }

                const nextWidget = target.dataset.actionId;
                if (nextWidget !== activeWidget) {
                    document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
                    document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
                    activeWidget = nextWidget;

                    // Open the time series chart when chart widget is opened.
                    if (`${activeWidget}` === "animation") {
                        initialization();
                    }

                } else {
                    activeWidget = null;
                }
            };

            // Action bar 
            document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
            let actionBarExpanded = false;
            document.addEventListener("calciteActionBarToggle", event => {
                actionBarExpanded = !actionBarExpanded;
                view.padding = {
                    left: actionBarExpanded ? 135 : 45
                };
            });

            // IMPORTANT NOTE:
            // You need to include progress chart and see-through-ground inside widget calcite-panel; otherwise,
            // when you click the checkbox, toggling action will be reversed for this activation.

            // Progress Chart
            document.getElementById("viaduct-checkbox").addEventListener("click", function (event) {
                const checked = event;
                timeSeriesChartViaductDiv.hidden = !timeSeriesChartViaductDiv.hidden;
            });

            document.getElementById("land-checkbox").addEventListener("click", function (event) {
                const timeSeriesChartLandDiv = document.getElementById("timeSeriesChartLand");
                const checked = event;
                timeSeriesChartLandDiv.hidden = !timeSeriesChartLandDiv.hidden;
            });



            // See-through-Ground
            view.when(function () {
                // allow navigation above and below the ground
                map.ground.navigationConstraint = {
                    type: "none"
                };
                // the webscene has no basemap, so set a surfaceColor on the ground
                map.ground.surfaceColor = "#fff";

                // to see through the ground, set the ground opacity to 0.4
                map.ground.opacity = 1;
            });

            document.getElementById("myLink").addEventListener("click", function (event) {
                const checked = event.srcElement.checked;
                map.ground.opacity = event.srcElement.checked ? 0 : 0.8;
                view.environment.atmosphereEnabled = false;
            });
            // Switch theme
            document.querySelector("calcite-shell").hidden = false;
            document.querySelector("calcite-loader").hidden = true;

        });



        // Measurement Widgets
        // To modify analysis objects we will temporarily store the corresponding widget in this variable.
        let analysisWidget = null;

        view.when(async () => {
            // Create the analysis objects
            const directLineMeasurementAnalysis = createDirectLineMeasurementAnalysis();
            const areaMeasurementAnalysis = createAreaMeasurementAnalysis();
            const sliceAnalysis = createSliceAnalysis();
            const lineOfSightAnalysis = createLineOfSightAnalysis();

            // Wait for the view to load before adding analysis objects
            await reactiveUtils.whenOnce(() => !view.updating);

            // Add analysis object to the view to show them
            view.analyses.addMany([
                directLineMeasurementAnalysis,
                areaMeasurementAnalysis,
                sliceAnalysis,
                lineOfSightAnalysis
            ]);

            // Configure buttons to interact with the analysis objects
            const areaMeasurementAnalysisButton = setupAnalysisButton(
                "areaMeasurementAnalysisButton",
                () => new AreaMeasurement3D({ view, analysis: areaMeasurementAnalysis })
            );

            const directLineMeasurementAnalysisButton = setupAnalysisButton(
                "directLineMeasurementAnalysisButton",
                () => new DirectLineMeasurement3D({ view, analysis: directLineMeasurementAnalysis })
            );

            const lineOfSightAnalysisButton = setupAnalysisButton(
                "lineOfSightAnalysisButton",
                () => new LineOfSight({ view, analysis: lineOfSightAnalysis })
            );

            const sliceAnalysisButton = setupAnalysisButton(
                "sliceAnalysisButton",
                () => new Slice({ view, analysis: sliceAnalysis })
            );

            // Remove button is a bit special
            document.getElementById("removeWidgetButton").addEventListener("click", () => {
                removeActiveWidget();
            });

            function setupAnalysisButton(elementId, widgetFactotry) {
                const button = document.getElementById(elementId);

                button.addEventListener("click", () => {
                    // remove current widget (if any)
                    removeActiveWidget();

                    // install a suitable widget in the `analysisWidget` variable
                    analysisWidget = widgetFactotry();

                    // highlight this button as the currently active one and add the remove widget button
                    button.appearance = "outline";
                    document.getElementById("removeWidgetButton").style.display = "block";

                    // show the analysisWidget in the lower right corner
                    view.ui.add(analysisWidget, "bottom-right");
                });
                return button;
            }

            function removeActiveWidget() {
                // remove the analysisWidget if one exists
                if (analysisWidget) {
                    analysisWidget.destroy();
                    analysisWidget = null;
                }

                // hide remove button
                document.getElementById("removeWidgetButton").style.display = "none";

                // reset appearance of the analysis buttons
                areaMeasurementAnalysisButton.appearance = "solid";
                directLineMeasurementAnalysisButton.appearance = "solid";
                lineOfSightAnalysisButton.appearance = "solid";
                sliceAnalysisButton.appearance = "solid";
            }
        });

        function createDirectLineMeasurementAnalysis() {
            return new DirectLineMeasurementAnalysis({
                startPoint: newPoint(-8238827, 4971466, 3),
                endPoint: newPoint(-8238819, 4971537, 3)
            });
        }

        function createAreaMeasurementAnalysis() {
            const roofPolygon = new Polygon({
                rings: [
                    [
                        [-8238931, 4971381, 50],
                        [-8238926, 4971426, 50],
                        [-8238835, 4971415, 50],
                        [-8238841, 4971369, 50],
                        [-8238931, 4971381, 50]
                    ]
                ],
                spatialReference: SpatialReference.WebMercator
            });

            return new AreaMeasurementAnalysis({
                geometry: roofPolygon
            });
        }

        function createSliceAnalysis() {
            return new SliceAnalysis({
                shape: {
                    position: newPoint(-8238840, 4971700, 21),
                    tilt: 0,
                    width: 70,
                    height: 100,
                    heading: 278
                }
            });
        }

        function createLineOfSightAnalysis() {
            return new LineOfSightAnalysis({
                observer: { position: newPoint(-8238825, 4971538, 48) },
                targets: [
                    { position: newPoint(-8238903, 4971649, 2) },
                    { position: newPoint(-8238866, 4971629, 19) },
                    { position: newPoint(-8238825, 4971880, 2) },
                    { position: newPoint(-8238791, 4971784, 2) }
                ]
            });
        }

        function newPoint(x, y, z) {
            // convenience function to have all points in the same spatial reference
            return new Point({ x, y, z, spatialReference: SpatialReference.WebMercator });
        }

        //view.ui.add("measurementToolMenu", "bottom-left");

        const measurementToolMenuExpand = new Expand({
            view,
            content: document.getElementById("measurementToolMenu"),
            expandIconClass: "esri-icon-measure-line"
        });
        view.ui.add(measurementToolMenuExpand, "top-right");

    });
</script>

</html>