<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about working on Building Scene Layer
  https://pro.arcgis.com/en/pro-app/2.7/help/mapping/layer-properties/maintain-and-work-with-a-building-scene-layer.html
  https://www.youtube.com/watch?v=maEXHMI9ddQ

  # BuildingFiler
  https://developers.arcgis.com/javascript/latest/api-reference/esri-layers-support-BuildingFilter.html

  -->
    <title>N2 Utility</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/1.10.0/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.10.0/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.28/"></script>
</head>

<body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
        <!--  Header slot  -->
        <div slot="header" id="header">
            <!-- Title -->
            <h2 slot="header" id="header-title"></h2>
            <!-- Date -->
            <div id="dateDiv">As of October 4, 2023</div>
            <!-- Contract Package -->
            <div class="esri-widget" id="dropdownDiv">
                <label for="sel-options">CP:</label>
                <select id="valSelect" class="esri-widget"></select>
                <label for="sel-options">Provider</label>
                <select id="companySelect" class="esri-widget"></select>
                <label for="sel-options">Type</label>
                <select id="typeSelect" class="esri-widget"></select>
            </div>
        </div>



        <!-- Action Bar -->
        <calcite-shell-panel slot="panel-start" display-mode="float" detached>
            <calcite-action-bar slot="action-bar">
                <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
                <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
                <calcite-action data-action-id="seethrough" icon="transparency" text="Underground"></calcite-action>
                <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>

            <!-- Action Bar Panel -->
            <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
                <div id="layers-container"></div>
            </calcite-panel>

            <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
                <div id="basemaps-container"></div>
            </calcite-panel>

            <calcite-panel heading="View Underground" height-scale="l" data-panel-id="seethrough" hidden>
                <calcite-label layout="inline" id="see-through-label">
                    <calcite-checkbox id="myLink"></calcite-checkbox> Ground color becomes transparent
                </calcite-label>
            </calcite-panel>

            <calcite-panel heading="Description" data-panel-id="information" hidden>
                <div id="info-content">
                    <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                    <div id="item-description">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </calcite-panel>
        </calcite-shell-panel>

        <div id="container">
            <div id="viewDiv"></div>


            <!--<div id="headerTitleDiv">N2 UTILITY</div>
            <div id="boxPower">
                <label class="labelPower">Power</label>
                <div id="chartPowerPointDiv"></div>
                <div id="chartPowerLineDiv"></div>
                <div id="chartPowerAllDiv"></div>
            </div>
            <div id="boxTelecom">
                <label class="labelTelecom">Telecom</label>
                <div id="chartTelecomPointDiv"></div>
                <div id="chartTelecomLineDiv"></div>
                <div id="chartTelecomAllDiv"></div>
            </div>
            <div id="boxWater">
                <label class="labelWater">Water</label>
                <div id="chartWaterPointDiv"></div>
                <div id="chartWaterLineDiv"></div>
                <div id="chartWaterAllDiv"></div>
            </div>
            <div id="boxSewage">
                <label class="labelSewage">Sewage</label>
                <div id="chartSewagePointDiv"></div>
                <div id="chartSewageLineDiv"></div>
                <div id="chartSewageAllDiv"></div>
            </div>
            <div id="boxTotal">
                <div id="labelTotalDiv">TOTAL</div>
                <div id="totalProgressDiv"></div>
            </div>
            <calcite-label layout="inline" id="see-through-label">
                <calcite-checkbox id="myLink"></calcite-checkbox><b style="color: white">See-through-ground</b>
            </calcite-label>-->
        </div>
    </calcite-shell>
</body>

</html>

<style>
    html,
    body,
    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    /*All calcite elements*/
    calcite-list {
        overflow-y: auto;
    }

    calcite-tab {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    calcite-loader {
        align-self: center;
        justify-self: center;
    }


    calcite-button {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: auto;
    }


    calcite-rating {
        margin-top: 0.25rem;
    }


    /* Header */
    #header {
        display: flex;
        padding: 0 1rem;
        padding-bottom: 0.7rem;
        background-color: var(--calcite-ui-foreground-1);
    }

    #header-title {
        margin-left: 1rem;
        margin-right: 1rem;
    }

    #dateDiv {
        font-size: 0.85vw;
        text-align: right;
        display: flex;
        align-items: flex-end;
        font-weight: bold;
    }

    /*Dropdown List*/

    #dropdownDiv {
        background-color: rgb(0, 0, 0, 0);
        font-size: 1.1vw;
        opacity: 1;
        color: white;
        font-weight: bold;
        padding-right: 5;
        padding-top: 6;
        right: 100;
        top: 19;
        z-index: 99;
        position: absolute;
    }


    /* Progress Charts */

    #container {
        display: grid;
        flex-wrap: wrap;
        box-sizing: border-box;
        grid-template-columns: 1fr 0.25fr;
        width: 100%;
        height: 100%;
    }


    /*
    #see-through-label {
        color: white;
        padding-top: 10;
        padding-bottom: 0;
        display: flex;
        align-self: center;
    }

    #see-through-label b {
        font-weight: normal;
    }*/

    .labelWater,
    .labelPower,
    .labelTelecom,
    .labelSewage {
        color: white;
        font-size: 1.5vw;
        margin: 0;
        text-align: center;
    }

    #labelTotalDiv {
        color: white;
        font-size: 1.5vw;
        width: 100%;
        height: 3.5vh;
        padding-top: 7;
        text-align: center;
    }

    #boxPower {
        position: absolute;
        z-index: 99;
        background-image: linear-gradient(rgb(0, 0, 0, 0), rgb(0, 185, 242, 0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: rgb(0, 0, 0, 0.5);
        bottom: 2.4%;
        left: 1%;
        color: white;
        font-size: 2vw;
        text-align: center;
        --ratio: calc(4 / 2);
        /* put the aspect ratio width to height you want */
        --h: min(calc(14vw / var(--ratio)), 16vh);
        height: var(--h);
        width: calc(var(--h) * var(--ratio));
    }

    #boxTelecom {
        position: absolute;
        z-index: 99;
        background-image: linear-gradient(rgb(0, 0, 0, 0), rgb(0, 185, 242, 0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: rgb(0, 0, 0, 0.5);
        bottom: 2.4%;
        left: 15.5%;
        color: white;
        font-size: 2vw;
        text-align: center;
        --ratio: calc(4 / 2);
        /* put the aspect ratio width to height you want */
        --h: min(calc(14vw / var(--ratio)), 16vh);
        height: var(--h);
        width: calc(var(--h) * var(--ratio));
    }

    #boxWater {
        position: absolute;
        z-index: 99;
        background-image: linear-gradient(rgb(0, 0, 0, 0), rgb(0, 185, 242, 0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: rgb(0, 0, 0, 0.5);
        bottom: 2.4%;
        left: 30%;
        color: white;
        font-size: 2vw;
        text-align: center;
        --ratio: calc(4 / 2);
        /* put the aspect ratio width to height you want */
        --h: min(calc(14vw / var(--ratio)), 16vh);
        height: var(--h);
        width: calc(var(--h) * var(--ratio));
    }

    #boxSewage {
        position: absolute;
        z-index: 99;
        background-image: linear-gradient(rgb(0, 0, 0, 0), rgb(0, 185, 242, 0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: rgb(0, 0, 0, 0.5);
        bottom: 2.4%;
        left: 44.5%;
        color: white;
        font-size: 2vw;
        text-align: center;
        --ratio: calc(4 / 2);
        /* put the aspect ratio width to height you want */
        --h: min(calc(14vw / var(--ratio)), 16vh);
        height: var(--h);
        width: calc(var(--h) * var(--ratio));
    }

    #boxTotal {
        position: absolute;
        z-index: 99;
        background-image: linear-gradient(rgb(0, 0, 0, 0), rgb(0, 185, 242, 0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        background-color: rgb(0, 0, 0, 0.5);
        bottom: 2.4%;
        left: 59%;
        color: white;
        font-size: 2vw;
        text-align: center;
        --ratio: calc(4 / 2);
        /* put the aspect ratio width to height you want */
        --h: min(calc(14vw / var(--ratio)), 16vh);
        height: var(--h);
        width: calc(var(--h) * var(--ratio));
    }

    #chartWaterPointDiv,
    #chartWaterLineDiv,
    #chartWaterAllDiv,
    #chartSewagePointDiv,
    #chartSewageLineDiv,
    #chartSewageAllDiv,
    #chartPowerPointDiv,
    #chartPowerLineDiv,
    #chartPowerAllDiv,
    #chartTelecomPointDiv,
    #chartTelecomLineDiv,
    #chartTelecomAllDiv {
        width: 100%;
        height: 65%;
        margin-top: auto;
        margin-bottom: auto;
        margin-left: auto;
    }

    #totalProgressDiv {
        color: rgb(0, 197, 255);
        font-size: 3vw;
        width: 100%;
        height: 6vh;
        padding-top: 12;
        text-align: center;
    }

    h5 {
        color: rgb(0, 197, 255);
        font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
            sans-serif;
        text-align: left;
        font-weight: normal;
        font-size: 1.2vw;
        padding: 0;
        margin: 0;
    }

    /*
    .panel {
        padding: 0px;
        margin: 0;
        box-sizing: border-box;
        width: 15vw;
        height: 40vh;
        position: absolute;
        top: 10%;
        right: 1;
        font-size: 1.3vw;
        color: white;
        background-color: rgb(0, 0, 0, 0);
        z-index: 99;
        transition: 3;
        line-height: 2;
    }*/

    /*All esri elements*/

    .active,
    .test:hover {
        background-color: rgba(77, 75, 75, 0);
        color: orange;
        font-size: 1.7vw;
    }

    .esri-layer-list__item-toggle-icon,
    .esri-layer-list__item-title {
        color: white;
    }

    .sassy-theme .esri-menu,
    .sassy-theme .esri-building-explorer,
    .sassy-theme .esri-popup__main-container,
    .sassy-theme .esri-popup .esri-popup__pointer-direction,
    .sassy-theme .esri-popup .esri-popup__button,
    .sassy-theme .esri-button,
    .sassy-theme .esri-input,
    .sassy-theme .esri-legend,
    .sassy-theme .esri-layer-list,
    .sassy-theme .esri-widget a {
        background-color: rgb(0, 0, 0, 0.5);
        color: #fff;
    }

    ::-webkit-scrollbar {
        display: none;
    }

    .esri-legend__layer-caption {
        display: none;
    }

    /* To remove inset outline in mapview*/
    .esri-view .esri-view-surface--touch-none:focus::after {
        outline: none !important;
    }
</style>

<script>
    require([
        "esri/Basemap",
        "esri/Map",
        "esri/views/MapView",
        "esri/views/SceneView",
        "esri/layers/FeatureLayer",
        "esri/layers/support/FeatureFilter",
        "esri/layers/SceneLayer",
        "esri/layers/Layer",
        "esri/layers/TileLayer",
        "esri/layers/VectorTileLayer",
        "esri/layers/support/LabelClass",
        "esri/symbols/LabelSymbol3D",
        "esri/WebMap",
        "esri/WebScene",
        "esri/portal/PortalItem",
        "esri/portal/Portal",
        "esri/widgets/TimeSlider",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/widgets/Fullscreen",
        "esri/rest/geometryService",
        "esri/rest/support/Query",
        "esri/rest/support/StatisticDefinition",
        "esri/symbols/WebStyleSymbol",
        "esri/TimeExtent",
        "esri/widgets/Expand",
        "esri/widgets/Editor",
        "esri/renderers/UniqueValueRenderer",
        "esri/widgets/support/DatePicker",
        "esri/widgets/FeatureTable",
        "esri/widgets/Compass",
        "esri/layers/ElevationLayer",
        "esri/Ground",
        "esri/layers/BuildingSceneLayer",
        "esri/widgets/BuildingExplorer",
        "esri/widgets/Slice",
        "esri/analysis/SlicePlane",
        "esri/renderers/SimpleRenderer",
        "esri/symbols/MeshSymbol3D",
        "esri/symbols/edges/SolidEdges3D",
        "esri/layers/GroupLayer",
        "esri/widgets/BasemapToggle",
        "esri/widgets/Search",
        "esri/widgets/BasemapGallery",
    ], function (
        Basemap,
        Map,
        MapView,
        SceneView,
        FeatureLayer,
        FeatureFilter,
        SceneLayer,
        Layer,
        TileLayer,
        VectorTileLayer,
        LabelClass,
        LabelSymbol3D,
        WebMap,
        WebScene,
        PortalItem,
        Portal,
        TimeSlider,
        Legend,
        LayerList,
        Fullscreen,
        geometryService,
        Query,
        StatisticDefinition,
        WebStyleSymbol,
        TimeExtent,
        Expand,
        Editor,
        UniqueValueRenderer,
        DatePicker,
        FeatureTable,
        Compass,
        ElevationLayer,
        Ground,
        BuildingSceneLayer,
        BuildingExplorer,
        Slice,
        SlicePlane,
        SimpleRenderer,
        MeshSymbol3D,
        SolidEdges3D,
        GroupLayer,
        BasemapToggle,
        Search,
        BasemapGallery
    ) {
        ////////////////////////////////////////////////////
        var basemap = new Basemap({
            baseLayers: [
                new VectorTileLayer({
                    portalItem: {
                        id: "8a9ef2a144e8423786f6139408ac3424",
                    },
                }),
            ],
        });
        var map = new Map({
            basemap: basemap, // "streets-night-vector",
            ground: "world-elevation",
        });

        var view = new SceneView({
            map: map,
            container: "viewDiv",
            viewingMode: "local",
            camera: {
                position: {
                    x: 120.5793,
                    y: 15.18,
                    z: 500,
                },
                tilt: 65,
            },
            environment: {
                background: {
                    type: "color", // autocasts as new ColorBackground()
                    color: [0, 0, 0, 1],
                },
                // disable stars
                starsEnabled: false,
                //disable atmosphere
                atmosphereEnabled: false,
            },
        });

        view.ui.components = []; //removing esri attribution





        // Setup UI
        //var chartTitleDiv = document.getElementById("chartTitleDiv");
        //var headerDiv = document.getElementById("headerDiv");
        //var headerTitleDiv = document.getElementById("headerTitleDiv");
        //var applicationDiv = document.getElementById("applicationDiv");



        /////////////////// LAYER IMPORT ////////////////////////////


        //*****************************//
        // 3D Web Symbo Style Settings //
        //*****************************//

        // Esri Icon Symbol
        function IconSymbol(name) {
            return {
                type: "web-style", // autocasts as new WebStyleSymbol()
                name: name,
                styleName: "EsriIconsStyle", //EsriRealisticTransportationStyle, EsriIconsStyle
            };
        }

        // Utility Point Symbol
        /// https://developers.arcgis.com/javascript/latest/guide/esri-web-style-symbols-3d/
        function utilPtSymbolInfra(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriInfrastructureStyle",
            };
        }

        function utilPtSymbolStreet(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriRealisticStreetSceneStyle",
            };
        }

        function utilPtSymbolIcons(name) {
            return {
                type: "web-style",
                name: name,
                styleName: "EsriIconsStyle",
            };
        }

        /* custom 3D Web Style for Utility Pole */
        // Choice: 3D_Electric_Pole, 3D_Drain_Box, 3D_Water_Valve, 3D_Telecom_BTS, 3D_TelecomCATV_Pole

        function customSymbol3D(name) {
            return {
                type: "web-style",
                portal: "https://www.maps.arcgis.com",

                // IMPORTANT: Your browser needs to be able to open the following link. It will say insecure so need to go to advanced.
                styleUrl:
                    "https://www.maps.arcgis.com/sharing/rest/content/items/c04d4d4145f64f8fa38407dd5331dd1f/data",
                name: name,
            };
        }

        /* Company and Utilty Relocation Status Symbols with Callout */
        var verticalOffsetExisting = {
            screenLength: 10,
            maxWorldLength: 10,
            minWorldLength: 15,
        };

        var verticalOffsetRelocation = {
            screenLength: 10,
            maxWorldLength: 30,
            minWorldLength: 35,
        };


        //*****************************//
        //      Renderer Settings      //
        //*****************************//






        // Existing Points
        // Utility Line
        /* UniqueValueRenderer for line3D: color, width, and line type*/
        const options = {
            // Circle
            profile: "circle",
            cap: "none",
            join: "miter",
            width: 0.5,
            height: 0.5,
            //color: [200, 200, 200],
            profileRotation: "all",
        };

        const options1 = {
            // rectangular
            profile: "quad",
            cap: "none",
            join: "miter",
            width: 0.5,
            height: 0.5,
            color: [200, 200, 200],
            profileRotation: "heading",
        };

        /* The colors used for the each transit line */

        const colorsRelocation = {
            1: [32, 178, 170, 0.5], //Telecom Line
            2: [112, 128, 144, 0.5], // Internet Cable Line
            3: [0, 128, 255, 0.5], // Water Distribution Pipe
            4: [224, 224, 224, 0.5], // Sewage
            5: [105, 105, 105, 0.5], // Drainage
            6: [205, 133, 63, 0.5], // Canal
            7: [139, 69, 19, 0.5], // Creek
            8: [211, 211, 211, 0.5], // Elecric Line
        };

        const colorsExisting = {
            1: [229, 229, 229, 0.1], //Telecom/CA (Utility TYpe)
            2: [229, 229, 229, 0.1], // Water
            3: [229, 229, 229, 0.1], // Power
        };



        // Function that automatically creates the symbol for the points of interest
        function getUniqueValueSymbol(name, color, sizeS, util) {
            // The point symbol is visualized with an icon symbol. To clearly see the location of the point
            // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
            // of the point feature.
            if (util == "Existing") {
                return {
                    type: "point-3d", // autocasts as new PointSymbol3D()
                    symbolLayers: [
                        {
                            type: "icon", // autocasts as new IconSymbol3DLayer()
                            resource: {
                                href: name,
                            },
                            size: sizeS,
                            outline: {
                                color: "white",
                                size: 2,
                            },
                        },
                    ],

                    verticalOffset: verticalOffsetExisting,

                    callout: {
                        type: "line", // autocasts as new LineCallout3D()
                        color: [128, 128, 128, 0.1],
                        size: 0.2,
                        border: {
                            color: "grey",
                        },
                    },
                };
            } else {
                return {
                    type: "point-3d", // autocasts as new PointSymbol3D()
                    symbolLayers: [
                        {
                            type: "icon", // autocasts as new IconSymbol3DLayer()
                            resource: {
                                href: name,
                            },
                            size: sizeS,
                            outline: {
                                color: "white",
                                size: 2,
                            },
                        },
                    ],

                    verticalOffset: verticalOffsetRelocation,

                    callout: {
                        type: "line", // autocasts as new LineCallout3D()
                        color: [128, 128, 128, 0.1],
                        size: 0.2,
                        border: {
                            color: "grey",
                        },
                    },
                };
            }
        }



        //Renderer for both line and point for Relocated feature layer
        var utilReloSymbolRenderer = {
            type: "unique-value", // autocasts as new UniqueValueRenderer()
            valueExpression:
                "When($feature.Remarks == 'pending', 'NoAction', \
                            $feature.Status == 1 && $feature.LAYER == 1, 'DemolishComplete',\
                            $feature.Status == 0 && $feature.LAYER == 1, 'DemolishIncomplete',\
                            $feature.Status == 0 && $feature.LAYER == 2, 'RelocIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 2, 'RelocComplete', \
                            $feature.Status == 0 && $feature.LAYER == 3, 'NewlyAdded', \
                            $feature.Status == 1 && $feature.LAYER == 3, 'NewlyAddedComplete',$feature.Comp_Agency)",
            //field: "Company",
            uniqueValueInfos: [
                {
                    value: "DemolishIncomplete",
                    label: "To be Demolished",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Demolished.png",
                        "#D13470",
                        20,
                        "Relocation"
                    ),
                },
                {
                    value: "DemolishComplete",
                    label: "Demolision Completed",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png",
                        "#D13470",
                        25,
                        "Relocation"
                    ),
                },
                {
                    value: "RelocIncomplete",
                    label: "Proposed Relocation",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Relocatd.png",
                        "#D13470",
                        30,
                        "Relocation"
                    ),
                },
                {
                    value: "RelocComplete",
                    label: "Relocation Completed",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Utility_Relocated_Completed_Symbol.png",
                        "#D13470",
                        30,
                        "Relocation"
                    ),
                },
                {
                    value: "NewlyAdded",
                    label: "Add New Utility",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/NewlyAdded.png",
                        "#D13470",
                        35,
                        "Relocation"
                    ),
                },
                {
                    value: "NewlyAddedComplete",
                    label: "Newly Utility Added",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/NewlyAdded_Completed.png",
                        "#D13470",
                        35,
                        "Relocation"
                    ),
                },
                {
                    value: "NoAction",
                    label: "Require Data Checking",
                    symbol: getUniqueValueSymbol(
                        "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
                        "#D13470",
                        35,
                        "Relocation"
                    ),
                },
            ],
        };


        //**** ---- Station Box Layer ---- ***///
        // Renderer
        let stationBoxRenderer = {
            type: "unique-value",
            field: "Layer",
            defaultSymbol: { type: "simple-fill" },
            uniqueValueInfos: [
                {
                    value: "00_Platform",
                    symbol: {
                        type: "simple-fill",
                        color: [160, 160, 160],
                        style: "backward-diagonal",
                        outline: {
                            width: 1,
                            color: "black",
                        },
                    },
                },
                {
                    value: "00_Platform 10car",
                    symbol: {
                        type: "simple-fill",
                        color: [104, 104, 104],
                        style: "cross",
                        outline: {
                            width: 1,
                            color: "black",
                            style: "short-dash",
                        },
                    },
                },
                {
                    value: "00_Station",
                    symbol: {
                        type: "simple-fill",
                        color: [0, 0, 0, 0],
                        outline: {
                            width: 2,
                            color: [115, 0, 0],
                        },
                    },
                },
            ],
        };

        //Import stationBox Layer
        var stationBoxLayer = new FeatureLayer({
            portalItem: {
                id: "590680d19f2e48fdbd8bcddce3aaedb5",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 3,
            renderer: stationBoxRenderer,
            elevationInfo: {
                mode: "on-the-ground",
            },
            title: "Station Box",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(stationBoxLayer, 0);


        
        //**** ---- Pier No. (point feature) Layer ---- ***///
        //Label Class
        var pierNoLabelClass = new LabelClass({
            symbol: {
                type: "label-3d", // autocasts as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text", // autocasts as new TextSymbol3DLayer()
                        material: {
                            color: "white",
                        },
                        size: 10,
                        color: "black",
                        haloColor: "black",
                        haloSize: 1,
                        font: {
                            family: "Ubuntu Mono",
                            //weight: "bold"
                        },
                    },
                ],
                verticalOffset: {
                    screenLength: 100,
                    maxWorldLength: 100,
                    minWorldLength: 20,
                },
                callout: {
                    type: "line", // autocasts as new LineCallout3D()
                    color: "white",
                    size: 0.7,
                    border: {
                        color: "grey",
                    },
                },
            },
            labelPlacement: "above-center",
            labelExpressionInfo: {
                expression: "$feature.PIER",
                //value: "{TEXTSTRING}"
            },
        });

        //Import layer
        var PierNoLayer = new FeatureLayer({
            portalItem: {
                id: "590680d19f2e48fdbd8bcddce3aaedb5",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 6,
            labelingInfo: [pierNoLabelClass],
            elevationInfo: {
                mode: "on-the-ground", //absolute-height, relative-to-ground
            },
            title: "Pier No",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(PierNoLayer, 1);


        //**** ---- Pier head and column Layer ---- ***///

        // Renderer
        let pierHeadColRenderer = {
            type: "unique-value",
            field: "Layer",
            defaultSymbol: { type: "simple-fill" }, // autocasts as new SimpleFillSymbol()
            uniqueValueInfos: [
                {
                    // All features with value of "North" will be blue
                    value: "Pier_Column",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: [78, 78, 78, 0.5],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "Pier_Head",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: [169, 169, 169, 0.7],
                    },
                },
            ],
        };

        //Import layer
        var pierHeadColumnLayerLayer = new FeatureLayer({
            portalItem: {
                id: "590680d19f2e48fdbd8bcddce3aaedb5",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 4,
            title: "Pier Head/Column",
            outFields: ["*"],
            renderer: pierHeadColRenderer,
            elevationInfo: {
                mode: "on-the-ground",
            },
            popupEnabled: false,
        });
        //pierHeadColumnLayerLayer.listMode = "hide";
        map.add(pierHeadColumnLayerLayer, 1);


        //**** ---- Centerline and chainage Layer ---- ***///

        //Label Class
        var labelChainage = new LabelClass({
            labelExpressionInfo: { expression: "$feature.KM_MAIN" },
            symbol: {
                type: "text",
                color: [85, 255, 0],
                size: 25,
            },
        });

        //Renderer
        var chainageRenderer = {
            type: "simple",
            symbol: {
                type: "simple-marker",
                size: 5,
                color: [255, 255, 255, 0.9],
                outline: {
                    width: 0.2,
                    color: "black",
                },
            },
        };

        //Import Layer
        var chainageLayer = new FeatureLayer({
            portalItem: {
                id: "590680d19f2e48fdbd8bcddce3aaedb5",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 5,
            title: "Chainage",
            elevationInfo: {
                mode: "relative-to-ground",
            },
            labelingInfo: [labelChainage],
            renderer: chainageRenderer,
            outFields: ["*"],
            popupEnabled: false,
        });
        //chainageLayer.listMode = "hide";
        map.add(chainageLayer, 1);



        //**** ---- PROW Layer ---- ***///
        var rowLayer = new FeatureLayer({
            portalItem: {
                id: "590680d19f2e48fdbd8bcddce3aaedb5",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            title: "ROW",
            definitionExpression: "Extension = 'N2'",
            popupEnabled: false,
        });
        map.add(rowLayer, 2);


        //**** ---- Utility Point Layer ---- ***///
        // To locate a symbol with callout on the ground,
        // If basemap elevation layer is on, use "relative-to-scene"
        // If basemap elevatio layer is off, use "absolute-height"

        //3D Web Style
        var utilTypePtRenderer = {
            type: "unique-value", //"unique-value", "simple"
            //Field: "UtilType2",
            //defaultSymbol: ,
            //valueExpression: "When($feature.UtilType == 1, 'Telecom', $feature.UtilType == 2, 'Water',$feature.UtilType == 3, 'Power', $feature.UtilType)",
            valueExpression:
                "When($feature.UtilType2 == 1, 'Telecom Pole (BTS)', \
                            $feature.UtilType2 == 2, 'Telecom Pole (CATV)', \
                            $feature.UtilType2 == 3, 'Water Meter', \
                            $feature.UtilType2 == 4, 'Water Valve', \
                            $feature.UtilType2 == 5, 'Manhole', \
                            $feature.UtilType2 == 6, 'Drain Box', \
                            $feature.UtilType2 == 7, 'Electric Pole', \
                            $feature.UtilType2 == 8, 'Street Light', \
                            $feature.UtilType2 == 9, 'Junction Box', \
                            $feature.UtilType2 == 10, 'Coupling', \
                            $feature.UtilType2 == 11, 'Fitting', \
                            $feature.UtilType2 == 12, 'Transformer', \
                            $feature.UtilType2 == 13, 'Truss Guy', \
                            $feature.UtilType2 == 14, 'Concrete Pedestal', \
                            $feature.UtilType2 == 15, 'Ground', \
                            $feature.UtilType2 == 16, 'Down Guy', \
                            $feature.UtilType2 == 17, 'Entry/Exit Pit', \
                            $feature.UtilType2 == 18, 'Handhole', \
                            $feature.UtilType2 == 19, 'Transmission Tower', \
                            $feature.UtilType)",
            uniqueValueInfos: [
                {
                    value: "Telecom Pole (BTS)",
                    symbol: customSymbol3D("3D_Telecom_BTS"),
                },
                {
                    value: "Telecom Pole (CATV)",
                    symbol: customSymbol3D("3D_TelecomCATV_Pole"),
                },
                {
                    value: "Manhole",
                    symbol: utilPtSymbolStreet("Storm_Drain"),
                },
                {
                    value: "Electric Pole",
                    //symbol: utilPtSymbolInfra("Powerline_Pole")
                    symbol: customSymbol3D("3D_Electric_Pole"),
                },
                {
                    value: "Street Light",
                    symbol: utilPtSymbolStreet(
                        "Overhanging_Street_and_Sidewalk_-_Light_on"
                    ),
                },
                {
                    value: "Junction Box",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Coupling",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Fitting",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Transformer",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Truss Guy",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Concrete Pedestal",
                    symbol: customSymbol3D("Concrete Pedestal"),
                },
                {
                    value: "Ground",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Down Guy",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Entry/Exit Pit",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Handhole",
                    symbol: customSymbol3D("3D_Drain_Box"),
                },
                {
                    value: "Transmission Tower",
                    symbol: utilPtSymbolInfra("Powerline_Pole"),
                },
            ],
            visualVariables: [
                {
                    type: "size",
                    axis: "height",
                    field: "SIZE",
                    valueUnit: "meters",
                },
                {
                    type: "rotation",
                    field: "ROTATION",
                },
                /*
                {
                  type: "opacity",
                  valueExpression: "($feature.Status * $feature.LAYER) / 2",
                  // when utility is demolished, it becomes transparent
                  //valueExpression: "When($feature.Status == 1 && $feature.LAYER == 1, 0, 1)",
                  //field: "SIZE",
                  stops: [
                    {value: 0, opacity: 0.005}, //  want to delete
                    {value: 1, opacity: 1}, // want to visualize
                  ],
                  legendOptions: {
                    showLegend: false
                  }
                }
          */
            ],
        };

        //Import Layer
        var utilityPointLayer = new FeatureLayer({
            portalItem: {
                id: "109d4ef09fd946d1bda17396f35deb94",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            title: "Relocation Plan (Point)",
            outFields: ["*"],
            renderer: utilTypePtRenderer,
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.Height",
                },
                unit: "meters",
                //offset: 0
            },
            popupTemplate: {
                title: "<h5>{Comp_Agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated",
                        title: "Go to Relocated",
                    },
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id",
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type",
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name",
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>",
                            },
                            {
                                fieldName: "CP",
                            },
                            {
                                fieldName: "Remarks",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(utilityPointLayer, 3);


        //**** ---- Point Symbols with callout (relocation status) ---- ***///
        // To locate a symbol with callout on the ground,
        // If basemap elevation layer is on, use "relative-to-scene"
        // If basemap elevatio layer is off, use "absolute-height"

        // Label Class
        var labelUtilPtSymbol = {
            type: "label-3d", // autocasts as new LabelSymbol3D()
            labelPlacement: "above-center",
            labelExpressionInfo: {
                //value: "{Company}",
                expression:
                    "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')", //$feature.Comp_Agency
            },
            symbolLayers: [
                {
                    type: "text", // autocasts as new TextSymbol3DLayer()
                    material: {
                        color: "black",
                    },
                    halo: {
                        color: [255, 255, 255, 0.7],
                        size: 2,
                    },
                    size: 10,
                },
            ],
        };

        //Import Layer for Relocation Status
        var utilityPointLayer1 = new FeatureLayer({
            portalItem: {
                id: "109d4ef09fd946d1bda17396f35deb94",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            title: "Utility 3D Render Test",
            outFields: ["*"],
            renderer: utilReloSymbolRenderer,
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.Height",
                },
                unit: "meters",
                //offset: 0
            },
            labelingInfo: [labelUtilPtSymbol],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated",
                        title: "Go to Relocated",
                    },
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id",
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type",
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name",
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>",
                            },
                            {
                                fieldName: "CP",
                            },
                            {
                                fieldName: "Remarks",
                            },
                        ],
                    },
                ],
            },
        });
        utilityPointLayer1.listMode = "hide";
        map.add(utilityPointLayer1);



        //**** ---- Utility Line Layer ---- ***///
        var utilityLineLayer = new FeatureLayer({
            portalItem: {
                id: "109d4ef09fd946d1bda17396f35deb94",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 2,
            title: "Relocation Plan (Line)",
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.height",
                },
                unit: "meters",
                //offset: 0
            },
            outFields: ["*"],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated-line",
                        title: "Go to Relocated",
                    },
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id",
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type",
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name",
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>",
                            },
                            {
                                fieldName: "CP",
                            },
                            {
                                fieldName: "Remarks",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(utilityLineLayer, 4);

        /* Utility Line rendnerer*/
        function lineSizeShapeSymbolLayers(
            profile,
            cap,
            join,
            width,
            height,
            profileRotation,
            property
        ) {
            return {
                type: "line-3d",
                symbolLayers: [
                    {
                        type: "path",
                        profile: profile,
                        material: {
                            color: colorsRelocation[property],
                        },
                        width: width,
                        height: height,
                        join: join,
                        cap: cap,
                        anchor: "bottom",
                        profileRotation: profileRotation,
                    },
                ],
            };
        }

        function renderutilityLineLayer() {
            const renderer = new UniqueValueRenderer({
                field: "utiltype2",
            });

            for (let property in colorsRelocation) {
                // For each utility type 2
                if (property == 1) {
                    // If utility type2 === Telecom Line
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            0.5,
                            0.5,
                            "all",
                            property
                        ),
                    });
                } else if (property == 2) {
                    // "Internet Cable Line"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            0.4,
                            0.4,
                            "all",
                            property
                        ),
                    });
                } else if (property == 3) {
                    // "Water Distributin Pipe"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            1,
                            1,
                            "all",
                            property
                        ),
                    });
                } else if (property == 4) {
                    // "Sewerage"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            1,
                            1,
                            "all",
                            property
                        ),
                    });
                } else if (property == 5) {
                    // "Drainage"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            1,
                            1,
                            "all",
                            property
                        ),
                    });
                } else if (property == 6) {
                    // "Canal"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "quad",
                            "none",
                            "miter",
                            2,
                            2,
                            "all",
                            property
                        ),
                    });
                } else if (property == 7) {
                    // "Creek"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            1,
                            1,
                            "all",
                            property
                        ),
                    });
                } else if (property == 8) {
                    // "Electric Line"
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "circle",
                            "none",
                            "miter",
                            0.3,
                            0.3,
                            "all",
                            property
                        ),
                    });
                } else {
                    // end of 'property == '1'
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: lineSizeShapeSymbolLayers(
                            "quad",
                            "none",
                            "miter",
                            0.3,
                            0.3,
                            "all",
                            property
                        ),
                    });
                }
            }
            utilityLineLayer.renderer = renderer;
        }

        renderutilityLineLayer();


        // Utility Line Label
        var utilityLineLayerLabelClass = {
            type: "label-3d", // autocasts as new LabelSymbol3D()
            labelPlacement: "above-center", // Polyline has not choice
            labelExpressionInfo: {
                expression:
                    "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')",
            },
            symbolLayers: [
                {
                    type: "text", // autocasts as new TextSymbol3DLayer()
                    material: {
                        color: "black",
                    },
                    halo: {
                        color: [255, 255, 255, 0.7],
                        size: 2,
                    },
                    size: 10,
                },
            ],
        };

        /*Line for Symbols */
        var utilityLineLayer1 = new FeatureLayer({
            portalItem: {
                id: "109d4ef09fd946d1bda17396f35deb94",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 2,
            title: "utilityLineLayer",
            elevationInfo: {
                mode: "relative-to-ground", // original was "relative-to-scene"
                featureExpressionInfo: {
                    expression: "$feature.height",
                },
                unit: "meters",
                //offset: 0
            },
            outFields: ["*"],
            renderer: utilReloSymbolRenderer,
            labelingInfo: [utilityLineLayerLabelClass],
            popupTemplate: {
                title: "<h5>{comp_agency}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                actions: [
                    {
                        id: "find-relocated-line",
                        title: "Go to Relocated",
                    },
                ],
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Id",
                            },
                            {
                                fieldName: "UtilType",
                                label: "Utility Type",
                            },
                            {
                                fieldName: "UtilType2",
                                label: "Utility Name",
                            },
                            {
                                fieldName: "LAYER",
                                label: "<h5>Action</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "<h5>Status</h5>",
                            },
                            {
                                fieldName: "CP",
                            },
                            {
                                fieldName: "Remarks",
                            },
                        ],
                    },
                ],
            },
        });
        utilityLineLayer1.listMode = "hide";
        map.add(utilityLineLayer1);


        //**** ---- Station Layer ---- ***///

        /*//Label Class
        var labelClass = new LabelClass({
            symbol: {
                type: "label-3d", // autocasts as new LabelSymbol3D()
                symbolLayers: [
                    {
                        type: "text", // autocasts as new TextSymbol3DLayer()
                        material: {
                            color: "orange",
                        },
                        size: 30,
                        color: "black",
                        haloColor: "black",
                        haloSize: 1,
                        font: {
                            family: "Ubuntu Mono",
                            //weight: "bold"
                        },
                    },
                ],
                verticalOffset: {
                    screenLength: 40,
                    maxWorldLength: 100,
                    minWorldLength: 20,
                },
            },
            labelPlacement: "above-center",
            labelExpressionInfo: {
                expression: 'DefaultValue($feature.Station, "no data")',
                //value: "{TEXTSTRING}"
            },
        });


        // Renderer
        var stationsRenderer = {
            type: "unique-value", // autocasts as new UniqueValueRenderer()
            field: "Station",
            defaultSymbol: IconSymbol("Train"), //Backhoe, Train
        };

        
        // Import Layer
        var stationLayer = new SceneLayer({
            portalItem: {
                id: "207cb34b8a324b40985b5805862c4b29",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            title: "Station",
            labelingInfo: [labelClass],
            renderer: stationsRenderer,
            elevationInfo: {
                // this elevation mode will place points on top of
                // buildings or other SceneLayer 3D objects
                mode: "relative-to-ground",
            },
            //definitionExpression: "Extension = 'N2'"
            //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
        });
        //stationLayer.listMode = "hide";
        map.add(stationLayer, 0);*/



        /*// Viaduct layer
        const colors = {
            1: [225, 225, 225, 0.1], // To be Constructed (white)
            2: [130, 130, 130, 0.5], // Under Construction
            3: [255, 0, 0, 0.8], // Delayed
            4: [0, 112, 255, 0.8], // Bored Pile
            5: [0, 112, 255, 0.8], // Pile cap
            6: [0, 112, 255, 0.8], // Pier
            7: [0, 112, 255, 0.8], // Pier head
            8: [0, 112, 255, 0.8], // Pre-cast
        };

        var viaductLayer = new SceneLayer({
            portalItem: {
                id: "a9c0878766964fa794cc67bbf38b7a09",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            // popupTemplate: viadTemplate,
            elevationInfo: {
                mode: "absolute-height", //absolute-height, relative-to-ground
            },
            title: "Viaduct",
            outFields: ["*"],
        });
        map.add(viaductLayer, 1);

        function renderViaductLayer() {
            const renderer = new UniqueValueRenderer({
                field: "Status1",
            });

            for (let property in colors) {
                if (colors.hasOwnProperty(property)) {
                    renderer.addUniqueValueInfo({
                        value: property,
                        symbol: {
                            type: "mesh-3d",
                            symbolLayers: [
                                {
                                    type: "fill",
                                    material: {
                                        color: colors[property],
                                        colorMixMode: "replace",
                                    },
                                    edges: {
                                        type: "solid", // autocasts as new SolidEdges3D()
                                        color: [225, 225, 225, 0.3],
                                    },
                                },
                            ],
                        },
                    });
                }
            }
            viaductLayer.renderer = renderer;
        }
        renderViaductLayer();*/



        //****---------------- Zoom To Layer -----------------------****//
        function zoomToLayer(layer) {
            return layer.queryExtent().then(function (response) {
                view
                    .goTo(response.extent, {
                        //response.extent
                        speedFactor: 2,
                    })
                    .catch(function (error) {
                        if (error.name != "AbortError") {
                            console.error(error);
                        }
                    });
            });
        }

        //***********************************************************************//
        //*******************************CHART***********************************//
        //***********************************************************************//
        const totalProgressTitleDiv = document.getElementById(
            "totalProgressTitleDiv"
        );
        const totalProgressDiv = document.getElementById("totalProgressDiv");

        /*am5.ready(function () {
            // Define
            const chartWaterPointDiv = document.getElementById("chartWaterPointDiv");
            const chartWaterLineDiv = document.getElementById("chartWaterLineDiv");
            const chartWaterAllDiv = document.getElementById("chartWaterAllDiv");

            const chartSewagePointDiv = document.getElementById(
                "chartSewagePointDiv"
            );
            const chartSewageLineDiv = document.getElementById("chartSewageLineDiv");
            const chartSewageAllDiv = document.getElementById("chartSewageAllDiv");

            const chartPowerPointDiv = document.getElementById("chartPowerPointDiv");
            const chartPowerLineDiv = document.getElementById("chartPowerLineDiv");
            const chartPowerAllDiv = document.getElementById("chartPowerAllDiv");

            const chartTelecomPointDiv = document.getElementById(
                "chartTelecomPointDiv"
            );
            const chartTelecomLineDiv = document.getElementById(
                "chartTelecomLineDiv"
            );
            const chartTelecomAllDiv = document.getElementById("chartTelecomAllDiv");

            // Default label
            // As default, chart shows the progress of all the relocated layers (point + line)

            function waterDefaultLabels() {
                chartWaterPointDiv.style.display = "none";
                chartWaterLineDiv.style.display = "none";
                chartWaterAllDiv.style.display = "block";
                waterAllChart();
            }
            waterDefaultLabels();

            function sewageDefaultLabels() {
                chartSewagePointDiv.style.display = "none";
                chartSewageLineDiv.style.display = "none";
                chartSewageAllDiv.style.display = "block";
                sewageAllChart();
            }
            sewageDefaultLabels();

            function powerDefaultLabels() {
                chartPowerPointDiv.style.display = "none";
                chartPowerLineDiv.style.display = "none";
                chartPowerAllDiv.style.display = "block";
                powerAllChart();
            }
            powerDefaultLabels();

            function telecomDefaultLabels() {
                chartTelecomPointDiv.style.display = "none";
                chartTelecomLineDiv.style.display = "none";
                chartTelecomAllDiv.style.display = "block";
                telecomAllChart();
            }
            telecomDefaultLabels();

            // Thousand separators function
            function thousands_separators(num) {
                var num_parts = num.toString().split(".");
                num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return num_parts.join(".");
            }

            ////
            // Total progress for both points and lines combined
            function totalProgressPt() {
                var total_util_number = {
                    onStatisticField: "Status",
                    outStatisticFieldName: "total_util_number",
                    statisticType: "count",
                };

                var total_prog_util = {
                    onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_prog_util",
                    statisticType: "sum",
                };

                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_util_number, total_prog_util];
                query.returnGeometry = true;

                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const progress = stats.total_prog_util;
                    const total = stats.total_util_number;
                    const perc = (progress / total) * 100;

                    const compileArray = [total, progress];
                    return compileArray;
                });
            }

            function totalProgressLine(compileArray) {
                var total_util_number = {
                    onStatisticField: "Status",
                    outStatisticFieldName: "total_util_number",
                    statisticType: "count",
                };

                var total_prog_util = {
                    onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_prog_util",
                    statisticType: "sum",
                };

                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_util_number, total_prog_util];
                query.returnGeometry = true;

                utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const progress = stats.total_prog_util;
                    const total = stats.total_util_number;
                    const perc = (progress / total) * 100;

                    const totalAll = total + compileArray[0];
                    const progressAll = progress + compileArray[1];

                    const totalperc = (progressAll / totalAll) * 100;
                    totalProgressDiv.innerHTML = totalperc.toFixed(1) + " %";
                });
            }

            function totalProgressAll() {
                totalProgressPt().then(totalProgressLine);
            }
            totalProgressAll();

            // Define drop-down list select
            var cpSelect = document.getElementById("valSelect");
            var companySelect = document.getElementById("companySelect");
            var typeSelect = document.getElementById("typeSelect");

            view
                .when(function () {
                    return utilityPointLayer.when(function () {
                        var query = utilityPointLayer.createQuery();
                        return utilityPointLayer.queryFeatures(query);
                    });
                })
                .then(getValues)
                .then(getUniqueValues)
                .then(addToSelect);

            // newValue1: CP
            // newValue2: Type
            // newValue3: Company

            function queryForLotGeometries() {
                var lotQuery = utilityPointLayer.createQuery();

                return utilityPointLayer
                    .queryFeatures(lotQuery)
                    .then(function (response) {
                        lotGeometries = response.features.map(function (feature) {
                            return feature.geometry;
                        });
                        return lotGeometries;
                    });
            }

            /////////////////////////////////////////////////////////////////////////
            // 2. Get values and Return to list
            //Return an array of all the values in the 'CP' field'
            /// 2.1. CP
            function getValues(response) {
                var features = response.features;
                var values = features.map(function (feature) {
                    return feature.attributes.CP;
                });
                return values;
            }

            // Return an array of unique values in the 'CP' field of Utililty Point
            function getUniqueValues(values) {
                var uniqueValues = [];

                values.forEach(function (item, i) {
                    if (
                        (uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) &&
                        item !== ""
                    ) {
                        uniqueValues.push(item);
                    }
                });
                return uniqueValues;
            }

            // Add the unique values to the cpSelect element. this will allow the user
            // to filter Utility Point by CP.
            function addToSelect(values) {
                values.sort();
                values.unshift("None"); // Add 'None' to the array and place it to the beginning of the array
                values.forEach(function (value) {
                    var option = document.createElement("option");
                    option.text = value;
                    cpSelect.add(option);
                });
            }

            /// 2.2. Company
            // Filter Company List when CP list changes
            // Insert my custom code to add companies from both point and line
            function filterUtilPointLineCP(cpValue) {
                var compArray = [];
                var compArray1 = [];

                // Query for Utility Point
                function utilPointQuery() {
                    var query = utilityPointLayer.createQuery();
                    // CP: All, Type: All, Provider: All
                    if (cpValue === undefined || cpValue === "None") {
                        query.where = "1=1";

                        // CP: !None, Type: All
                    } else if (cpValue !== "None") {
                        query.where = "CP = '" + cpValue + "'";
                    }

                    return utilityPointLayer
                        .queryFeatures(query)
                        .then(function (response) {
                            stats = response.features;
                            stats.forEach((result, index) => {
                                const attributes = result.attributes;
                                const COMPANY = attributes.Company;
                                compArray.push(COMPANY);
                            });
                            return compArray;
                        }); // end of query features
                } // end of utility point query

                // Query for Utility Line
                function utilLineQuery(compArray) {
                    var query2 = utilityLineLayer.createQuery();

                    // CP: All, Type: All, Provider: All
                    if (cpValue === undefined || cpValue === "None") {
                        query2.where = "1=1";

                        // CP: !None, Type: All
                    } else if (cpValue !== "None") {
                        query2.where = "CP = '" + cpValue + "'";
                    }

                    return utilityLineLayer
                        .queryFeatures(query2)
                        .then(function (response) {
                            stats = response.features;
                            stats.forEach((result) => {
                                const attributes = result.attributes;
                                const COMPANY = attributes.Company;
                                compArray1.push(COMPANY);
                            });
                            const allArray = compArray.concat(compArray1);
                            return allArray;
                        });
                } // end of Utility line query

                function getUniqueValues2(values2) {
                    var uniqueValues2 = [];
                    values2.forEach(function (item, i) {
                        if (
                            (uniqueValues2.length < 1 ||
                                uniqueValues2.indexOf(item) === -1) &&
                            item !== ""
                        ) {
                            uniqueValues2.push(item);
                        }
                    });
                    return uniqueValues2;
                }

                // Add the unique values to the second select element (Company)
                function addToSelectQuery2(query2Values) {
                    companySelect.options.length = 0;
                    query2Values.sort();
                    query2Values.unshift("None");
                    query2Values.forEach(function (value) {
                        var option = document.createElement("option");
                        option.text = value;
                        companySelect.add(option);
                    });
                }
                utilPointQuery()
                    .then(utilLineQuery)
                    .then(getUniqueValues2) // original: .then(getUniqueValues)
                    .then(addToSelectQuery2)
                    .then(totalProgressAll);
            } // end of filterUtilPointLineCP
            filterUtilPointLineCP();

            /// 2.3. Type
            /// Inser my custom functin to get Type from point and line
            function filterUtilPointLineType(cpValue, companyValue) {
                var Array = [];
                var Array1 = [];

                // Query for Utility Point
                function utilPointQuery3() {
                    var query = utilityPointLayer.createQuery();

                    // CP: undefined, Company: undefined
                    if (cpValue === undefined && companyValue === undefined) {
                        query.where = "1=1";

                        // CP: None, Company: !None
                    } else if (cpValue === "None" && companyValue !== "None") {
                        query.where = "Company = '" + companyValue + "'";

                        // CP: None, Company: None
                    } else if (cpValue === "None" && companyValue === "None") {
                        query.where = "1=1";

                        // CP: !None, Company: None
                    } else if (cpValue !== "None" && companyValue === "None") {
                        query.where = "CP = '" + cpValue + "'";

                        // CP: !None, Company: !None
                    } else if (cpValue !== "None" && companyValue !== "None") {
                        query.where =
                            "CP = '" +
                            cpValue +
                            "'" +
                            " AND " +
                            "Company = '" +
                            companyValue +
                            "'";
                    }

                    return utilityPointLayer
                        .queryFeatures(query)
                        .then(function (response) {
                            stats = response.features;
                            stats.forEach((result, index) => {
                                const attributes = result.attributes;
                                const TYPE = attributes.Type;
                                Array.push(TYPE);
                            });
                            return Array;
                        }); // end of query features
                } // end of utility point query

                // Query for Utility Line
                function utilLineQuery3(compArray) {
                    var query2 = utilityLineLayer.createQuery();

                    // CP: undefined, Company: undefined
                    if (cpValue === undefined && companyValue === undefined) {
                        query2.where = "1=1";

                        // CP: None, Company: !None
                    } else if (cpValue === "None" && companyValue !== "None") {
                        query2.where = "Company = '" + companyValue + "'";

                        // CP: None, Company: None
                    } else if (cpValue === "None" && companyValue === "None") {
                        query2.where = "1=1";

                        // CP: !None, Company: None
                    } else if (cpValue !== "None" && companyValue === "None") {
                        query2.where = "CP = '" + cpValue + "'";

                        // CP: !None, Company: !None
                    } else if (cpValue !== "None" && companyValue !== "None") {
                        query2.where =
                            "CP = '" +
                            cpValue +
                            "'" +
                            " AND " +
                            "Company = '" +
                            companyValue +
                            "'";
                    }

                    return utilityLineLayer
                        .queryFeatures(query2)
                        .then(function (response) {
                            stats = response.features;
                            stats.forEach((result) => {
                                const attributes = result.attributes;
                                const TYPE = attributes.Type;
                                Array1.push(TYPE);
                            });
                            const allArray = Array.concat(Array1);
                            return allArray;
                        });
                } // end of Utility line query

                function getUniqueValues3(values2) {
                    var uniqueValues2 = [];
                    values2.forEach(function (item, i) {
                        if (
                            (uniqueValues2.length < 1 ||
                                uniqueValues2.indexOf(item) === -1) &&
                            item !== ""
                        ) {
                            uniqueValues2.push(item);
                        }
                    });
                    return uniqueValues2;
                }

                // Add the unique values to the second select element (Company)
                function addToSelectQuery3(query2Values) {
                    typeSelect.options.length = 0;
                    query2Values.sort();
                    query2Values.unshift("None");
                    query2Values.forEach(function (value) {
                        var option = document.createElement("option");
                        option.text = value;
                        typeSelect.add(option);
                    });
                    return query2Values;
                }
                utilPointQuery3()
                    .then(utilLineQuery3)
                    .then(getUniqueValues3)
                    .then(addToSelectQuery3)
                    .then(ZoomToLayerQuery)
                    .then(totalProgressAll);
            } // end of filterUtilPointLineCP
            filterUtilPointLineType();

            // Define zoomTo
            // This is necessary, as some companies have only points or lines, or both.
            // Use correct zoomToLayer
            function ZoomToLayerQuery(values) {
                var regex = /\b(?:Point|Line)\b/gi;
                var subject = values.toString();
                let result = subject.match(regex);

                // both Point and Line
                if (result.length === 3) {
                    zoomToLayer(utilityPointLayer);
                } else if (result[0] === "Point") {
                    zoomToLayer(utilityPointLayer);
                } else {
                    zoomToLayer(utilityLineLayer);
                }
            }
            ///////////////////////////////////////////////////////////////////////
            // Set the definition expression on the Utility Point layer
            // to reflect the selecction of the user
            // Only for CP
            function setLotMunicipalOnlyExpression(newValue) {
                const cpExpression = "CP = '" + newValue + "'";
                if (newValue === "None") {
                    utilityPointLayer.definitionExpression = null;
                    utilityPointLayer1.definitionExpression = null;
                    utilityLineLayer.definitionExpression = null;
                    utilityLineLayer1.definitionExpression = null;
                    viaductLayer.definitionExpression = null;
                } else {
                    utilityPointLayer.definitionExpression = cpExpression;
                    utilityPointLayer1.definitionExpression = cpExpression;
                    utilityLineLayer.definitionExpression = cpExpression;
                    utilityLineLayer1.definitionExpression = cpExpression;
                    viaductLayer.definitionExpression = cpExpression;
                }
                zoomToLayer(utilityPointLayer);
                return queryForLotGeometries();
            }

            function setLotDefinitionExpression(newValue1, newValue2, newValue3) {
                const cpExpression = "CP = '" + newValue1 + "'";
                const companyExpression = "Company = '" + newValue3 + "'";
                const typeExpression = "Type = '" + newValue2 + "'";
                // newValue: CP
                // newValue2: Utility Type
                // newValue3: Company

                //1
                if (newValue1 == "None" && newValue2 == "None" && newValue3 == "None") {
                    utilityPointLayer.definitionExpression = null;
                    utilityPointLayer1.definitionExpression = null;
                    utilityLineLayer.definitionExpression = null;
                    utilityLineLayer1.definitionExpression = null;
                    //2
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "None" &&
                    newValue3 !== "None"
                ) {
                    utilityPointLayer.definitionExpression = companyExpression;
                    utilityPointLayer1.definitionExpression = companyExpression;

                    utilityLineLayer.definitionExpression = companyExpression;
                    utilityLineLayer1.definitionExpression = companyExpression;

                    //3
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "Point" &&
                    newValue3 == "None"
                ) {
                    utilityPointLayer.definitionExpression = null;
                    utilityPointLayer1.definitionExpression = null;
                    utilityLineLayer.definitionExpression = typeExpression;
                    utilityLineLayer1.definitionExpression = typeExpression;
                    //4
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "Point" &&
                    newValue3 !== "None"
                ) {
                    utilityPointLayer.definitionExpression = companyExpression;
                    utilityPointLayer1.definitionExpression = companyExpression;
                    utilityLineLayer.definitionExpression = typeExpression;
                    utilityLineLayer1.definitionExpression = typeExpression;
                    //5
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "Line" &&
                    newValue3 == "None"
                ) {
                    utilityLineLayer.definitionExpression = null;
                    utilityLineLayer1.definitionExpression = null;
                    utilityPointLayer.definitionExpression = typeExpression;
                    utilityPointLayer1.definitionExpression = typeExpression;
                    //6
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "Line" &&
                    newValue3 !== "None"
                ) {
                    utilityLineLayer.definitionExpression = companyExpression;
                    utilityLineLayer1.definitionExpression = companyExpression;
                    utilityPointLayer.definitionExpression = typeExpression;
                    utilityPointLayer1.definitionExpression = typeExpression;
                    //7
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "None" &&
                    newValue3 == "None"
                ) {
                    utilityLineLayer.definitionExpression = cpExpression;
                    utilityLineLayer1.definitionExpression = cpExpression;
                    utilityPointLayer.definitionExpression = cpExpression;
                    utilityPointLayer1.definitionExpression = cpExpression;
                    //8
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "None" &&
                    newValue3 !== "None"
                ) {
                    utilityLineLayer.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityLineLayer1.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityPointLayer.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityPointLayer1.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    //9
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "Point" &&
                    newValue3 == "None"
                ) {
                    utilityLineLayer.definitionExpression = typeExpression;
                    utilityLineLayer1.definitionExpression = typeExpression;
                    utilityPointLayer.definitionExpression = cpExpression;
                    utilityPointLayer1.definitionExpression = cpExpression;
                    //10
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "Point" &&
                    newValue3 !== "None"
                ) {
                    utilityLineLayer.definitionExpression = typeExpression;
                    utilityLineLayer1.definitionExpression = typeExpression;
                    utilityPointLayer.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityPointLayer1.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    //11
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "Line" &&
                    newValue3 == "None"
                ) {
                    utilityLineLayer.definitionExpression = cpExpression;
                    utilityLineLayer1.definitionExpression = cpExpression;
                    utilityPointLayer.definitionExpression = typeExpression;
                    utilityPointLayer1.definitionExpression = typeExpression;
                    //12
                } else if (
                    newValue1 !== "None" &&
                    newValue2 == "Line" &&
                    newValue3 !== "None"
                ) {
                    utilityLineLayer.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityLineLayer1.definitionExpression =
                        cpExpression + " AND " + companyExpression;
                    utilityPointLayer.definitionExpression = typeExpression;
                    utilityPointLayer1.definitionExpression = typeExpression;

                    // When a comapny is first selected over CP,
                } else if (
                    newValue1 == "None" &&
                    newValue2 == "" &&
                    newValue3 !== "None"
                ) {
                    utilityPointLayer.definitionExpression = companyExpression;
                    utilityPointLayer1.definitionExpression = companyExpression;

                    utilityLineLayer.definitionExpression = companyExpression;
                    utilityLineLayer1.definitionExpression = companyExpression;
                }
                return queryForLotGeometries();
            }

            // When CP is changed, Type is reset to 'None'
            const changeSelected = (e) => {
                const $select = document.querySelector("#typeSelect");
                $select.value = "None";
            };

            // Dropdown List
            // Select CP from dropdown list
            cpSelect.addEventListener("change", function () {
                var type = event.target.value;
                var target = event.target;
                var companyValue = companySelect.value;

                filterUtilPointLineCP(type);
                filterUtilPointLineType(type, companyValue);

                setLotMunicipalOnlyExpression(type);
                changeSelected();

                totalProgressAll();

                waterDefaultLabels();
                sewageDefaultLabels();
                powerDefaultLabels();
                telecomDefaultLabels();
            });

            function waterPointFilter() {
                chartWaterPointDiv.style.display = "block";
                chartWaterLineDiv.style.display = "none";
                chartWaterAllDiv.style.display = "none";
                chartPointWater();
            }

            function waterLineFilter() {
                chartWaterPointDiv.style.display = "none";
                chartWaterLineDiv.style.display = "block";
                chartWaterAllDiv.style.display = "none";
                chartLineWater();
            }

            function sewagePointFilter() {
                chartSewagePointDiv.style.display = "block";
                chartSewageLineDiv.style.display = "none";
                chartSewageAllDiv.style.display = "none";
                chartPointSewage();
            }

            function sewageLineFilter() {
                chartSewagePointDiv.style.display = "none";
                chartSewageLineDiv.style.display = "block";
                chartSewageAllDiv.style.display = "none";
                chartLineSewage();
            }

            function powerPointFilter() {
                chartPowerPointDiv.style.display = "block";
                chartPowerLineDiv.style.display = "none";
                chartPowerAllDiv.style.display = "none";
                chartPointPower();
            }

            function powerLineFilter() {
                chartPowerPointDiv.style.display = "none";
                chartPowerLineDiv.style.display = "block";
                chartPowerAllDiv.style.display = "none";
                chartLinePower();
            }

            function telecomPointFilter() {
                chartTelecomPointDiv.style.display = "block";
                chartTelecomLineDiv.style.display = "none";
                chartTelecomAllDiv.style.display = "none";
                chartPointTelecom();
            }

            function telecomLineFilter() {
                chartTelecomPointDiv.style.display = "none";
                chartTelecomLineDiv.style.display = "block";
                chartTelecomAllDiv.style.display = "none";
                chartLineTelecom();
            }

            // Provider dropdown list
            companySelect.addEventListener("change", function (event) {
                const companyValue = event.target.value;

                changeSelected();

                var cpValue = cpSelect.value;
                console.log(
                    cpSelect.value + "; " + typeSelect.value + "; " + companySelect.value
                );
                filterUtilPointLineType(cpValue, companyValue);
                setLotDefinitionExpression(
                    cpSelect.value,
                    typeSelect.value,
                    companySelect.value
                );

                // If a provider selected does not have both point or line,
                const typeS = typeSelect.value;
                if (typeS === "Point") {
                    waterPointFilter();
                    sewagePointFilter();
                    powerPointFilter();
                    telecomPointFilter();
                } else if (typeS === "Line") {
                    waterLineFilter();
                    sewageLineFilter();
                    powerLineFilter();
                    telecomLineFilter();
                } else if (typeS === "None") {
                    waterDefaultLabels();
                    sewageDefaultLabels();
                    powerDefaultLabels();
                    telecomDefaultLabels();

                    // When a comapny is first selected over CP,
                } else if (typeS === "") {
                    waterDefaultLabels();
                    sewageDefaultLabels();
                    powerDefaultLabels();
                    telecomDefaultLabels();
                }
                totalProgressAll();
            });

            // Utility Type: Point or Line
            typeSelect.addEventListener("change", async function (event) {
                const typeS = event.target.value;

                setLotDefinitionExpression(cpSelect.value, typeS, companySelect.value);

                if (typeS === "Point") {
                    waterPointFilter();
                    sewagePointFilter();
                    powerPointFilter();
                    telecomPointFilter();
                } else if (typeS === "Line") {
                    waterLineFilter();
                    sewageLineFilter();
                    powerLineFilter();
                    telecomLineFilter();
                } else if (typeS === "None") {
                    waterDefaultLabels();
                    sewageDefaultLabels();
                    powerDefaultLabels();
                    telecomDefaultLabels();
                }
                totalProgressAll();
            });

            // Get last edited date

            const month = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            function getEditedDateValue() {
                var tempDates = [];

                var query = utilityPointLayer.createQuery();
                query.fields = ["last_edited_date"];
                query.where = "last_edited_date IS NOT NULL";
                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features;
                    stats.forEach((result, index) => {
                        var attributes = result.attributes;
                        const dates = attributes.last_edited_date;
                        tempDates.push(dates);
                    });
                    const lastDate = Math.max(...tempDates);
                    const lastEdit = new Date(lastDate);
                    const yyyy = lastEdit.getFullYear();
                    const mm = month[lastEdit.getMonth()];
                    const dd = lastEdit.getDate();
                    const lastEditedDate = `As of ${mm} ${dd}, ${yyyy}`;
                    document.getElementById("dateDiv").innerHTML = "As of June 16, 2023";
                });
            } getEditedDateValue();* /

            document.getElementById("dateDiv").innerHTML = "As of October 27, 2023";

            ///
            let chartLayerView;

            // Chart ********************************
            const marginTop = 0;
            const marginLeft = 0;
            const marginRight = 0;
            const marginBottom = 0;
            const paddingTop = 0;
            const paddingLeft = 5;
            const paddingRight = 5;
            const paddingBottom = 0;

            const xAxisNumberFormat = "#'%'";
            const seriesBulletLabelFontSize = "0.5em";

            // series line fill pattern
            const linePatternColorComplete = "#70AD47";
            const linePatternColorOpacityComplete = 0;
            const linePatternFillOpacityComplete = 0;

            const linePatternColorOpacityIncomplet = 0;
            const linePatternFillOpacityIncomplet = 1;
            const linePatternStrokeOpacityIncomplet = 0;

            const chartIconWidth = 40;
            const chartIconHeight = 40;
            const chartIconPositionX = -27;
            const chartPaddingRightIconLabel = 45;

            const chartSeriesFillColorComp = "#0070ff";
            const chartSeriesFillColorIncomp = "#000000";
            const chartBorderLineColor = "#00c5ff";
            const chartBorderLineWidth = 0.4;

            // axis label
            const yAxisLabelFontSize = "0vw";
            const xAxisLabelFontSize = "0.8vw";
            const legendFontSize = "0.8vw";

            // 1. Water
            // 1.1. Point
            var root_water1 = am5.Root.new("chartWaterPointDiv");
            root_water1._logo.dispose();

            var myTheme = am5.Theme.new(root_water1);
            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function chartPointWater(cpValue, companyValue) {
                root_water1.container.children.clear();
                var total_water_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_incomp",
                    statisticType: "sum",
                };

                var total_water_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_water_incomp, total_water_comp];
                query.returnGeometry = true;

                utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const water_incomp = stats.total_water_incomp;
                    const water_comp = stats.total_water_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_water1.setThemes([
                        am5themes_Animated.new(root_water1),
                        am5themes_Responsive.new(root_water1),
                        //MyTheme.new(root_water1),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_water1.container.children.push(
                        am5xy.XYChart.new(root_water1, {
                            panX: false,
                            panY: false,
                            layout: root_water1.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "water",
                            comp: water_comp,
                            incomp: water_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_water1, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_water1, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_water1, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_water1, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_water1, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_water1, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_water1, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_water1, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_water1, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_water1, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_water1, {
                                sprite: am5.Label.new(root_water1, {
                                    text:
                                        water_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_water1.interfaceColors.get("alternativeText"),
                                    opacity: fieldName === "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 2" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view
                                    .whenLayerView(utilityPointLayer)
                                    .then(function (layerView) {
                                        //testUtilPt1.definitionExpression = sqlExpression;
                                        utilityPointLayer.queryFeatures().then(function (results) {
                                            const RESULT_LENGTH = results.features;
                                            const ROW_N = RESULT_LENGTH.length;

                                            let objID = [];
                                            for (var i = 0; i < ROW_N; i++) {
                                                var obj = results.features[i].attributes.OBJECTID;
                                                objID.push(obj);
                                            }

                                            var queryExt = new Query({
                                                objectIds: objID,
                                            });

                                            utilityPointLayer
                                                .queryExtent(queryExt)
                                                .then(function (result) {
                                                    if (result.extent) {
                                                        view.goTo(result.extent);
                                                    }
                                                });

                                            if (highlight) {
                                                highlightSelect.remove();
                                            }
                                            highlight = layerView.highlight(objID);

                                            view.on("click", function () {
                                                layerView.filter = null;
                                                highlight.remove();
                                            });
                                        }); // end of query features
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // end of when layerview

                                view
                                    .whenLayerView(utilityPointLayer1)
                                    .then(function (layerView) {
                                        utilityPointLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartWater

            // 1.2. Line
            var root_water2 = am5.Root.new("chartWaterLineDiv");
            root_water2._logo.dispose();

            var myTheme = am5.Theme.new(root_water2);
            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function chartLineWater(cpValue, companyValue) {
                root_water2.container.children.clear();
                var total_water_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_incomp",
                    statisticType: "sum",
                };

                var total_water_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_water_incomp, total_water_comp];
                query.returnGeometry = true;

                utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const water_incomp = stats.total_water_incomp;
                    const water_comp = stats.total_water_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_water2.setThemes([
                        am5themes_Animated.new(root_water2),
                        am5themes_Responsive.new(root_water2),
                        //MyTheme.new(root_water2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_water2.container.children.push(
                        am5xy.XYChart.new(root_water2, {
                            panX: false,
                            panY: false,
                            layout: root_water2.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "water",
                            comp: water_comp,
                            incomp: water_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_water2, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_water2, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_water2, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_water2, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_water2, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_water2, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_water2, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_water2, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_water2, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_water2, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_water2, {
                                sprite: am5.Label.new(root_water2, {
                                    text:
                                        water_comp === 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_water2.interfaceColors.get("alternativeText"),
                                    opacity: fieldName === "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 2" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                    //testUtilPt1.definitionExpression = sqlExpression;
                                    utilityLineLayer.queryFeatures().then(function (results) {
                                        const RESULT_LENGTH = results.features;
                                        const ROW_N = RESULT_LENGTH.length;

                                        let objID = [];
                                        for (var i = 0; i < ROW_N; i++) {
                                            var obj = results.features[i].attributes.OBJECTID;
                                            objID.push(obj);
                                        }

                                        var queryExt = new Query({
                                            objectIds: objID,
                                        });

                                        utilityLineLayer
                                            .queryExtent(queryExt)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view.goTo(result.extent);
                                                }
                                            });

                                        if (highlight) {
                                            highlightSelect.remove();
                                        }
                                        highlight = layerView.highlight(objID);

                                        view.on("click", function () {
                                            layerView.filter = null;
                                            highlight.remove();
                                        });
                                    }); // end of query features
                                    layerView.filter = {
                                        where: sqlExpression,
                                        //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                    };
                                }); // end of when layerview

                                view
                                    .whenLayerView(utilityLineLayer1)
                                    .then(function (layerView) {
                                        utilityLineLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartWater

            // 1.3. Point + Line
            /// 1.3.1. Point for compiled
            /// 1.3.1. Point for compiled
            function chartPointWaterForCompile() {
                var total_water_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_incomp",
                    statisticType: "sum",
                };

                var total_water_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_water_incomp, total_water_comp];
                query.returnGeometry = true;

                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const water_incomp = stats.total_water_incomp;
                    const water_comp = stats.total_water_comp;
                    const waterPointValues = [water_incomp, water_comp];

                    return waterPointValues;
                }); // end of queryFeatures
            } // end of updateChartWater

            /// 1.3.2. Line for compiled
            function chartLineWaterForCompile(waterPointValues) {
                var total_water_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_incomp",
                    statisticType: "sum",
                };

                var total_water_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_water_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_water_incomp, total_water_comp];
                query.returnGeometry = true;

                return utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const water_incomp = stats.total_water_incomp;
                    const water_comp = stats.total_water_comp;

                    const waterIncompTotal = water_incomp + waterPointValues[0];
                    const waterCompTotal = water_comp + waterPointValues[1];
                    const waterTotalValues = [waterIncompTotal, waterCompTotal];

                    return waterTotalValues;
                }); // end of queryFeatures
            } // end of updateChartWater

            /// 1.3.3. Point + Line
            var root_water3 = am5.Root.new("chartWaterAllDiv");
            root_water3._logo.dispose();

            function waterCompiledChart(waterTotalValues) {
                root_water3.container.children.clear();

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_water3.setThemes([
                    am5themes_Animated.new(root_water3),
                    am5themes_Responsive.new(root_water3),
                    //MyTheme.new(root_water3),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_water3.container.children.push(
                    am5xy.XYChart.new(root_water3, {
                        panX: false,
                        panY: false,
                        layout: root_water3.verticalLayout,
                        marginTop: marginTop,
                        marginLeft: marginLeft,
                        marginRight: marginRight,
                        marginBottom: marginBottom,
                        paddingTop: paddingTop,
                        paddingLeft: paddingLeft,
                        paddingRight: paddingRight,
                        paddingBottom: paddingBottom,
                    })
                );

                const water_incomp = waterTotalValues[0];
                const water_comp = waterTotalValues[1];

                data = [
                    {
                        category: "Water",
                        comp: water_comp,
                        incomp: water_incomp,
                        icon: "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_water3, {});
                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root_water3, {
                        categoryField: "category",
                        //visible: false, // disable axis label
                        renderer: yRenderer,
                        bullet: function (root_water3, axis, dataItem) {
                            return am5xy.AxisBullet.new(root_water3, {
                                location: 0.5,
                                sprite: am5.Picture.new(root_water3, {
                                    width: chartIconWidth,
                                    height: chartIconHeight,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    x: chartIconPositionX,
                                    src: dataItem.dataContext.icon,
                                }),
                            });
                        },
                        tooltip: am5.Tooltip.new(root_water3, {}),
                    })
                );

                yRenderer.labels.template.setAll({
                    paddingRight: 45,
                });

                yRenderer.grid.template.setAll({
                    location: 1,
                });

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    //maxWidth: 150,
                    fontSize: "0em",
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root_water3, {
                        min: 0,
                        max: 100,
                        strictMinMax: true,
                        numberFormat: xAxisNumberFormat,
                        calculateTotals: true,
                        visible: false, // disable axis label
                        renderer: am5xy.AxisRendererX.new(root_water3, {
                            strokeOpacity: 0.1,
                        }),
                    })
                );

                // Add series
                let arrLviews = [];
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root_water3, {
                            name: name,
                            stacked: true,
                            xAxis: xAxis,
                            yAxis: yAxis,
                            baseAxis: yAxis,
                            valueXField: fieldName,
                            valueXShow: "valueXTotalPercent",
                            categoryYField: "category",
                            fill:
                                fieldName === "incomp"
                                    ? am5.color(chartSeriesFillColorIncomp)
                                    : am5.color(chartSeriesFillColorComp),
                            stroke: am5.color(chartBorderLineColor),
                        })
                    );

                    series.columns.template.setAll({
                        fillOpacity: fieldName === "incomp" ? 0 : 1,
                        strokeWidth: chartBorderLineWidth,
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(30),
                        tooltipY: 0,
                    });

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(90),
                        tooltipY: 0,
                    });

                    var tooltip = am5.Tooltip.new(root_water3, {
                        getFillFromSprite: true,
                        scale: 0.7,
                        fontSize: "0.5em",
                        dx: 0,
                        dy: -20,
                        labelText:
                            "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                    });

                    series.set("tooltip", tooltip);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_water3, {
                            sprite: am5.Label.new(root_water3, {
                                text:
                                    water_comp == 0
                                        ? ""
                                        : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_water3.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true,
                            }),
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const selectedStatus = fieldName == "incomp" ? 0 : 1;
                        const sqlExpression =
                            "UtilType = 2" + " AND " + "Status = " + selectedStatus;

                        var highlight = null;
                        // Point 1:
                        view.when(function () {
                            view.whenLayerView(utilityPointLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityPointLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityPointLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityPointLayer1).then(function (layerView) {
                                utilityPointLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView

                            var highlight2 = null;
                            // Line
                            view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityLineLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityLineLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight2) {
                                        highlightSelect.remove();
                                    }
                                    highlight2 = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight2.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
                                utilityLineLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView
                        }); // end of view.when
                    }); // End of filterByChart
                }

                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");

                chart.appear(1000, 100);
            }

            function waterAllChart() {
                chartPointWaterForCompile()
                    .then(chartLineWaterForCompile)
                    .then(waterCompiledChart);
            }

            // 2. Seweage
            var root_sewage1 = am5.Root.new("chartSewagePointDiv");
            root_sewage1._logo.dispose();

            var myTheme = am5.Theme.new(root_sewage1);
            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function chartPointSewage() {
                root_sewage1.container.children.clear();
                var total_sewage_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_incomp",
                    statisticType: "sum",
                };

                var total_sewage_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_sewage_incomp, total_sewage_comp];
                query.returnGeometry = true;

                utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const sewage_incomp = stats.total_sewage_incomp;
                    const sewage_comp = stats.total_sewage_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_sewage1.setThemes([
                        am5themes_Animated.new(root_sewage1),
                        am5themes_Responsive.new(root_sewage1),
                        //MyTheme.new(root_sewage1),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_sewage1.container.children.push(
                        am5xy.XYChart.new(root_sewage1, {
                            panX: false,
                            panY: false,
                            layout: root_sewage1.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "sewage",
                            comp: sewage_comp,
                            incomp: sewage_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_sewage1, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_sewage1, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_sewage1, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_sewage1, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_sewage1, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_sewage1, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_sewage1, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_sewage1, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_sewage1, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_sewage1, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_sewage1, {
                                sprite: am5.Label.new(root_sewage1, {
                                    text:
                                        sewage_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_sewage1.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 3" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view
                                    .whenLayerView(utilityPointLayer)
                                    .then(function (layerView) {
                                        //testUtilPt1.definitionExpression = sqlExpression;
                                        utilityPointLayer.queryFeatures().then(function (results) {
                                            const RESULT_LENGTH = results.features;
                                            const ROW_N = RESULT_LENGTH.length;

                                            let objID = [];
                                            for (var i = 0; i < ROW_N; i++) {
                                                var obj = results.features[i].attributes.OBJECTID;
                                                objID.push(obj);
                                            }

                                            var queryExt = new Query({
                                                objectIds: objID,
                                            });

                                            utilityPointLayer
                                                .queryExtent(queryExt)
                                                .then(function (result) {
                                                    if (result.extent) {
                                                        view.goTo(result.extent);
                                                    }
                                                });

                                            if (highlight) {
                                                highlightSelect.remove();
                                            }
                                            highlight = layerView.highlight(objID);

                                            view.on("click", function () {
                                                layerView.filter = null;
                                                highlight.remove();
                                            });
                                        }); // end of query features
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // end of when layerview

                                view
                                    .whenLayerView(utilityPointLayer1)
                                    .then(function (layerView) {
                                        utilityPointLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartSewage

            // 1.2. Line
            var root_sewage2 = am5.Root.new("chartSewageLineDiv");
            root_sewage2._logo.dispose();

            function chartLineSewage() {
                root_sewage2.container.children.clear();

                var total_sewage_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_incomp",
                    statisticType: "sum",
                };

                var total_sewage_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_sewage_incomp, total_sewage_comp];
                query.returnGeometry = true;

                utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const sewage_incomp = stats.total_sewage_incomp;
                    const sewage_comp = stats.total_sewage_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_sewage2.setThemes([
                        am5themes_Animated.new(root_sewage2),
                        am5themes_Responsive.new(root_sewage2),
                        MyTheme.new(root_sewage2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_sewage2.container.children.push(
                        am5xy.XYChart.new(root_sewage2, {
                            panX: false,
                            panY: false,
                            layout: root_sewage2.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "sewage",
                            comp: sewage_comp,
                            incomp: sewage_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_sewage2, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_sewage2, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_sewage2, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_sewage2, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_sewage2, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_sewage2, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_sewage2, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_sewage2, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_sewage2, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_sewage2, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_sewage2, {
                                sprite: am5.Label.new(root_sewage2, {
                                    text:
                                        sewage_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_sewage2.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 3" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                    //testUtilPt1.definitionExpression = sqlExpression;
                                    utilityLineLayer.queryFeatures().then(function (results) {
                                        const RESULT_LENGTH = results.features;
                                        const ROW_N = RESULT_LENGTH.length;

                                        let objID = [];
                                        for (var i = 0; i < ROW_N; i++) {
                                            var obj = results.features[i].attributes.OBJECTID;
                                            objID.push(obj);
                                        }

                                        var queryExt = new Query({
                                            objectIds: objID,
                                        });

                                        utilityLineLayer
                                            .queryExtent(queryExt)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view.goTo(result.extent);
                                                }
                                            });

                                        if (highlight) {
                                            highlightSelect.remove();
                                        }
                                        highlight = layerView.highlight(objID);

                                        view.on("click", function () {
                                            layerView.filter = null;
                                            highlight.remove();
                                        });
                                    }); // end of query features
                                    layerView.filter = {
                                        where: sqlExpression,
                                        //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                    };
                                }); // end of when layerview

                                view
                                    .whenLayerView(utilityLineLayer1)
                                    .then(function (layerView) {
                                        utilityLineLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartSewage

            // 1.3. Point + Line
            /// 1.3.1. Point for compiled
            function chartPointSewageForCompile() {
                var total_sewage_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_incomp",
                    statisticType: "sum",
                };

                var total_sewage_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_sewage_incomp, total_sewage_comp];
                query.returnGeometry = true;

                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const sewage_incomp = stats.total_sewage_incomp;
                    const sewage_comp = stats.total_sewage_comp;
                    const sewagePointValues = [sewage_incomp, sewage_comp];

                    return sewagePointValues;
                }); // end of queryFeatures
            } // end of updateChartSewage

            /// 1.3.2. Line for compiled
            function chartLineSewageForCompile(sewagePointValues) {
                var total_sewage_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_incomp",
                    statisticType: "sum",
                };

                var total_sewage_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_sewage_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_sewage_incomp, total_sewage_comp];
                query.returnGeometry = true;

                return utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const sewage_incomp = stats.total_sewage_incomp;
                    const sewage_comp = stats.total_sewage_comp;

                    const sewageIncompTotal = sewage_incomp + sewagePointValues[0];
                    const sewageCompTotal = sewage_comp + sewagePointValues[1];
                    const sewageTotalValues = [sewageIncompTotal, sewageCompTotal];

                    return sewageTotalValues;
                }); // end of queryFeatures
            } // end of updateChartSewage

            /// 1.3.3. Point + Line
            var root_sewage3 = am5.Root.new("chartSewageAllDiv");
            root_sewage3._logo.dispose();

            function sewageCompiledChart(sewageTotalValues) {
                root_sewage3.container.children.clear();

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_sewage3.setThemes([
                    am5themes_Animated.new(root_sewage3),
                    am5themes_Responsive.new(root_sewage3),
                    //MyTheme.new(root_sewage3),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_sewage3.container.children.push(
                    am5xy.XYChart.new(root_sewage3, {
                        panX: false,
                        panY: false,
                        layout: root_sewage3.verticalLayout,
                        marginTop: marginTop,
                        marginLeft: marginLeft,
                        marginRight: marginRight,
                        marginBottom: marginBottom,
                        paddingTop: paddingTop,
                        paddingLeft: paddingLeft,
                        paddingRight: paddingRight,
                        paddingBottom: paddingBottom,
                    })
                );

                const sewage_incomp = sewageTotalValues[0];
                const sewage_comp = sewageTotalValues[1];

                data = [
                    {
                        category: "Sewage",
                        comp: sewage_comp,
                        incomp: sewage_incomp,
                        icon: "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_sewage3, {});
                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root_sewage3, {
                        categoryField: "category",
                        //visible: false, // disable axis label
                        renderer: yRenderer,
                        bullet: function (root_sewage3, axis, dataItem) {
                            return am5xy.AxisBullet.new(root_sewage3, {
                                location: 0.5,
                                sprite: am5.Picture.new(root_sewage3, {
                                    width: chartIconWidth,
                                    height: chartIconHeight,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    x: chartIconPositionX,
                                    src: dataItem.dataContext.icon,
                                }),
                            });
                            d;
                        },
                        tooltip: am5.Tooltip.new(root_sewage3, {}),
                    })
                );

                yRenderer.labels.template.setAll({
                    paddingRight: 45,
                });

                yRenderer.grid.template.setAll({
                    location: 1,
                });

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    //maxWidth: 150,
                    fontSize: "0em",
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root_sewage3, {
                        min: 0,
                        max: 100,
                        strictMinMax: true,
                        numberFormat: xAxisNumberFormat,
                        calculateTotals: true,
                        visible: false, // disable axis label
                        renderer: am5xy.AxisRendererX.new(root_sewage3, {
                            strokeOpacity: 0.1,
                        }),
                    })
                );

                // Add series
                let arrLviews = [];
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root_sewage3, {
                            name: name,
                            stacked: true,
                            xAxis: xAxis,
                            yAxis: yAxis,
                            baseAxis: yAxis,
                            valueXField: fieldName,
                            valueXShow: "valueXTotalPercent",
                            categoryYField: "category",
                            fill:
                                fieldName === "incomp"
                                    ? am5.color(chartSeriesFillColorIncomp)
                                    : am5.color(chartSeriesFillColorComp),
                            stroke: am5.color(chartBorderLineColor),
                        })
                    );

                    series.columns.template.setAll({
                        fillOpacity: fieldName === "incomp" ? 0 : 1,
                        strokeWidth: chartBorderLineWidth,
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(30),
                        tooltipY: 0,
                    });

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(90),
                        tooltipY: 0,
                    });

                    var tooltip = am5.Tooltip.new(root_sewage3, {
                        getFillFromSprite: true,
                        scale: 0.7,
                        fontSize: "0.5em",
                        dx: 0,
                        dy: -20,
                        labelText:
                            "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                    });

                    series.set("tooltip", tooltip);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_sewage3, {
                            sprite: am5.Label.new(root_sewage3, {
                                text:
                                    sewage_comp == 0
                                        ? ""
                                        : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_sewage3.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true,
                            }),
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const selectedStatus = fieldName == "incomp" ? 0 : 1;
                        const sqlExpression =
                            "UtilType = 3" + " AND " + "Status = " + selectedStatus;

                        var highlight = null;
                        // Point 1:
                        view.when(function () {
                            view.whenLayerView(utilityPointLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityPointLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityPointLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityPointLayer1).then(function (layerView) {
                                utilityPointLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView

                            var highlight2 = null;
                            // Line
                            view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityLineLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityLineLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight2) {
                                        highlightSelect.remove();
                                    }
                                    highlight2 = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight2.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
                                utilityLineLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView
                        }); // end of view.when
                    }); // End of filterByChart
                }

                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");

                chart.appear(1000, 100);
            }

            function sewageAllChart() {
                chartPointSewageForCompile()
                    .then(chartLineSewageForCompile)
                    .then(sewageCompiledChart);
            }

            // 3. Power
            var root_power1 = am5.Root.new("chartPowerPointDiv");
            root_power1._logo.dispose();

            var myTheme = am5.Theme.new(root_power1);
            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function chartPointPower() {
                root_power1.container.children.clear();
                var total_power_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_incomp",
                    statisticType: "sum",
                };

                var total_power_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_power_incomp, total_power_comp];
                query.returnGeometry = true;

                utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const power_incomp = stats.total_power_incomp;
                    const power_comp = stats.total_power_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_power1.setThemes([
                        am5themes_Animated.new(root_power1),
                        am5themes_Responsive.new(root_power1),
                        //MyTheme.new(root_power1),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_power1.container.children.push(
                        am5xy.XYChart.new(root_power1, {
                            panX: false,
                            panY: false,
                            layout: root_power1.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "power",
                            comp: power_comp,
                            incomp: power_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_power1, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_power1, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_power1, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_power1, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_power1, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_power1, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_power1, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_power1, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_power1, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_power1, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_power1, {
                                sprite: am5.Label.new(root_power1, {
                                    text:
                                        power_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_power1.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 4" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view
                                    .whenLayerView(utilityPointLayer)
                                    .then(function (layerView) {
                                        //testUtilPt1.definitionExpression = sqlExpression;
                                        utilityPointLayer.queryFeatures().then(function (results) {
                                            const RESULT_LENGTH = results.features;
                                            const ROW_N = RESULT_LENGTH.length;

                                            let objID = [];
                                            for (var i = 0; i < ROW_N; i++) {
                                                var obj = results.features[i].attributes.OBJECTID;
                                                objID.push(obj);
                                            }

                                            var queryExt = new Query({
                                                objectIds: objID,
                                            });

                                            utilityPointLayer
                                                .queryExtent(queryExt)
                                                .then(function (result) {
                                                    if (result.extent) {
                                                        view.goTo(result.extent);
                                                    }
                                                });

                                            if (highlight) {
                                                highlightSelect.remove();
                                            }
                                            highlight = layerView.highlight(objID);

                                            view.on("click", function () {
                                                layerView.filter = null;
                                                highlight.remove();
                                            });
                                        }); // end of query features
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // end of when layerview

                                view
                                    .whenLayerView(utilityPointLayer1)
                                    .then(function (layerView) {
                                        utilityPointLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartPower

            // 1.2. Line
            var root_power2 = am5.Root.new("chartPowerLineDiv");
            root_power2._logo.dispose();

            function chartLinePower() {
                root_power2.container.children.clear();

                var total_power_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_incomp",
                    statisticType: "sum",
                };

                var total_power_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_power_incomp, total_power_comp];
                query.returnGeometry = true;

                utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const power_incomp = stats.total_power_incomp;
                    const power_comp = stats.total_power_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_power2.setThemes([
                        am5themes_Animated.new(root_power2),
                        am5themes_Responsive.new(root_power2),
                        //MyTheme.new(root_power2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_power2.container.children.push(
                        am5xy.XYChart.new(root_power2, {
                            panX: false,
                            panY: false,
                            layout: root_power2.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "power",
                            comp: power_comp,
                            incomp: power_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_power2, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_power2, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_power2, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_power2, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_power2, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_power2, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_power2, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_power2, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_power2, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_power2, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_power2, {
                                sprite: am5.Label.new(root_power2, {
                                    text:
                                        power_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_power2.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 4" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                    //testUtilPt1.definitionExpression = sqlExpression;
                                    utilityLineLayer.queryFeatures().then(function (results) {
                                        const RESULT_LENGTH = results.features;
                                        const ROW_N = RESULT_LENGTH.length;

                                        let objID = [];
                                        for (var i = 0; i < ROW_N; i++) {
                                            var obj = results.features[i].attributes.OBJECTID;
                                            objID.push(obj);
                                        }

                                        var queryExt = new Query({
                                            objectIds: objID,
                                        });

                                        utilityLineLayer
                                            .queryExtent(queryExt)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view.goTo(result.extent);
                                                }
                                            });

                                        if (highlight) {
                                            highlightSelect.remove();
                                        }
                                        highlight = layerView.highlight(objID);

                                        view.on("click", function () {
                                            layerView.filter = null;
                                            highlight.remove();
                                        });
                                    }); // end of query features
                                    layerView.filter = {
                                        where: sqlExpression,
                                        //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                    };
                                }); // end of when layerview

                                view
                                    .whenLayerView(utilityLineLayer1)
                                    .then(function (layerView) {
                                        utilityLineLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartPower

            // 1.3. Point + Line
            /// 1.3.1. Point for compiled
            function chartPointPowerForCompile() {
                var total_power_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_incomp",
                    statisticType: "sum",
                };

                var total_power_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_power_incomp, total_power_comp];
                query.returnGeometry = true;

                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const power_incomp = stats.total_power_incomp;
                    const power_comp = stats.total_power_comp;
                    const powerPointValues = [power_incomp, power_comp];

                    return powerPointValues;
                }); // end of queryFeatures
            } // end of updateChartPower

            /// 1.3.2. Line for compiled
            function chartLinePowerForCompile(powerPointValues) {
                var total_power_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_incomp",
                    statisticType: "sum",
                };

                var total_power_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_power_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_power_incomp, total_power_comp];
                query.returnGeometry = true;

                return utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const power_incomp = stats.total_power_incomp;
                    const power_comp = stats.total_power_comp;

                    const powerIncompTotal = power_incomp + powerPointValues[0];
                    const powerCompTotal = power_comp + powerPointValues[1];
                    const powerTotalValues = [powerIncompTotal, powerCompTotal];

                    return powerTotalValues;
                }); // end of queryFeatures
            } // end of updateChartPower

            /// 1.3.3. Point + Line
            var root_power3 = am5.Root.new("chartPowerAllDiv");
            root_power3._logo.dispose();

            function powerCompiledChart(powerTotalValues) {
                root_power3.container.children.clear();

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_power3.setThemes([
                    am5themes_Animated.new(root_power3),
                    am5themes_Responsive.new(root_power3),
                    //MyTheme.new(root_power3),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_power3.container.children.push(
                    am5xy.XYChart.new(root_power3, {
                        panX: false,
                        panY: false,
                        layout: root_power3.verticalLayout,
                        marginTop: marginTop,
                        marginLeft: marginLeft,
                        marginRight: marginRight,
                        marginBottom: marginBottom,
                        paddingTop: paddingTop,
                        paddingLeft: paddingLeft,
                        paddingRight: paddingRight,
                        paddingBottom: paddingBottom,
                    })
                );

                const power_incomp = powerTotalValues[0];
                const power_comp = powerTotalValues[1];

                data = [
                    {
                        category: "Power",
                        comp: power_comp,
                        incomp: power_incomp,
                        icon: "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_power3, {});
                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root_power3, {
                        categoryField: "category",
                        //visible: false, // disable axis label
                        renderer: yRenderer,
                        bullet: function (root_water3, axis, dataItem) {
                            return am5xy.AxisBullet.new(root_water3, {
                                location: 0.5,
                                sprite: am5.Picture.new(root_water3, {
                                    width: chartIconWidth,
                                    height: chartIconHeight,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    x: chartIconPositionX,
                                    src: dataItem.dataContext.icon,
                                }),
                            });
                        },
                        tooltip: am5.Tooltip.new(root_power3, {}),
                    })
                );

                yRenderer.labels.template.setAll({
                    paddingRight: 45,
                });

                yRenderer.grid.template.setAll({
                    location: 1,
                });

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    //maxWidth: 150,
                    fontSize: "0em",
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root_power3, {
                        min: 0,
                        max: 100,
                        strictMinMax: true,
                        numberFormat: xAxisNumberFormat,
                        calculateTotals: true,
                        visible: false, // disable axis label
                        renderer: am5xy.AxisRendererX.new(root_power3, {
                            strokeOpacity: 0.1,
                        }),
                    })
                );

                // Add series
                let arrLviews = [];
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root_power3, {
                            name: name,
                            stacked: true,
                            xAxis: xAxis,
                            yAxis: yAxis,
                            baseAxis: yAxis,
                            valueXField: fieldName,
                            valueXShow: "valueXTotalPercent",
                            categoryYField: "category",
                            fill:
                                fieldName === "incomp"
                                    ? am5.color(chartSeriesFillColorIncomp)
                                    : am5.color(chartSeriesFillColorComp),
                            stroke: am5.color(chartBorderLineColor),
                        })
                    );

                    series.columns.template.setAll({
                        fillOpacity: fieldName === "incomp" ? 0 : 1,
                        strokeWidth: chartBorderLineWidth,
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(30),
                        tooltipY: 0,
                    });

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(90),
                        tooltipY: 0,
                    });

                    var tooltip = am5.Tooltip.new(root_power3, {
                        getFillFromSprite: true,
                        scale: 0.7,
                        fontSize: "0.5em",
                        dx: 0,
                        dy: -20,
                        labelText:
                            "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                    });

                    series.set("tooltip", tooltip);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_power3, {
                            sprite: am5.Label.new(root_power3, {
                                text:
                                    power_comp == 0
                                        ? ""
                                        : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_power3.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true,
                            }),
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const selectedStatus = fieldName == "incomp" ? 0 : 1;
                        const sqlExpression =
                            "UtilType = 4" + " AND " + "Status = " + selectedStatus;

                        var highlight = null;
                        // Point 1:
                        view.when(function () {
                            view.whenLayerView(utilityPointLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityPointLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityPointLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityPointLayer1).then(function (layerView) {
                                utilityPointLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView

                            var highlight2 = null;
                            // Line
                            view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityLineLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityLineLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight2) {
                                        highlightSelect.remove();
                                    }
                                    highlight2 = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight2.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
                                utilityLineLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView
                        }); // end of view.when
                    }); // End of filterByChart
                }

                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");

                chart.appear(1000, 100);
            }

            function powerAllChart() {
                chartPointPowerForCompile()
                    .then(chartLinePowerForCompile)
                    .then(powerCompiledChart);
            }

            // 4. Telecom/CATV
            // 1.1. Point
            var root_telecom1 = am5.Root.new("chartTelecomPointDiv");
            root_telecom1._logo.dispose();

            var myTheme = am5.Theme.new(root_telecom1);
            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function chartPointTelecom() {
                root_telecom1.container.children.clear();
                var total_telecom_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_incomp",
                    statisticType: "sum",
                };

                var total_telecom_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_telecom_incomp, total_telecom_comp];
                query.returnGeometry = true;

                utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const telecom_incomp = stats.total_telecom_incomp;
                    const telecom_comp = stats.total_telecom_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_telecom1.setThemes([
                        am5themes_Animated.new(root_telecom1),
                        am5themes_Responsive.new(root_telecom1),
                        //MyTheme.new(root_telecom1),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_telecom1.container.children.push(
                        am5xy.XYChart.new(root_telecom1, {
                            panX: false,
                            panY: false,
                            layout: root_telecom1.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "telecom",
                            comp: telecom_comp,
                            incomp: telecom_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_telecom1, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_telecom1, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_telecom1, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_telecom1, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_telecom1, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_telecom1, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_telecom1, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_telecom1, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_telecom1, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_telecom1, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_telecom1, {
                                sprite: am5.Label.new(root_telecom1, {
                                    text:
                                        telecom_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_telecom1.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 1" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view
                                    .whenLayerView(utilityPointLayer)
                                    .then(function (layerView) {
                                        //testUtilPt1.definitionExpression = sqlExpression;
                                        utilityPointLayer.queryFeatures().then(function (results) {
                                            const RESULT_LENGTH = results.features;
                                            const ROW_N = RESULT_LENGTH.length;

                                            let objID = [];
                                            for (var i = 0; i < ROW_N; i++) {
                                                var obj = results.features[i].attributes.OBJECTID;
                                                objID.push(obj);
                                            }

                                            var queryExt = new Query({
                                                objectIds: objID,
                                            });

                                            utilityPointLayer
                                                .queryExtent(queryExt)
                                                .then(function (result) {
                                                    if (result.extent) {
                                                        view.goTo(result.extent);
                                                    }
                                                });

                                            if (highlight) {
                                                highlightSelect.remove();
                                            }
                                            highlight = layerView.highlight(objID);

                                            view.on("click", function () {
                                                layerView.filter = null;
                                                highlight.remove();
                                            });
                                        }); // end of query features
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // end of when layerview

                                view
                                    .whenLayerView(utilityPointLayer1)
                                    .then(function (layerView) {
                                        utilityPointLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartTelecom

            // 1.2. Line
            var root_telecom2 = am5.Root.new("chartTelecomLineDiv");
            root_telecom2._logo.dispose();

            function chartLineTelecom() {
                root_telecom2.container.children.clear();

                var total_telecom_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_incomp",
                    statisticType: "sum",
                };

                var total_telecom_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_telecom_incomp, total_telecom_comp];
                query.returnGeometry = true;

                utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const telecom_incomp = stats.total_telecom_incomp;
                    const telecom_comp = stats.total_telecom_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root_telecom2.setThemes([
                        am5themes_Animated.new(root_telecom2),
                        am5themes_Responsive.new(root_telecom2),
                        //MyTheme.new(root_telecom2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root_telecom2.container.children.push(
                        am5xy.XYChart.new(root_telecom2, {
                            panX: false,
                            panY: false,
                            layout: root_telecom2.verticalLayout,
                            marginTop: marginTop,
                            marginLeft: marginLeft,
                            marginRight: marginRight,
                            marginBottom: marginBottom,
                            paddingTop: paddingTop,
                            paddingLeft: paddingLeft,
                            paddingRight: paddingRight,
                            paddingBottom: paddingBottom,
                        })
                    );

                    var data = [
                        {
                            category: "telecom",
                            comp: telecom_comp,
                            incomp: telecom_incomp,
                            icon: "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
                        },
                    ];

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root_telecom2, {});
                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root_telecom2, {
                            categoryField: "category",
                            //visible: false, // disable axis label
                            renderer: yRenderer,
                            bullet: function (root_telecom2, axis, dataItem) {
                                return am5xy.AxisBullet.new(root_telecom2, {
                                    location: 0.5,
                                    sprite: am5.Picture.new(root_telecom2, {
                                        width: chartIconWidth,
                                        height: chartIconHeight,
                                        centerY: am5.p50,
                                        centerX: am5.p50,
                                        x: chartIconPositionX,
                                        src: dataItem.dataContext.icon,
                                    }),
                                });
                            },
                            tooltip: am5.Tooltip.new(root_telecom2, {}),
                        })
                    );

                    yRenderer.labels.template.setAll({
                        paddingRight: 45,
                    });

                    yRenderer.grid.template.setAll({
                        location: 1,
                    });

                    // Label properties Y axis
                    yAxis.get("renderer").labels.template.setAll({
                        //maxWidth: 150,
                        fontSize: "0em",
                    });

                    yAxis.data.setAll(data);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root_telecom2, {
                            min: 0,
                            max: 100,
                            strictMinMax: true,
                            numberFormat: xAxisNumberFormat,
                            calculateTotals: true,
                            visible: false, // disable axis label
                            renderer: am5xy.AxisRendererX.new(root_telecom2, {
                                strokeOpacity: 0.1,
                            }),
                        })
                    );

                    // Add series
                    let arrLviews = [];
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    function makeSeries(name, fieldName) {
                        var series = chart.series.push(
                            am5xy.ColumnSeries.new(root_telecom2, {
                                name: name,
                                stacked: true,
                                xAxis: xAxis,
                                yAxis: yAxis,
                                baseAxis: yAxis,
                                valueXField: fieldName,
                                valueXShow: "valueXTotalPercent",
                                categoryYField: "category",
                                fill:
                                    fieldName === "incomp"
                                        ? am5.color(chartSeriesFillColorIncomp)
                                        : am5.color(chartSeriesFillColorComp),
                                stroke: am5.color(chartBorderLineColor),
                            })
                        );

                        series.columns.template.setAll({
                            fillOpacity: fieldName === "incomp" ? 0 : 1,
                            strokeWidth: chartBorderLineWidth,
                            tooltipText: "{name}, {categoryX}: {valueY}",
                            width: am5.percent(90),
                            tooltipY: 0,
                        });

                        var tooltip = am5.Tooltip.new(root_telecom2, {
                            getFillFromSprite: true,
                            scale: 0.7,
                            fontSize: "0.5em",
                            dx: 0,
                            dy: -20,
                            labelText:
                                "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                        });

                        series.set("tooltip", tooltip);
                        series.data.setAll(data);

                        // Make stuff animate on load
                        // https://www.amcharts.com/docs/v5/concepts/animations/
                        series.appear();

                        series.bullets.push(function () {
                            return am5.Bullet.new(root_telecom2, {
                                sprite: am5.Label.new(root_telecom2, {
                                    text:
                                        telecom_comp == 0
                                            ? ""
                                            : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                    fill: root_telecom2.interfaceColors.get("alternativeText"),
                                    opacity: fieldName == "incomp" ? 0 : 1,
                                    fontSize: seriesBulletLabelFontSize,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    populateText: true,
                                }),
                            });
                        });

                        series.columns.template.events.on("click", function (ev) {
                            const selectedStatus = fieldName == "incomp" ? 0 : 1;
                            const sqlExpression =
                                "UtilType = 1" + " AND " + "Status = " + selectedStatus;

                            var highlight = null;
                            // Point 1:
                            view.when(function () {
                                view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                    //testUtilPt1.definitionExpression = sqlExpression;
                                    utilityLineLayer.queryFeatures().then(function (results) {
                                        const RESULT_LENGTH = results.features;
                                        const ROW_N = RESULT_LENGTH.length;

                                        let objID = [];
                                        for (var i = 0; i < ROW_N; i++) {
                                            var obj = results.features[i].attributes.OBJECTID;
                                            objID.push(obj);
                                        }

                                        var queryExt = new Query({
                                            objectIds: objID,
                                        });

                                        utilityLineLayer
                                            .queryExtent(queryExt)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view.goTo(result.extent);
                                                }
                                            });

                                        if (highlight) {
                                            highlightSelect.remove();
                                        }
                                        highlight = layerView.highlight(objID);

                                        view.on("click", function () {
                                            layerView.filter = null;
                                            highlight.remove();
                                        });
                                    }); // end of query features
                                    layerView.filter = {
                                        where: sqlExpression,
                                        //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                    };
                                }); // end of when layerview

                                view
                                    .whenLayerView(utilityLineLayer1)
                                    .then(function (layerView) {
                                        utilityLineLayer1
                                            .queryFeatures(query)
                                            .then(function (results) {
                                                const RESULT_LENGTH = results.features;
                                                const ROW_N = RESULT_LENGTH.length;

                                                let objID = [];
                                                for (var i = 0; i < ROW_N; i++) {
                                                    var obj = results.features[i].attributes.OBJECTID;
                                                    objID.push(obj);
                                                }

                                                view.on("click", function () {
                                                    layerView.filter = null;
                                                });
                                            });
                                        layerView.filter = {
                                            where: sqlExpression,
                                            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                        };
                                    }); // End of whenLayerView
                            }); // end of view.when
                        }); // End of filterByChart
                    }

                    makeSeries("Complete", "comp");
                    makeSeries("Incomplete", "incomp");

                    chart.appear(1000, 100);
                }); // end of queryFeatures
            } // end of updateChartTelecom

            // 1.3. Point + Line
            /// 1.3.1. Point for compiled
            function chartPointTelecomForCompile() {
                var total_telecom_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_incomp",
                    statisticType: "sum",
                };

                var total_telecom_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityPointLayer.createQuery();
                query.outStatistics = [total_telecom_incomp, total_telecom_comp];
                query.returnGeometry = true;

                return utilityPointLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const telecom_incomp = stats.total_telecom_incomp;
                    const telecom_comp = stats.total_telecom_comp;
                    const telecomPointValues = [telecom_incomp, telecom_comp];

                    return telecomPointValues;
                }); // end of queryFeatures
            } // end of updateChartTelecom

            /// 1.3.2. Line for compiled
            function chartLineTelecomForCompile(telecomPointValues) {
                var total_telecom_incomp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_incomp",
                    statisticType: "sum",
                };

                var total_telecom_comp = {
                    onStatisticField:
                        "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_telecom_comp",
                    statisticType: "sum",
                };

                // Query
                var query = utilityLineLayer.createQuery();
                query.outStatistics = [total_telecom_incomp, total_telecom_comp];
                query.returnGeometry = true;

                return utilityLineLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const telecom_incomp = stats.total_telecom_incomp;
                    const telecom_comp = stats.total_telecom_comp;

                    const telecomIncompTotal = telecom_incomp + telecomPointValues[0];
                    const telecomCompTotal = telecom_comp + telecomPointValues[1];
                    const telecomTotalValues = [telecomIncompTotal, telecomCompTotal];

                    return telecomTotalValues;
                }); // end of queryFeatures
            } // end of updateChartTelecom

            /// 1.3.3. Point + Line
            var root_telecom3 = am5.Root.new("chartTelecomAllDiv");
            root_telecom3._logo.dispose();

            function telecomCompiledChart(telecomTotalValues) {
                root_telecom3.container.children.clear();

                // Set themes
                // https://www.amcharts.com/docs/v5/concepts/themes/
                root_telecom3.setThemes([
                    am5themes_Animated.new(root_telecom3),
                    am5themes_Responsive.new(root_telecom3),
                    //MyTheme.new(root_telecom3),
                ]);

                // Create chart
                // https://www.amcharts.com/docs/v5/charts/xy-chart/
                var chart = root_telecom3.container.children.push(
                    am5xy.XYChart.new(root_telecom3, {
                        panX: false,
                        panY: false,
                        layout: root_telecom3.verticalLayout,
                        marginTop: marginTop,
                        marginLeft: marginLeft,
                        marginRight: marginRight,
                        marginBottom: marginBottom,
                        paddingTop: paddingTop,
                        paddingLeft: paddingLeft,
                        paddingRight: paddingRight,
                        paddingBottom: paddingBottom,
                    })
                );

                const telecom_incomp = telecomTotalValues[0];
                const telecom_comp = telecomTotalValues[1];

                data = [
                    {
                        category: "Telecom",
                        comp: telecom_comp,
                        incomp: telecom_incomp,
                        icon: "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
                    },
                ];

                // Create axes
                // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                var yRenderer = am5xy.AxisRendererY.new(root_telecom3, {});
                var yAxis = chart.yAxes.push(
                    am5xy.CategoryAxis.new(root_telecom3, {
                        categoryField: "category",
                        //visible: false, // disable axis label
                        renderer: yRenderer,
                        bullet: function (root_telecom3, axis, dataItem) {
                            return am5xy.AxisBullet.new(root_telecom3, {
                                location: 0.5,
                                sprite: am5.Picture.new(root_telecom3, {
                                    width: chartIconWidth,
                                    height: chartIconHeight,
                                    centerY: am5.p50,
                                    centerX: am5.p50,
                                    x: chartIconPositionX,
                                    src: dataItem.dataContext.icon,
                                }),
                            });
                        },
                        tooltip: am5.Tooltip.new(root_telecom3, {}),
                    })
                );

                yRenderer.labels.template.setAll({
                    paddingRight: 45,
                });

                yRenderer.grid.template.setAll({
                    location: 1,
                });

                // Label properties Y axis
                yAxis.get("renderer").labels.template.setAll({
                    //maxWidth: 150,
                    fontSize: "0em",
                });

                yAxis.data.setAll(data);

                var xAxis = chart.xAxes.push(
                    am5xy.ValueAxis.new(root_telecom3, {
                        min: 0,
                        max: 100,
                        strictMinMax: true,
                        numberFormat: xAxisNumberFormat,
                        calculateTotals: true,
                        visible: false, // disable axis label
                        renderer: am5xy.AxisRendererX.new(root_telecom3, {
                            strokeOpacity: 0.1,
                        }),
                    })
                );

                // Add series
                let arrLviews = [];
                // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                function makeSeries(name, fieldName) {
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root_telecom3, {
                            name: name,
                            stacked: true,
                            xAxis: xAxis,
                            yAxis: yAxis,
                            baseAxis: yAxis,
                            valueXField: fieldName,
                            valueXShow: "valueXTotalPercent",
                            categoryYField: "category",
                            fill:
                                fieldName === "incomp"
                                    ? am5.color(chartSeriesFillColorIncomp)
                                    : am5.color(chartSeriesFillColorComp),
                            stroke: am5.color(chartBorderLineColor),
                        })
                    );

                    series.columns.template.setAll({
                        fillOpacity: fieldName === "incomp" ? 0 : 1,
                        strokeWidth: chartBorderLineWidth,
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(30),
                        tooltipY: 0,
                    });

                    series.columns.template.setAll({
                        tooltipText: "{name}, {categoryX}: {valueY}",
                        width: am5.percent(90),
                        tooltipY: 0,
                    });

                    var tooltip = am5.Tooltip.new(root_telecom3, {
                        getFillFromSprite: true,
                        scale: 0.7,
                        fontSize: "0.5em",
                        dx: 0,
                        dy: -20,
                        labelText:
                            "[bold][fontSize:18.5px]{name}: {valueX} ({valueXTotalPercent.formatNumber('#.')}%)",
                    });

                    series.set("tooltip", tooltip);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear();

                    series.bullets.push(function () {
                        return am5.Bullet.new(root_telecom3, {
                            sprite: am5.Label.new(root_telecom3, {
                                text:
                                    telecom_comp == 0
                                        ? ""
                                        : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                                fill: root_telecom3.interfaceColors.get("alternativeText"),
                                opacity: fieldName == "incomp" ? 0 : 1,
                                fontSize: seriesBulletLabelFontSize,
                                centerY: am5.p50,
                                centerX: am5.p50,
                                populateText: true,
                            }),
                        });
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const selectedStatus = fieldName == "incomp" ? 0 : 1;
                        const sqlExpression =
                            "UtilType = 1" + " AND " + "Status = " + selectedStatus;

                        var highlight = null;
                        // Point 1:
                        view.when(function () {
                            view.whenLayerView(utilityPointLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityPointLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityPointLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight) {
                                        highlightSelect.remove();
                                    }
                                    highlight = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityPointLayer1).then(function (layerView) {
                                utilityPointLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView

                            var highlight2 = null;
                            // Line
                            view.whenLayerView(utilityLineLayer).then(function (layerView) {
                                //testUtilPt1.definitionExpression = sqlExpression;
                                utilityLineLayer.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    utilityLineLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlight2) {
                                        highlightSelect.remove();
                                    }
                                    highlight2 = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlight2.remove();
                                    });
                                }); // end of query features
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // end of when layerview

                            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
                                utilityLineLayer1.queryFeatures().then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    view.on("click", function () {
                                        layerView.filter = null;
                                    });
                                });
                                layerView.filter = {
                                    where: sqlExpression,
                                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                                };
                            }); // End of whenLayerView
                        }); // end of view.when
                    }); // End of filterByChart
                }

                makeSeries("Complete", "comp");
                makeSeries("Incomplete", "incomp");

                chart.appear(1000, 100);
            }

            function telecomAllChart() {
                chartPointTelecomForCompile()
                    .then(chartLineTelecomForCompile)
                    .then(telecomCompiledChart);
            }
        }); // End of am5
        */


        /////////////////////// PopUp Setting ////////////////////////////

        // Utility Point
        var highlightSelect;
        view.when(function () {
            var popup = view.popup;
            popup.viewModel.on("trigger-action", function (event) {
                if (event.action.id == "find-relocated") {
                    var attributes = popup.viewModel.selectedFeature.attributes;
                    var info = attributes.Id;
                    var infoObjId = attributes.OBJECTID; //1

                    view.whenLayerView(utilityPointLayer).then(function (layerView) {
                        utilityPointLayer.queryFeatures().then(function (results) {
                            const ggg = results.features;
                            const rowN = ggg.length; //7
                            var i;
                            let objID = [];
                            for (i = 0; i < rowN; i++) {
                                if (results.features[i].attributes.Id == info) {
                                    if (results.features[i].attributes.OBJECTID == infoObjId) {
                                        continue;
                                    }
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }
                            }
                            var queryExt = new Query({
                                //objectIds: [1,2,3,4,5]
                                //objectIds: objID
                                objectIds: objID,
                            });
                            utilityPointLayer1.queryExtent(queryExt).then(function (result) {
                                if (result.extent) {
                                    view.goTo(result.extent.expand(200));
                                }
                            });

                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                            highlightSelect = layerView.highlight(objID);

                            view.on("click", function () {
                                highlightSelect.remove();
                            });
                        }); // End of queryFeatures()
                    }); // End of layerView
                } // End of if (event.action.id...)
            });
        }); // End of view.when()

        // Utility Line
        view.when(function () {
            var popup = view.popup;
            popup.viewModel.on("trigger-action", function (event) {
                if (event.action.id == "find-relocated-line") {
                    var attributes = popup.viewModel.selectedFeature.attributes;
                    var info = attributes.Id;
                    var infoObjId = attributes.OBJECTID; //1

                    view.whenLayerView(utilityLineLayer).then(function (layerView) {
                        utilityLineLayer.queryFeatures().then(function (results) {
                            const ggg = results.features;
                            const rowN = ggg.length; //7
                            //var rrr = results.features[0].attributes.Id;
                            //var rrr = results.features[6].attributes.Id; // return Id of 7th row

                            var i;
                            let objID = [];
                            for (i = 0; i < rowN; i++) {
                                if (results.features[i].attributes.Id == info) {
                                    if (results.features[i].attributes.OBJECTID == infoObjId) {
                                        continue;
                                    }
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }
                            }

                            var queryExt = new Query({
                                //objectIds: [1,2,3,4,5]
                                //objectIds: objID
                                objectIds: objID,
                            });

                            utilityLineLayer1.queryExtent(queryExt).then(function (result) {
                                if (result.extent) {
                                    view.goTo(result.extent);
                                }
                            });

                            if (highlightSelect) {
                                highlightSelect.remove();
                            }
                            highlightSelect = layerView.highlight(objID);

                            view.on("click", function () {
                                highlightSelect.remove();
                            });
                        }); // End of queryFeatures()
                    }); // End of layerView
                } // End of if (event.action.id...)
            });
        }); // End of view.when()



        // ------------- Calcite Action Bar (Outside: the chart code block) ------------- //
        view.when(() => {
            document.querySelector("#header-title").textContent = "N2 UTILITY";

            let activeWidget;
            const handleActionBarClick = ({ target }) => {
                if (target.tagName !== "CALCITE-ACTION") {
                    return;
                }

                if (activeWidget) {
                    document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
                    document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
                }

                const nextWidget = target.dataset.actionId;
                if (nextWidget !== activeWidget) {
                    document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
                    document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
                    activeWidget = nextWidget;

                } else {
                    activeWidget = null;
                }
            };


            // Action bar 
            document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
            let actionBarExpanded = false;
            document.addEventListener("calciteActionBarToggle", event => {
                actionBarExpanded = !actionBarExpanded;
                view.padding = {
                    left: actionBarExpanded ? 135 : 45
                };
            });
        });


        /////////////////////// Widgets ////////////////////////////


        //****---------------- Legend-----------------------****//

        const legend = new Legend({
            view: view,
            container: "legend-container",
            layerInfos: [
                "*"
            ],

        });


        //****-------------- Basemap Gallery ---------------****//

        const basemaps = new BasemapGallery({
            view,
            container: "basemaps-container",
        });


        //****---------------- Layer List ------------------****//

        const layerList = new LayerList({
            view: view,
            selectionEnabled: true,
            container: "layers-container",
            listItemCreatedFunction: function (event) {
                const item = event.item;
                if (
                    item.title === "Chainage"
                ) {
                    item.visible = false;
                }
                if (item.layer.type != "group") { // don't show legend twice
                    item.panel = {
                        content: "legend",
                        open: true
                    };
                }
            },
        });


        //****--------------- Compass ----------------****//
        var compass = new Compass({
            view: view,
        });
        view.ui.add(compass, "top-right");


        //****--------------- Search Widget ----------------****//
        var searchWidget = new Search({
            view: view,
            locationEnabled: false,
            allPlaceholder: "Chainage or Utility ID",
            includeDefaultSources: false,
            sources: [
                {
                    layer: PierNoLayer,
                    searchFields: ["PIER"],
                    displayField: "PIER",
                    exactMatch: false,
                    outFields: ["PIER"],
                    name: "Pier No",
                    zoomScale: 1000,
                    placeholder: "example: P-288",
                },
                {
                    layer: chainageLayer,
                    searchFields: ["KmSpot"],
                    displayField: "KmSpot",
                    exactMatch: false,
                    outFields: ["*"],
                    zoomScale: 1000,
                    name: "Main KM",
                    placeholder: "example: 80+400",
                },
                {
                    layer: utilityPointLayer,
                    searchFields: ["Id"],
                    displayField: "Id",
                    exactMatch: false,
                    outFields: ["Id"],
                    name: "Unique ID (Point)",
                    placeholder: "example: MER0001-X01",
                },
                {
                    layer: utilityLineLayer1,
                    searchFields: ["Id"],
                    displayField: "Id",
                    exactMatch: false,
                    outFields: ["Id"],
                    name: "Unique ID (Line)",
                    placeholder: "example: MER0001-X01",
                },
            ],
        });

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",

        });
        view.ui.add(searchExpand, {
            position: "top-right",
        });

        searchExpand.watch("expanded", function () {
            if (!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });


        /*
        // See-through-Ground
        view.when(function () {
            // allow navigation above and below the ground
            map.ground.navigationConstraint = {
                type: "none",
            };
            // the webscene has no basemap, so set a surfaceColor on the ground
            map.ground.surfaceColor = "#fff";

            // to see through the ground, set the ground opacity to 0.4
            map.ground.opacity = 0.9;
        });

        document
            .getElementById("myLink")
            .addEventListener("click", function (event) {
                const checked = event.srcElement.checked;
                map.ground.opacity = event.srcElement.checked ? 0.1 : 0.6;
            });*/


    });
</script>