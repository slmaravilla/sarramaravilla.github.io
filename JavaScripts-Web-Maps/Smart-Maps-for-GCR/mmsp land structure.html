<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MMSP Land Acquisition</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.27/"></script>
</head>
<style>
    html,
    body,
    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
    }

    body {
        display: flex;
    }

    calcite-list {
        overflow-y: auto;
    }

    calcite-loader {
        align-self: center;
        justify-self: center;
    }

    calcite-segmented-control {
        margin-left: 10px;
    }

    #handedover-stationlot-segment-control {
        margin-bottom: 20px;
    }

    calcite-label {
        --calcite-label-margin-bottom: 0px;
        margin: 5px;
    }

    #container {
        display: grid;
        flex-wrap: wrap;
        box-sizing: border-box;
        grid-template-columns: 1fr 0.3fr;
        width: 100%;
        height: 100%;
    }

    calcite-button {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: auto;
    }

    #header-title {
        margin-left: 1rem;
        margin-right: 1rem;
    }

    #info-content {
        padding: 0.75rem;
    }

    #header {
        display: flex;
        padding: 0 1rem;
        background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
        display: flex;
        margin-inline-start: auto;
        align-self: center;
    }

    .label-wrapper {
        display: flex;
        margin-inline: 1rem;
        padding: 0.5rem;
        border: 1px solid var(--calcite-ui-border-1);
        cursor: pointer;
    }

    calcite-switch {
        margin: 0 0.5rem;
    }

    calcite-tabs {
        overflow-y: auto;

        width: 100%;
    }

    calcite-tab-title {
        overflow: hidden;
        padding: 0;
    }

    #info-content {
        overflow-y: auto;
    }

    #pieChartLotDiv,
    #pieChartStructureDiv,
    #isfPieChartDiv {
        height: 45%;
        margin-bottom: 5;
    }

    /* Radio Button for handed-over lots */
    #handedOverButton {
        position: fixed;
    }

    .lotNumber-container,
    .structureNumber-container,
    .isfNumber-container,
    .handOverLot-container,
    .demolishedStructure-container,
    .pteStructure-container {
        display: flex;
        height: 70px;
    }

    #lotNumberDiv,
    #handedOverLotNumberDiv,
    #demolishedStructureNumberDiv,
    #structureNumberDiv,
    #isfNumberDiv {
        width: 52%;
        height: 11%;
        padding-top: 2%;
        padding-left: 15px;
        font-size: 1vw;
        color: #f7f5f7;
    }

    #lotNumberDiv b,
    #handedOverLotNumberDiv b,
    #demolishedStructureNumberDiv b,
    #structureNumberDiv b,
    #isfNumberDiv b {
        font-size: 2.5vw;
        font-family: "Calibri";
        font-weight: bold;
        color: #6ede00;
        /*#d4ff33;*/
        margin: auto;
    }

    #handedOverLotNumberDiv label,
    #demolishedStructureNumberDiv label {
        font-size: 1.7vw;
        font-family: "Calibri";
        color: #6ede00;
        /*#d4ff33;*/
        margin: auto;
    }

    #landImage,
    #landNumberImage,
    #isfNumberImage,
    #structureImage,
    #handedOverImage,
    #structureNumberImage,
    #demolishedStructureImage {
        width: 60;
        height: 60;
        margin-left: auto;
        margin-right: auto;
        margin-top: auto;
        margin-bottom: auto;
    }

    br {
        content: "";
        margin: 2em;
        display: block;
        font-size: 24%;
    }

    b {
        color: orange;
    }

    #dateDiv {
        font-size: 0.85vw;
        text-align: right;
        display: flex;
        align-items: flex-end;
        font-weight: bold;
    }

    #measurementToolMenu {
        padding: 0.8em;
        max-width: 180px;
        width: 250px;
    }

    #measurementToolLabel {
        color: white;
    }

    /* Expropriation List */
    /** clear background color of list box **/
    .panel-side {
        background-color: rgb(0, 0, 0, 0);
        margin-top: 1%;
        padding-left: 20;
    }

    /** adjust line height between texts **/
    .panel-side li {
        padding: 1% 1%;
    }

    /** adjust lot ID's font size and color **/
    .panel-side li b {
        color: red;
        font-size: 0.8vw;
    }

    .panel-result {
        cursor: pointer;
        margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
        background-color: rgba(73, 72, 72, 0.5);
    }

    #expropriationListDiv,
    #problemLotListDiv {
        list-style: none;
        padding: 0.5%;
        padding-right: 5%;
        font-size: 0.8vw;
        width: 22vw;
    }

    /* MOA Chart */
    #chartMoaLotDiv,
    #chartMoaStructureDiv {
        width: 100%;
        height: 30%;
        align-items: center;
        padding: 1%;
        margin-top: 3%;
    }

    /* Dropdown list */
    #dropdownDiv {
        background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: white;
        text-align: center;
        margin: auto;
    }

    /* Browser Setting */
    #timeSeriesChart {
        position: absolute;
        z-index: 1;
        height: 40vh;
        width: 60vw;
        bottom: 20%;
        left: 8vw;
        background-color: rgb(37, 37, 37);
    }

    #land-checkbox {
        margin: 10;
    }

    /* SCROLL BAR */
    /* ESRI POPUP */

    ::-webkit-scrollbar {
        width: 5px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
        background: #00032235;
        /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
        background: #ffba1f;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
        background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
    }

    /*
    .esri-legend__layer-cell--info {
      background-color: black;
      color: white;
      font-size: 0.85vw;
    }
    */

    .esri-legend {
        overflow: hidden;
        overflow-y: auto;
        margin-left: -10;
    }
</style>

<body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
        <!--  Header slot  -->
        <div slot="header" id="header">
            <!-- Title -->
            <h2 id="header-title" slot="header"></h2>
            <div id="dateDiv"></div>
            <!-- Dropdown Lists -->
            <div id="dropdownDiv" class="esri-widget">
                <label id="dropdownContractPackageLabel">
                    CP:
                    <select id="packageSelect" class="esri-widget"></select>
                </label>
                <label id="dropdownLandTypeLabel">
                    Land Type:
                    <select id="landTypeSelect" class="esri-widget"></select>
                </label>
                <label id="dropdownStationTypeLabel">
                    Section:
                    <select id="stationSelect" class="esri-widget"></select>
                </label>
            </div>
            <!--
      <div id="Handed-Over">
        <calcite-segmented-control>
          <calcite-segmented-control-item id="handedover-button" value="handedover">Handed-Over Lots</calcite-segmented-control-item>
        </calcite-segmented-control>
      </div>
      -->
        </div>

        <!-- Icon -->
        <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
        <calcite-shell-panel slot="panel-start" display-mode="float" detached>
            <calcite-action-bar slot="action-bar">
                <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
                <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
                <calcite-action data-action-id="charts" icon="graph-time-series" text="Progree Chart"></calcite-action>
                <calcite-action data-action-id="handedover" icon="selection" text="Handed-Over Lot"></calcite-action>
                <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>

            <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
                <calcite-list>
                    <calcite-list-item label="Existing Structure" description="" value="structure-acquisition">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="structure-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="structure-legend" class="esri-widget" style="margin-bottom: 0px" hidden></div>
                    </calcite-list-item>
                    <calcite-list-item label="Land Acquisition" description="" value="land-acquisition">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="land-check" style="margin-left: 5px"
                            checked></calcite-checkbox>
                        <div id="land-legend" class="esri-widget" style="margin-bottom: 0px"></div>
                    </calcite-list-item>
                    <calcite-list-item label="Demolished Structure" description=""
                        value="demolished-structure-acquisition">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="demolished-structure-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="demolished-structure-legend" class="esri-widget" style="margin-bottom: 0px" hidden>
                        </div>
                    </calcite-list-item>
                    <calcite-list-item label="Informal Settlers Families (ISF)" description="" value="isf-acquisition">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="isf-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="isf-legend" class="esri-widget" style="margin-bottom: 0px" hidden></div>
                    </calcite-list-item>
                    <calcite-list-item label="Depot Building" description="" value="depot-building">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="depotBuilding-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="depotbuilding-legend" class="esri-widget" style="margin-bottom: 0px" hidden></div>
                    </calcite-list-item>
                    <calcite-list-item label="BSS Depot Building" description="" value="bss-depot-building">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="bssDepotBuilding-check" style="margin-left: 5px"
                            checked></calcite-checkbox>
                        <div id="bssdepotbuilding-legend" class="esri-widget" style="margin-bottom: 0px"></div>
                    </calcite-list-item>
                    <calcite-list-item label="East Valenzuela Station" description="" value="evs-acquisition">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="evs-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="evs-legend" class="esri-widget" style="margin-bottom: 0px" hidden></div>
                    </calcite-list-item>
                    <calcite-list-item label="Senate-DepEd Boundary" description="" value="senate-boundary">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="senateBoundary-check"
                            style="margin-left: 5px"></calcite-checkbox>
                        <div id="senateboundary-legend" class="esri-widget" style="margin-bottom: 0px" hidden></div>
                    </calcite-list-item>
                    <calcite-list-item label="PO Section Box" description="" value="po-sectionbox">
                        <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                        <calcite-checkbox slot="actions-start" id="poSectionBox-check" style="margin-left: 5px"
                            checked></calcite-checkbox>
                        <div id="posectionbox-legend" class="esri-widget" style="margin-bottom: 0px"></div>
                    </calcite-list-item>
                </calcite-list>
            </calcite-panel>

            <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
                <div id="basemaps-container"></div>
            </calcite-panel>

            <calcite-panel class="timeSeries-panel" height-scale="l" data-panel-id="charts" hidden></calcite-panel>

            <calcite-panel heading="View Handed Over/PTE Lots" height-scale="l" data-panel-id="handedover" hidden>
                <div id="viewHandedOverLot">
                    <calcite-label id="handedoverlot-label"> Stations: </calcite-label>
                    <calcite-segmented-control id="handedover-stationlot-segment-control">
                        <calcite-segmented-control-item id="stationLot-on"
                            value="stationloton">ON</calcite-segmented-control-item>
                        <calcite-segmented-control-item id="stationLot-off" value="stationlotoff"
                            checked>OFF</calcite-segmented-control-item>
                    </calcite-segmented-control>
                    <calcite-label id="handedoverlot-label">
                        Subterranean:
                    </calcite-label>
                    <calcite-segmented-control>
                        <calcite-segmented-control-item id="subteLot-on"
                            value="subteloton">ON</calcite-segmented-control-item>
                        <calcite-segmented-control-item id="subteLot-off" value="subtelotoff"
                            checked>OFF</calcite-segmented-control-item>
                    </calcite-segmented-control>
                </div>
            </calcite-panel>

            <!-- Info panel (populates with info from the web map) -->
            <calcite-panel heading="Description" data-panel-id="information" hidden>
                <div id="info-content">
                    <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                    <div id="item-description">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </calcite-panel>
        </calcite-shell-panel>

        <div id="container">
            <div id="timeSeriesChart" hidden></div>
            <div id="viewDiv"></div>
            <!-- Chart Panel -->
            <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
            <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
            <calcite-tabs>
                <calcite-tab-nav slot="title-group" id="thetabs">
                    <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                    <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                    <calcite-tab-title class="ISF">ISF</calcite-tab-title>
                    <calcite-tab-title>ExproList</calcite-tab-title>
                    <calcite-tab-title>Remarks</calcite-tab-title>
                </calcite-tab-nav>
                <calcite-tab>
                    <div class="lotNumber-container">
                        <div id="lotNumberDiv"></div>
                        <img id="landNumberImage" src="https://EijiGorilla.github.io/Symbols/Land_logo.png" />
                    </div>
                    <div class="box" id="pieChartLotDiv"></div>
                    <div class="handOverLot-container">
                        <div id="handedOverLotNumberDiv"></div>
                        <img id="handedOverImage" src="https://EijiGorilla.github.io/Symbols/Handed_Over_Logo.svg" />
                    </div>
                    <div id="chartMoaLotDiv"></div>
                </calcite-tab>
                <calcite-tab>
                    <div class="structureNumber-container">
                        <div id="structureNumberDiv"></div>
                        <img id="structureNumberImage" src="https://EijiGorilla.github.io/Symbols/House_Logo.svg" />
                    </div>
                    <div class="boxStructure" id="pieChartStructureDiv"></div>
                    <div class="demolishedStructure-container">
                        <div id="demolishedStructureNumberDiv"></div>
                        <img id="demolishedStructureImage"
                            src="https://EijiGorilla.github.io/Symbols/Structure_Demolished.svg" />
                    </div>
                    <div id="chartMoaStructureDiv"></div>
                </calcite-tab>
                <calcite-tab>
                    <div class="isfNumber-container">
                        <div id="isfNumberDiv"></div>
                        <img id="isfNumberImage" src="https://EijiGorilla.github.io/Symbols/NLO_Logo.svg" />
                    </div>
                    <div class="box2" id="isfPieChartDiv"></div>
                </calcite-tab>
                <calcite-tab>
                    <div class="panel-side esri-widget">
                        <ul id="expropriationListDiv">
                            <li>Loading&hellip;</li>
                        </ul>
                    </div>
                </calcite-tab>
                <calcite-tab>
                    <div class="panel-side esri-widget">
                        <ul id="problemLotListDiv">
                            <li>Loading&hellip;</li>
                        </ul>
                    </div>
                </calcite-tab>
            </calcite-tabs>
        </div>
    </calcite-shell>
</body>
<script>
    require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/widgets/Bookmarks",
        "esri/widgets/BasemapGallery",
        "esri/widgets/LayerList",
        "esri/widgets/Legend",
        "esri/rest/support/Query",
        "esri/widgets/Fullscreen",
        "esri/layers/support/FeatureFilter",
        "esri/widgets/TableList",
        "esri/portal/PortalItem",
        "esri/portal/Portal",
        "esri/rest/geometryService",
        "esri/rest/support/StatisticDefinition",
        "esri/symbols/WebStyleSymbol",
        "esri/widgets/Expand",
        "esri/renderers/UniqueValueRenderer",
        "esri/Ground",
        "esri/rest/support/RelationshipQuery",
        "esri/layers/GraphicsLayer",
        "esri/widgets/Search",
        "esri/widgets/Locate",
        "esri/widgets/BasemapToggle",
        "esri/widgets/Print",
    ], function (
        WebMap,
        MapView,
        Map,
        FeatureLayer,
        Bookmarks,
        BasemapGallery,
        LayerList,
        Legend,
        Query,
        Fullscreen,
        FeatureFilter,
        TableList,
        PortalItem,
        Portal,
        geometryService,
        StatisticDefinition,
        WebStyleSymbol,
        Expand,
        UniqueValueRenderer,
        Ground,
        RelationshipQuery,
        GraphicsLayer,
        Search,
        Locate,
        BasemapToggle,
        Print
    ) {
        var map = new Map({
            basemap: "dark-gray-vector", // "streets-night-vector", basemap
            ground: "world-elevation",
        });

        var view = new MapView({
            map: map,
            center: [121.0194387, 14.6972616],
            zoom: 14,
            container: "viewDiv",
            environment: {
                background: {
                    type: "color", // autocasts as new ColorBackground()
                    color: [0, 0, 0, 1],
                },
            },
        });

        // Removes bottom license copyright
        view.ui.components = [];

        // Default Renderer for Polygon------------
        let defaultLotSymbolBoundary = {
            type: "simple-fill",
            color: [0, 0, 0, 0],
            style: "solid",
            outline: {
                style: "short-dash",
                color: [215, 215, 158],
                width: 1.5,
            },
        };

        //------------- Layer ----------------------------- /
        // Lot Layer----------------------------------
        const LOT_LABEL_CLASS = {
            symbol: {
                type: "text", // autocasts as new TextSymbol()
                color: "black",
                /*
                  font: {  // autocast as new Font()
                      family: "Gill Sans",
                      size: 8
                  }
                  */
            },
            labelPlacement: "always-horizontal",
            labelExpressionInfo: {
                expression: "$feature.CN",
            },
        };

        let lotDefaultSymbol = {
            type: "simple-fill", // autocasts as new SimpleFillSymbol()
            color: [0, 0, 0, 0],
            style: "solid",
            outline: {
                // autocasts as new SimpleLineSymbol()
                color: [110, 110, 110],
                width: 0.7,
            },
        };

        let lotDefaultRenderer = {
            type: "simple",
            symbol: lotDefaultSymbol,
        };

        let lotLayerRenderer = {
            type: "unique-value",
            //field: "StatusLA",
            defaultSymbol: lotDefaultSymbol, // autocasts as new SimpleFillSymbol()
            valueExpression:
                "When($feature.StatusNVS3 == 1, '1',$feature.StatusNVS3 == 2, '2', $feature.StatusNVS3 == 3, '3', \
                        $feature.StatusNVS3 == 4, '4', $feature.StatusNVS3 == 5, '5', \
                        $feature.StatusNVS3 == 6, '6', $feature.StatusNVS3 == 7, '7', $feature.StatusNVS3)",
            uniqueValueInfos: [
                {
                    // All features with value of "North" will be blue
                    value: "1",
                    label: "Paid",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[1],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "2",
                    label: "For Payment Processing",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[2],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "3",
                    label: "For Legal Pass",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[3],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "4",
                    label: "For Appraisal/Offer to Buy",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[4],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "5",
                    label: "For Expro",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[5],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "6",
                    label: "with WOP Fully Turned-over",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[6],
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "7",
                    label: "ROWUA/TUA",
                    symbol: {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: colorLotReqs()[7],
                    },
                },
            ],
        };

        function colorLotReqs() {
            return {
                1: [112, 173, 71],
                2: [0, 112, 255],
                3: [255, 255, 0],
                4: [255, 170, 0],
                5: [255, 0, 0],
                6: [0, 115, 76],
                7: "#55FF00",
            };
        }

        var lotLayer = new FeatureLayer({
            portalItem: {
                id: "032432d931624de9bf5ff03f1f9d7016",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            title: "Land Acquisition",
            labelingInfo: [LOT_LABEL_CLASS],
            renderer: lotLayerRenderer,
            popupTemplate: {
                title: "<p>{Id}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Issue",
                                label: "Remarks",
                            },
                            {
                                fieldName: "OWNER",
                                label: "Land Owner",
                            },
                            {
                                fieldName: "Station1",
                                label: "Station",
                            },
                            {
                                fieldName: "StatusNVS3",
                                label: "<p>Status of Land Acquisition</p>",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(lotLayer);

        // Handed-Over Layer
        const handedOverRenderer = {
            type: "simple",
            field: "HandedOver",
            symbol: {
                type: "simple-fill", // autocasts as new SimpleFillSymbol()
                color: "#FF00C5",
                style: "solid",
                outline: {
                    // autocasts as new SimpleLineSymbol()
                    color: [110, 110, 110],
                    width: 0.5,
                },
            },
        };
        var handedOverLotLayer = new FeatureLayer({
            portalItem: {
                id: "032432d931624de9bf5ff03f1f9d7016",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            definitionExpression: "HandedOver = 1",
            title: "Handed-Over Lots",
            renderer: handedOverRenderer,
            popupEnabled: false,
        });
        map.add(handedOverLotLayer);
        handedOverLotLayer.visible = false;

        // Delete this layer later. temporary used to experiment time series chart
        var handedOverLotBackgroundLayer = new FeatureLayer({
            portalItem: {
                id: "032432d931624de9bf5ff03f1f9d7016",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            definitionExpression: "HandedOver IS NULL",
            labelingInfo: [LOT_LABEL_CLASS],
            renderer: lotDefaultRenderer,
            popupTemplate: {
                title: "<p>{Id}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Issue",
                                label: "Remarks",
                            },
                            {
                                fieldName: "OWNER",
                                label: "Land Owner",
                            },
                            {
                                fieldName: "Station1",
                                label: "Station",
                            },
                            {
                                fieldName: "StatusNVS3",
                                label: "<p>Status of Land Acquisition</p>",
                            },
                        ],
                    },
                ],
            },
        });
        handedOverLotBackgroundLayer.visible = false;
        map.add(handedOverLotBackgroundLayer);

        // Handed-Over subterranean lots
        var pteLotSubteLayer = new FeatureLayer({
            portalItem: {
                id: "032432d931624de9bf5ff03f1f9d7016",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 1",
            title: "PTE Subterranean Lots",
            renderer: handedOverRenderer,
            popupEnabled: false,
        });
        map.add(pteLotSubteLayer);
        pteLotSubteLayer.visible = false;

        var pteLotSubteBackgroundLayer = new FeatureLayer({
            portalItem: {
                id: "032432d931624de9bf5ff03f1f9d7016",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 0",
            labelingInfo: [LOT_LABEL_CLASS],
            renderer: lotDefaultRenderer,
            popupTemplate: {
                title: "<p>{Id}</p>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Issue",
                                label: "Remarks",
                            },
                            {
                                fieldName: "OWNER",
                                label: "Land Owner",
                            },
                            {
                                fieldName: "Station1",
                                label: "Station",
                            },
                            {
                                fieldName: "StatusNVS3",
                                label: "<p>Status of Land Acquisition</p>",
                            },
                        ],
                    },
                ],
            },
        });
        pteLotSubteBackgroundLayer.visible = false;
        map.add(pteLotSubteBackgroundLayer);

        // Zoom
        function zoomToLayer(layer) {
            return layer.queryExtent().then(function (response) {
                view
                    .goTo(response.extent, {
                        //response.extent
                        speedFactor: 2,
                        zoom: 17,
                    })
                    .catch(function (error) {
                        if (error.name != "AbortError") {
                            console.error(error);
                        }
                    });
            });
        }

        // Structure Layer----------------------------------
        function colorStructureReqs() {
            return {
                1: [112, 173, 71], // Paid #70AD47
                2: [0, 112, 255], // For Payment Processing #0070FF
                3: [255, 255, 0], // For Legal Pass #FFFF00
                4: [255, 170, 0], // For Appraisal/Offer to Compensate #FFAA00
                5: [255, 0, 0], // For Expro #FF0000
                6: [0, 115, 76], //Quit Claim #00734C
            };
        }

        let structureLayerRenderer = {
            type: "unique-value",
            //field: "StatusLA",
            defaultSymbol: defaultLotSymbolBoundary, // autocasts as new SimpleFillSymbol()
            valueExpression:
                "When($feature.Status == 1, '1',$feature.Status == 2, '2', \
                          $feature.Status == 3, '3', \
                          $feature.Status == 4, '4', $feature.Status == 5, '5', \
                          $feature.Status == 6, '6', $feature.Status)",
            uniqueValueInfos: [
                {
                    // All features with value of "North" will be blue
                    value: "1",
                    label: "Paid",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[1],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "2",
                    label: "For Payment Processing",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[2],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "3",
                    label: "For Legal Pass",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[3],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "4",
                    label: "For Appraisal/Offer to Buy",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[4],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "5",
                    label: "For Expro",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[5],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "6",
                    label: "Quit Claim",
                    symbol: {
                        type: "simple-fill",
                        color: colorStructureReqs()[6],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
            ],
        };

        var structureLayer = new FeatureLayer({
            portalItem: {
                id: "ec9dac0c16af4797bb917a0babc735e9",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            title: "Existing Structure",
            outFields: ["*"],
            renderer: structureLayerRenderer,
            popupTemplate: {
                title: "Structure ID: <b>{STRUCTURE_TAG_NO_}</b>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "STATION",
                                label: "Station",
                            },
                            {
                                fieldName: "Status",
                                label: "<b>Status of Structure</b>",
                            },
                            {
                                fieldName: "LOT_OWNER",
                                label: "Lot Owner",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(structureLayer);

        // Structure demolished
        let structureDemolishedRenderer = {
            type: "unique-value",
            field: "REMARKS",
            defaultSymbol: defaultLotSymbolBoundary, // autocasts as new SimpleFillSymbol()
            uniqueValueInfos: [
                {
                    // All features with value of "North" will be blue
                    value: "Demolished",
                    label: "Demolished",
                    symbol: {
                        type: "simple-fill",
                        color: "#FFAA00",
                        style: "solid", // "backward-diagonal"
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
                {
                    // All features with value of "North" will be blue
                    value: "Not Yet",
                    label: "Occupied",
                    symbol: {
                        type: "simple-fill",
                        color: "#99A5A2",
                        style: "solid",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7,
                        },
                    },
                },
            ],
        };

        var structureDemolishedLayer = new FeatureLayer({
            portalItem: {
                id: "ec9dac0c16af4797bb917a0babc735e9",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            title: "Demolished Structure",
            outFields: ["*"],
            renderer: structureDemolishedRenderer,
            popupTemplate: {
                title: "Structure ID: <b>{STRUCTURE_TAG_NO_}</b>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "STATION",
                                label: "Station",
                            },
                            {
                                fieldName: "Status",
                                label: "<b>Status of Structure</b>",
                            },
                            {
                                fieldName: "LOT_OWNER",
                                label: "Lot Owner",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(structureDemolishedLayer);

        // ISF Layer----------------------------------
        const ISF_COLOR = ["#267300", "#FF0000"];
        const OUTLINE_COLOR = "white";

        let isfRenderer = {
            type: "unique-value",
            valueExpression:
                "When($feature.RELOCATION == 'RELOCATED', 'Relocated', \
                               $feature.RELOCATION == 'FOR RELOCATION', 'Unrelocated', $feature.RELOCATION)",
            uniqueValueInfos: [
                //[1:Non-Compensable, 2:For Processing, 3:Compensated]
                {
                    value: "Relocated",
                    label: "Relocated",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 9,
                        color: ISF_COLOR[0], // the first two letters dictate transparency.
                        outline: {
                            width: 1.5,
                            color: OUTLINE_COLOR,
                        },
                    },
                },
                {
                    value: "Unrelocated",
                    label: "For Relocation",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 9,
                        color: ISF_COLOR[1], // the first two letters dictate transparency.
                        outline: {
                            width: 1.5,
                            color: OUTLINE_COLOR,
                        },
                    },
                },
            ],
        };

        var isfLayer = new FeatureLayer({
            portalItem: {
                id: "a2e32eb82db84b3a8006e1c1e2cd7874",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            title: "ISF (Informal Settlers Families)",
            outFields: ["*"],
            returnGeometry: true,
            renderer: isfRenderer,
            labelsVisible: false,
        });
        map.add(isfLayer);

        // Construction Boundary----------------------------------
        let ConstructionBoundaryFill = {
            type: "unique-value",
            valueExpression:
                "When($feature.MappingBoundary == 1, 'Boundary', $feature.MappingBoundary)",
            uniqueValueInfos: [
                {
                    value: "Boundary",
                    symbol: {
                        type: "simple-fill",
                        color: [0, 0, 0, 0],
                        outline: {
                            width: 1.5,
                            color: [255, 255, 255],
                            style: "short-dash",
                        },
                    },
                },
            ],
        };

        var constBoundary = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 4,
            outFields: ["*"],
            renderer: ConstructionBoundaryFill,
            definitionExpression: "MappingBoundary = 1",
            title: "Construction Boundary",
            popupEnabled: false,
        });
        map.add(constBoundary);

        // Alignment----------------------------------
        var alignmentLine = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 13,
            outFields: ["*"],
            title: "Alignment",
            popupEnabled: false,
        });
        map.add(alignmentLine);

        // Segment DPWH----------------------------------
        var dpwhSegmentLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 2,
            title: "DPWH Segment",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(dpwhSegmentLayer);

        // BSS Boundary----------------------------------
        /*
        var bssDepotLayer = new FeatureLayer ({
          portalItem: {
              id: "b0cf28b499a54de7b085725bca08deee",
              portal: {
                  url: "https://gis.railway-sector.com/portal"
              }
          },
          layerId: 3,
          title: "BSS Boundary",
          outFields: ["*"],
          popupEnabled: false
        });
        map.add(bssDepotLayer);
  */
        // Creek Diversion----------------------------------
        var creekDivLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 10,
            title: "Creek Diversion",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(creekDivLayer);

        // Depot Building----------------------------------
        var depotBuildingLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 6,
            title: "Depot Building",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(depotBuildingLayer);

        // BSS Building----------------------------------
        var bssDepotBuildingLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 7,
            title: "BSS Building",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(bssDepotBuildingLayer);

        // East Valenzuela----------------------------------
        var evsLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 9,
            title: "East Valenzuela",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(evsLayer);

        // NNC Construction boundary (Senate)----------------------------------
        var senateBoundaryLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 5,
            title: "NCC Property",
            outFields: ["*"],
            popupEnabled: false,
        });
        //senateBoundaryLayer.list = "hide";
        map.add(senateBoundaryLayer);

        // Station1 box----------------------------------
        let poSectionBoxRenderer = {
            type: "unique-value",
            field: "Layer",
            defaultSymbol: { type: "simple-fill" },
            uniqueValueInfos: [
                {
                    value: "U-Shape Retaining Wall",
                    symbol: {
                        type: "simple-fill",
                        color: [104, 104, 104],
                        style: "backward-diagonal",
                        outline: {
                            width: 1,
                            color: "black",
                        },
                    },
                },
                {
                    value: "Cut & Cover Box",
                    symbol: {
                        type: "simple-fill",
                        color: [104, 104, 104],
                        style: "backward-diagonal",
                        outline: {
                            width: 1,
                            color: "black",
                        },
                    },
                },
                {
                    value: "TBM Shaft",
                    symbol: {
                        type: "simple-fill",
                        color: [104, 104, 104],
                        style: "backward-diagonal",
                        outline: {
                            width: 1,
                            color: "black",
                        },
                    },
                },
                {
                    value: "TBM",
                    symbol: {
                        type: "simple-fill",
                        color: [178, 178, 178],
                        style: "backward-diagonal",
                        outline: {
                            width: 0.5,
                            color: "black",
                        },
                    },
                },
                {
                    value: "Station Platform",
                    symbol: {
                        type: "simple-fill",
                        color: [240, 204, 230],
                        style: "backward-diagonal",
                        outline: {
                            width: 0.4,
                            color: "black",
                        },
                    },
                },
                {
                    value: "Station Box",
                    symbol: {
                        type: "simple-fill",
                        color: [0, 0, 0, 0],
                        outline: {
                            width: 2,
                            color: "red",
                        },
                    },
                },
                {
                    value: "NATM",
                    symbol: {
                        type: "simple-fill",
                        color: [178, 178, 178],
                        style: "backward-diagonal",
                        outline: {
                            width: 0.5,
                            color: "grey",
                        },
                    },
                },
            ],
        };

        var poSectionBoxLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 8,
            renderer: poSectionBoxRenderer,
            title: "Alignment",
            outFields: ["*"],
            popupEnabled: false,
        });
        map.add(poSectionBoxLayer);

        // Station Point----------------------------------
        var stationLayer = new FeatureLayer({
            portalItem: {
                id: "b0cf28b499a54de7b085725bca08deee",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            title: "Station",
            definitionExpression: "Project = 'MMSP'",
            //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
        });
        stationLayer.listMode = "hide";
        map.add(stationLayer, 0);

        // Get last edited date
        const month = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];
        function getEditedDateValue() {
            var tempDates = [];

            var query = lotLayer.createQuery();
            //query.fields = ["enddate"];
            query.where = "last_edited_date IS NOT NULL";
            return lotLayer.queryFeatures(query).then(function (response) {
                var stats = response.features;
                stats.forEach((result, index) => {
                    var attributes = result.attributes;
                    const dates = attributes.last_edited_date;
                    tempDates.push(dates);
                });
                const lastDate = Math.max(...tempDates);
                const lastEdit = new Date(lastDate);
                const yyyy = lastEdit.getFullYear();
                const mm = month[lastEdit.getMonth()];
                const dd = lastEdit.getDate();
                const lastEditedDate = `As of ${mm} ${dd}, ${yyyy}`;
                document.getElementById("dateDiv").innerHTML =
                    "As of September 25, 2023";
            });
        }

        getEditedDateValue();

        // Chart-----------------------------------------------
        let chartLayerView;
        var highlightSelect;

        const lotNumberDiv = document.getElementById("lotNumberDiv");
        const handedOverLotNumberDiv = document.getElementById(
            "handedOverLotNumberDiv"
        );
        const structureNumberDiv = document.getElementById("structureNumberDiv");
        const demolishedStructureNumberDiv = document.getElementById(
            "demolishedStructureNumberDiv"
        );
        const isfNumberDiv = document.getElementById("isfNumberDiv");
        const handedOverButton = document.getElementById("handedOverButton");

        var stationSelect = document.getElementById("stationSelect");
        var landTypeSelect = document.getElementById("landTypeSelect");
        var packageSelect = document.getElementById("packageSelect");

        am5.ready(function () {
            // Expropriation List----------------------------------
            view.when(function () {
                var expropriationList = document.getElementById(
                    "expropriationListDiv"
                );

                // Obtain a list of Owner's names and status
                view.whenLayerView(lotLayer).then(function (exprolayerView) {
                    exprolayerView.watch("updating", function (val) {
                        if (!val) {
                            // Query for only Expropriation lots
                            var query = new Query();
                            query.where = "StatusNVS3 = 5";
                            exprolayerView.queryFeatures(query).then(function (result) {
                                expropriationList.innerHTML = "";
                                result.features.forEach(function (feature) {
                                    var attributes = feature.attributes;
                                    var li = document.createElement("li");
                                    li.setAttribute("class", "panel-result");

                                    const status = attributes.StatusNVS3;
                                    if (status == 5) {
                                        statusla = "Expropriation";
                                    }

                                    // Add Expropriation lots to list
                                    li.innerHTML =
                                        "<b>" +
                                        attributes.ID +
                                        "</b>" +
                                        "<br>" +
                                        attributes.OWNER +
                                        "</br>";

                                    li.addEventListener("click", function (event) {
                                        var target = event.target;
                                        var objectId = feature.attributes.OBJECTID;
                                        var queryExtent = new Query({
                                            objectIds: [objectId],
                                        });

                                        // Query extent for selected expropriation lot in the list
                                        exprolayerView
                                            .queryExtent(queryExtent)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view
                                                        .goTo({
                                                            target: result.extent,
                                                            speedFactor: 2,
                                                            zoom: 17,
                                                        })
                                                        .catch(function (error) {
                                                            if (error.name != "AbortError") {
                                                                console.error(error);
                                                            }
                                                        }); // End of catch
                                                } // End of if (result.extent)
                                            }); // End of layerView.queryExtent

                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function () {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    expropriationList.appendChild(li);

                                    /* It looks like hovering + zoom do not work when put together
                                                    // Hover a mouse over the list and highlight
                                                    li.addEventListener("mouseenter", function(event) {
                                                      var objectId = feature.attributes.OBJECTID;
                
                                                      if (highlightSelect) {
                                                        highlightSelect.remove();
                                                      }
                                                      highlightSelect = exprolayerView.highlight([objectId]);
                
                                                      view.on("click", function() {
                                                        exprolayerView.filter = null;
                                                        highlightSelect.remove();
                                                      });
                
                                                    }); // End of mouse hover highlight
                                                    */
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()

            // Problem lot list
            view.when(function () {
                var problemLotList = document.getElementById("problemLotListDiv");

                // Obtain a list of Owner's names and status
                view.whenLayerView(lotLayer).then(function (exprolayerView) {
                    exprolayerView.watch("updating", function (val) {
                        if (!val) {
                            // Query for only Expropriation lots
                            var query = new Query();
                            query.where = "Issue IS NOT NULL";
                            exprolayerView.queryFeatures(query).then(function (result) {
                                problemLotList.innerHTML = "";
                                result.features.forEach(function (feature) {
                                    var attributes = feature.attributes;
                                    var li = document.createElement("li");
                                    li.setAttribute("class", "panel-result");

                                    // Add Expropriation lots to list
                                    li.innerHTML =
                                        "<b>" +
                                        attributes.ID +
                                        "</b>" +
                                        "<br>" +
                                        attributes.Issue +
                                        "</br>";

                                    li.addEventListener("click", function (event) {
                                        var target = event.target;
                                        var objectId = feature.attributes.OBJECTID;
                                        var queryExtent = new Query({
                                            objectIds: [objectId],
                                        });

                                        // Query extent for selected expropriation lot in the list
                                        exprolayerView
                                            .queryExtent(queryExtent)
                                            .then(function (result) {
                                                if (result.extent) {
                                                    view
                                                        .goTo({
                                                            target: result.extent,
                                                            speedFactor: 2,
                                                            zoom: 17,
                                                        })
                                                        .catch(function (error) {
                                                            if (error.name != "AbortError") {
                                                                console.error(error);
                                                            }
                                                        }); // End of catch
                                                } // End of if (result.extent)
                                            }); // End of layerView.queryExtent

                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function () {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    problemLotList.appendChild(li);

                                    /*
                                                    // Hover a mouse over the list and highlight
                                                    li.addEventListener("mouseenter", function(event) {
                                                      var objectId = feature.attributes.OBJECTID;
                
                                                      if (highlightSelect) {
                                                        highlightSelect.remove();
                                                      }
                                                      highlightSelect = exprolayerView.highlight([objectId]);
                
                                                      view.on("click", function() {
                                                        exprolayerView.filter = null;
                                                        highlightSelect.remove();
                                                      });
                                                    }); // End of mouse hover highlight
                                                    */
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()

            // Thousand separators function
            function thousands_separators(num) {
                var num_parts = num.toString().split(".");
                num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return num_parts.join(".");
            }

            // 1. Total Number of Lots
            function totalNumberOfLots() {
                var totalLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalLot",
                    statisticType: "sum",
                };
                var query = lotLayer.createQuery();
                query.outStatistics = [totalLot];
                query.returnGeometry = true;

                return lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const LOT_TOTAL = stats.totalLot;
                    return LOT_TOTAL;
                });
            }

            // Total number of Lots
            function totalNumberOfLotsAll(totalLotValue) {
                var totalLot = {
                    onStatisticField: "ID",
                    outStatisticFieldName: "totalLot",
                    statisticType: "count",
                };
                var query = lotLayer.createQuery();
                query.outStatistics = [totalLot];
                query.returnGeometry = true;

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const LOT_TOTAL = stats.totalLot;
                    const totalValue = thousands_separators(LOT_TOTAL);
                    lotNumberDiv.innerHTML = `TOTAL LOTS<br><br><b>${totalLotValue}</b> (${totalValue})`;
                });
            }
            totalNumberOfLots().then(totalNumberOfLotsAll);

            // Total number of handed-over lots
            function handedOverNumberLot(totalLot) {
                var totalHandedOverLot = {
                    onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalHandedOverLot",
                    statisticType: "sum",
                };
                var query = lotLayer.createQuery();
                query.outStatistics = [totalHandedOverLot];
                query.returnGeometry = true;

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const handedOver = stats.totalHandedOverLot;
                    const HAND_OVER_TOTAL = thousands_separators(handedOver);
                    const remaining = totalLot - HAND_OVER_TOTAL;
                    const percent_handedOver = ((handedOver / totalLot) * 100).toFixed(
                        0
                    );
                    handedOverLotNumberDiv.innerHTML = `HANDED-OVER<br><br><b>${HAND_OVER_TOTAL}</b> <label>(${percent_handedOver} %)</label>`;
                });
            }
            totalNumberOfLots().then(handedOverNumberLot);

            // Total number of structures
            function totalNumberOfStructures() {
                var totalStructure = {
                    onStatisticField: "CASE WHEN Status >= 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalStructure",
                    statisticType: "sum",
                };
                var query = structureLayer.createQuery();
                query.outStatistics = [totalStructure];
                query.returnGeometry = true;

                return structureLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const total = stats.totalStructure;
                    const STRUCTURE_TOTAL =
                        total === null ? 0 : thousands_separators(stats.totalStructure);

                    // structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br><br>${STRUCTURE_TOTAL}` : `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;

                    return STRUCTURE_TOTAL;
                });
            }

            function totalNumberOfStructureAll(structureValue) {
                var totalStructureAll = {
                    onStatisticField: "CASE WHEN Id IS NOT NULL THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalStructureAll",
                    statisticType: "sum",
                };

                var query = structureLayer.createQuery();
                query.outStatistics = [totalStructureAll];
                query.outFields = ["*"];
                query.returnGeometry = true;

                structureLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const total = stats.totalStructureAll;

                    const total_structure =
                        total === null ? 0 : thousands_separators(total);
                    //const totalValue = thousands_separators(total) + " (" + structureValue + ")";

                    //structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br><br>${STRUCTURE_TOTAL}` : `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;
                    structureNumberDiv.innerHTML = `TOTAL STRUCTURES<br><br><b>${structureValue}</b> (${total_structure})`;
                });
            }
            totalNumberOfStructures().then(totalNumberOfStructureAll);

            // Total number of demolished structures
            function totalNumberOfDemolishedStructure() {
                var total_structure_all = {
                    onStatisticField: "CASE WHEN REMARKS IS NOT NULL THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_structure_all",
                    statisticType: "sum",
                };

                var total_demolished_structure = {
                    onStatisticField:
                        "CASE WHEN REMARKS = 'Demolished' THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_demolished_structure",
                    statisticType: "sum",
                };

                var query = structureDemolishedLayer.createQuery();
                query.outStatistics = [
                    total_structure_all,
                    total_demolished_structure,
                ];
                query.outFields = ["REMARKS"];
                query.returnGeometry = true;

                structureDemolishedLayer
                    .queryFeatures(query)
                    .then(function (response) {
                        var stats = response.features[0].attributes;

                        const total = stats.total_structure_all;
                        const demolished = stats.total_demolished_structure;
                        const demolished_total =
                            total === null ? 0 : thousands_separators(demolished);
                        const remaining = total === null ? 0 : total - demolished;
                        const percent_demolished =
                            total === null ? 0 : ((demolished / total) * 100).toFixed(0);
                        demolishedStructureNumberDiv.innerHTML = `DEMOLISHED<br><br><b>${demolished_total}</b> <label>(${percent_demolished} %)</label>`;
                    });
            }
            totalNumberOfDemolishedStructure();

            // Total number of ISF
            function isfNumber() {
                var totalRelo = {
                    onStatisticField:
                        "CASE WHEN RELOCATION = 'RELOCATED' THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalRelo",
                    statisticType: "sum",
                };
                var totalIsf = {
                    onStatisticField: "RELOCATION",
                    outStatisticFieldName: "totalIsf",
                    statisticType: "count",
                };

                var query = isfLayer.createQuery();
                query.outStatistics = [totalRelo, totalIsf];
                query.outFields = ["*"];
                query.returnGeometry = true;

                isfLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const ISF_RELO = stats.totalRelo;
                    const ISF_TOTAL = stats.totalIsf;
                    const PERCENT = (ISF_RELO / ISF_TOTAL) * 100;

                    isfNumberDiv.innerHTML = `TOTAL ISF<br><br><b>${ISF_TOTAL}</b>`;

                    if (ISF_RELO == null) {
                        isfNumberDiv.innerHTML = `TOTAL ISF<br><br><b>0</b>`;
                    } else {
                        const isf_total = ISF_RELO + " (" + PERCENT + "%" + ")";
                        isfNumberDiv.innerHTML = `TOTAL ISF<br><br><b>${ISF_TOTAL}</b>`;
                    }
                });
            }
            isfNumber();

            // Dropdown List
            // 1. Define Query
            // 1.1. Query all features from lot layer
            view
                .when(function () {
                    return lotLayer.when(function () {
                        var query = lotLayer.createQuery();
                        return lotLayer.queryFeatures(query);
                    });
                })
                .then(getValues)
                .then(getUniqueValues)
                .then(addToSelect);

            function queryForLotGeometries() {
                var lotQuery = lotLayer.createQuery();

                return lotLayer.queryFeatures(lotQuery).then(function (response) {
                    lotGeometries = response.features.map(function (feature) {
                        return feature.geometry;
                    });
                    return lotGeometries;
                });
            }

            // 1. Contract Package:--------------------------------
            function getValues(response) {
                var features = response.features;
                var values = features.map(function (feature) {
                    return feature.attributes.Package;
                });
                return values;
            }

            // Return an array of unique values in the 'Municipality' field of the lot Layer
            function getUniqueValues(values) {
                var uniqueValues = [];

                values.forEach(function (item, i) {
                    if (
                        (uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) &&
                        item !== ""
                    ) {
                        uniqueValues.push(item);
                    }
                });
                return uniqueValues;
            }

            // Add the unique values to the municipalility select element. this will allow the user
            // to filter lot layer by municipality.
            function addToSelect(values) {
                values.sort();
                values.unshift("None"); // Add 'None' to the array and place it to the beginning of the array
                values.forEach(function (value) {
                    var option = document.createElement("option");
                    option.text = value;
                    packageSelect.add(option);
                });
            }

            // 2. Land Type:--------------------------------
            // 3. Get values and return to list
            /// 3.1. Land Type
            function landTypeFilterList(cpValue) {
                var landTypeArray = [];

                function landTypeQuery() {
                    var query = lotLayer.createQuery();
                    query.where =
                        cpValue === undefined || cpValue === "None"
                            ? "1=1"
                            : "Package = '" + cpValue + "'";

                    return lotLayer.queryFeatures(query).then(function (response) {
                        stats = response.features;
                        stats.forEach((result, index) => {
                            const attributes = result.attributes;
                            const landType = attributes.Type;
                            landTypeArray.push(landType);
                        });
                        return landTypeArray;
                    });
                }

                function getUniqueValues2(values2) {
                    var uniqueValues2 = [];
                    values2.forEach(function (item, i) {
                        if (
                            (uniqueValues2.length < 1 ||
                                uniqueValues2.indexOf(item) === -1) &&
                            item !== ""
                        ) {
                            uniqueValues2.push(item);
                        }
                    });
                    return uniqueValues2;
                }

                function addToSelectQuery2(query2Values) {
                    landTypeSelect.options.length = 0;
                    query2Values.sort();
                    query2Values.unshift("None");
                    query2Values.forEach(function (value) {
                        var option = document.createElement("option");
                        option.text = value;
                        landTypeSelect.add(option);
                    });
                }
                landTypeQuery().then(getUniqueValues2).then(addToSelectQuery2);
            }
            landTypeFilterList();

            // 3. Section/station list
            function sectionFilterList(cpValue, landTypeValue) {
                var sectionArray = [];

                function sectionQuery() {
                    var query = lotLayer.createQuery();
                    if (cpValue === undefined && landTypeValue === undefined) {
                        query.where = "1=1";

                        // CP: None, Land Type: !None
                    } else if (cpValue === "None" && landTypeValue !== "None") {
                        query.where = "Type = '" + landTypeValue + "'";

                        // CP: !None, Land Type: None
                    } else if (cpValue !== "None" && landTypeValue == "None") {
                        query.where = "Package = '" + cpValue + "'";

                        // CP: !None , Land Type: !None
                    } else if (cpValue !== "None" && landTypeValue !== "None") {
                        query.where =
                            "Package = '" +
                            cpValue +
                            "'" +
                            " AND " +
                            "Type = '" +
                            landTypeValue +
                            "'";
                    }

                    return lotLayer.queryFeatures(query).then(function (response) {
                        stats = response.features;
                        stats.forEach((result, index) => {
                            const attributes = result.attributes;
                            const section = attributes.Station1;
                            sectionArray.push(section);
                        });
                        return sectionArray;
                    });
                }

                function getUniqueValues3(values2) {
                    var uniqueValues2 = [];
                    values2.forEach(function (item, i) {
                        if (
                            (uniqueValues2.length < 1 ||
                                uniqueValues2.indexOf(item) === -1) &&
                            item !== ""
                        ) {
                            uniqueValues2.push(item);
                        }
                    });
                    return uniqueValues2;
                }

                function addToSelectQuery3(query2Values) {
                    stationSelect.options.length = 0;
                    query2Values.sort();
                    query2Values.unshift("None");
                    query2Values.forEach(function (value) {
                        var option = document.createElement("option");
                        option.text = value;
                        stationSelect.add(option);
                    });
                }
                sectionQuery().then(getUniqueValues3).then(addToSelectQuery3);
            }
            sectionFilterList();

            // 4. Set DefinitionExpression on the lot layer
            // 4.1. Only for Contract Package
            function setContractPackageExpression(cpValue) {
                const definitionExpression = "Package = '" + cpValue + "'";
                if (cpValue === "None") {
                    lotLayer.definitionExpression = null;
                    structureLayer.definitionExpression = null;
                    structureDemolishedLayer.definitionExpression = null;
                    isfLayer.definitionExpression = null;
                    constBoundary.definitionExpression = null;
                } else {
                    lotLayer.definitionExpression = definitionExpression;
                    structureLayer.definitionExpression = definitionExpression;
                    structureDemolishedLayer.definitionExpression =
                        definitionExpression;
                    isfLayer.definitionExpression = definitionExpression;
                    constBoundary.definitionExpression = definitionExpression;
                }
                zoomToLayer(lotLayer);

                return queryForLotGeometries;
            }

            // 4.2. CP + Land Type + Section/Station
            function setContractPackageLandTypeSectionExpression(
                cpValue,
                landTypeValue,
                sectionValue
            ) {
                const packageDefinition = "Package = '" + cpValue + "'";
                const landTypeDefinition = "Type = '" + landTypeValue + "'";
                const sectionDefinition = "Station1 = '" + sectionValue + "'";

                const packageLandTypeDefinition =
                    "Package = '" +
                    cpValue +
                    "'" +
                    " AND " +
                    "Type = '" +
                    landTypeValue +
                    "'";
                const packageSectionDefinition =
                    "Package = '" +
                    cpValue +
                    "'" +
                    " AND " +
                    "Station1 = '" +
                    sectionValue +
                    "'";
                const packageLandTypeSectionDefinition =
                    "Package = '" +
                    cpValue +
                    "'" +
                    " AND " +
                    "Type = '" +
                    landTypeValue +
                    "'" +
                    " AND " +
                    "Station1 = '" +
                    sectionValue +
                    "'";
                const landTypeSectionDefinition =
                    "Type = '" +
                    landTypeValue +
                    "'" +
                    " AND " +
                    "Station1 = '" +
                    sectionValue +
                    "'";

                if (
                    cpValue == "None" &&
                    landTypeValue == "None" &&
                    sectionValue == "None"
                ) {
                    lotLayer.definitionExpression = null;
                    structureLayer.definitionExpression = null;
                    structureDemolishedLayer.definitionExpression = null;
                    isfLayer.definitionExpression = null;
                    isfLayer.visible = true;
                } else if (
                    cpValue !== "None" &&
                    landTypeValue == "None" &&
                    sectionValue == "None"
                ) {
                    lotLayer.definitionExpression = packageDefinition;
                    structureLayer.definitionExpression = packageDefinition;
                    structureDemolishedLayer.definitionExpression = packageDefinition;
                    isfLayer.definitionExpression = packageDefinition;
                } else if (
                    cpValue == "None" &&
                    landTypeValue !== "None" &&
                    sectionValue == "None"
                ) {
                    lotLayer.definitionExpression = landTypeDefinition;
                    structureLayer.definitionExpression = landTypeDefinition;
                    structureDemolishedLayer.definitionExpression = landTypeDefinition;
                    isfLayer.definitionExpression =
                        structureLayer.definitionExpression = landTypeDefinition;
                } else if (
                    cpValue == "None" &&
                    landTypeValue == "None" &&
                    sectionValue !== "None"
                ) {
                    lotLayer.definitionExpression = sectionDefinition;
                    structureLayer.definitionExpression = sectionDefinition;
                    structureDemolishedLayer.definitionExpression = sectionDefinition;
                    isfLayer.definitionExpression = sectionDefinition;
                } else if (
                    cpValue !== "None" &&
                    landTypeValue !== "None" &&
                    sectionValue == "None"
                ) {
                    lotLayer.definitionExpression = packageLandTypeDefinition;
                    structureLayer.definitionExpression = packageLandTypeDefinition;
                    structureDemolishedLayer.definitionExpression =
                        packageLandTypeDefinition;
                    isfLayer.definitionExpression = packageLandTypeDefinition;
                } else if (
                    cpValue !== "None" &&
                    landTypeValue == "None" &&
                    sectionValue !== "None"
                ) {
                    lotLayer.definitionExpression = packageSectionDefinition;
                    structureLayer.definitionExpression = packageSectionDefinition;
                    structureDemolishedLayer.definitionExpression =
                        packageSectionDefinition;
                    isfLayer.definitionExpression = packageSectionDefinition;
                } else if (
                    cpValue == "None" &&
                    landTypeValue !== "None" &&
                    sectionValue !== "None"
                ) {
                    lotLayer.definitionExpression = landTypeSectionDefinition;
                    structureLayer.definitionExpression = landTypeSectionDefinition;
                    structureDemolishedLayer.definitionExpression =
                        landTypeSectionDefinition;
                    isfLayer.definitionExpression = landTypeSectionDefinition;
                } else if (
                    cpValue !== "None" &&
                    landTypeValue !== "None" &&
                    sectionValue !== "None"
                ) {
                    lotLayer.definitionExpression = packageLandTypeSectionDefinition;
                    structureLayer.definitionExpression =
                        packageLandTypeSectionDefinition;
                    structureDemolishedLayer.definitionExpression =
                        packageLandTypeSectionDefinition;
                    isfLayer.definitionExpression = packageLandTypeSectionDefinition;
                }
                zoomToLayer(lotLayer);

                return queryForLotGeometries();
            }

            // When CP is changed, Land Type and station is reset to 'None'
            const changeSelected = (e) => {
                const $select = document.querySelector("#stationSelect");
                $select.value = "None";
            };

            // 5. Add EventListener for land type and station dropdown lists
            /// 5.1. Contract Package
            packageSelect.addEventListener("change", function () {
                const cpValue = event.target.value;
                const landTypeValue = landTypeSelect.value;
                const sectionValue = stationSelect.value;

                // Filter data
                setContractPackageExpression(cpValue);
                // Reset drowpdown
                changeSelected();

                // Filter dropdown list
                landTypeFilterList(cpValue);
                sectionFilterList(cpValue, landTypeValue);

                // Update Chart and numbers
                updateChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(totalNumberOfLotsAll);
                updateMoaChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(handedOverNumberLot);
                updateChartStructure(cpValue, landTypeValue, sectionValue);
                totalNumberOfStructures().then(totalNumberOfStructureAll);
                totalNumberOfDemolishedStructure();
                updateMoaChartStructure(cpValue, landTypeValue, sectionValue);
                isfNumber();
                updateChartISF(cpValue, landTypeValue, sectionValue);
                timeSeriesChart(cpValue, landTypeValue, sectionValue);
            });

            /// 5.2. Land Type
            landTypeSelect.addEventListener("change", function () {
                const cpValue = packageSelect.value;
                const landTypeValue = landTypeSelect.value;
                const sectionValue = "None";

                // Filter data
                setContractPackageLandTypeSectionExpression(
                    cpValue,
                    landTypeValue,
                    sectionValue
                );

                // Reset drowpdown
                changeSelected();

                // Filter dropdown list
                //landTypeFilterList(cpValue);
                sectionFilterList(cpValue, landTypeValue);

                // Update Chart and numbers
                updateChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(totalNumberOfLotsAll);
                updateMoaChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(handedOverNumberLot);
                updateChartStructure(cpValue, landTypeValue, sectionValue);
                totalNumberOfStructures().then(totalNumberOfStructureAll);
                totalNumberOfDemolishedStructure();
                updateMoaChartStructure(cpValue, landTypeValue, sectionValue);
                isfNumber();
                updateChartISF(cpValue, landTypeValue, sectionValue);
                timeSeriesChart(cpValue, landTypeValue, sectionValue);
            });

            /// 5.3. Section/ Station
            stationSelect.addEventListener("change", function () {
                const cpValue = packageSelect.value;
                const landTypeValue = landTypeSelect.value;
                const sectionValue = stationSelect.value;

                // Filter data
                setContractPackageLandTypeSectionExpression(
                    cpValue,
                    landTypeValue,
                    sectionValue
                );

                // Update Chart and numbers
                updateChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(totalNumberOfLotsAll);
                updateMoaChartLot(cpValue, landTypeValue, sectionValue);
                totalNumberOfLots().then(handedOverNumberLot);
                updateChartStructure(cpValue, landTypeValue, sectionValue);
                totalNumberOfStructures().then(totalNumberOfStructureAll);
                totalNumberOfDemolishedStructure();
                updateMoaChartStructure(cpValue, landTypeValue, sectionValue);
                isfNumber();
                updateChartISF(cpValue, landTypeValue, sectionValue);
                timeSeriesChart(cpValue, landTypeValue, sectionValue);
            });

            // Charts for Lot and Structure
            const LEGEND_FONT_SIZE = "0.9em";

            // Note that we need 'root' for each chart
            // for the second chart, var root2 = am5.Root.new("xxx");

            //----------------------------------------------------------------------------------//
            /// Time series chart EXPERIMENT
            var root5 = am5.Root.new("timeSeriesChart");
            root5._logo.dispose();

            function timeSeriesChart(cpValue, landTypeValue, sectionValue) {
                root5.container.children.clear();

                var query = lotLayer.createQuery();
                const cpExpression = "Package = '" + cpValue + "'";
                const landtypeExpression = "Type = '" + landTypeValue + "'";
                const sectionExpression = "Station1 = '" + sectionValue + "'";
                const statusExpression = "HandOverDate IS NOT NULL";

                if (
                    cpValue === "None" &&
                    (landTypeValue === "None" || landTypeValue === undefined) &&
                    sectionValue === "None"
                ) {
                    query.where = statusExpression;
                } else if (
                    cpValue === undefined &&
                    landTypeValue === undefined &&
                    sectionValue === undefined
                ) {
                    query.where = statusExpression;
                } else if (
                    cpValue === "None" &&
                    (landTypeValue === "None" || landTypeValue === undefined) &&
                    sectionValue !== "None"
                ) {
                    query.where = sectionExpression + " AND " + statusExpression;
                } else if (
                    cpValue === "None" &&
                    (landTypeValue !== "None" || landTypeValue === undefined) &&
                    sectionValue === "None"
                ) {
                    query.where = landtypeExpression + " AND " + statusExpression;
                } else if (
                    cpValue === "None" &&
                    (landTypeValue !== "None" || landTypeValue === undefined) &&
                    sectionValue !== "None"
                ) {
                    query.where =
                        landtypeExpression +
                        " AND " +
                        sectionExpression +
                        " AND " +
                        statusExpression;
                } else if (
                    cpValue !== "None" &&
                    (landTypeValue === "None" || landTypeValue === undefined) &&
                    sectionValue === "None"
                ) {
                    query.where = cpExpression + " AND " + statusExpression;
                } else if (
                    cpValue !== "None" &&
                    (landTypeValue === "None" || landTypeValue === undefined) &&
                    sectionValue !== "None"
                ) {
                    query.where =
                        cpExpression +
                        " AND " +
                        sectionExpression +
                        " AND " +
                        statusExpression;
                } else if (
                    cpValue !== "None" &&
                    (landTypeValue !== "None" || landTypeValue === undefined) &&
                    sectionValue === "None"
                ) {
                    query.where =
                        cpExpression +
                        " AND " +
                        landtypeExpression +
                        " AND " +
                        statusExpression;
                } else if (
                    cpValue !== "None" &&
                    (landTypeValue !== "None" || landTypeValue === undefined) &&
                    sectionValue !== "None"
                ) {
                    query.where =
                        cpExpression +
                        " AND " +
                        landtypeExpression +
                        " AND " +
                        sectionExpression +
                        " AND " +
                        statusExpression;
                } else {
                    query.where = statusExpression;
                }

                var total_count_handedOVer = {
                    onStatisticField: "HandOverDate",
                    outStatisticFieldName: "total_count_handedOVer",
                    statisticType: "count",
                };

                query.outStatistics = [total_count_handedOVer];
                query.outFields = ["HandOverDate"];
                query.orderByFields = ["HandOverDate"];
                query.groupByFieldsForStatistics = ["HandOverDate"];

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features;
                    ////
                    // collect all dates
                    const data = stats.map((result, index) => {
                        const attributes = result.attributes;
                        const date = attributes.HandOverDate;
                        const count = attributes.total_count_handedOVer;

                        // compile in object array
                        return Object.assign(
                            {},
                            {
                                date,
                                value: count,
                            }
                        );
                    });

                    console.log(data);
                    // set themes
                    root5.setThemes([am5themes_Animated.new(root5)]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root5.container.children.push(
                        am5xy.XYChart.new(root5, {
                            panX: false,
                            panY: false,
                            wheelX: "panX",
                            wheelY: "zoomX",
                        })
                    );

                    // Chart title
                    chart.children.unshift(
                        am5.Label.new(root5, {
                            text: "Monthly Progress of Handed-Over Lots",
                            fontSize: 14,
                            fontWeight: "bold",
                            textAlign: "center",
                            fill: am5.color("#ffffff"),
                            x: am5.percent(50),
                            centerX: am5.percent(50),
                            paddingTop: 0,
                            paddingBottom: 0,
                        })
                    );

                    // Add cursor
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
                    var cursor = chart.set(
                        "cursor",
                        am5xy.XYCursor.new(root5, {
                            behavior: "zoomX",
                        })
                    );
                    cursor.lineY.set("visible", false);

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var xAxis = chart.xAxes.push(
                        am5xy.DateAxis.new(root5, {
                            maxDeviation: 0,
                            groupData: true,
                            baseInterval: {
                                timeUnit: "day",
                                count: 1,
                            },
                            groupIntervals: [{ timeUnit: "month", count: 1 }],
                            renderer: am5xy.AxisRendererX.new(root5, {
                                minGridDistance: 60,
                                strokeOpacity: 1,
                                strokeWidth: 1,
                                stroke: am5.color("#ffffff"),
                            }),
                            //tooltip: am5.Tooltip.new(root5, {})
                        })
                    );

                    // Label properties for yAxis (category axis)
                    xAxis.get("renderer").labels.template.setAll({
                        //oversizedBehavior: "wrap",
                        textAlign: "center",
                        fill: am5.color("#ffffff"),
                        //maxWidth: 150,
                        fontSize: 12,
                    });

                    var yAxis = chart.yAxes.push(
                        am5xy.ValueAxis.new(root5, {
                            calculateTotals: true,
                            min: 0,
                            renderer: am5xy.AxisRendererY.new(root5, {
                                minGridDistance: 60,
                                strokeOpacity: 1,
                                strokeWidth: 1,
                                stroke: am5.color("#ffffff"),
                            }),
                        })
                    );

                    yAxis.get("renderer").labels.template.setAll({
                        //oversizedBehavior: "wrap",
                        textAlign: "center",
                        fill: am5.color("#ffffff"),
                        //maxWidth: 150,
                        fontSize: 12,
                    });

                    // Add yaxix title
                    yAxis.children.unshift(
                        am5.Label.new(root5, {
                            rotation: -90,
                            text: "No. of handed-over lots",
                            y: am5.p50,
                            centerX: am5.p50,
                            fill: am5.color("#ffffff"),
                            fontSize: 11,
                        })
                    );

                    // Add series
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root5, {
                            name: "Series",
                            xAxis: xAxis,
                            yAxis: yAxis,
                            valueYField: "value",
                            valueXField: "date",
                            valueYGrouped: "sum",
                        })
                    );

                    // Add Label bullet
                    series.bullets.push(function () {
                        return am5.Bullet.new(root5, {
                            locationY: 1,
                            locationX: 0.5,
                            sprite: am5.Label.new(root5, {
                                text: "{valueYTotal}",
                                fill: root5.interfaceColors.get("alternativeText"),
                                centerY: 0,
                                centerX: am5.p50,
                                populateText: true,
                                fontSize: 10,
                            }),
                        });
                    });

                    series.columns.template.setAll({ strokeOpacity: 0 });

                    // Add scrollbar
                    /*
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/scrollbars/
                    chart.set("scrollbarX", am5.Scrollbar.new(root5, {
                      orientation: "horizontal",
                      fillOpacity: 0.5
                    }));*/
        
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear(1000);
                    chart.appear(1000, 100);
                });
            }
            timeSeriesChart();

            /// Time series chart EXPERIMENT
            //----------------------------------------------------------------------------------//
            var root = am5.Root.new("pieChartLotDiv");
            root._logo.dispose();
            function updateChartLot(cpValue, landTypeValue, sectionValue) {
                // Root element needs to be empty (as newly created) and can be used to add any other charts to it
                root.container.children.clear();

                // First, define statuses
                function Status_Name_Lot() {
                    return {
                        1: "Paid",
                        2: "For Payment Processing",
                        3: "For Legal Pass",
                        4: "For Appraisal/Offer to Buy",
                        5: "For Expro",
                        6: "with WOP Fully Turned-over",
                        7: "ROWUA/TUA",
                    };
                }

                var totalPaidLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalPaidLot",
                    statisticType: "sum",
                };

                var totalpaypLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalpaypLot",
                    statisticType: "sum",
                };

                var totalLegalpassLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalLegalpassLot",
                    statisticType: "sum",
                };

                var totalOtbLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalOtbLot",
                    statisticType: "sum",
                };

                var totalExproLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalExproLot",
                    statisticType: "sum",
                };

                var totalDismissalLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalDismissalLot",
                    statisticType: "sum",
                };

                var totalRowuaLot = {
                    onStatisticField: "CASE WHEN StatusNVS3 = 7 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalRowuaLot",
                    statisticType: "sum",
                };

                var query = lotLayer.createQuery();
                query.outStatistics = [
                    totalPaidLot,
                    totalpaypLot,
                    totalLegalpassLot,
                    totalOtbLot,
                    totalExproLot,
                    totalDismissalLot,
                    totalRowuaLot,
                ];
                query.returnGeometry = true;

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const PAID = stats.totalPaidLot;
                    const PAYP = stats.totalpaypLot;
                    const LEGALPASS = stats.totalLegalpassLot;
                    const OTB = stats.totalOtbLot;
                    const EXPRO = stats.totalExproLot;
                    const DISMISSAL = stats.totalDismissalLot;
                    const ROWUA = stats.totalRowuaLot;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root.setThemes([
                        am5themes_Animated.new(root),
                        am5themes_Responsive.new(root),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root.container.children.push(
                        am5percent.PieChart.new(root, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(85), // outer radius
                            innerRadius: am5.percent(40),
                        })
                    );

                    // Set data
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                    //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                    // To set slice color, you need to add this before data.setAll
                    /*
                pieSeries.get("colors").set("colors", [
                  am5.color("#70ad47"),
                  am5.color("#0070FF"),
                  am5.color("#FFFF00"),
                  am5.color("#FFAA00"),
                  am5.color("#FF0000"),
                  am5.color("#00734C"),
                ]);
                */

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        templateField: "sliceSettings",
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    //pieSeries.appear(1000, 100)
                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        if (SELECTED == Status_Name_Lot()[1]) {
                            selectedStatus = 1;
                        } else if (SELECTED == Status_Name_Lot()[2]) {
                            selectedStatus = 2;
                        } else if (SELECTED == Status_Name_Lot()[3]) {
                            selectedStatus = 3;
                        } else if (SELECTED == Status_Name_Lot()[4]) {
                            selectedStatus = 4;
                        } else if (SELECTED == Status_Name_Lot()[5]) {
                            selectedStatus = 5;
                        } else if (SELECTED == Status_Name_Lot()[6]) {
                            selectedStatus = 6;
                        } else if (SELECTED == Status_Name_Lot()[7]) {
                            selectedStatus = 7;
                        } else {
                            selectedStatus = null;
                        }

                        //cpValue, landTypeValue, sectionValue
                        var query = lotLayer.createQuery();
                        const cpExpression = "Package = '" + cpValue + "'";
                        const landtypeExpression = "Type = '" + landTypeValue + "'";
                        const sectionExpression = "Station1 = '" + sectionValue + "'";
                        const statusExpression = "StatusNVS3 = " + selectedStatus;

                        if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === undefined &&
                            landTypeValue === undefined &&
                            sectionValue === undefined
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where = sectionExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = landtypeExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = cpExpression + " AND " + statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        }

                        view.when(function () {
                            view.whenLayerView(lotLayer).then(function (layerView) {
                                //chartLayerView = layerView;

                                lotLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    lotLayer.queryExtent(queryExt).then(function (result) {
                                        if (result.extent) {
                                            view.goTo(result.extent);
                                        }
                                    });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures
                                layerView.filter = {
                                    where: "StatusNVS3 = " + selectedStatus,
                                };
                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: Status_Name_Lot()[1],
                            value: PAID,
                            sliceSettings: {
                                fill: am5.color("#70ad47"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[2],
                            value: PAYP,
                            sliceSettings: {
                                fill: am5.color("#0070ff"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[3],
                            value: LEGALPASS,
                            sliceSettings: {
                                fill: am5.color("#ffff00"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[4],
                            value: OTB,
                            sliceSettings: {
                                fill: am5.color("#ffaa00"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[5],
                            value: EXPRO,
                            sliceSettings: {
                                fill: am5.color("#ff0000"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[6],
                            value: DISMISSAL,
                            sliceSettings: {
                                fill: am5.color("#00734c"),
                            },
                        },
                        {
                            category: Status_Name_Lot()[7],
                            value: ROWUA,
                            sliceSettings: {
                                fill: am5.color("#55ff00"),
                            },
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    // To align legend items: valueLabels right, labels to left
                    // 1. fix width of valueLabels
                    // 2. dynamically change width of labels by screen size

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".box");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 180);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 2,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateChartLot()
            updateChartLot();

            // ------------------ PIE CHART FOR STRUCTURE ----------------------//
            var root2 = am5.Root.new("pieChartStructureDiv");
            root2._logo.dispose();

            //https://www.amcharts.com/docs/v5/tutorials/using-custom-theme-to-apply-patterns-to-pie-chart-slices/
            // This user-defined theme allows different line patterns in slices
            class MyTheme extends am5.Theme {
                setupDefaultRules() {
                    var theme = this;

                    const gap = 4;
                    const rotation = 135;
                    const strokeWidth = 1.1;
                    const fillOpacity = 0;
                    const width = 10;
                    const height = 10;

                    this.patterns = [
                        am5.LinePattern.new(this._root, {
                            color: am5.color("#70AD47"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),

                        am5.LinePattern.new(this._root, {
                            color: am5.color("#0070FF"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),

                        am5.LinePattern.new(this._root, {
                            color: am5.color("#FFFF00"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),

                        am5.LinePattern.new(this._root, {
                            color: am5.color("#FFAA00"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),
                        am5.LinePattern.new(this._root, {
                            color: am5.color("#FF0000"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),

                        am5.LinePattern.new(this._root, {
                            color: am5.color("#00734C"),
                            gap: gap,
                            rotation: rotation,
                            strokeWidth: strokeWidth,
                            fillOpacity: fillOpacity,
                            width: width,
                            height: height,
                        }),
                    ];

                    this.currentPattern = 0;
                    this.rule("Slice").setAll({
                        fillOpacity: 1,
                    });

                    this.rule("Slice").setup = function (target) {
                        target.set("fillPattern", theme.patterns[theme.currentPattern]);
                        theme.currentPattern++;
                        if (theme.currentPattern == theme.patterns.length) {
                            theme.currentPattern = 0;
                        }
                    };
                }
            }

            async function updateChartStructure(
                cpValue,
                landTypeValue,
                sectionValue
            ) {
                root2.container.children.clear();

                function Status_Name_Structure() {
                    return {
                        1: "Paid",
                        2: "For Payment Processing",
                        3: "For Legal Pass",
                        4: "For Appraisal/Offer to Buy",
                        5: "For Expro",
                        6: "Quit Claim",
                    };
                }
                var totalPaidStruc = {
                    onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalPaidStruc",
                    statisticType: "sum",
                };

                var totalPaypStruc = {
                    onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalPaypStruc",
                    statisticType: "sum",
                };

                var totalLegalpassStruc = {
                    onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalLegalpassStruc",
                    statisticType: "sum",
                };

                var totalOtbStruc = {
                    onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalOtbStruc",
                    statisticType: "sum",
                };

                var totalExproStruc = {
                    onStatisticField: "CASE WHEN Status = 5 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalExproStruc",
                    statisticType: "sum",
                };

                var totalQuitcStruc = {
                    onStatisticField: "CASE WHEN Status = 6 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalQuitcStruc",
                    statisticType: "sum",
                };

                var query = structureLayer.createQuery();
                query.outStatistics = [
                    totalPaidStruc,
                    totalPaypStruc,
                    totalLegalpassStruc,
                    totalOtbStruc,
                    totalExproStruc,
                    totalQuitcStruc,
                ];
                query.returnGeometry = true;

                structureLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const PAID = stats.totalPaidStruc;
                    const PAYP = stats.totalPaypStruc;
                    const LEGALPASS = stats.totalLegalpassStruc;
                    const OTB = stats.totalOtbStruc;
                    const EXPRO = stats.totalExproStruc;
                    const QUITC = stats.totalQuitcStruc;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root2.setThemes([
                        am5themes_Animated.new(root2),
                        am5themes_Responsive.new(root2),
                        MyTheme.new(root2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root2.container.children.push(
                        am5percent.PieChart.new(root2, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root2.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root2, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(90), // outer radius
                            innerRadius: am5.percent(40),
                        })
                    );

                    /*
                pieSeries.slices.template.set("fillPattern", am5.LinePattern.new(root2, {
                  //fill: am5.color("#ffffffff"), // 100% transparent
                  //color: am5.color("#0070FF"),//target.dataItem.dataContext.color,
                  width: 100,
                  height: 200,
                  gap: 6,
                  rotation: 135,
                  strokeWidth: 1.5,
                  //repetition: "repeat-y",
                  //checkered: true,
                  //stroke: target.dataItem.dataContext.color,
                }));*/
        

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        //fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;

                        if (SELECTED == Status_Name_Structure()[1]) {
                            selectedStatus = 1;
                        } else if (SELECTED == Status_Name_Structure()[2]) {
                            selectedStatus = 2;
                        } else if (SELECTED == Status_Name_Structure()[3]) {
                            selectedStatus = 3;
                        } else if (SELECTED == Status_Name_Structure()[4]) {
                            selectedStatus = 4;
                        } else if (SELECTED == Status_Name_Structure()[5]) {
                            selectedStatus = 5;
                        } else if (SELECTED == Status_Name_Structure()[6]) {
                            selectedStatus = 6;
                        } else {
                            selectedStatus = null;
                        }

                        var query = structureLayer.createQuery();
                        const cpExpression = "Package = '" + cpValue + "'";
                        const landtypeExpression = "Type = '" + landTypeValue + "'";
                        const sectionExpression = "Station1 = '" + sectionValue + "'";
                        const statusExpression = "Status = " + selectedStatus;

                        console.log(
                            cpValue + "; " + landTypeValue + "; " + selectedStatus
                        );

                        if (
                            cpValue === "None" &&
                            (landTypeValue === "None" || landTypeValue === undefined) &&
                            sectionValue === "None"
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === undefined &&
                            landTypeValue === undefined &&
                            sectionValue === undefined
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === "None" &&
                            (landTypeValue === "None" || landTypeValue === undefined) &&
                            sectionValue !== "None"
                        ) {
                            query.where = sectionExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            (landTypeValue !== "None" || landTypeValue === undefined) &&
                            sectionValue === "None"
                        ) {
                            query.where = landtypeExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            (landTypeValue !== "None" || landTypeValue === undefined) &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            (landTypeValue === "None" || landTypeValue === undefined) &&
                            sectionValue === "None"
                        ) {
                            query.where = cpExpression + " AND " + statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            (landTypeValue === "None" || landTypeValue === undefined) &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            (landTypeValue !== "None" || landTypeValue === undefined) &&
                            sectionValue === "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            (landTypeValue !== "None" || landTypeValue === undefined) &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else {
                            query.where = statusExpression;
                        }

                        // Zoom, filter, and highlight selected chart categories
                        view.when(function () {
                            view.whenLayerView(structureLayer).then(function (layerView) {
                                chartLayerView = layerView;

                                structureLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    structureLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures

                                layerView.filter = {
                                    where: "Status = " + selectedStatus,
                                };
                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: Status_Name_Structure()[1],
                            value: PAID,
                        },
                        {
                            category: Status_Name_Structure()[2],
                            value: PAYP,
                        },
                        {
                            category: Status_Name_Structure()[3],
                            value: LEGALPASS,
                        },
                        {
                            category: Status_Name_Structure()[4],
                            value: OTB,
                        },
                        {
                            category: Status_Name_Structure()[5],
                            value: EXPRO,
                        },
                        {
                            category: Status_Name_Structure()[6],
                            value: QUITC,
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root2, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root2.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".boxStructure");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 180);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 1.1,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeature
            } // End of updateChartStructure()
            updateChartStructure();

            // ----------------- BAR CHART FOR MOA LOT ----------------- //
            var root3 = am5.Root.new("chartMoaLotDiv");
            root3._logo.dispose();
            var myTheme = am5.Theme.new(root3);

            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function updateMoaChartLot(cpValue, landTypeValue, sectionValue) {
                root3.container.children.clear();

                var totalNVSLot = {
                    onStatisticField: "CASE WHEN S_MOA = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalNVSLot",
                    statisticType: "sum",
                };

                var totalExproLot = {
                    onStatisticField: "CASE WHEN S_MOA = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalExproLot",
                    statisticType: "sum",
                };

                var totalRowuaLot = {
                    onStatisticField: "CASE WHEN S_MOA = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "totalRowuaLot",
                    statisticType: "sum",
                };

                var query = lotLayer.createQuery();
                query.outStatistics = [totalNVSLot, totalExproLot, totalRowuaLot];
                query.returnGeometry = true;

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const NVS = stats.totalNVSLot;
                    const EXPRO = stats.totalExproLot;
                    const ROWUA = stats.totalRowuaLot;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root3.setThemes([am5themes_Animated.new(root3), myTheme]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root3.container.children.push(
                        am5xy.XYChart.new(root3, {
                            panX: false,
                            panY: false,
                            wheelX: "none",
                            wheelY: "none",
                            paddingLeft: 10,
                            paddingRight: 30,
                        })
                    );

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root3, {
                        minGridDistance: 5,
                        strokeOpacity: 1,
                        strokeWidth: 1,
                        inversed: true,
                        stroke: am5.color("#ffffff"),
                    });
                    yRenderer.grid.template.set("location", 1);

                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root3, {
                            maxDeviation: 0,
                            categoryField: "country",
                            renderer: yRenderer,
                        })
                    );

                    // Remove grid lines
                    yAxis.get("renderer").grid.template.set("forceHidden", true);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root3, {
                            maxDeviation: 0,
                            min: 0,
                            renderer: am5xy.AxisRendererX.new(root3, {
                                visible: true,
                                strokeOpacity: 1,
                                strictMinMax: true,
                                calculateTotals: true,
                                strokeWidth: 1,
                                stroke: am5.color("#ffffff"),
                            }),
                        })
                    );
                    // Remove grid lines
                    xAxis.get("renderer").grid.template.set("forceHidden", true);

                    // Label properties for yAxis (category axis)
                    yAxis.get("renderer").labels.template.setAll({
                        //oversizedBehavior: "wrap",
                        textAlign: "center",
                        fill: am5.color("#ffffff"),
                        //maxWidth: 150,
                        fontSize: 12,
                    });

                    xAxis.get("renderer").labels.template.setAll({
                        fill: am5.color("#ffffff"),
                    });

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root3, {
                            name: "Series 1",
                            xAxis: xAxis,
                            yAxis: yAxis,
                            valueXField: "value",
                            sequencedInterpolation: true,
                            categoryYField: "country",
                        })
                    );

                    var columnTemplate = series.columns.template;

                    columnTemplate.setAll({
                        draggable: true,
                        cursorOverStyle: "pointer",
                        tooltipText: "{value}",
                        cornerRadiusBR: 10,
                        cornerRadiusTR: 10,
                        strokeOpacity: 0,
                    });

                    // Add Label bullet
                    series.bullets.push(function () {
                        return am5.Bullet.new(root3, {
                            locationY: 1,
                            sprite: am5.Label.new(root3, {
                                text: "{value}",
                                fill: root3.interfaceColors.get("alternativeText"),
                                centerY: -3,
                                centerX: am5.p50,
                                fontSize: 14,
                                populateText: true,
                            }),
                        });
                    });

                    // Use different color by column
                    columnTemplate.adapters.add("fill", (fill, target) => {
                        return chart
                            .get("colors")
                            .getIndex(series.columns.indexOf(target));
                    });

                    columnTemplate.adapters.add("stroke", (stroke, target) => {
                        return chart
                            .get("colors")
                            .getIndex(series.columns.indexOf(target));
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.country;
                        console.log(SELECTED);

                        if (SELECTED == "1-NVS") {
                            selectedStatus = 1;
                        } else if (SELECTED == "2-Expropriation") {
                            selectedStatus = 2;
                        } else if (SELECTED == "3-ROWUA") {
                            selectedStatus = 3;
                        }

                        var query = lotLayer.createQuery();
                        const cpExpression = "Package = '" + cpValue + "'";
                        const landtypeExpression = "Type = '" + landTypeValue + "'";
                        const sectionExpression = "Station1 = '" + sectionValue + "'";
                        const statusExpression = "S_MOA = " + selectedStatus;

                        if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === undefined &&
                            landTypeValue === undefined &&
                            sectionValue === undefined
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where = sectionExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = landtypeExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = cpExpression + " AND " + statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        }

                        view.whenLayerView(lotLayer).then(function (layerView) {
                            //CHART_ELEMENT.style.visibility = "visible";

                            lotLayer.queryFeatures(query).then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID,
                                });

                                lotLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent);
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            });
                            layerView.filter = {
                                where: "S_MOA = " + selectedStatus,
                                //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                            };
                        }); // End of whenLayerView
                    });

                    // Chart title
                    chart.children.unshift(
                        am5.Label.new(root2, {
                            text: "   MODE OF ACQUISITION",
                            fontSize: 16,
                            fontWeight: "normal",
                            //textAlign: "right",
                            fill: am5.color("#f7f5f7"),
                            paddingTop: -15,
                            paddingBottom: 5,
                        })
                    );

                    // Set data
                    var data = [
                        {
                            country: "1-NVS",
                            value: NVS,
                        },
                        {
                            country: "2-Expropriation",
                            value: EXPRO,
                        },
                        {
                            country: "3-ROWUA",
                            value: ROWUA,
                        },
                    ];

                    yAxis.data.setAll(data);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear(1000);
                    chart.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateMOAChartLot

            updateMoaChartLot();

            // ----------------- BAR CHART FOR MOA STRUCTURE ----------------- //
            var root6 = am5.Root.new("chartMoaStructureDiv");
            root6._logo.dispose();
            var myTheme = am5.Theme.new(root6);

            myTheme.rule("Grid", ["base"]).setAll({
                strokeOpacity: 0,
            });

            function updateMoaChartStructure(cpValue, landTypeValue, sectionValue) {
                root6.container.children.clear();

                var total_NVS_structure = {
                    onStatisticField: "CASE WHEN S_MOA = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_NVS_structure",
                    statisticType: "sum",
                };

                var total_Expro_structure = {
                    onStatisticField: "CASE WHEN S_MOA = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_Expro_structure",
                    statisticType: "sum",
                };

                var total_rowua_structure = {
                    onStatisticField: "CASE WHEN S_MOA = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_rowua_structure",
                    statisticType: "sum",
                };

                var query = lotLayer.createQuery();
                query.outStatistics = [
                    total_NVS_structure,
                    total_Expro_structure,
                    total_rowua_structure,
                ];
                query.returnGeometry = true;

                lotLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const NVS = stats.total_NVS_structure;
                    const EXPRO = stats.total_Expro_structure;
                    const ROWUA = stats.total_rowua_structure;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root6.setThemes([am5themes_Animated.new(root6), myTheme]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/
                    var chart = root6.container.children.push(
                        am5xy.XYChart.new(root6, {
                            panX: false,
                            panY: false,
                            wheelX: "none",
                            wheelY: "none",
                            paddingLeft: 0,
                            paddingLeft: 10,
                            paddingRight: 40,
                        })
                    );

                    // Chart title
                    chart.children.unshift(
                        am5.Label.new(root2, {
                            text: "   MODE OF ACQUISITION",
                            fontSize: 16,
                            fontWeight: "normal",
                            //textAlign: "right",
                            fill: am5.color("#f7f5f7"),
                            paddingTop: -15,
                            paddingBottom: 10,
                        })
                    );

                    // Create axes
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                    var yRenderer = am5xy.AxisRendererY.new(root6, {
                        minGridDistance: 5,
                        strokeOpacity: 1,
                        strokeWidth: 1,
                        inversed: true,
                        stroke: am5.color("#ffffff"),
                    });
                    yRenderer.grid.template.set("location", 1);

                    var yAxis = chart.yAxes.push(
                        am5xy.CategoryAxis.new(root6, {
                            maxDeviation: 0,
                            categoryField: "country",
                            renderer: yRenderer,
                        })
                    );

                    // Remove grid lines
                    yAxis.get("renderer").grid.template.set("forceHidden", true);

                    var xAxis = chart.xAxes.push(
                        am5xy.ValueAxis.new(root6, {
                            maxDeviation: 0,
                            min: 0,
                            renderer: am5xy.AxisRendererX.new(root6, {
                                visible: true,
                                strokeOpacity: 1,
                                strictMinMax: true,
                                calculateTotals: true,
                                strokeWidth: 1,
                                stroke: am5.color("#ffffff"),
                            }),
                        })
                    );
                    // Remove grid lines
                    xAxis.get("renderer").grid.template.set("forceHidden", true);

                    // Label properties for yAxis (category axis)
                    yAxis.get("renderer").labels.template.setAll({
                        //oversizedBehavior: "wrap",
                        textAlign: "center",
                        fill: am5.color("#ffffff"),
                        //maxWidth: 150,
                        fontSize: 12,
                    });

                    xAxis.get("renderer").labels.template.setAll({
                        fill: am5.color("#ffffff"),
                    });

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
                    var series = chart.series.push(
                        am5xy.ColumnSeries.new(root6, {
                            name: "Series 1",
                            xAxis: xAxis,
                            yAxis: yAxis,
                            valueXField: "value",
                            sequencedInterpolation: true,
                            categoryYField: "country",
                        })
                    );

                    var columnTemplate = series.columns.template;

                    columnTemplate.setAll({
                        draggable: true,
                        cursorOverStyle: "pointer",
                        tooltipText: "{value}",
                        cornerRadiusBR: 10,
                        cornerRadiusTR: 10,
                        strokeOpacity: 0,
                    });

                    // Add Label bullet
                    series.bullets.push(function () {
                        return am5.Bullet.new(root6, {
                            locationY: 1,
                            sprite: am5.Label.new(root6, {
                                text: "{value}",
                                fill: root6.interfaceColors.get("alternativeText"),
                                centerY: -3,
                                centerX: am5.p50,
                                fontSize: 14,
                                populateText: true,
                            }),
                        });
                    });

                    // Use different color by column
                    columnTemplate.adapters.add("fill", (fill, target) => {
                        return chart
                            .get("colors")
                            .getIndex(series.columns.indexOf(target));
                    });

                    columnTemplate.adapters.add("stroke", (stroke, target) => {
                        return chart
                            .get("colors")
                            .getIndex(series.columns.indexOf(target));
                    });

                    series.columns.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.country;
                        console.log(SELECTED);

                        if (SELECTED == "1-NVS") {
                            selectedStatus = 1;
                        } else if (SELECTED == "2-Expropriation") {
                            selectedStatus = 2;
                        } else if (SELECTED == "3-ROWUA") {
                            selectedStatus = 3;
                        }

                        view.whenLayerView(lotLayer).then(function (layerView) {
                            //CHART_ELEMENT.style.visibility = "visible";

                            lotLayer.queryFeatures().then(function (results) {
                                const RESULT_LENGTH = results.features;
                                const ROW_N = RESULT_LENGTH.length;

                                let objID = [];
                                for (var i = 0; i < ROW_N; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID,
                                });

                                lotLayer.queryExtent(queryExt).then(function (result) {
                                    if (result.extent) {
                                        view.goTo(result.extent);
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function () {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            });
                            layerView.filter = {
                                where: "MOA = " + selectedStatus,
                                //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                            };
                        }); // End of whenLayerVie
                    });

                    // Set data
                    var data = [
                        {
                            country: "1-NVS",
                            value: NVS,
                        },
                        {
                            country: "2-Expropriation",
                            value: EXPRO,
                        },
                        {
                            country: "3-ROWUA",
                            value: ROWUA,
                        },
                    ];

                    yAxis.data.setAll(data);
                    series.data.setAll(data);

                    // Make stuff animate on load
                    // https://www.amcharts.com/docs/v5/concepts/animations/
                    series.appear(1000);
                    chart.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateMOAChartLot
            updateMoaChartStructure();

            var root7 = am5.Root.new("isfPieChartDiv");
            root7._logo.dispose();
            const statusISF = ["UNRELOCATED", "RELOCATED"];

            async function updateChartISF(cpValue, landTypeValue, sectionValue) {
                root7.container.children.clear();
                var total_unrelocated_lot = {
                    onStatisticField:
                        "CASE WHEN RELOCATION <> 'RELOCATED' THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_unrelocated_lot",
                    statisticType: "sum",
                };

                var total_relocated_lot = {
                    onStatisticField:
                        "CASE WHEN RELOCATION = 'RELOCATED' THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_relocated_lot",
                    statisticType: "sum",
                };

                var query = isfLayer.createQuery();
                query.outStatistics = [total_unrelocated_lot, total_relocated_lot];
                query.returnGeometry = true;

                return isfLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const noclear = stats.total_unrelocated_lot;
                    const clear = stats.total_relocated_lot;

                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root7.setThemes([
                        am5themes_Animated.new(root7),
                        am5themes_Responsive.new(root7),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root7.container.children.push(
                        am5percent.PieChart.new(root7, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root7.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root7, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(85), // outer radius
                            innerRadius: am5.percent(40),
                        })
                    );
                    /*
        
                var label = pieSeries.children.push(am5.Label.new(root, {
                  text: clear,
                  fontSize: 40,
                  centerX: am5.percent(50),
                  centerY: am5.percent(50),
                  populateText: true,
                  fill: am5.color("#ffffff")
                }));*/
        
                    // Set data
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                    //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                    // To set slice color, you need to add this before data.setAll
                    /*
                pieSeries.get("colors").set("colors", [
                  am5.color("#70ad47"),
                  am5.color("#0070FF"),
                  am5.color("#FFFF00"),
                  am5.color("#FFAA00"),
                  am5.color("#FF0000"),
                  am5.color("#00734C"),
                ]);
                */

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        templateField: "sliceSettings",
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    //pieSeries.appear(1000, 100)
                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;

                        var query = isfLayer.createQuery();
                        const cpExpression = "Package = '" + cpValue + "'";
                        const landtypeExpression = "Type = '" + landTypeValue + "'";
                        const sectionExpression = "Station1 = '" + sectionValue + "'";
                        const statusExpression = "RELOCATION = '" + SELECTED + "'";

                        console.log(cpValue + "; " + landTypeValue + "; " + sectionValue);
                        if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === undefined &&
                            landTypeValue === undefined &&
                            sectionValue === undefined
                        ) {
                            query.where = statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where = sectionExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = landtypeExpression + " AND " + statusExpression;
                        } else if (
                            cpValue === "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue === "None"
                        ) {
                            query.where = cpExpression + " AND " + statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue === "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue === "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                statusExpression;
                        } else if (
                            cpValue !== "None" &&
                            landTypeValue !== "None" &&
                            sectionValue !== "None"
                        ) {
                            query.where =
                                cpExpression +
                                " AND " +
                                landtypeExpression +
                                " AND " +
                                sectionExpression +
                                " AND " +
                                statusExpression;
                        }

                        view.when(function () {
                            view.whenLayerView(isfLayer).then(function (layerView) {
                                //chartLayerView = layerView;

                                isfLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    isfLayer.queryExtent(queryExt).then(function (result) {
                                        if (result.extent) {
                                            view.goTo(result.extent);
                                        }
                                    });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures
                                layerView.filter = {
                                    where: "RELOCATION = '" + SELECTED + "'",
                                };
                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: statusISF[0],
                            value: noclear,
                            sliceSettings: {
                                fill: am5.color("#00C5FF"),
                            },
                        },
                        {
                            category: statusISF[1],
                            value: clear,
                            sliceSettings: {
                                fill: am5.color("#70AD47"),
                            },
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root7, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root7.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    // To align legend items: valueLabels right, labels to left
                    // 1. fix width of valueLabels
                    // 2. dynamically change width of labels by screen size

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".box2");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 180);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 2,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeature
            } // End of updateChartISF()
            updateChartISF();

            ///////////////////////////////////////////////////////////////////////////////////
            // Handed-Over Button to show lots that were handed over at stations and at Subterranean
            const viewHandedOverLot = document.getElementById("viewHandedOverLot");
            const stationon = document.getElementById("stationLot-on");
            const subteon = document.getElementById("subteLot-on");

            viewHandedOverLot.addEventListener("click", function (event) {
                //const handedOver_switch = event.target.ariaLabel;
                const stationon_switch = stationon.checked; // true or false
                const subteon_switch = subteon.checked;

                if (stationon_switch === true && subteon_switch === false) {
                    handedOverLotLayer.visible = true;
                    handedOverLotBackgroundLayer.visible = true;
                    lotLayer.visible = false;

                    pteLotSubteLayer.visible = false;
                    pteLotSubteBackgroundLayer.visible = false;
                } else if (stationon_switch === false && subteon_switch === true) {
                    handedOverLotLayer.visible = false;
                    handedOverLotBackgroundLayer.visible = false;
                    lotLayer.visible = false;

                    pteLotSubteLayer.visible = true;
                    pteLotSubteBackgroundLayer.visible = true;
                } else if (stationon_switch === false && subteon_switch === false) {
                    handedOverLotLayer.visible = false;
                    handedOverLotBackgroundLayer.visible = false;
                    lotLayer.visible = true;

                    pteLotSubteLayer.visible = false;
                    pteLotSubteBackgroundLayer.visible = false;
                } else if (stationon_switch === true && subteon_switch === true) {
                    handedOverLotLayer.visible = true;
                    handedOverLotBackgroundLayer.visible = true;
                    lotLayer.visible = false;

                    pteLotSubteLayer.visible = true;
                    pteLotSubteBackgroundLayer.visible = true;
                }
            });

            // view.when
            view.when(() => {
                document.querySelector("#header-title").textContent =
                    "MMSP LAND ACQUISITION";
                document.querySelector("#item-description").innerHTML = `
                                                                 1. You can <b>filter the data</b> by CP, land type (station or subterranean), and section using dropdown lits.<br>
                                                                 2. View charts for summary statistics and progress on acquisition of land/structure.<br>
                                                                 3. <b>Click pie chart</b> to view the respective lots/structures on the map.<br>
                                                                 4. <b>Lots under expropriation</b> is available in the 'Expro List' tab.<br>
                                                                 5. <b>Lots with Remarks</b> are available in the 'Remarks' tab.<br>
                                                                 6. <b>Click/unclick widgets</b> icon for viewing Layer list:<br>
                                                                 &ensp;* legend,<br>
                                                                 &ensp;* basemaps,<br>
                                                                 &ensp;* Progress Chart,<br>
                                                                 &ensp;* Handed-Over Lots,<br>
                                                                 &ensp;* Information<br>
                                                                 7. <b>NVS</b> stands for <b>'Negotiated Voluntary Sale'.</b><br>
                                                                 8. <b>ROWUA</b> stands for <b>'Right-of-Way Usage Agreement'.</b><br>
                                                                 `;
                const timeSeriesChartDiv = document.getElementById("timeSeriesChart");
                let activeWidget;

                const handleActionBarClick = ({ target }) => {
                    if (target.tagName !== "CALCITE-ACTION") {
                        return;
                    }

                    if (activeWidget) {
                        document.querySelector(
                            `[data-action-id=${activeWidget}]`
                        ).active = false;
                        document.querySelector(
                            `[data-panel-id=${activeWidget}]`
                        ).hidden = true;

                        // Close the progress time series chart when chart widget is closed
                        if (`${activeWidget}` === "charts") {
                            timeSeriesChartDiv.style.display = "none";
                        }
                    }

                    const nextWidget = target.dataset.actionId;
                    if (nextWidget !== activeWidget) {
                        document.querySelector(
                            `[data-action-id=${nextWidget}]`
                        ).active = true;
                        document.querySelector(
                            `[data-panel-id=${nextWidget}]`
                        ).hidden = false;
                        activeWidget = nextWidget;

                        // Open the time series chart when chart widget is opened.
                        if (`${activeWidget}` === "charts") {
                            timeSeriesChartDiv.style.display = "block";
                        }
                    } else {
                        activeWidget = null;
                    }
                };

                // Action bar
                document
                    .querySelector("calcite-action-bar")
                    .addEventListener("click", handleActionBarClick);
                let actionBarExpanded = false;
                document.addEventListener("calciteActionBarToggle", (event) => {
                    actionBarExpanded = !actionBarExpanded;
                    view.padding = {
                        left: actionBarExpanded ? 135 : 45,
                    };
                });

                // Switch theme
                document.querySelector("calcite-shell").hidden = false;
                document.querySelector("calcite-loader").hidden = true;

                /*
              // When 'Structure' tab is clicked, it becomes visible.
              document.querySelector('#thetabs').addEventListener("click", tabChange);
              function tabChange(event) {
                const value = event.target.className;
      
                if (value === 'Structure') {
                  structureLayer.visible = true;
                }
              }*/
      
            }); // end of view.when
        });

        // Widgets
        const basemaps = new BasemapGallery({
            view,
            container: "basemaps-container",
        });

        // Legend
        var legend_land = new Legend({
            view,
            container: "land-legend",
            layerInfos: [
                {
                    layer: lotLayer,
                    title: "",
                },
            ],
        });

        var legend_structure = new Legend({
            view,
            container: "structure-legend",
            layerInfos: [
                {
                    layer: structureLayer,
                    title: "",
                },
            ],
        });

        var legend_demolished_structure = new Legend({
            view,
            container: "demolished-structure-legend",
            layerInfos: [
                {
                    layer: structureDemolishedLayer,
                    title: "",
                },
            ],
        });

        var legend_depotBuilding = new Legend({
            view,
            container: "depotbuilding-legend",
            layerInfos: [
                {
                    layer: depotBuildingLayer,
                    title: "",
                },
            ],
        });

        var legend_bssDepotBuilding = new Legend({
            view,
            container: "bssdepotbuilding-legend",
            layerInfos: [
                {
                    layer: bssDepotBuildingLayer,
                    title: "",
                },
            ],
        });

        var legend_evs = new Legend({
            view,
            container: "evs-legend",
            layerInfos: [
                {
                    layer: evsLayer,
                    title: "",
                },
            ],
        });

        var legend_senateBoundary = new Legend({
            view,
            container: "senateboundary-legend",
            layerInfos: [
                {
                    layer: senateBoundaryLayer,
                    title: "",
                },
            ],
        });

        var legend_poSectionBox = new Legend({
            view,
            container: "posectionbox-legend",
            layerInfos: [
                {
                    layer: poSectionBoxLayer,
                    title: "",
                },
            ],
        });

        // Default setting
        lotLayer.visible = true;
        structureLayer.visible = false;
        structureDemolishedLayer.visible = false;
        isfLayer.visible = false;
        depotBuildingLayer.visible = false;
        bssDepotBuildingLayer.visible = true;
        evsLayer.visible = false;
        senateBoundaryLayer.visible = false;
        poSectionBoxLayer.visible = true;

        // Hide and Unhide of Legend + layerList + lotLayer
        // 1. Checkbox
        const landCheckbox = document.getElementById("land-check");
        const structureCheckbox = document.getElementById("structure-check");
        const DemolishedStructureCheckbox = document.getElementById(
            "demolished-structure-check"
        );
        const isfCheckbox = document.getElementById("isf-check");
        const depotBuildingCheckbox = document.getElementById(
            "depotBuilding-check"
        );
        const bssDepotBuildingCheckbox = document.getElementById(
            "bssDepotBuilding-check"
        );
        const evsCheckbox = document.getElementById("evs-check");
        const senateBoundaryCheckbox = document.getElementById(
            "senateBoundary-check"
        );
        const poSectionBoxCheckbox =
            document.getElementById("poSectionBox-check");

        // 2. Legend
        const landLegend = document.getElementById("land-legend");
        const structureLegend = document.getElementById("structure-legend");
        const DemolishedStructureLegend = document.getElementById(
            "demolished-structure-legend"
        );
        const isfLegend = document.getElementById("isf-legend");
        const depotBuildingLegend = document.getElementById(
            "depotbuilding-legend"
        );
        const bssDepotBuildingLegend = document.getElementById(
            "bssdepotbuilding-legend"
        );
        const evsLegend = document.getElementById("evs-legend");
        const senateboundaryLegend = document.getElementById(
            "senateboundary-legend"
        );
        const posectionboxLegend = document.getElementById("posectionbox-legend");

        // Lot Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                landLegend.hidden = !landLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    lotLayer.visible = true;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    lotLayer.visible = false;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            landCheckbox.addEventListener("click", checkBoxClick);
        });

        // Structure Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                structureLegend.hidden = !structureLegend.hidden;

                // Visible/unvisible structure layer
                if (activeWidget) {
                    structureLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    structureLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            structureCheckbox.addEventListener("click", checkBoxClick);
        });

        // Demolished Structure Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                DemolishedStructureLegend.hidden = !DemolishedStructureLegend.hidden;

                // Visible/unvisible structure layer
                if (activeWidget) {
                    structureDemolishedLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    structureDemolishedLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            DemolishedStructureCheckbox.addEventListener("click", checkBoxClick);
        });

        // ISF Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                isfLegend.hidden = !isfLegend.hidden;

                // Visible/unvisible structure layer
                if (activeWidget) {
                    isfLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    isfLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            isfCheckbox.addEventListener("click", checkBoxClick);
        });

        // Depot Building
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                depotBuildingLegend.hidden = !depotBuildingLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    depotBuildingLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    depotBuildingLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            depotBuildingCheckbox.addEventListener("click", checkBoxClick);
        });

        // BSS Depot Building Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                bssDepotBuildingLegend.hidden = !bssDepotBuildingLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    bssDepotBuildingLayer.visible = true;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    bssDepotBuildingLayer.visible = false;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            bssDepotBuildingCheckbox.addEventListener("click", checkBoxClick);
        });

        // EVS
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                evsLegend.hidden = !evsLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    evsLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    evsLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            evsCheckbox.addEventListener("click", checkBoxClick);
        });

        // Senate Boundary
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                senateboundaryLegend.hidden = !senateboundaryLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    senateBoundaryLayer.visible = false;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    senateBoundaryLayer.visible = true;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            senateBoundaryCheckbox.addEventListener("click", checkBoxClick);
        });

        // PO Sectin Box Layer
        view.when(() => {
            let activeWidget;
            const checkBoxClick = ({ target }) => {
                // Hide/Unhide legend
                posectionboxLegend.hidden = !posectionboxLegend.hidden;

                // Visible/Unvisible Lot Layer
                if (activeWidget) {
                    poSectionBoxLayer.visible = true;
                }

                const nextWidget = target.id;
                if (nextWidget !== activeWidget) {
                    poSectionBoxLayer.visible = false;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };
            poSectionBoxCheckbox.addEventListener("click", checkBoxClick);
        });

        var searchWidget = new Search({
            view: view,
            locationEnabled: false,
            allPlaceholder: "LotID, StructureID",
            includeDefaultSources: false,
            sources: [
                {
                    layer: lotLayer,
                    searchFields: ["ID"],
                    displayField: "ID",
                    exactMatch: false,
                    outFields: ["ID"],
                    name: "Lot No",
                    placeholder: "example: DP89",
                },
                {
                    layer: structureLayer,
                    searchFields: ["Id_1"],
                    displayField: "Id",
                    exactMatch: false,
                    outFields: ["Id_1"],
                    name: "Structure ID",
                    placeholder: "example: QH-MMSP-02-01-S045C",
                },
            ],
        });

        view.ui.empty("top-left");

        // Create Expand widge for Search widget
        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",
            group: "top-right",
        });

        view.ui.add(searchExpand, {
            position: "top-right",
        });

        searchExpand.watch("expanded", function () {
            if (!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });
    });
</script>

</html>