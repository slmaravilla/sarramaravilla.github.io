<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
    <title>Progress Summary (SC)</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.26/esri/themes/dark/main.css"
    />

    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css"
    />

    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://js.arcgis.com/4.28/"></script>
  </head>
  <body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <div id="applicationDiv">
        <div id="headerTitleDiv">Pre-Construction Work Progress (SC)</div>
        <div class="contentBox">
          <div class="container">
            <div class="landStrucIsfBox">
              <div id="landChartDiv"></div>
              <div id="landChartCountDiv"></div>
              <div id="structureChartDiv"></div>
            </div>
            <div class="treeBox">
              <div id="isfChartDiv"></div>
              <div id="treeCuttingChartDiv"></div>
              <div id="treeCompenChartDiv"></div>
              <!-- <div id="treeEmptyChartDiv"></div> -->
            </div>
            <div class="utilityBox">
              <div id="utilityPointChartDiv"></div>
              <div id="utilityLineChartDiv"></div>
              <div id="utilityEmptyChartDiv"></div>
            </div>
          </div>
        </div>
        <div id="legendChartDiv"></div>
        <div class="dateDiv">February 29, 2024</div>
        <div id="informationDiv"></div>
      </div>
    </calcite-shell>
  </body>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }

    #applicationDiv {
      display: flex;
      flex-wrap: wrap;
      height: 99%;
      margin: 0 auto;
      box-sizing: border-box;
      background-color: #03283f;
    }

    #informationDiv {
      position: absolute;
      z-index: 99;
      width: 30vw;
      height: 10vh;
      color: white;
      bottom: 190;
      right: 5;
      font-size: 1rem;
    }

    #informationDiv b {
      font-size: 1rem;
      color: orange;
      margin: 0;
      padding: 0;
    }

    calcite-shell {
      background-color: #03283f;
    }

    calcite-action-bar {
      position: absolute;
      z-index: 99;
      top: 0;
      right: 0;
      margin: 1rem;
    }

    calcite-panel {
      position: absolute;
      z-index: 1;
      bottom: 10px;
      right: 300px;
      width: 30vw;
      height: 50%;
    }
    calcite-loader {
      align-self: center;
      justify-self: center;
    }

    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    #info-content {
      padding: 0.75rem;
    }

    .contentBox {
      display: grid;
      grid-template-columns: 80vw 17.8vw;
      width: 100%;
      height: 88vh;
    }

    .container {
      display: grid;
      flex-wrap: wrap;
      height: 88vh;
      box-sizing: border-box;
      border-right: 0;
    }

    .containerB {
      font-size: 1.5vw;
      color: white;
      padding-top: 40%;
    }

    #headerTitleDiv {
      color: white;
      font-weight: bold;
      font-size: 1.7vw;
      margin: 0.5rem;
    }

    .dateDiv {
      z-index: 99;
      position: absolute;
      padding-bottom: 10;
      font-size: 1vw;
      color: rgb(0, 197, 255);
      right: 10;
      bottom: 10;
    }

    .landStrucIsfBox,
    .treeBox {
      display: inline-flex;
      height: 29.5vh;
      width: 100%;
      box-sizing: border-box;
      border-top: 0;
      border-bottom: 0;
      margin: 0;
      padding: 0;
    }

    .utilityBox {
      display: inline-flex;
      height: 29.5vh;
      width: 100%;
      box-sizing: border-box;
      border-top: 0;
      border-bottom: 0;
      margin: 0;
      padding: 0;
    }

    #legendChartDiv {
      position: absolute;
      z-index: 99;
      right: 80;
      margin: 0;
      padding: 0;
      top: 0;
      background-color: rgba(0, 0, 0, 0);
      height: 55vh;
      width: 10vw;
    }

    #landChartDiv,
    #landChartCountDiv,
    #structureChartDiv,
    #isfChartDiv,
    #treeCuttingChartDiv,
    #treeCompenChartDiv,
    #utilityPointChartDiv,
    #utilityLineChartDiv,
    #treeEmptyChartDiv,
    #utilityEmptyChartDiv {
      width: 35%;
      height: 32vh;
      align-items: center;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      margin: 0;
      padding: 0;
    }

    a {
      font-size: 1.2rem;
      color: white;
      font-weight: bold;
    }

    a:hover,
    a:focus {
      color: rgb(185, 171, 171);
      font-size: 1.2vw;
    }

    ul {
      list-style: none;
      padding-left: 10;
      line-height: 3rem;
    }
    â€‹ p {
      font-size: 1rem;
      width: auto;
      vertical-align: text-bottom;
      padding: 0;
      margin-top: 0;
    }

    h2 {
      font-weight: 400;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      font-style: normal;
      font-size: 23px;
      color: white;
      padding: 3px;
      margin: 0px;
      width: 470px;
      vertical-align: text-top;
    }

    h3 {
      color: white;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 10;
      width: 100%;
    }

    h4 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: left;
      font-weight: normal;
      font-size: 16px;
      padding-top: 20px;
      margin: 0;
      width: 160px;
      vertical-align: text-bottom;
    }

    h5 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 3;
      margin: 10;
    }

    h6 {
      color: rgb(0, 197, 255);
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
      text-align: center;
      font-weight: normal;
      font-size: 30px;
      padding: 0px 0px 0px 0px;
    }

    .sassy-theme .esri-menu,
    .sassy-theme .esri-popup__main-container,
    .sassy-theme .esri-popup .esri-popup__pointer-direction,
    .sassy-theme .esri-popup .esri-popup__button,
    .sassy-theme .esri-button,
    .sassy-theme .esri-input,
    .sassy-theme .esri-legend,
    .sassy-theme .esri-layer-list,
    .sassy-theme .esri-widget a {
      background-color: rgb(0, 0, 0, 0.7);
      color: #fff;
    }

    .sassy-theme .esri-legend__layer-caption {
      display: none;
    }
  </style>

  <script>
    require([
    "esri/Basemap",
      "esri/Map",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/layers/support/FeatureFilter",
      "esri/layers/SceneLayer",
      "esri/layers/Layer",
      "esri/layers/TileLayer",
      "esri/layers/VectorTileLayer",
      "esri/layers/support/LabelClass",
      "esri/symbols/LabelSymbol3D",
      "esri/WebMap",
      "esri/WebScene",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/widgets/TimeSlider",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/Fullscreen",
      "esri/rest/geometryService",
      "esri/rest/support/Query",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/TimeExtent",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/support/DatePicker",
      "esri/widgets/FeatureTable",
      "esri/widgets/Compass",
      "esri/layers/ElevationLayer",
      "esri/Ground",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
    ], function (
      Basemap,
      Map,
      MapView,
      SceneView,
      FeatureLayer,
      FeatureFilter,
      SceneLayer,
      Layer,
      TileLayer,
      VectorTileLayer,
      LabelClass,
      LabelSymbol3D,
      WebMap,
      WebScene,
      PortalItem,
      Portal,
      TimeSlider,
      Legend,
      LayerList,
      Fullscreen,
      geometryService,
      Query,
      StatisticDefinition,
      WebStyleSymbol,
      TimeExtent,
      Expand,
      Editor,
      UniqueValueRenderer,
      DatePicker,
      FeatureTable,
      Compass,
      ElevationLayer,
      Ground,
      GraphicsLayer,
      Search
    ) {
      ////////////////////////////////////////////////////

      // //
      // function shiftCamera(deg) {
      //   var camera = view.camera.clone();
      //   camera.position.longitude += deg;
      //   return camera;
      // }

      // function catchAbortError(error) {
      //   if (error.name != "AbortError") {
      //     console.error(error);
      //   }
      // }

      // Setup UI

      //*******************************//
      // Import Layers                 //
      //*******************************//
      var lotLayer = new FeatureLayer({
        portalItem: {
          id: "99500faf0251426ea1df934a739faa6f",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 1,
        outFields: ["*"],
        title: "Status of Land Acquisition",
        labelsVisible: false,
      });

      // Structure
      var structureLayer = new FeatureLayer({
        portalItem: {
          id: "99500faf0251426ea1df934a739faa6f",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 2,
        title: "Status of Structure",
        outFields: ["*"],
      });

      // Relocation Status point layer
      var reloISFLayer = new FeatureLayer({
        portalItem: {
          id: "99500faf0251426ea1df934a739faa6f",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 3,
        outFields: ["*"],
        title: "Status for Relocation (ISF)",
      });
      //reloISFLayer.listMode = "hide";

      // Tree Cutting
      var treeLayer = new FeatureLayer({
        portalItem: {
          id: "dfd0bca99c754002b55459004b684415",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 2,
        elevationInfo: {
          mode: "on-the-ground",
        },
        outFields: ["*"],
        title: "Status of Tree Cutting",
      });

      // Utility Relocation (Point)
      var utilPointLayer = new FeatureLayer({
        portalItem: {
          id: "b7d01020d54c4015ba0ba9454475d1dc",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 1,
        title: "Utility Point",
        outFields: ["*"],
        elevationInfo: {
          mode: "on-the-ground",
        },
      });

      // Utility Relocation (Line)
      var utilLineLayer = new FeatureLayer({
        portalItem: {
          id: "b7d01020d54c4015ba0ba9454475d1dc",
          portal: {
            url: "https://gis.railway-sector.com/portal",
          },
        },
        layerId: 2,
        title: "Utility Line",
        elevationInfo: {
          mode: "relative-to-scene",
          featureExpressionInfo: {
            expression: "$feature.height",
          },
          unit: "meters",
          //offset: 0
        },
        outFields: ["*"],
      });

      /////////////////////////////////////////////////////////////////////
      var applicationDiv = document.getElementById("applicationDiv");

      var headerDiv = document.getElementById("headerDiv");
      var headerTitleDiv = document.getElementById("headerTitleDiv");

      // Land, structure, and ISF
      var landChartDiv = document.getElementById("landChartDiv");
      var landChartCountDiv = document.getElementById("landChartCountDiv")
      var structureChartDiv = document.getElementById("structureChartDiv");
      var isfChartDiv = document.getElementById("isfChartDiv");

      // Tree cutting and tree compensation
      var treeCuttingChartDiv = document.getElementById("treeCuttingChartDiv");
      var treeCompenChartDiv = document.getElementById("treeCompenChartDiv");

      // Utitlity Relocation
      var utilityPointChartDiv = document.getElementById(
        "utilityPointChartDiv"
      );
      var utilityLineChartDiv = document.getElementById("utilityLineChartDiv");

      var informationDiv = document.getElementById("informationDiv");

      // //informationDiv.innerHTML =  "<br>" + "<b>" + "Note:" + "</b>" + "<br>" + "<br>" + "* Each gauge shows percent progress of each CP in the sliced chart.";
      // informationDiv.innerHTML = `<b>Note:</b><br>
      //                             <p>1. The progress of individual CPs is indicated in the sliced areas of gauges.</p>
      //                             <p>2. Values in the parentheses represent the total number of observations or total area (m2).
      //                             `;

      // Thousand separators function
      function thousands_separators(num) {
        var num_parts = num.toString().split(".");
        num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return num_parts.join(".");
      }

      ////////// Chart Begins //////////////////
      am4core.ready(function () {
        am4core.useTheme(am4themes_animated);

        //
        const axis1TickColor = "#C5C5C5";
        // Color Definition
        const color_101 = "#ffa500";
        const color_102 = "#ff69b4";
        const color_103a = "#00ff00";
        const color_103b = "#70AD47";
        const color_103c = "#088f8f";
        const color_104 = "#ffff00";
        const color_105 = "#bf40bf";
        const color_106 = "#ff7f7f";
        const color_107 = "#cdaa66";
        const color_handedOver = "#00c5ff";

        // const cpColor = [
        //   {
        //     cp: "S-01",
        //     color: "#ffa500",
        //   },
        //   {
        //     cp: "S-02",
        //     color: "#ff69b4",
        //   },
        //   {
        //     cp: "S-03A",
        //     color: "#00ff00",
        //   },
        //   {
        //     cp: "S-03B",
        //     color: "#70ad47",
        //   },
        //   {
        //     cp: "S-03C",
        //     color: "#088f8f",
        //   },
        //   {
        //     cp: "S-04",
        //     color: "#ffff00",
        //   },
        //   {
        //     cp: "S-05",
        //     color: "#bf40bf",
        //   },
        //   {
        //     cp: "S-06",
        //     color: "#ff7f7f",
        //   },
        //   {
        //     cp: "S-07",
        //     color: "#cdaa66",
        //   },
        // ];

        // Bottom Title Color
        const BOTTOM_LABEL_COL = am4core.color("#C5C5C5");
        const TOP_TITLE_COL = am4core.color("#FFFFFF");

        // Gauge Needle (hand) length
        const NEEDLE_LENGTH = am4core.percent(70);

        const bottomLabelFontSize = "1.3em";
        const titleFontSize = "1.7em";
        const labelMarginTop = -5;
        // Themes begin

        // Legend
        //
        function legendCP() {
          var total_s01_lot = {
            onStatisticField: "CASE WHEN CP = 'S-01' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s01_lot",
            statisticType: "sum",
          };

          var total_s02_lot = {
            onStatisticField: "CASE WHEN CP = 'S-02' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s02_lot",
            statisticType: "sum",
          };

          var total_s03a_lot = {
            onStatisticField: "CASE WHEN CP = 'S-03a' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s03a_lot",
            statisticType: "sum",
          };

          var total_s03b_lot = {
            onStatisticField: "CASE WHEN CP = 'S-03b' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s03b_lot",
            statisticType: "sum",
          };

          var total_s03c_lot = {
            onStatisticField: "CASE WHEN CP = 'S-03c' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s03c_lot",
            statisticType: "sum",
          };
          

          var total_s04_lot = {
            onStatisticField: "CASE WHEN CP = 'S-04' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s04_lot",
            statisticType: "sum",
          };

          var total_s05_lot = {
            onStatisticField: "CASE WHEN CP = 'S-05' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s05_lot",
            statisticType: "sum",
          };

          var total_s06_lot = {
            onStatisticField: "CASE WHEN CP = 'S-06' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s06_lot",
            statisticType: "sum",
          }

          var total_s07_lot = {
            onStatisticField: "CASE WHEN CP = 'S-07' THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_s07_lot",
            statisticType: "sum",
          }

          var query = lotLayer.createQuery();
          query.outStatistics = [
            total_s01_lot,
            total_s02_lot,
            total_s03a_lot,
            total_s03b_lot,
            total_s03c_lot,
            total_s04_lot,
            total_s05_lot,
            total_s06_lot,
            total_s07_lot,  
          ];
          query.returnGeometry = true;

          return lotLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const s01 = stats.total_s01_lot;
            const s02 = stats.total_s02_lot;
            const s03a = stats.total_s03a_lot;
            const s03b = stats.total_s03b_lot;
            const s03c = stats.total_s03c_lot;
            const s04 = stats.total_s04_lot;
            const s05 = stats.total_s05_lot;
            const s06 = stats.total_s06_lot;
            const s07 = stats.total_s07_lot;

            var chart = am4core.create("legendChartDiv", am4charts.PieChart);

            // Add data
            chart.data = [
              {
                CP: "All CPs",
                status: 0,
                color: am4core.color(color_handedOver),
              },
              {
                CP: "CP S-01 (%)",
                status: s01,
                color: am4core.color(color_101),
              },
              {
                CP: "CP S-02 (%)",
                status: s02,
                color: am4core.color(color_102),
              },
              {
                CP: "CP S-03A (%)",
                status: s03a,
                color: am4core.color(color_103a),
              },
              {
                CP: "CP S-03B (%)",
                status: s03b,
                color: am4core.color(color_103b),
              },
              {
                CP: "CP S-03C (%)",
                status: s03c,
                color: am4core.color(color_103c),
              },
              {
                CP: "CP S-04 (%)",
                status: s04,
                color: am4core.color(color_104),
              },
              {
                CP: "CP S-05 (%)",
                status: s05,
                color: am4core.color(color_105),
              },
              {
                CP: "CP S-06 (%)",
                status: s06,
                color: am4core.color(color_106),
              },
              {
                CP: "CP S-07 (%)",
                status: s07,
                color: am4core.color(color_107),
              },
            ];

            // Set inner radius
            chart.innerRadius = am4core.percent(0);
            chart.radius = am4core.percent(0);
            // Add and configure Series

            function createSlices(field, status) {
              var pieSeries = chart.series.push(new am4charts.PieSeries());
              pieSeries.dataFields.value = field;
              pieSeries.dataFields.category = status;
              pieSeries.disabled = true;
              pieSeries.slices.template.propertyFields.fill = "color";
              pieSeries.slices.template.stroke = am4core.color("#fff");
              pieSeries.slices.template.strokeWidth = 0;
              pieSeries.slices.template.strokeOpacity = 1;

              // change the cursor on hover to make it apparent the object can be interacted with
              pieSeries.slices.template.cursorOverStyle = [
                {
                  property: "cursor",
                  value: "pointer",
                },
              ];

              // Add a legend
              const LegendFontSizze = "1em";
              chart.legend = new am4charts.Legend();

              chart.legend.valueLabels.template.align = "right";
              chart.legend.valueLabels.template.textAlign = "end";

              //chart.legend.position = "bottom";
              chart.legend.labels.template.fontSize = LegendFontSizze;
              chart.legend.labels.template.fill = "#ffffff";
              chart.legend.valueLabels.template.fill = am4core.color("#ffffff");

              //pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
              //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";

              // Responsive code for chart
              chart.responsive.enabled = true;
              chart.responsive.useDefault = false;
              chart.logo.disabled = true;

              chart.responsive.rules.push({
                relevant: function (target) {
                  if (target.pixelWidth <= 400) {
                    return true;
                  }
                  return false;
                },
                state: function (target, stateId) {
                  if (target instanceof am4charts.PieSeries) {
                    var state = target.states.create(stateId);

                    var labelState =
                      target.labels.template.states.create(stateId);
                    labelState.properties.disabled = true;

                    var tickState =
                      target.ticks.template.states.create(stateId);
                    tickState.properties.disabled = true;
                    return state;
                  }
                  if (target instanceof am4charts.Legend) {
                    var state = target.states.create(stateId);
                    state.properties.paddingTop = 0;
                    state.properties.paddingRight = 0;
                    state.properties.paddingBottom = 0;
                    state.properties.paddingLeft = 0;
                    state.properties.marginLeft = 0;
                    return state;
                  }
                  return null;
                },
              });
              // Responsive code for chart

              // Chart Title
              //var title = chart.titles.create();
              //title.text = "Land"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
              //title.fontSize = 20;
              //title.fontWeight = "bold";
              //title.fill = "#ffffff";
              //title.marginTop = 5;

              var marker = chart.legend.markers.template.children.getIndex(0);
              var markerTemplate = chart.legend.markers.template;
              //marker.cornerRadius(12, 12, 12, 12); round legend marker
              marker.strokeWidth = 1;
              marker.strokeOpacity = 1;
              marker.stroke = am4core.color("#ccc");

              // Change size of legend marker
              markerTemplate.width = 18;
              markerTemplate.height = 18;
              // This creates initial animation
              //pieSeries.hiddenState.properties.opacity = 1;
              //pieSeries.hiddenState.properties.endAngle = -90;
              //pieSeries.hiddenState.properties.startAngle = -90;
            } // End of createSlices function

            createSlices("status", "CP");
          }); // End of queryFeatures
        } // End of updateChartLot()
        legendCP();

        // Calculate Statistcis
        // Land, Structure, and ISF

        //////////////////////////////////////////

        //////////////////////////////////////////

        /// 1. Land
        // Note that we need the following:
        // 1. total handed over %
        // 2. weighted handed over % for each CP [this is used for dividing bar areas = visualization purpose]
        // 3. actual handed over % for each CP [this number is used for annotation]
        const queryTotalHandedOver =
          "(CP IS NOT NULL OR AffectedArea IS NOT NULL) AND CP NOT IN ('S-03B, S-03C')";

        
        function lotTotalArea() {
          var total_affected_area = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_affected_area",
            statisticType: "sum",
          };
          
          var query = lotLayer.createQuery();
          query.where = queryTotalHandedOver;
          query.outStatistics = [total_affected_area];

          return lotLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const totalAffected = stats.total_affected_area;
            return totalAffected;
          });
        } 
     

        function lotSummary(totalAffected) {
          var total_affected_area = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_affected_area",
            statisticType: "sum",
          };

          var total_handover_area = {
            onStatisticField: "HandedOverArea",
            outStatisticFieldName: "total_handover_area",
            statisticType: "sum",
          };

          var query = lotLayer.createQuery();
          query.outStatistics = [total_affected_area, total_handover_area];
          query.where = queryTotalHandedOver;
          query.orderByFields = ["CP"];
          query.groupByFieldsForStatistics = ["CP"];

          var cpS01 = [];
          var cpS01_a = [];

          var cpS02 = [];
          var cpS02_a = [];

          var cpS03A = [];
          var cpS03A_a = [];

          var cpS03B = [];
          var cpS03B_a = [];

          var cpS03C = [];
          var cpS03C_a = [];

          var cpS04 = [];
          var cpS04_a = [];

          var cpS05 = [];
          var cpS05_a = [];

          var cpS06 = [];
          var cpS06_a = [];

          var cpS07 = [];
          var cpS07_a = [];

          return lotLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const affected = attributes.total_affected_area;
              const handedOver = attributes.total_handover_area;
              //const handedOver = attributes.total_handover_area > affected ? 5000 : attributes.total_handover_area;
              const LOT_HANDOVER_PERC = (handedOver / totalAffected) * 100;
              const lot_handedover = (handedOver / affected) * 100;

              if (cpPackage === "S-01") {
                cpS01.push(LOT_HANDOVER_PERC);
                cpS01_a.push(lot_handedover);
              } else if (cpPackage === "S-02") {
                cpS02.push(LOT_HANDOVER_PERC);
                cpS02_a.push(lot_handedover);
              } else if (cpPackage === "S-03A") {
                cpS03A.push(LOT_HANDOVER_PERC);
                cpS03A_a.push(lot_handedover);
              } else if (cpPackage === "S-03B") {
                cpS03B.push(LOT_HANDOVER_PERC);
                cpS03B_a.push(lot_handedover);
              } else if (cpPackage === "S-03C") {
                cpS03C.push(LOT_HANDOVER_PERC);
                cpS03C_a.push(lot_handedover);
              } else if (cpPackage === "S-04") {
                cpS04.push(LOT_HANDOVER_PERC);
                cpS04_a.push(lot_handedover);
              } else if (cpPackage === "S-05") {
                cpS05.push(LOT_HANDOVER_PERC);
                cpS05_a.push(lot_handedover);
              } else if (cpPackage === "S-06") {
                cpS06.push(LOT_HANDOVER_PERC);
                cpS06_a.push(lot_handedover);
              } else if (cpPackage === "S-07") {
                cpS07.push(LOT_HANDOVER_PERC);
                cpS07_a.push(lot_handedover);
              }
            });
            return [
              cpS01,
              cpS02,
              cpS03A,
              cpS03B,
              cpS03C,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03A_a,
              cpS03B_a,
              cpS03C_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
              totalAffected,
            ];
            
          });
        } // End of lotSummary function
        
        function laFigureLot([
          cpS01,
          cpS02,
          cpS03A,
          cpS03B,
          cpS03C,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03A_a,
          cpS03B_a,
          cpS03C_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
          totalAffected,
        ]) {
          var totalScore = // sum of weighted handed-over %
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03A) +
            Number(cpS03B) +
            Number(cpS03C) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          // Weighted handed over % for each CP for dividing bars (visualization purpose)
          var S01 = Number(cpS01_a);
          var S02 = S01 + Number(cpS02);
          var S03a = S02 + Number(cpS03A);
          var S03b = S03a + Number(cpS03B);
          var S03c = S03b + Number(cpS03C);
          var S04 = S03c + Number(cpS04);
          var S05 = S04 + Number(cpS05);
          var S06 = S05 + Number(cpS06);
          var S07 = S06 + Number(cpS07);

          var s01 = Number(cpS01_a);
          var s02 = Number(cpS02_a);
          var s03a = Number(cpS03A_a);
          var s03b = Number(cpS03B_a);
          var s03c = Number(cpS03C_a);
          var s04 = Number(cpS04_a);
          var s05 = Number(cpS05_a);
          var s06 = Number(cpS06_a);
          var s07 = Number(cpS07_a);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: s01.toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: s02.toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: s03a.toFixed(0),
                color: color_103a,
                lowScore: S02,
                highScore: S03a,
              },
              {
                title: s03b.toFixed(0),
                color: color_103b,
                lowScore: S03a,
                highScore: S03b,
              },
              {
                title: s03c.toFixed(0),
                color: color_103c,
                lowScore: S03b,
                highScore: S03c,
              },
              {
                title: s04.toFixed(0),
                color: color_104,
                lowScore: S03c,
                highScore: S04,
              },
              {
                title: s05.toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: s06.toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: s07.toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("landChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          //'<a href="https://google.com"}">More info</a>'

          title.text = "LAND";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">LAND</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          //var sourceLabel = chart.createChild(am4core.Label);
          //sourceLabel.html = '<a href="https://google.com">Test</a>';

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]HANDED-OVER AREA";
          //label.html = '<a href="https://google.com">HANDED-OVER AREA</a>';
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1; // default 0.8 fill-color of
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
    var label2 = chart.radarContainer.createChild(am4core.Label);
    label2.isMeasured = false;
    label2.fontSize = "2em";
    label2.horizontalCenter = "middle";
    label2.verticalCenter = "bottom";
    label2.text = matchingGrade.title.toUpperCase();
    //label2.fill = am4core.color(matchingGrade.color);
    label2.fill =  am4core.color("#00C3FF");
    */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }
        lotTotalArea().then(lotSummary).then(laFigureLot);
        
        /// 2. Structure
        function strucTotalArea() {
          var total_number_struc = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_number_struc",
            statisticType: "sum",
          };

          var query = structureLayer.createQuery();
          query.outStatistics = [total_number_struc];

          return structureLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const totalNumberStruc = stats.total_number_struc;
            //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
            return totalNumberStruc;
          });
        }

        function strucSummary(totalNumberStruc) {
          var total_number_struc = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_number_struc",
            statisticType: "sum",
          };

          var total_dismantle_struc = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_dismantle_struc",
            statisticType: "sum",
          };

          var query = structureLayer.createQuery();
          query.outStatistics = [total_number_struc, total_dismantle_struc];
          query.returnGeometry = true;
          query.groupByFieldsForStatistics = ["CP"];

          var cpS01 = [];
          var cpS01_a = [];

          var cpS02 = [];
          var cpS02_a = [];

          var cpS03 = [];
          var cpS03_a = [];

          var cpS04 = [];
          var cpS04_a = [];

          var cpS05 = [];
          var cpS05_a = [];

          var cpS06 = [];
          var cpS06_a = [];

          var cpS07 = [];
          var cpS07_a = [];

          return structureLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const dismantled = attributes.total_dismantle_struc;
              const totalN = attributes.total_number_struc;

              const STRUC_DISMANTLE_PERC =
                (dismantled / totalNumberStruc) * 100;
              const dismantled_struc = (dismantled / totalN) * 100;

              if (cpPackage === "S-01") {
                cpS01.push(STRUC_DISMANTLE_PERC);
                cpS01_a.push(dismantled_struc);
              } else if (cpPackage === "S-02") {
                cpS02.push(STRUC_DISMANTLE_PERC);
                cpS02_a.push(dismantled_struc);
              } else if (cpPackage === "S-03") {
                cpS03.push(STRUC_DISMANTLE_PERC);
                cpS03_a.push(dismantled_struc);
              } else if (cpPackage === "S-04") {
                cpS04.push(STRUC_DISMANTLE_PERC);
                cpS04_a.push(dismantled_struc);
              } else if (cpPackage === "S-05") {
                cpS05.push(STRUC_DISMANTLE_PERC);
                cpS05_a.push(dismantled_struc);
              } else if (cpPackage === "S-05") {
                cpS06.push(STRUC_DISMANTLE_PERC);
                cpS06_a.push(dismantled_struc);
              } else if (cpPackage === "S-05") {
                cpS07.push(STRUC_DISMANTLE_PERC);
                cpS07_a.push(dismantled_struc);
              }
            });
            return [
              cpS01,
              cpS02,
              cpS03,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
            ];
          });
        } // End of strucSummary function

        function laFigureStruc([
          cpS01,
          cpS02,
          cpS03,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
        ]) {
          var totalScore =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var S01 = Number(cpS01);
          var S02 = Number(cpS01) + Number(cpS02);
          var S03 = Number(cpS01) + Number(cpS02) + Number(cpS03);
          var S04 =
            Number(cpS01) + Number(cpS02) + Number(cpS03) + Number(cpS04);
          var S05 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05);
          var S06 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06);
          var S07 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: isNaN(cpS01_a) ? "" : Number(cpS01_a).toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: isNaN(cpS02_a) ? "" : Number(cpS02_a).toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: isNaN(cpS03_a) ? "" : Number(cpS03_a).toFixed(0),
                color: color_103,
                lowScore: S02,
                highScore: S03,
              },
              {
                title: isNaN(cpS04_a) ? "" : Number(cpS04_a).toFixed(0),
                color: color_104,
                lowScore: S03,
                highScore: S04,
              },
              {
                title: isNaN(cpS05_a) ? "" : Number(cpS05_a).toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: isNaN(cpS06_a) ? "" : Number(cpS06_a).toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: isNaN(cpS07_a) ? "" : Number(cpS07_a).toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("structureChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "EXISTING STRUCTURE";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">EXISTING STRUCTURE</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]DISMANTLED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
    var label2 = chart.radarContainer.createChild(am4core.Label);
    label2.isMeasured = false;
    label2.fontSize = "2em";
    label2.horizontalCenter = "middle";
    label2.verticalCenter = "bottom";
    label2.text = matchingGrade.title.toUpperCase();
    //label2.fill = am4core.color(matchingGrade.color);
    label2.fill =  am4core.color("#00C3FF");
    */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }
        strucTotalArea().then(strucSummary).then(laFigureStruc);

        /// 3. ISF
        function isfTotalArea() {
          var total_number_isf = {
            onStatisticField: "StrucID",
            outStatisticFieldName: "total_number_isf",
            statisticType: "count",
          };

          var query = reloISFLayer.createQuery();
          query.outStatistics = [total_number_isf];

          return reloISFLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;

            const totalNumberISF = stats.total_number_isf;

            //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
            return totalNumberISF;
          });
        }

        function isfSummary(totalNumberISF) {
          var total_number_isf = {
            onStatisticField: "StrucID",
            outStatisticFieldName: "total_number_isf",
            statisticType: "count",
          };

          var total_relocation_isf = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_relocation_isf",
            statisticType: "sum",
          };

          var query = reloISFLayer.createQuery();
          query.outStatistics = [total_number_isf, total_relocation_isf];
          query.returnGeometry = true;
          query.groupByFieldsForStatistics = ["CP"];

          var cpS01 = [];
          var cpS01_a = [];

          var cpS02 = [];
          var cpS02_a = [];

          var cpS03 = [];
          var cpS03_a = [];

          var cpS04 = [];
          var cpS04_a = [];

          var cpS05 = [];
          var cpS05_a = [];

          var cpS06 = [];
          var cpS06_a = [];

          var cpS07 = [];
          var cpS07_a = [];

          return reloISFLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const relocated = attributes.total_relocation_isf;
              const totalISF = attributes.total_number_isf;
              const ISF_RELOCATED_PERC = (relocated / totalNumberISF) * 100;
              const isf_relocated = (relocated / totalISF) * 100;

              if (cpPackage === "S-01") {
                cpS01.push(ISF_RELOCATED_PERC);
                cpS01_a.push(isf_relocated);
              } else if (cpPackage === "S-02") {
                cpS02.push(ISF_RELOCATED_PERC);
                cpS02_a.push(isf_relocated);
              } else if (cpPackage === "S-03") {
                cpS03.push(ISF_RELOCATED_PERC);
                cpS03_a.push(isf_relocated);
              } else if (cpPackage === "S-04") {
                cpS04.push(ISF_RELOCATED_PERC);
                cpS04_a.push(isf_relocated);
              } else if (cpPackage === "S-05") {
                cpS05.push(ISF_RELOCATED_PERC);
                cpS05_a.push(isf_relocated);
              } else if (cpPackage === "S-06") {
                cpS06.push(ISF_RELOCATED_PERC);
                cpS06_a.push(isf_relocated);
              } else if (cpPackage === "S-07") {
                cpS07.push(ISF_RELOCATED_PERC);
                cpS07_a.push(isf_relocated);
              }
            });
            return [
              cpS01,
              cpS02,
              cpS03,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
            ];
          });
        } // End of isfSummary function

        function laFigureIsf([
          cpS01,
          cpS02,
          cpS03,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
        ]) {
          var totalScore =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var S01 = Number(cpS01);
          var S02 = Number(cpS01) + Number(cpS02);
          var S03 = Number(cpS01) + Number(cpS02) + Number(cpS03);
          var S04 =
            Number(cpS01) + Number(cpS02) + Number(cpS03) + Number(cpS04);
          var S05 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05);
          var S06 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06);
          var S07 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: isNaN(cpS01_a) ? "" : Number(cpS01_a).toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: isNaN(cpS02_a) ? "" : Number(cpS02_a).toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: isNaN(cpS03_a) ? "" : Number(cpS03_a).toFixed(0),
                color: color_103,
                lowScore: S02,
                highScore: S03,
              },
              {
                title: isNaN(cpS04_a) ? "" : Number(cpS04_a).toFixed(0),
                color: color_104,
                lowScore: S03,
                highScore: S04,
              },
              {
                title: isNaN(cpS05_a) ? "" : Number(cpS05_a).toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: isNaN(cpS06_a) ? "" : Number(cpS06_a).toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: isNaN(cpS07_a) ? "" : Number(cpS07_a).toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create("isfChartDiv", am4charts.GaugeChart);
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "INFORMAL SETTLERS";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html" target="_blank">INFORMAL SETTLERS</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]RELOCATED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
    var label2 = chart.radarContainer.createChild(am4core.Label);
    label2.isMeasured = false;
    label2.fontSize = "2em";
    label2.horizontalCenter = "middle";
    label2.verticalCenter = "bottom";
    label2.text = matchingGrade.title.toUpperCase();
    //label2.fill = am4core.color(matchingGrade.color);
    label2.fill =  am4core.color("#00C3FF");
    */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }
        isfTotalArea().then(isfSummary).then(laFigureIsf);

        // Tree

        /// 1. Tree Cutting
        function treeCuttingTotal() {
          var total_number_tree = {
            onStatisticField: "TreeNo",
            outStatisticFieldName: "total_number_tree",
            statisticType: "count",
          };

          var query = treeLayer.createQuery();
          query.outStatistics = [total_number_tree];

          return treeLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;
            const totalNumber = stats.total_number_tree;
            //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
            return totalNumber;
          });
        }

        function treeCutSummary(totalNumber) {
          var total_number_tree = {
            onStatisticField: "TreeNo",
            outStatisticFieldName: "total_number_tree",
            statisticType: "count",
          };

          var total_cutearthballed_tree = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_cutearthballed_tree",
            statisticType: "sum",
          };

          var query = treeLayer.createQuery();
          query.outStatistics = [total_number_tree, total_cutearthballed_tree];
          query.returnGeometry = true;
          query.groupByFieldsForStatistics = ["CP"];

          var cpS01 = [];
          var cpS01_a = [];

          var cpS02 = [];
          var cpS02_a = [];

          var cpS03 = [];
          var cpS03_a = [];

          var cpS04 = [];
          var cpS04_a = [];

          var cpS05 = [];
          var cpS05_a = [];

          var cpS06 = [];
          var cpS06_a = [];

          var cpS07 = [];
          var cpS07_a = [];

          return treeLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const cutEarthballed = attributes.total_cutearthballed_tree;
              const totalCutEarth = attributes.total_number_tree;
              const TREE_CUT_PERC = (cutEarthballed / totalNumber) * 100;
              const tree_cutEarth = (cutEarthballed / totalCutEarth) * 100;

              if (cpPackage === "S-01") {
                cpS01.push(TREE_CUT_PERC);
                cpS01_a.push(tree_cutEarth);
              } else if (cpPackage === "S-02") {
                cpS02.push(TREE_CUT_PERC);
                cpS02_a.push(tree_cutEarth);
              } else if (cpPackage === "S-03") {
                cpS03.push(TREE_CUT_PERC);
                cpS03_a.push(tree_cutEarth);
              } else if (cpPackage === "S-04") {
                cpS04.push(TREE_CUT_PERC);
                cpS04_a.push(tree_cutEarth);
              } else if (cpPackage === "S-05") {
                cpS05.push(TREE_CUT_PERC);
                cpS05_a.push(tree_cutEarth);
              } else if (cpPackage === "S-06") {
                cpS06.push(TREE_CUT_PERC);
                cpS06_a.push(tree_cutEarth);
              } else if (cpPackage === "S-07") {
                cpS07.push(TREE_CUT_PERC);
                cpS07_a.push(tree_cutEarth);
              }
            });
            return [
              cpS01,
              cpS02,
              cpS03,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
            ];
          });
        } // End of treeCutSummary function

        function treeCuttingFigure([
          cpS01,
          cpS02,
          cpS03,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
        ]) {
          var totalScore =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var S01 = Number(cpS01);
          var S02 = Number(cpS01) + Number(cpS02);
          var S03 = Number(cpS01) + Number(cpS02) + Number(cpS03);
          var S04 =
            Number(cpS01) + Number(cpS02) + Number(cpS03) + Number(cpS04);
          var S05 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05);
          var S06 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06);
          var S07 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: isNaN(cpS01_a) ? "" : Number(cpS01_a).toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: isNaN(cpS02_a) ? "" : Number(cpS02_a).toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: isNaN(cpS03_a) ? "" : Number(cpS03_a).toFixed(0),
                color: color_103,
                lowScore: S02,
                highScore: S03,
              },
              {
                title: isNaN(cpS04_a) ? "" : Number(cpS04_a).toFixed(0),
                color: color_104,
                lowScore: S03,
                highScore: S04,
              },
              {
                title: isNaN(cpS05_a) ? "" : Number(cpS05_a).toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: isNaN(cpS06_a) ? "" : Number(cpS06_a).toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: isNaN(cpS07_a) ? "" : Number(cpS07_a).toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "treeCuttingChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "TREE CUTTING";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Tree_Cutting/index.html" target="_blank">TREE CUTTING</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]CUT/EARTHBALLED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
    var label2 = chart.radarContainer.createChild(am4core.Label);
    label2.isMeasured = false;
    label2.fontSize = "2em";
    label2.horizontalCenter = "middle";
    label2.verticalCenter = "bottom";
    label2.text = matchingGrade.title.toUpperCase();
    //label2.fill = am4core.color(matchingGrade.color);
    label2.fill =  am4core.color("#00C3FF");
    */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }
        treeCuttingTotal().then(treeCutSummary).then(treeCuttingFigure);

        // Tree Compensation
        function treeCompenTotal() {
          var total_number_tree = {
            onStatisticField: "CASE WHEN Compensation >= 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_number_tree",
            statisticType: "sum",
          };

          var query = treeLayer.createQuery();
          query.outStatistics = [total_number_tree];

          return treeLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;
            const totalNumber = stats.total_number_tree;

            return totalNumber;
          });
        }

        function treeCompenSummary(totalNumber) {
          var total_number_tree = {
            onStatisticField: "CASE WHEN Compensation >= 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_number_tree",
            statisticType: "sum",
          };

          var total_compensated_tree = {
            onStatisticField: "CASE WHEN Compensation = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_compensated_tree",
            statisticType: "sum",
          };

          var query = treeLayer.createQuery();
          query.outStatistics = [total_number_tree, total_compensated_tree];
          query.returnGeometry = true;
          query.groupByFieldsForStatistics = ["CP"];

          var cpS01 = [];
          var cpS01_a = [];

          var cpS02 = [];
          var cpS02_a = [];

          var cpS03 = [];
          var cpS03_a = [];

          var cpS04 = [];
          var cpS04_a = [];

          var cpS05 = [];
          var cpS05_a = [];

          var cpS06 = [];
          var cpS06_a = [];

          var cpS07 = [];
          var cpS07_a = [];

          return treeLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const compensated = attributes.total_compensated_tree;
              const totalCompen = attributes.total_number_tree;

              const temp = (compensated / totalNumber) * 100;
              const TREE_COMPEN_PERC = isNaN(temp)
                ? 0
                : (compensated / totalNumber) * 100;

              const temp1 = (compensated / totalCompen) * 100;
              const tree_compen = isNaN(temp1)
                ? 0
                : (compensated / totalCompen) * 100;

              if (cpPackage === "S-01") {
                cpS01.push(TREE_COMPEN_PERC);
                cpS01_a.push(tree_compen);
              } else if (cpPackage === "S-02") {
                cpS02.push(TREE_COMPEN_PERC);
                cpS02_a.push(tree_compen);
              } else if (cpPackage === "S-03") {
                cpS03.push(TREE_COMPEN_PERC);
                cpS03_a.push(tree_compen);
              } else if (cpPackage === "S-04") {
                cpS04.push(TREE_COMPEN_PERC);
                cpS04_a.push(0); // no applicable: all trees in S-04 are Non-Compensable (i.e., not subject to this)
              } else if (cpPackage === "S-05") {
                cpS05.push(TREE_COMPEN_PERC);
                cpS05_a.push(tree_compen);
              } else if (cpPackage === "S-06") {
                cpS06.push(TREE_COMPEN_PERC);
                cpS06_a.push(tree_compen);
              } else if (cpPackage === "S-07") {
                cpS07.push(TREE_COMPEN_PERC);
                cpS07_a.push(tree_compen);
              }
            });
            return [
              cpS01,
              cpS02,
              cpS03,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
            ];
          });
        } // End of treeCompenSummary function

        function treeCompenFigure([
          cpS01,
          cpS02,
          cpS03,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
        ]) {
          var totalScore =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var S01 = Number(cpS01);
          var S02 = Number(cpS01) + Number(cpS02);
          var S03 = Number(cpS01) + Number(cpS02) + Number(cpS03);
          var S04 =
            Number(cpS01) + Number(cpS02) + Number(cpS03) + Number(cpS04);
          var S05 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05);
          var S06 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06);
          var S07 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: isNaN(cpS01_a) ? "" : Number(cpS01_a).toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: isNaN(cpS02_a) ? "" : Number(cpS02_a).toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: isNaN(cpS03_a) ? "" : Number(cpS03_a).toFixed(0),
                color: color_103,
                lowScore: S02,
                highScore: S03,
              },
              {
                title: isNaN(cpS04_a) ? "" : Number(cpS04_a).toFixed(0),
                color: color_104,
                lowScore: S03,
                highScore: S04,
              },
              {
                title: isNaN(cpS05_a) ? "" : Number(cpS05_a).toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: isNaN(cpS06_a) ? "" : Number(cpS06_a).toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: isNaN(cpS07_a) ? "" : Number(cpS07_a).toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
      Grading Lookup
      */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "treeCompenChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "TREE COMPENSATION";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Tree_Cutting/index.html" target="_blank">TREE COMPENSATION</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]COMPENSATED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
      Ranges
      */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%"; //data.score.toFixed(0).toString() + "%"
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
      var label2 = chart.radarContainer.createChild(am4core.Label);
      label2.isMeasured = false;
      label2.fontSize = "2em";
      label2.horizontalCenter = "middle";
      label2.verticalCenter = "bottom";
      label2.text = matchingGrade.title.toUpperCase();
      //label2.fill = am4core.color(matchingGrade.color);
      label2.fill =  am4core.color("#00C3FF");
      */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
      hand.events.on("positionchanged", function(){
      label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
      var value2 = axis.positionToValue(hand.currentPosition);
      var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
      label2.text = matchingGrade.title.toUpperCase();
      label2.fill = am4core.color(matchingGrade.color);
      label2.stroke = am4core.color(matchingGrade.color);
      label.fill = am4core.color(matchingGrade.color);
      })
      */
          /*
      setInterval(function() {
      var value = chartMin + Math.random() * (chartMax - chartMin);
      hand.showValue(value, 1000, am4core.ease.cubicOut);
      }, 2000);
      */
        }
        treeCompenTotal().then(treeCompenSummary).then(treeCompenFigure);

        // Utility Point + Line Total Number
        function utilityPointTotal() {
          var total_number_utilPoint = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_utilPoint",
            statisticType: "count",
          };

          var query = utilPointLayer.createQuery();
          query.outStatistics = [total_number_utilPoint];

          return utilPointLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;
            const totalNumberPoint = stats.total_number_utilPoint;
            return totalNumberPoint;
          });
        }

        function utilityLineTotal(totalNumberPoint) {
          var total_number_utilLine = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_utilLine",
            statisticType: "count",
          };

          var query = utilLineLayer.createQuery();
          query.outStatistics = [total_number_utilLine];

          return utilLineLayer.queryFeatures(query).then(function (response) {
            var stats = response.features[0].attributes;
            const totalNumberLine = stats.total_number_utilLine;
            const grandTotal =
              Number(totalNumberPoint) + Number(totalNumberLine);
            return grandTotal;
          });
        }

        // Utility Point + Line Total Completed
        function utilityPointCompleted(grandTotal) {
          var total_number_utilPoint = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_utilPoint",
            statisticType: "count",
          };

          var total_completed_utilPoint = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_completed_utilPoint",
            statisticType: "sum",
          };

          var query = utilPointLayer.createQuery();
          query.outStatistics = [
            total_number_utilPoint,
            total_completed_utilPoint,
          ];
          query.groupByFieldsForStatistics = ["CP"];

          var point_cpS01 = [];
          var point_cpS01_a = [];

          var point_cpS02 = [];
          var point_cpS02_a = [];

          var point_cpS03 = [];
          var point_cpS03_a = [];

          var point_cpS04 = [];
          var point_cpS04_a = [];

          var point_cpS05 = [];
          var point_cpS05_a = [];

          var point_cpS06 = [];
          var point_cpS06_a = [];

          var point_cpS07 = [];
          var point_cpS07_a = [];

          return utilPointLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const completed = attributes.total_completed_utilPoint;
              const totalUtilPoint = attributes.total_number_utilPoint;

              if (cpPackage === "S-01") {
                point_cpS01.push(completed);
                point_cpS01_a.push(totalUtilPoint);
              } else if (cpPackage === "S-02") {
                point_cpS02.push(completed);
                point_cpS02_a.push(totalUtilPoint);
              } else if (
                cpPackage === "S-03a" ||
                cpPackage === "S-03b" ||
                cpPackage === "S-03c"
              ) {
                point_cpS03.push(completed);
                point_cpS03_a.push(totalUtilPoint);
              } else if (cpPackage === "S-04") {
                point_cpS04.push(completed);
                point_cpS04_a.push(totalUtilPoint);
              } else if (cpPackage === "S-05") {
                point_cpS05.push(completed);
                point_cpS05_a.push(totalUtilPoint);
              } else if (cpPackage === "S-06") {
                point_cpS06.push(completed);
                point_cpS06_a.push(totalUtilPoint);
              } else if (cpPackage === "S-07") {
                point_cpS07.push(completed);
                point_cpS07_a.push(totalUtilPoint);
              }
            });

            point_cpS03 = [point_cpS03[0] + point_cpS03[1] + point_cpS03[2]];
            point_cpS03_a = [
              point_cpS03_a[0] + point_cpS03_a[1] + point_cpS03_a[2],
            ];

            return [
              point_cpS01,
              point_cpS02,
              point_cpS03,
              point_cpS04,
              point_cpS05,
              point_cpS06,
              point_cpS07,
              point_cpS01_a,
              point_cpS02_a,
              point_cpS03_a,
              point_cpS04_a,
              point_cpS05_a,
              point_cpS06_a,
              point_cpS07_a,
              grandTotal,
            ];
          });
        }

        function utilityLineCompleted([
          point_cpS01,
          point_cpS02,
          point_cpS03,
          point_cpS04,
          point_cpS05,
          point_cpS06,
          point_cpS07,
          point_cpS01_a,
          point_cpS02_a,
          point_cpS03_a,
          point_cpS04_a,
          point_cpS05_a,
          point_cpS06_a,
          point_cpS07_a,
          grandTotal,
        ]) {
          var total_number_utilLine = {
            onStatisticField: "LAYER",
            outStatisticFieldName: "total_number_utilLine",
            statisticType: "count",
          };

          var total_completed_utilLine = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_completed_utilLine",
            statisticType: "sum",
          };

          var query = utilLineLayer.createQuery();
          query.outStatistics = [
            total_number_utilLine,
            total_completed_utilLine,
          ];
          query.groupByFieldsForStatistics = ["CP"];

          // Numeric
          const point_s01 = Number(point_cpS01);
          const point_s02 = Number(point_cpS02);
          const point_s03 = Number(point_cpS03);
          const point_s04 = Number(point_cpS04);
          const point_s05 = Number(point_cpS05);
          const point_s06 = Number(point_cpS06);
          const point_s07 = Number(point_cpS07);
          const gTotal = Number(grandTotal);

          var totalCompleted_cpS01 = [];
          var totalCompleted_cpS02 = [];
          var totalCompleted_cpS03 = [];
          var totalCompleted_cpS04 = [];
          var totalCompleted_cpS05 = [];
          var totalCompleted_cpS06 = [];
          var totalCompleted_cpS07 = [];

          var totalUtil_cpS01 = [];
          var totalUtil_cpS02 = [];
          var totalUtil_cpS03 = [];
          var totalUtil_cpS04 = [];
          var totalUtil_cpS05 = [];
          var totalUtil_cpS06 = [];
          var totalUtil_cpS07 = [];

          return utilLineLayer.queryFeatures(query).then(function (response) {
            stats = response.features;

            stats.forEach((result, index) => {
              const attributes = result.attributes;
              const cpPackage = result.attributes.CP;
              const completed = attributes.total_completed_utilLine;
              const totalUtilLine = attributes.total_number_utilLine;

              const completedLine = Number(completed);

              if (cpPackage === "S-01") {
                const tempComp_s01 = completedLine + point_s01;
                totalCompleted_cpS01.push(tempComp_s01);
                const totalCount_s01 = totalUtilLine + Number(point_cpS01_a);
                totalUtil_cpS01.push(totalCount_s01);
              } else if (cpPackage === "S-02") {
                const tempComp_s02 = completedLine + point_s02;
                totalCompleted_cpS02.push(tempComp_s02);
                const totalCount_s02 = totalUtilLine + Number(point_cpS02_a);
                totalUtil_cpS02.push(totalCount_s02);
              } else if (
                cpPackage === "S-03a" ||
                cpPackage === "S-03b" ||
                cpPackage === "S-03c"
              ) {
                //const tempComp_s03 = completedLine + point_s03;
                totalCompleted_cpS03.push(completedLine);
                totalUtil_cpS03.push(totalUtilLine);
              } else if (cpPackage === "S-04") {
                const tempComp_s04 = completedLine + point_s04;
                totalCompleted_cpS04.push(tempComp_s04);
                const totalCount_s04 = totalUtilLine + Number(point_cpS04_a);
                totalUtil_cpS04.push(totalCount_s04);
              } else if (cpPackage === "S-05") {
                const tempComp_s05 = completedLine + point_s05;
                totalCompleted_cpS05.push(tempComp_s05);
                const totalCount_s05 = totalUtilLine + Number(point_cpS05_a);
                totalUtil_cpS05.push(totalCount_s05);
              } else if (cpPackage === "S-06") {
                const tempComp_s06 = completedLine + point_s06;
                totalCompleted_cpS06.push(tempComp_s06);
                const totalCount_s06 = totalUtilLine + Number(point_cpS06_a);
                totalUtil_cpS06.push(totalCount_s06);
              } else if (cpPackage === "S-07") {
                const tempComp_s07 = completedLine + point_s07;
                totalCompleted_cpS07.push(tempComp_s07);
                const totalCount_s07 = totalUtilLine + Number(point_cpS07_a);
                totalUtil_cpS07.push(totalCount_s07);
              }
            });
            // S-03: S-03a, S-03b, S-03c
            totalCompleted_cpS03 = [
              totalCompleted_cpS03[0] +
                totalCompleted_cpS03[1] +
                totalCompleted_cpS03[2] +
                point_s03,
            ];

            totalUtil_cpS03 = [
              totalUtil_cpS03[0] +
                totalUtil_cpS03[1] +
                totalUtil_cpS03[2] +
                point_s03,
            ];

            const cpS01 = (totalCompleted_cpS01 / gTotal) * 100;
            const cpS02 = (totalCompleted_cpS02 / gTotal) * 100;
            const cpS03 = (totalCompleted_cpS03 / gTotal) * 100;
            const cpS04 = (totalCompleted_cpS04 / gTotal) * 100;
            const cpS05 = (totalCompleted_cpS05 / gTotal) * 100;
            const cpS06 = (totalCompleted_cpS06 / gTotal) * 100;
            const cpS07 = (totalCompleted_cpS07 / gTotal) * 100;
            const cpS01_a = (totalCompleted_cpS01 / totalUtil_cpS01) * 100;
            const cpS02_a = (totalCompleted_cpS02 / totalUtil_cpS02) * 100;
            const cpS03_a = (totalCompleted_cpS03 / totalUtil_cpS03) * 100;
            const cpS04_a = (totalCompleted_cpS04 / totalUtil_cpS04) * 100;
            const cpS05_a = (totalCompleted_cpS05 / totalUtil_cpS05) * 100;
            const cpS06_a = (totalCompleted_cpS05 / totalUtil_cpS06) * 100;
            const cpS07_a = (totalCompleted_cpS05 / totalUtil_cpS07) * 100;

            return [
              cpS01,
              cpS02,
              cpS03,
              cpS04,
              cpS05,
              cpS06,
              cpS07,
              cpS01_a,
              cpS02_a,
              cpS03_a,
              cpS04_a,
              cpS05_a,
              cpS06_a,
              cpS07_a,
            ];
          });
        }

        // Utility Progress Chart
        function utilityChart([
          cpS01,
          cpS02,
          cpS03,
          cpS04,
          cpS05,
          cpS06,
          cpS07,
          cpS01_a,
          cpS02_a,
          cpS03_a,
          cpS04_a,
          cpS05_a,
          cpS06_a,
          cpS07_a,
        ]) {
          var totalScore =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var S01 = Number(cpS01);
          var S02 = Number(cpS01) + Number(cpS02);
          var S03 = Number(cpS01) + Number(cpS02) + Number(cpS03);
          var S04 =
            Number(cpS01) + Number(cpS02) + Number(cpS03) + Number(cpS04);
          var S05 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05);
          var S06 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06);
          var S07 =
            Number(cpS01) +
            Number(cpS02) +
            Number(cpS03) +
            Number(cpS04) +
            Number(cpS05) +
            Number(cpS06) +
            Number(cpS07);

          var chartMin = 0;
          var chartMax = 100;

          // #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
          // const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

          var data = {
            score: totalScore,
            gradingData: [
              {
                title: isNaN(cpS01_a) ? "" : Number(cpS01_a).toFixed(0),
                color: color_101,
                lowScore: 0,
                highScore: S01,
              },
              {
                title: isNaN(cpS02_a) ? "" : Number(cpS02_a).toFixed(0),
                color: color_102,
                lowScore: S01,
                highScore: S02,
              },
              {
                title: isNaN(cpS03_a) ? "" : Number(cpS03_a).toFixed(0),
                color: color_103,
                lowScore: S02,
                highScore: S03,
              },
              {
                title: isNaN(cpS04_a) ? "" : Number(cpS04_a).toFixed(0),
                color: color_104,
                lowScore: S03,
                highScore: S04,
              },
              {
                title: isNaN(cpS05_a) ? "" : Number(cpS05_a).toFixed(0),
                color: color_105,
                lowScore: S04,
                highScore: S05,
              },
              {
                title: isNaN(cpS06_a) ? "" : Number(cpS06_a).toFixed(0),
                color: color_106,
                lowScore: S05,
                highScore: S06,
              },
              {
                title: isNaN(cpS07_a) ? "" : Number(cpS07_a).toFixed(0),
                color: color_107,
                lowScore: S06,
                highScore: S07,
              },
              {
                title: "",
                color: "#C5C5C5",
                lowScore: S07,
                highScore: 100,
              },
            ],
          };

          /**
    Grading Lookup
    */
          function lookUpGrade(lookupScore, grades) {
            // Only change code below this line
            for (var i = 0; i < grades.length; i++) {
              if (
                grades[i].lowScore < lookupScore &&
                grades[i].highScore >= lookupScore
              ) {
                return grades[i];
              }
            }
            return null;
          }

          // create chart
          var chart = am4core.create(
            "utilityPointChartDiv",
            am4charts.GaugeChart
          );
          chart.hiddenState.properties.opacity = 0;
          chart.fontSize = 11;
          chart.innerRadius = am4core.percent(80);
          chart.resizable = true;
          chart.responsive.enabled = true;
          chart.logo.disabled = true;
          /**
           * Chart Title
           */
          // Title Color
          var title = chart.titles.create();
          title.text = "UTILITY";
          //title.html = '<a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Utility_Relocation/index.html" target="_blank">UTILITY</a>';
          title.fontSize = titleFontSize;
          title.align = "center";
          title.marginBottom = -10;
          title.marginTop = 0;
          title.fill = TOP_TITLE_COL;

          // Add bottom label
          var label = chart.chartContainer.createChild(am4core.Label);
          label.text = "[bold]COMPLETED";
          label.fontSize = bottomLabelFontSize;
          label.align = "center";
          label.marginTop = labelMarginTop;
          label.fill = BOTTOM_LABEL_COL;

          /**
           * Normal axis
           */

          var axis = chart.xAxes.push(new am4charts.ValueAxis());
          axis.min = chartMin;
          axis.max = chartMax;
          axis.strictMinMax = true;
          axis.renderer.radius = am4core.percent(80);
          axis.renderer.inside = true;
          axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
          axis.renderer.ticks.template.disabled = false;
          axis.renderer.ticks.template.strokeOpacity = 1;
          //axis.renderer.ticks.template.strokeWidth = 1;
          axis.renderer.ticks.template.length = 10;
          axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
          //axis.renderer.grid.template.disabled = true;
          axis.renderer.labels.template.radius = am4core.percent(40);
          axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
          axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

          /**
           * Axis for ranges
           */

          var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
          axis2.min = chartMin;
          axis2.max = chartMax;
          axis2.strictMinMax = true;
          axis2.renderer.labels.template.disabled = true;
          axis2.renderer.ticks.template.disabled = true;
          axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
          axis2.renderer.grid.template.opacity = 0.5;
          axis2.renderer.labels.template.bent = true;
          axis2.renderer.labels.template.fill = am4core.color("#000");
          axis2.renderer.labels.template.fontWeight = "bold";
          axis2.renderer.labels.template.fillOpacity = 0.7;

          /**
    Ranges
    */

          for (let grading of data.gradingData) {
            var range = axis2.axisRanges.create();
            range.axisFill.fill = am4core.color(grading.color);
            range.axisFill.fillOpacity = 1;
            range.axisFill.zIndex = -1;
            range.value =
              grading.lowScore > chartMin ? grading.lowScore : chartMin;
            range.endValue =
              grading.highScore < chartMax ? grading.highScore : chartMax;
            range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
            range.stroke = am4core.color(grading.color).lighten(-0.1);
            range.label.inside = true;
            range.label.text = grading.title.toUpperCase();
            range.label.inside = true;
            range.label.location = 0.5;
            range.label.inside = true;
            range.label.radius = am4core.percent(10);
            range.label.paddingBottom = -5; // ~half font size
            range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
          }

          var matchingGrade = lookUpGrade(data.score, data.gradingData);

          /**
           * Label 1 (total Percent)
           */

          var label = chart.radarContainer.createChild(am4core.Label);
          label.isMeasured = false;
          label.fontSize = "3.5em";
          label.x = am4core.percent(50);
          label.y = am4core.percent(100);
          label.paddingBottom = -5;
          label.horizontalCenter = "middle";
          label.verticalCenter = "bottom";
          //label.dataItem = data;
          label.text = data.score.toFixed(0).toString() + "%";
          //label.text = "{score}";
          //label.fill = am4core.color(matchingGrade.color);
          label.fill = am4core.color("#00C3FF");

          /**
           * Label 2
           */

          /*
    var label2 = chart.radarContainer.createChild(am4core.Label);
    label2.isMeasured = false;
    label2.fontSize = "2em";
    label2.horizontalCenter = "middle";
    label2.verticalCenter = "bottom";
    label2.text = matchingGrade.title.toUpperCase();
    //label2.fill = am4core.color(matchingGrade.color);
    label2.fill =  am4core.color("#00C3FF");
    */
          /**
           * Hand
           */

          var hand = chart.hands.push(new am4charts.ClockHand());
          hand.axis = axis2;
          hand.innerRadius = am4core.percent(55);
          hand.startWidth = 8;
          hand.pin.disabled = true;
          hand.value = data.score;
          hand.fill = am4core.color("#000000"); // inner color of needle
          //hand.stroke = am4core.color("#000");
          hand.fillOpacity = 0.5;

          /*
    hand.events.on("positionchanged", function(){
    label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
    var value2 = axis.positionToValue(hand.currentPosition);
    var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
    label2.text = matchingGrade.title.toUpperCase();
    label2.fill = am4core.color(matchingGrade.color);
    label2.stroke = am4core.color(matchingGrade.color);
    label.fill = am4core.color(matchingGrade.color);
    })
    */
          /*
    setInterval(function() {
    var value = chartMin + Math.random() * (chartMax - chartMin);
    hand.showValue(value, 1000, am4core.ease.cubicOut);
    }, 2000);
    */
        }

        utilityPointTotal()
          .then(utilityLineTotal)
          .then(utilityPointCompleted)
          .then(utilityLineCompleted)
          .then(utilityChart);
      }); // end am4core.ready()
    });
  </script>
</html>