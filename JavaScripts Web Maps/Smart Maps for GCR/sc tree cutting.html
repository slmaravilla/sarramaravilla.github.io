<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
    <title>Tree Cutting (SC)</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.28/"></script>
</head>
<style>
    html,
    body,
    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
    }

    body {
        display: flex;
    }

    #header-title {
        margin-left: 1rem;
        margin-right: 1rem;
    }

    #info-content {
        padding: 0.75rem;
    }

    #item-description b {
        color: orange;
    }

    calcite-loader {
        align-self: center;
        justify-self: center;
    }

    calcite-label {
        --calcite-label-margin-bottom: 0px;
    }

    #container {
        display: grid;
        flex-wrap: wrap;
        box-sizing: border-box;
        grid-template-columns: 1fr 0.25fr;
        width: 100%;
        height: 100%;
    }

    calcite-tabs {
        width: 100%;
        height: 100%;
    }

    #chartPanel {
        background-color: rgb(0, 0, 0, 0);
        padding: 8;
        width: 100%;
        height: 100%;
    }

    calcite-rating {
        margin-top: 0.25rem;
    }

    #header {
        display: flex;
        padding: 0 1rem;
        padding-bottom: 0.7rem;
        background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
        display: flex;
        margin-inline-start: auto;
        align-self: center;
        vertical-align: middle;
    }

    .label-wrapper {
        display: flex;
        margin-inline: 1rem;
        padding: 0.5rem;
        border: 1px solid var(--calcite-ui-border-1);
        cursor: pointer;
    }

    #dateDiv {
        font-size: 0.85vw;
        text-align: right;
        display: flex;
        align-items: flex-end;
        font-weight: bold;
    }

    #dropdownDiv {
        background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: black;
        text-align: right;
        margin: auto;
        color: white;
    }


    #treeCuttingNumberDiv,
    #treeCompensationNumberDiv,
    #treeConservationNumberDiv {
        color: rgb(0, 197, 255);
        text-align: center;
        font-weight: normal;
        font-size: 1.6vw;
        border: solid 0.5px gray;
        padding-top: 2%;
        padding-bottom: 4%;
        margin: 3% auto;
        width: 80%;
    }

    #treeCuttingNumberDiv p,
    #treeCompensationNumberDiv p,
    #treeConservationNumberDiv p {
        font-size: 1.1rem;
        font-weight: bold;
        color: rgb(250, 246, 246);
        margin: auto;
        text-align: center;
        padding-bottom: 5%;
    }

    #toggle-cluster,
    #toggle-cluster2,
    #toggle-cluster3 {
        width: 70%;
        margin: auto;
        margin-top: 20%;
    }

    #treeCuttingDiv,
    #treeCompensationDiv,
    #treeConservationDiv {
        height: 50vh;
        align-items: center;
        margin-bottom: 1vw;
    }

    p {
        color: red;
        text-align: left;
        font-weight: bold;
        font-size: 0.5rem;
    }

    h2 {
        font-weight: 400;
        font-style: normal;
        font-size: 2vw;
        color: white;
        padding: 3px;
        margin: 0px;
        vertical-align: text-top;
    }

    h5 {
        color: rgb(0, 197, 255);
        text-align: left;
        font-weight: normal;
        font-size: 14px;
        padding: 0;
        margin: 0;
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }

    .esri-icon-non-visible::before {
        content: '\e610' !important;
        color: #969696 !important;
    }

    .esri-icon-visible::before {
        content: '\e611' !important;
        background-color: #11a7fd;
        color: white !important;
    }

    .esri-view .esri-view-surface--touch-none:focus::after {
        outline: none !important;
    }
</style>

<body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
        <!--  Header slot  -->
        <div slot="header" id="header">
            <!-- Title -->
            <h2 id="header-title" slot="header"></h2>
            <div id="dateDiv">October 23, 2023</div>

            <!-- Dropdown Lists -->
            <div id="dropdownDiv" class="esri-widget">
                <label id="dropdownContractPackageLabel">
                    CP:
                    <select id="packageSelect" class="esri-widget"></select>
                </label>
            </div>
        </div>
        <!-- Icon -->
        <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
        <calcite-shell-panel slot="panel-start" display-mode="float" detached>
            <calcite-action-bar slot="action-bar">
                <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
                <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
                <calcite-action data-action-id="locate" icon="gps-on-f" text="My Location"></calcite-action>
                <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>

            <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
            <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
                <div id="layers-container"></div>
            </calcite-panel>
            <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
                <div id="basemaps-container"></div>
            </calcite-panel>
            <calcite-panel heading="Click the icon below" width-scale="w" data-panel-id="locate" hidden>
                <div id="locate-container"></div>
            </calcite-panel>

            <!-- Info panel (populates with info from the web map) -->
            <calcite-panel heading="Description" data-panel-id="information" hidden>
                <div id="info-content">
                    <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                    <div id="item-description">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </calcite-panel>
        </calcite-shell-panel>

        <div id="container">
            <div id="viewDiv"></div>
            <calcite-tabs>
                <div id="chartPanel">
                    <calcite-tab-nav slot="tab-nav" id="thetabs">
                        <calcite-tab-title class="Cutting" selected>Cutting</calcite-tab-title>
                        <calcite-tab-title class="Compensation">Compensation</calcite-tab-title>
                        <calcite-tab-title class="Conservation">Conservation</calcite-tab-title>
                    </calcite-tab-nav>
                    <calcite-tab>
                        <div id="treeCuttingNumberDiv"></div>
                        <div class="boxCut" id="treeCuttingDiv"></div>
                        <button id="toggle-cluster" class="esri-button" type="button">Disable Clustering</button>
                    </calcite-tab>
                    <calcite-tab>
                        <div id="treeCompensationNumberDiv"></div>
                        <div class="boxCompen" id="treeCompensationDiv"></div>
                        <button id="toggle-cluster2" class="esri-button" type="button">Disable Clustering</button>
                    </calcite-tab>
                    <calcite-tab>
                        <div id="treeConservationNumberDiv"></div>
                        <div class="boxConserve" id="treeConservationDiv"></div>
                        <button id="toggle-cluster3" class="esri-button" type="button">Disable Clustering</button>
                    </calcite-tab>
                </div>
            </calcite-tabs>
        </div>
    </calcite-shell>
</body>
<script>
    require([
        "esri/Basemap",
        "esri/Map",
        "esri/views/MapView",
        "esri/views/SceneView",
        "esri/layers/FeatureLayer",
        "esri/layers/support/FeatureFilter",
        "esri/layers/SceneLayer",
        "esri/layers/Layer",
        "esri/layers/TileLayer",
        "esri/layers/VectorTileLayer",
        "esri/layers/support/LabelClass",
        "esri/symbols/LabelSymbol3D",
        "esri/WebMap",
        "esri/WebScene",
        "esri/portal/PortalItem",
        "esri/portal/Portal",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/widgets/Fullscreen",
        "esri/rest/geometryService",
        "esri/rest/support/Query",
        "esri/rest/support/StatisticDefinition",
        "esri/symbols/WebStyleSymbol",
        "esri/widgets/Expand",
        "esri/widgets/Editor",
        "esri/renderers/UniqueValueRenderer",
        "esri/layers/support/Sublayer",
        "esri/widgets/Search",
        "esri/widgets/Compass",
        "esri/smartMapping/labels/clusters",
        "esri/smartMapping/popup/clusters",
        "esri/widgets/Locate",
        "esri/widgets/BasemapGallery",
        "esri/layers/GroupLayer"
    ], function (
        Basemap,
        Map,
        MapView,
        SceneView,
        FeatureLayer,
        FeatureFilter,
        SceneLayer,
        Layer,
        TileLayer,
        VectorTileLayer,
        LabelClass,
        LabelSymbol3D,
        WebMap,
        WebScene,
        PortalItem,
        Portal,
        Legend,
        LayerList,
        Fullscreen,
        geometryService,
        Query,
        StatisticDefinition,
        WebStyleSymbol,
        Expand,
        Editor,
        UniqueValueRenderer,
        Sublayer,
        Search,
        Compass,
        clusterLabelCreator,
        clusterPopupCreator,
        Locate,
        BasemapGallery,
        GroupLayer
    ) {
        var highlightSelect;

        var basemap = new Basemap({
            baseLayers: [
                new VectorTileLayer({
                    portalItem: {
                        id: "8a9ef2a144e8423786f6139408ac3424", // 3a62040541b84f528da3ac7b80cf4a63
                    },
                }),
            ],
        });

        var map = new Map({
            basemap: basemap, // "streets-night-vector",
            ground: "world-elevation",
        });

        var view = new MapView({
            map: map,
            center: [120.99, 14.4],
            zoom: 10,
            container: "viewDiv",
            environment: {
                background: {
                    type: "color", // autocasts as new ColorBackground()
                    color: [0, 0, 0, 1],
                },
            },
        });
        view.ui.components = [];



        ///////------------ Renderer----------- //////

        // Tree Cutting
        function colorsCut() {
            return {
                1: [113, 171, 72, 0.8],
                2: [0, 115, 255, 0.8],
                3: [255, 255, 0, 0.8],
                4: [255, 170, 0, 0.8],
                5: [255, 0, 0, 0.8],
            };
        }

        const outlineColor = "gray";

        let treeCuttingRenderer = {
            type: "unique-value",
            field: "Status",
            uniqueValueInfos: [
                {
                    value: 1,
                    label: "Cut/Earthballed",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCut()[1], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 2,
                    label: "Permit Acquired",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCut()[3], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 3,
                    label: "Submitted to DENR",
                    symbol: {
                        type: "simple-marker",
                        size: 4,
                        color: colorsCut()[4], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 4,
                    label: "Ongoing Acquisition of Application Documents",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCut()[5], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
            ],
        };


        // Tree Compensation
        function colorsCompen() {
            return {
                1: [0, 112, 255, 0.8],
                2: [255, 255, 0, 0.8],
                3: [113, 171, 72, 0.8],
            };
        }

        let treeCompensationRenderer = {
            type: "unique-value",
            field: "Compensation",
            uniqueValueInfos: [
                {
                    value: 1,
                    label: "Non-Compensable",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCompen()[1], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 2,
                    label: "For Processing",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCompen()[2], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 3,
                    label: "Compensated",
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: colorsCompen()[3], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
            ],
        };


        // Tree Conservation
        const colors = [
            "#9e0142",
            "#d53e4f",
            "#f46d43",
            "#fdae61",
            "#fee08b",
            "#e6f598",
            "#abdda4",
            "#66c2a5",
            "#3288bd",
            "#5e4fa2",
            "#ffffff",
            "#44555a",
        ];

        let treeConservationRenderer = {
            type: "unique-value",
            field: "Conservation",
            uniqueValueInfos: [
                {
                    value: 1,
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[0], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 2,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[1], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 3,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[2], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 4,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[3], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 5,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[4], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 6,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[5], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 7,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[6], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 8,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[7], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 9,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[8], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 10,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[9], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 11,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[10], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
                {
                    value: 12,
                    style: "triangle",
                    symbol: {
                        type: "simple-marker",
                        style: "triangle",
                        size: 5,
                        color: colors[11], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor,
                        },
                    },
                },
            ],
        };


        ///////------------ Importing Layers ----------- //////

        //----- Station Point Layer -----//

        var labelStation = new LabelClass ({
            labelExpressionInfo: {expression: "$feature.Station"},
            symbol: {
                type: "text",
                color: "black",
                haloColor: "white",
                haloSize: 1,
                font: {
                    family: "Arial",
                    size: 9,
                    //weight: "bold"
                }
            },
            labelPlacement: "center-right",
        });

        var stationLayer = new FeatureLayer({
            portalItem: {
                id: "299f80a1d0844e109dcf354f9463f6b4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            title: "SC Stations",
            layerId: 2,
            labelingInfo: [labelStation],
        });
        stationLayer.listMode = "hide";
        map.add(stationLayer);
        stationLayer.visible = true;


        //----- Chainage Layer -----//
        // Label Class
        var labelChainage = new LabelClass({
            labelExpressionInfo: { expression: "$feature.KmSpot" },
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 11,
                    weight: "bold",
                },
            },
        });
        // Renderer
        var chainageRenderer = {
            type: "simple",
            symbol: {
                type: "simple-marker",
                size: 5,
                color: [255, 255, 255, 0.9],
                outline: {
                    width: 0.2,
                    color: "black",
                },
            },
        };
        // Import chainage layer
        var chainageLayer = new FeatureLayer({
            portalItem: {
                id: "299f80a1d0844e109dcf354f9463f6b4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 5,
            title: "Chainage",
            elevationInfo: {
                mode: "relative-to-ground",
            },
            labelingInfo: [labelChainage],
            renderer: chainageRenderer,
            outFields: ["*"],
            popupEnabled: false,
            minScale: 150000,
            maxScale: 0,
        });
        //chainageLayer.listMode = "hide";
        map.add(chainageLayer);


        //----- PROW-----//
        var rowLayer = new FeatureLayer({
            portalItem: {
                id: "299f80a1d0844e109dcf354f9463f6b4",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            title: "ROW",
            definitionExpression: "Extension = 'SC'",
            popupEnabled: false,
        });
        rowLayer.listMode = "hide";
        map.add(rowLayer, 0);


        //----- Tree Cutting Layer-----//
        var treeCuttingLayer = new FeatureLayer({
            portalItem: {
                id: "5eae7c0082e54d5fad5e98128c243998",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            elevationInfo: {
                mode: "on-the-ground",
            },
            outFields: ["*"],
            title: "Status of Tree Cutting",
            renderer: treeCuttingRenderer,
            popupTemplate: {
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "ScientificName",
                                label: "Scientific Name",
                            },
                            {
                                fieldName: "CommonName",
                                label: "Common Name",
                            },
                            {
                                fieldName: "Province",
                            },
                            {
                                fieldName: "Municipality",
                            },
                            {
                                fieldName: "TreeNo",
                                label: "Tree No.",
                            },
                            {
                                fieldName: "CP",
                                label: "<h5>CP</h5>",
                            },
                            {
                                fieldName: "Compensation",
                                label: "Status of Tree Compensation",
                            },
                            {
                                fieldName: "Conservation",
                                label: "Conservation Status",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(treeCuttingLayer, 2);

        //----- Tree Compensation Layer-----//
        var compensationLayer = new FeatureLayer({
            portalItem: {
                id: "5eae7c0082e54d5fad5e98128c243998",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            title: "Status of Tree Compensation",
            renderer: treeCompensationRenderer,
            popupTemplate: {
                title: "<h5>{Compensation}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "ScientificName",
                                label: "Scientific Name",
                            },
                            {
                                fieldName: "CommonName",
                                label: "Common Name",
                            },
                            {
                                fieldName: "Province",
                            },
                            {
                                fieldName: "Municipality",
                            },
                            {
                                fieldName: "TreeNo",
                                label: "Tree No.",
                            },
                            {
                                fieldName: "CP",
                                label: "<h5>CP</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "Status of Tree Cutting",
                            },
                            {
                                fieldName: "Conservation",
                                label: "Conservation Status",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(compensationLayer, 2);

        //----- Tree Conservation Layer-----//
        var conservationLayer = new FeatureLayer({
            portalItem: {
                id: "5eae7c0082e54d5fad5e98128c243998",
                portal: {
                    url: "https://gis.railway-sector.com/portal",
                },
            },
            layerId: 1,
            outFields: ["*"],
            title: "Tree Conservation",
            renderer: treeConservationRenderer,
            popupTemplate: {
                title: "<h5>{Conservation}</h5>",
                lastEditInfoEnabled: false,
                returnGeometry: true,
                content: [
                    {
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "ScientificName",
                                label: "Scientific Name",
                            },
                            {
                                fieldName: "CommonName",
                                label: "Common Name",
                            },
                            {
                                fieldName: "Province",
                            },
                            {
                                fieldName: "Municipality",
                            },
                            {
                                fieldName: "TreeNo",
                                label: "Tree No.",
                            },
                            {
                                fieldName: "CP",
                                label: "<h5>CP</h5>",
                            },
                            {
                                fieldName: "Status",
                                label: "Status of Tree Cutting",
                            },
                            {
                                fieldName: "Compensation",
                                label: "Status of Tree Compensation",
                            },
                        ],
                    },
                ],
            },
        });
        map.add(conservationLayer, 2);



        // Point clustering
        treeCuttingLayer.featureReduction = {
            type: "cluster",
            clusterMinSize: 16.5,
            labelingInfo: [
                {
                    deconflictionStrategy: "none",
                    labelExpressionInfo: {
                        expression: "Text($feature.cluster_count, '#,###')",
                    },
                    symbol: {
                        type: "text",
                        color: "white",
                        font: {
                            family: "Noto Sans",
                            size: 12,
                        },
                    },
                    labelPlacement: "center-center",
                },
            ],
            popupTemplate: {
                title: "Cluster Summary",
                content: "This cluster represents <b>{cluster_count}</b> features.",
                fieldInfos: [
                    {
                        fieldName: "cluster_count",
                        format: {
                            places: 0,
                            digitSeparator: true,
                        },
                    },
                ],
            },
        };

        compensationLayer.featureReduction = {
            type: "cluster",
            clusterMinSize: 16.5,
            labelingInfo: [
                {
                    deconflictionStrategy: "none",
                    labelExpressionInfo: {
                        expression: "Text($feature.cluster_count, '#,###')",
                    },
                    symbol: {
                        type: "text",
                        color: "white",
                        font: {
                            family: "Noto Sans",
                            size: 12,
                        },
                    },
                    labelPlacement: "center-center",
                },
            ],
            popupTemplate: {
                title: "Cluster Summary",
                content: "This cluster represents <b>{cluster_count}</b> features.",
                fieldInfos: [
                    {
                        fieldName: "cluster_count",
                        format: {
                            places: 0,
                            digitSeparator: true,
                        },
                    },
                ],
            },
        };

        conservationLayer.featureReduction = {
            type: "cluster",
            clusterMinSize: 16.5,
            labelingInfo: [
                {
                    deconflictionStrategy: "none",
                    labelExpressionInfo: {
                        expression: "Text($feature.cluster_count, '#,###')",
                    },
                    symbol: {
                        type: "text",
                        color: "white",
                        font: {
                            family: "Noto Sans",
                            size: 12,
                        },
                    },
                    labelPlacement: "center-center",
                },
            ],
            popupTemplate: {
                title: "Cluster Summary",
                content: "This cluster represents <b>{cluster_count}</b> features.",
                fieldInfos: [
                    {
                        fieldName: "cluster_count",
                        format: {
                            places: 0,
                            digitSeparator: true,
                        },
                    },
                ],
            },
        };


        //**** ---- Group Layers ---- ***///

        const alignmentGroupLayer = new GroupLayer({
            title: "Alignment",
            visible: true,
            visibilityMode: "independent",
            layers: [rowLayer, chainageLayer]
        });


        const treeStatusGroupLayer = new GroupLayer({
            title: "Tree Status",
            visible: true,
            visibilityMode: "independent",
            layers: [conservationLayer, compensationLayer, treeCuttingLayer]
        });


        map.add(treeStatusGroupLayer);
        map.add(alignmentGroupLayer);

        ///// END OF IMPORTING LAYERS




        //*******************************//
        //      Progress Chart           //
        //*******************************//

        ///-------- Function for zooming to selected layers ----------///
        function zoomToLayer(layer) {
            return layer.queryExtent().then(function (response) {
                view
                    .goTo(response.extent, {
                        //response.extent
                        speedFactor: 2,
                    })
                    .catch(function (error) {
                        if (error.name != "AbortError") {
                            console.error(error);
                        }
                    });
            });
        }
        

        am5.ready(function () {
            const LEGEND_FONT_SIZE = "0.9em";

            ///-------- Pie Chart for Tree Cutting ----------///
            var root = am5.Root.new("treeCuttingDiv");
            root._logo.dispose();
            const treeCutStatus = [
                "Cut/Earthballed",
                "Permit Acquired",
                "Submitted to DENR",
                "Ongoing Acquisition of Application Documents",
            ];

            function updateChartCutting(selectedCP) {
                root.container.children.clear();

                var total_cutearthb = {
                    onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_cutearthb",
                    statisticType: "sum",
                };

                var total_permit = {
                    onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_permit",
                    statisticType: "sum",
                };

                var total_denr = {
                    onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_denr",
                    statisticType: "sum",
                };

                var total_ongoing = {
                    onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_ongoing",
                    statisticType: "sum",
                };

                var query = treeCuttingLayer.createQuery();
                query.outStatistics = [
                    total_cutearthb,
                    total_permit,
                    total_denr,
                    total_ongoing,
                ];
                query.returnGeometry = true;

                treeCuttingLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const cutEarthb = stats.total_cutearthb;
                    const permit = stats.total_permit;
                    const denr = stats.total_denr;
                    const ongoing = stats.total_ongoing;


                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root.setThemes([
                        am5themes_Animated.new(root),
                        am5themes_Responsive.new(root),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root.container.children.push(
                        am5percent.PieChart.new(root, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(85), // outer radius
                            innerRadius: am5.percent(40),
                            scale: 0.8,
                        })
                    );

                    // Set data
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                    //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        templateField: "sliceSettings",
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    //pieSeries.appear(1000, 100)
                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        if (SELECTED == treeCutStatus[0]) {
                            selectedStatus = 1;
                        } else if (SELECTED == treeCutStatus[1]) {
                            selectedStatus = 2;
                        } else if (SELECTED == treeCutStatus[2]) {
                            selectedStatus = 3;
                        } else if (SELECTED == treeCutStatus[3]) {
                            selectedStatus = 4;
                        } else {
                            selectedStatus = null;
                        }

                        view.when(function () {
                            view.whenLayerView(treeCuttingLayer).then(function (layerView) {

                                var query = treeCuttingLayer.createQuery();
                                query.where = "Status =" + selectedStatus;
                                treeCuttingLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });
                                    treeCuttingLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures

                                layerView.filter = {
                                    where: "Status = " + selectedStatus,
                                }

                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: treeCutStatus[0],
                            value: cutEarthb,
                            sliceSettings: {
                                fill: am5.color("#71AB48"),
                            },
                        },
                        {
                            category: treeCutStatus[1],
                            value: permit,
                            sliceSettings: {
                                fill: am5.color("#FFFF00"),
                            },
                        },
                        {
                            category: treeCutStatus[2],
                            value: denr,
                            sliceSettings: {
                                fill: am5.color("#FFAA00"),
                            },
                        },
                        {
                            category: treeCutStatus[3],
                            value: ongoing,
                            sliceSettings: {
                                fill: am5.color("#FF0000"),
                            },
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    // To align legend items: valueLabels right, labels to left
                    // 1. fix width of valueLabels
                    // 2. dynamically change width of labels by screen size

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".boxCut");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 180);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 2,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateChartCutting



            ///-------- Pie Chart for Tree Compensation ----------///

            var root2 = am5.Root.new("treeCompensationDiv");
            root2._logo.dispose();
            const treeCompen = ["Non-Compensable", "For Processing", "Compensated"];

            function updateChartTreeComp() {
                root2.container.children.clear();
                root2._logo.dispose();

                var total_noncompen = {
                    onStatisticField: "CASE WHEN Compensation = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_noncompen",
                    statisticType: "sum",
                };

                var total_processing = {
                    onStatisticField: "CASE WHEN Compensation = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_processing",
                    statisticType: "sum",
                };

                var total_comp = {
                    onStatisticField: "CASE WHEN Compensation = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_comp",
                    statisticType: "sum",
                };

                var query = compensationLayer.createQuery();
                query.outStatistics = [total_noncompen, total_processing, total_comp];
                query.returnGeometry = true;

                compensationLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const nonComp = stats.total_noncompen;
                    const processing = stats.total_processing;
                    const compensated = stats.total_comp;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root2.setThemes([
                        am5themes_Animated.new(root2),
                        am5themes_Responsive.new(root2),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root2.container.children.push(
                        am5percent.PieChart.new(root2, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root2.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root2, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(85), // outer radius
                            innerRadius: am5.percent(40),
                            scale: 0.8,
                        })
                    );

                    // Set data
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                    //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        templateField: "sliceSettings",
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    //pieSeries.appear(1000, 100)
                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        if (SELECTED == treeCompen[0]) {
                            selectedStatus = 1;
                        } else if (SELECTED == treeCompen[1]) {
                            selectedStatus = 2;
                        } else if (SELECTED == treeCompen[2]) {
                            selectedStatus = 3;
                        } else {
                            selectedStatus = null;
                        }

                        view.when(function () {
                            view.whenLayerView(compensationLayer).then(function (layerView) {

                                var query = compensationLayer.createQuery();
                                query.where = "Compensation =" + selectedStatus;
                                compensationLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });
                                    compensationLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures
                                layerView.filter = {
                                    where: "Compensation = " + selectedStatus,
                                };
                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: treeCompen[0],
                            value: nonComp,
                            sliceSettings: {
                                fill: am5.color("#0070FF"),
                            },
                        },
                        {
                            category: treeCompen[1],
                            value: processing,
                            sliceSettings: {
                                fill: am5.color("#FFFF00"),
                            },
                        },
                        {
                            category: treeCompen[2],
                            value: compensated,
                            sliceSettings: {
                                fill: am5.color("#71AB48"),
                            },
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root2, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root2.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    // To align legend items: valueLabels right, labels to left
                    // 1. fix width of valueLabels
                    // 2. dynamically change width of labels by screen size

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".boxCompen");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 180);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 2,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateChartTreeComp



            ///-------- Pie Chart for Tree Conservation ----------///
            var root3 = am5.Root.new("treeConservationDiv");
            root3._logo.dispose();
            const treeConserveStatus = [
                "Ex",
                "Ew",
                "CR",
                "E",
                "VU",
                "NT",
                "LC",
                "DD",
                "NE",
                "OTS",
                "NL",
                "EN",
            ];

            function updateChartTreeConservation() {
                root3.container.children.clear();

                var total_ex = {
                    onStatisticField: "CASE WHEN Conservation = 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_ex",
                    statisticType: "sum",
                };

                var total_ew = {
                    onStatisticField: "CASE WHEN Conservation = 2 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_ew",
                    statisticType: "sum",
                };

                var total_cr = {
                    onStatisticField: "CASE WHEN Conservation = 3 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_cr",
                    statisticType: "sum",
                };

                var total_e = {
                    onStatisticField: "CASE WHEN Conservation = 4 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_e",
                    statisticType: "sum",
                };

                var total_vu = {
                    onStatisticField: "CASE WHEN Conservation = 5 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_vu",
                    statisticType: "sum",
                };

                var total_nt = {
                    onStatisticField: "CASE WHEN Conservation = 6 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_nt",
                    statisticType: "sum",
                };

                var total_lc = {
                    onStatisticField: "CASE WHEN Conservation = 7 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_lc",
                    statisticType: "sum",
                };

                var total_dd = {
                    onStatisticField: "CASE WHEN Conservation = 8 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_dd",
                    statisticType: "sum",
                };

                var total_ne = {
                    onStatisticField: "CASE WHEN Conservation = 9 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_ne",
                    statisticType: "sum",
                };

                var total_ots = {
                    onStatisticField: "CASE WHEN Conservation = 10 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_ots",
                    statisticType: "sum",
                };

                var total_nl = {
                    onStatisticField: "CASE WHEN Conservation = 11 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_nl",
                    statisticType: "sum",
                };

                var total_en = {
                    onStatisticField: "CASE WHEN Conservation = 12 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_en",
                    statisticType: "sum",
                };

                var query = conservationLayer.createQuery();
                query.outStatistics = [
                    total_ex,
                    total_ew,
                    total_cr,
                    total_e,
                    total_vu,
                    total_nt,
                    total_lc,
                    total_dd,
                    total_ne,
                    total_ots,
                    total_nl,
                    total_en,
                ];
                query.returnGeometry = true;

                conservationLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;

                    const cons_ex = stats.total_ex;
                    const cons_ew = stats.total_ew;
                    const cons_cr = stats.total_cr;
                    const cons_e = stats.total_e;
                    const cons_vu = stats.total_vu;
                    const cons_nt = stats.total_nt;
                    const cons_lc = stats.total_lc;
                    const cons_dd = stats.total_dd;
                    const cons_ne = stats.total_ne;
                    const cons_ots = stats.total_ots;
                    const cons_nl = stats.total_nl;
                    const cons_en = stats.total_en;

                    // Set themes
                    // https://www.amcharts.com/docs/v5/concepts/themes/
                    root3.setThemes([
                        am5themes_Animated.new(root3),
                        am5themes_Responsive.new(root3),
                    ]);

                    // Create chart
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
                    var chart = root3.container.children.push(
                        am5percent.PieChart.new(root3, {
                            //centerY: am5.percent(-2), //-10
                            //y: am5.percent(-30), // -30
                            layout: root3.verticalLayout,
                        })
                    );

                    // Create series
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
                    var pieSeries = chart.series.push(
                        am5percent.PieSeries.new(root3, {
                            name: "Series",
                            categoryField: "category",
                            valueField: "value",
                            //legendLabelText: "[{fill}]{category}[/]",
                            legendValueText:
                                "{valuePercentTotal.formatNumber('#.')}% ({value})",
                            radius: am5.percent(85), // outer radius
                            innerRadius: am5.percent(40),
                            scale: 0.8,
                        })
                    );

                    // Set data
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
                    //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

                    // Set slice opacity and stroke color
                    pieSeries.slices.template.setAll({
                        fillOpacity: 0.9,
                        stroke: am5.color("#ffffff"),
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        templateField: "sliceSettings",
                    });

                    // Disabling labels and ticks
                    pieSeries.labels.template.set("visible", false);
                    pieSeries.ticks.template.set("visible", false);

                    //pieSeries.appear(1000, 100)
                    pieSeries.slices.template.events.on("click", function (ev) {
                        const SELECTED = ev.target.dataItem.dataContext.category;
                        console.log(SELECTED);
                        if (SELECTED == treeConserveStatus[0]) {
                            selectedStatus = 1;
                        } else if (SELECTED == treeConserveStatus[1]) {
                            selectedStatus = 2;
                        } else if (SELECTED == treeConserveStatus[2]) {
                            selectedStatus = 3;
                        } else if (SELECTED == treeConserveStatus[3]) {
                            selectedStatus = 4;
                        } else if (SELECTED == treeConserveStatus[4]) {
                            selectedStatus = 5;
                        } else if (SELECTED == treeConserveStatus[5]) {
                            selectedStatus = 6;
                        } else if (SELECTED == treeConserveStatus[6]) {
                            selectedStatus = 7;
                        } else if (SELECTED == treeConserveStatus[7]) {
                            selectedStatus = 8;
                        } else if (SELECTED == treeConserveStatus[8]) {
                            selectedStatus = 9;
                        } else if (SELECTED == treeConserveStatus[9]) {
                            selectedStatus = 10;
                        } else if (SELECTED == treeConserveStatus[10]) {
                            selectedStatus = 11;
                        } else if (SELECTED == treeConserveStatus[11]) {
                            selectedStatus = 12;
                        } else {
                            selectedStatus = null;
                        }

                        view.when(function () {
                            view.whenLayerView(conservationLayer).then(function (layerView) {

                                var query = conservationLayer.createQuery();
                                query.where = "Conservation =" + selectedStatus;
                                conservationLayer.queryFeatures(query).then(function (results) {
                                    const RESULT_LENGTH = results.features;
                                    const ROW_N = RESULT_LENGTH.length;

                                    let objID = [];
                                    for (var i = 0; i < ROW_N; i++) {
                                        var obj = results.features[i].attributes.OBJECTID;
                                        objID.push(obj);
                                    }

                                    console.log(objID);

                                    var queryExt = new Query({
                                        objectIds: objID,
                                    });

                                    conservationLayer
                                        .queryExtent(queryExt)
                                        .then(function (result) {
                                            if (result.extent) {
                                                view.goTo(result.extent);
                                            }
                                        });

                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = layerView.highlight(objID);

                                    view.on("click", function () {
                                        layerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of queryFeatures
                                layerView.filter = {
                                    where: "Conservation = " + selectedStatus,
                                };
                            }); // End of view.whenLayerView
                        }); // End of view.when
                    });

                    pieSeries.data.setAll([
                        {
                            category: treeConserveStatus[0],
                            value: cons_ex,
                            sliceSettings: {
                                fill: am5.color(colors[0]),
                            },
                        },
                        {
                            category: treeConserveStatus[1],
                            value: cons_ew,
                            sliceSettings: {
                                fill: am5.color(colors[1]),
                            },
                        },
                        {
                            category: treeConserveStatus[2],
                            value: cons_cr,
                            sliceSettings: {
                                fill: am5.color(colors[2]),
                            },
                        },
                        {
                            category: treeConserveStatus[3],
                            value: cons_e,
                            sliceSettings: {
                                fill: am5.color(colors[3]),
                            },
                        },
                        {
                            category: treeConserveStatus[4],
                            value: cons_vu,
                            sliceSettings: {
                                fill: am5.color(colors[4]),
                            },
                        },
                        {
                            category: treeConserveStatus[5],
                            value: cons_nt,
                            sliceSettings: {
                                fill: am5.color(colors[5]),
                            },
                        },
                        {
                            category: treeConserveStatus[6],
                            value: cons_lc,
                            sliceSettings: {
                                fill: am5.color(colors[6]),
                            },
                        },
                        {
                            category: treeConserveStatus[7],
                            value: cons_dd,
                            sliceSettings: {
                                fill: am5.color(colors[7]),
                            },
                        },
                        {
                            category: treeConserveStatus[8],
                            value: cons_ne,
                            sliceSettings: {
                                fill: am5.color(colors[8]),
                            },
                        },
                        {
                            category: treeConserveStatus[9],
                            value: cons_ots,
                            sliceSettings: {
                                fill: am5.color(colors[9]),
                            },
                        },
                        {
                            category: treeConserveStatus[10],
                            value: cons_nl,
                            sliceSettings: {
                                fill: am5.color(colors[10]),
                            },
                        },
                        {
                            category: treeConserveStatus[11],
                            value: cons_en,
                            sliceSettings: {
                                fill: am5.color(colors[11]),
                            },
                        },
                    ]);

                    // Legend
                    // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
                    var legend = chart.children.push(
                        am5.Legend.new(root3, {
                            centerX: am5.percent(50),
                            x: am5.percent(50),
                            layout: root3.verticalLayout,
                            marginBottom: 10,
                        })
                    );
                    legend.data.setAll(pieSeries.dataItems);

                    // Change the size of legend markers
                    legend.markers.template.setAll({
                        width: 18,
                        height: 18,
                        strokeWidth: 1,
                        strokeOpacity: 1,
                        stroke: am5.color("#ffffff"),
                    });

                    // Change the marker shape
                    legend.markerRectangles.template.setAll({
                        cornerRadiusTL: 10,
                        cornerRadiusTR: 10,
                        cornerRadiusBL: 10,
                        cornerRadiusBR: 10,
                    });

                    // To align legend items: valueLabels right, labels to left
                    // 1. fix width of valueLabels
                    // 2. dynamically change width of labels by screen size

                    const valueLabelsWidth = 50;

                    // Responsive legend
                    // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
                    chart.onPrivate("width", function (width) {
                        let box = document.querySelector(".boxConserve");
                        const boxWidth = box.offsetWidth;
                        var availableSpace = Math.max(width - chart.width() - 150, 160);
                        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                        legend.labels.template.setAll({
                            width: availableSpace,
                            maxWidth: availableSpace,
                        });
                    });

                    // Change legend labelling properties
                    // To have responsive font size, do not set font size
                    legend.labels.template.setAll({
                        oversizedBehavior: "truncate",
                        fill: am5.color("#ffffff"),
                        //textDecoration: "underline"
                        //width: am5.percent(200)
                        //fontWeight: "300"
                    });

                    legend.valueLabels.template.setAll({
                        textAlign: "right",
                        width: valueLabelsWidth,
                        fill: am5.color("#ffffff"),
                        //fontSize: LEGEND_FONT_SIZE,
                    });

                    legend.itemContainers.template.setAll({
                        // set space between legend items
                        paddingTop: 1.1,
                        paddingBottom: 2,
                    });

                    pieSeries.appear(1000, 100);
                }); // End of queryFeatures
            } // End of updateChartTreeConservation


            // Default
            treeCuttingLayer.visible = true;
            compensationLayer.visible = false;
            conservationLayer.visible = false;
            updateChartCutting();
            totalNumberTreeCut();


            ///-------- TOTAL NUMBER OF TREES ----------///

            // Thousand separators function
            function thousands_separators(num) {
                var num_parts = num.toString().split(".");
                num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return num_parts.join(".");
            }

            // Total number of tree
            function totalNumberTreeCut() {
                var total_number_cutting = {
                    onStatisticField: "CASE WHEN Status >= 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_number_cutting",
                    statisticType: "sum",
                };

                var query = treeCuttingLayer.createQuery();
                query.outStatistics = [total_number_cutting];
                query.returnGeometry = true;

                treeCuttingLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const total = thousands_separators(stats.total_number_cutting);
                    document.getElementById(
                        "treeCuttingNumberDiv"
                    ).innerHTML = `<p>Number of Trees</p>${total}`;
                    //`<b>Number of Trees</b><br>${total}`
                });
            }

            function totalNumberTreeCompen() {
                var total_number_compen = {
                    onStatisticField: "CASE WHEN Compensation >= 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_number_compen",
                    statisticType: "sum",
                };

                var query = compensationLayer.createQuery();
                query.outStatistics = [total_number_compen];
                query.returnGeometry = true;

                compensationLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const total = thousands_separators(stats.total_number_compen);
                    document.getElementById(
                        "treeCompensationNumberDiv"
                    ).innerHTML = `<p>Number of Trees</p>${total}`;
                    //`<b>Number of Trees</b><br>${total}`
                });
            }

            function totalNumberTreeConservation() {
                var total_number_conservation = {
                    onStatisticField: "CASE WHEN Compensation >= 1 THEN 1 ELSE 0 END",
                    outStatisticFieldName: "total_number_conservation",
                    statisticType: "sum",
                };

                var query = conservationLayer.createQuery();
                query.outStatistics = [total_number_conservation];
                query.returnGeometry = true;

                conservationLayer.queryFeatures(query).then(function (response) {
                    var stats = response.features[0].attributes;
                    const total = thousands_separators(stats.total_number_conservation);
                    document.getElementById(
                        "treeConservationNumberDiv"
                    ).innerHTML = `<p>Number of Trees</p>${total}`;
                    //`<b>Number of Trees</b><br>${total}`
                });
            }


            ///----------------- DROPDOWN LIST ------------------///

            var packageSelect = document.getElementById("packageSelect");

            view
                .when(function () {
                    return treeCuttingLayer.when(function () {
                        var query = treeCuttingLayer.createQuery();
                        return treeCuttingLayer.queryFeatures(query);
                    });
                })
                .then(getValues)
                .then(getUniqueValues)
                .then(addToSelect);

            function queryTreeGeometries() {
                var treeQuery = treeCuttingLayer.createQuery();

                return treeCuttingLayer
                    .queryFeatures(treeQuery)
                    .then(function (response) {
                        treeGeometries = response.features.map(function (feature) {
                            return feature.geometry;
                        });
                        return treeGeometries;
                    });
            }

            // 1. Contract Package:--------------------------------
            function getValues(response) {
                var features = response.features;
                var values = features.map(function (feature) {
                    return feature.attributes.CP;
                });
                return values;
            }

            // Return an array of unique values in the 'Municipality' field of the lot Layer
            function getUniqueValues(values) {
                var uniqueValues = [];

                values.forEach(function (item, i) {
                    if (
                        (uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) &&
                        item !== ""
                    ) {
                        uniqueValues.push(item);
                    }
                });
                return uniqueValues;
            }

            // Add the unique values to the municipalility select element. this will allow the user
            // to filter lot layer by municipality.
            function addToSelect(values) {
                values.sort();
                values.unshift("None"); // Add 'None' to the array and place it to the beginning of the array
                values.forEach(function (value) {
                    var option = document.createElement("option");
                    option.text = value;
                    packageSelect.add(option);
                });
            }

            // Set the definition expression on the lot layer to reflect the selecction of the user
            // This is activated, only when station is updated in the dropdown list (not priority)
            function setContractPackageOnlyExpression(cpValue) {
                if (cpValue == "None") {
                    compensationLayer.definitionExpression = null;
                    treeCuttingLayer.definitionExpression = null;
                    conservationLayer.definitionExpression = null;
                } else {
                    compensationLayer.definitionExpression = "CP = '" + cpValue + "'";
                    treeCuttingLayer.definitionExpression = "CP = '" + cpValue + "'";
                    conservationLayer.definitionExpression = "CP = '" + cpValue + "'";
                }

                //if (!treeCuttingLayer.visible) {
                //    treeCuttingLayer.visible = true;
                // }

                zoomToLayer(treeCuttingLayer);
                return queryTreeGeometries();
            }

            // CP dropdown list
            packageSelect.addEventListener("change", function () {
                const selectedCP = event.target.value;

                // Filter data
                setContractPackageOnlyExpression(selectedCP);

                // update chart
                updateChartCutting();
                updateChartTreeComp();
                updateChartTreeConservation();

                totalNumberTreeCut();
                totalNumberTreeCompen();
                totalNumberTreeConservation();

            });

            /////////////////////////////////////////////////////////


            ///-------- Action Bar ----------///
            // view.when
            view.when(() => {
                document.querySelector("#header-title").textContent = "SC TREE";
                document.querySelector(
                    "#item-description"
                ).innerHTML = `1. You can <b>filter the data</b> by contract pakcage using a dropdown list in the header panel.
                                                                <br><br>2. You can view summary statistics and progress on tree cutting and tree compensation in charts.
                                                                <br><br>3. <b>Click pie chart</b> to view trees on the map corresponding to the selected progress.
                                                                <br><br>4. <b>Click/unclick widgets</b> icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.`;

                let activeWidget;
                const handleActionBarClick = ({ target }) => {
                    if (target.tagName !== "CALCITE-ACTION") {
                        return;
                    }

                    if (activeWidget) {
                        document.querySelector(
                            `[data-action-id=${activeWidget}]`
                        ).active = false;
                        document.querySelector(
                            `[data-panel-id=${activeWidget}]`
                        ).hidden = true;
                    }

                    const nextWidget = target.dataset.actionId;
                    if (nextWidget !== activeWidget) {
                        document.querySelector(
                            `[data-action-id=${nextWidget}]`
                        ).active = true;
                        document.querySelector(
                            `[data-panel-id=${nextWidget}]`
                        ).hidden = false;
                        activeWidget = nextWidget;
                    } else {
                        activeWidget = null;
                    }
                };

                // Action bar
                document
                    .querySelector("calcite-action-bar")
                    .addEventListener("click", handleActionBarClick);
                let actionBarExpanded = false;
                document.addEventListener("calciteActionBarToggle", (event) => {
                    actionBarExpanded = !actionBarExpanded;
                    view.padding = {
                        left: actionBarExpanded ? 135 : 45,
                    };
                });

                //
                document
                    .querySelector("#thetabs")
                    .addEventListener("click", tabChange);
                function tabChange(event) {
                    const value = event.target.className;

                    if (value === "Cutting") {
                        compensationLayer.visible = false;
                        treeCuttingLayer.visible = true;
                        conservationLayer.visible = false;
                        updateChartCutting();
                        totalNumberTreeCut();
                    } else if (value === "Compensation") {
                        treeCuttingLayer.visible = false;
                        compensationLayer.visible = true;
                        conservationLayer.visible = false;
                        updateChartTreeComp();
                        totalNumberTreeCompen();
                    } else if (value === "Conservation") {
                        treeCuttingLayer.visible = false;
                        compensationLayer.visible = false;
                        conservationLayer.visible = true;
                        updateChartTreeConservation();
                        totalNumberTreeConservation();
                    }
                }
            }); // end of view.when
        }); // End of am4core.ready


        //*******************************//
        //           Clustering          //
        //*******************************//


        ///--------TREE CUTTING CLUSTERING---------///

        treeCuttingLayer.when().then(generateClusterConfig).then((featureReduction) => {
            treeCuttingLayer.featureReduction = featureReduction;

            const toggleButton = document.getElementById("toggle-cluster");
            toggleButton.addEventListener("click", toggleClustering);

            // To turn off clustering on a layer, set the
            // featureReduction property to null
            function toggleClustering() {
                if (isWithinScaleThreshold()) {
                    let fr = treeCuttingLayer.featureReduction;
                    treeCuttingLayer.featureReduction =
                        fr && fr.type === "cluster" ? null : featureReduction;
                }
                toggleButton.innerText =
                    toggleButton.innerText === "Enable Clustering"
                        ? "Disable Clustering"
                        : "Enable Clustering";
            }

            view.watch("scale", (scale) => {
                if (toggleButton.innerText === "Disable Clustering") {
                    treeCuttingLayer.featureReduction = isWithinScaleThreshold()
                        ? featureReduction
                        : null;
                }
            });
        })
            .catch((error) => {
                console.error(error);
            });

        function isWithinScaleThreshold() {
            return view.scale > 5000;
        }

        async function generateClusterConfig(layer) {
            // generates default popupTemplate
            const popupTemplate = await clusterPopupCreator
                .getTemplates({ layer })
                .then(
                    (popupTemplateResponse) =>
                        popupTemplateResponse.primaryTemplate.value
                );

            // generates default labelingInfo
            const { labelingInfo, clusterMinSize } = await clusterLabelCreator
                .getLabelSchemes({ layer, view })
                .then((labelSchemes) => labelSchemes.primaryScheme);

            return {
                type: "cluster",
                popupTemplate,
                labelingInfo,
                clusterMinSize
            };
        }


        ///--------TREE COMPENSATION CLUSTERING---------///

        compensationLayer.when().then(generateClusterConfig).then((featureReduction) => {
            compensationLayer.featureReduction = featureReduction;

            const toggleButton = document.getElementById("toggle-cluster2");
            toggleButton.addEventListener("click", toggleClustering);

            // To turn off clustering on a layer, set the
            // featureReduction property to null
            function toggleClustering() {
                if (isWithinScaleThreshold()) {
                    let fr = compensationLayer.featureReduction;
                    compensationLayer.featureReduction =
                        fr && fr.type === "cluster" ? null : featureReduction;
                }
                toggleButton.innerText =
                    toggleButton.innerText === "Enable Clustering"
                        ? "Disable Clustering"
                        : "Enable Clustering";
            }

            view.watch("scale", (scale) => {
                if (toggleButton.innerText === "Disable Clustering") {
                    compensationLayer.featureReduction = isWithinScaleThreshold()
                        ? featureReduction
                        : null;
                }
            });
        })
            .catch((error) => {
                console.error(error);
            });

        function isWithinScaleThreshold() {
            return view.scale > 5000;
        }

        async function generateClusterConfig(layer) {
            // generates default popupTemplate
            const popupTemplate = await clusterPopupCreator
                .getTemplates({ layer })
                .then(
                    (popupTemplateResponse) =>
                        popupTemplateResponse.primaryTemplate.value
                );

            // generates default labelingInfo
            const { labelingInfo, clusterMinSize } = await clusterLabelCreator
                .getLabelSchemes({ layer, view })
                .then((labelSchemes) => labelSchemes.primaryScheme);

            return {
                type: "cluster",
                popupTemplate,
                labelingInfo,
                clusterMinSize
            };
        }



        ///--------TREE CONSERVATION CLUSTERING---------///

        conservationLayer.when().then(generateClusterConfig).then((featureReduction) => {
            conservationLayer.featureReduction = featureReduction;

            const toggleButton = document.getElementById("toggle-cluster3");
            toggleButton.addEventListener("click", toggleClustering);

            // To turn off clustering on a layer, set the
            // featureReduction property to null
            function toggleClustering() {
                if (isWithinScaleThreshold()) {
                    let fr = conservationLayer.featureReduction;
                    conservationLayer.featureReduction =
                        fr && fr.type === "cluster" ? null : featureReduction;
                }
                toggleButton.innerText =
                    toggleButton.innerText === "Enable Clustering"
                        ? "Disable Clustering"
                        : "Enable Clustering";
            }

            view.watch("scale", (scale) => {
                if (toggleButton.innerText === "Disable Clustering") {
                    conservationLayer.featureReduction = isWithinScaleThreshold()
                        ? featureReduction
                        : null;
                }
            });
        })
            .catch((error) => {
                console.error(error);
            });

        function isWithinScaleThreshold() {
            return view.scale > 5000;
        }

        async function generateClusterConfig(layer) {
            // generates default popupTemplate
            const popupTemplate = await clusterPopupCreator
                .getTemplates({ layer })
                .then(
                    (popupTemplateResponse) =>
                        popupTemplateResponse.primaryTemplate.value
                );

            // generates default labelingInfo
            const { labelingInfo, clusterMinSize } = await clusterLabelCreator
                .getLabelSchemes({ layer, view })
                .then((labelSchemes) => labelSchemes.primaryScheme);

            return {
                type: "cluster",
                popupTemplate,
                labelingInfo,
                clusterMinSize
            };
        }


        //*****************************//
        //           Widgets           //
        //*****************************//


        ///-------- Basemap Gallery ----------///
        const basemaps = new BasemapGallery({
            view,
            container: "basemaps-container",
        });


        ///-------- Search Bar ----------///
        var searchWidget = new Search({
            view: view,
            locationEnabled: false,
            allPlaceholder: "Tree No, Chainage",
            includeDefaultSources: false,
            sources: [
                {
                    layer: treeCuttingLayer,
                    searchFields: ["ID"],
                    displayField: "ID",
                    exactMatch: false,
                    outFields: ["*"],
                    name: "Tree ID.",
                    placeholder: "Tree ID: DP-T-1",
                },
            ],
        });

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",
            group: "top-right",
        });

        view.ui.add(searchExpand, {
            position: "top-right",
        });
        searchExpand.watch("expanded", function () {
            if (!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });


        ///-------- Layer List ----------///
        var layerList = new LayerList({
            view: view,
            selectionEnabled: true,
            container: "layers-container",
            listItemCreatedFunction: function (event) {
                const item = event.item;
                if (item.title === "Chainage") {
                    item.visible = false;
                }
                if (item.layer.type != "group") { // don't show legend twice
                    item.panel = {
                        content: "legend",
                        open: true
                    };
                }
            },
        });


        ///-------- Legend ----------///
        var legend = new Legend({
            view,
            container: "legend-container",
            layerInfos: [
                {
                    layer: treeCuttingLayer,
                    title: "Status of Tree Cutting",
                },
                {
                    layer: compensationLayer,
                    title: "Status of Tree Compensation",
                },
                {
                    layer: conservationLayer,
                    title: "Conservation Status",
                },
            ],
        });


        ///-------- Locate ----------///
        const locate = new Locate({
            view: view,
            container: "locate-container",
        });

        view.ui.empty("top-left");
    });
</script>

</html>